<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quote Builder</title>
    <style>
        :root {
            /* T-MOBILE INSPIRED THEME */
            --primary-color: #E20074; /* T-Mobile Magenta */
            --primary-light: #f26ea4; /* Lighter Magenta for pills */
            --primary-hover: #b5005d;
            --bg-color: #f4f4f4;
            --card-bg: #ffffff;
            --text-main: #262626;
            --text-secondary: #6a6a6a;
            --border-color: #e0e0e0;
            --success-color: #10b981;
            --danger-color: #E20074;
            --anim-speed: 0.4s;
            --toggle-width: 200px;
        }

        /* Global Box Sizing */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { height: 100%; overflow-x: hidden; }

        body {
            font-family: BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
	    accent-color: var(--primary-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
            min-height: 100%;
            -webkit-text-size-adjust: 100%;
            overflow-x: hidden;
            touch-action: manipulation;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding-bottom: 80px; 
        }

        /* HEADER */
        header {
            margin-bottom: 30px;
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 50px;
        }

        h1 {
            margin: 0;
            font-size: 2rem;
            color: var(--primary-color);
            font-weight: 800;
            z-index: 2;
            letter-spacing: -0.5px;
        }

        /* T-Mobile Text Logo */
        .tmo-logo-wrapper {
            display: flex;
            align-items: center;
            z-index: 2;
        }
        .tmo-text-logo {
            font-family: "Tele-Grotesk Next Ultra", "Arial Black", sans-serif;
            font-size: 1.8rem;
            font-weight: 900;
            color: var(--primary-color);
            letter-spacing: -0.5px;
        }
        .tmo-logo-img {
            height: 37px;
            width: auto;
            aspect-ratio: 500 / 103;
        }
        .tmo-text-logo-print {
            font-family: "Tele-Grotesk Next Ultra", "Arial Black", sans-serif;
            font-size: 14px;
            font-weight: 900;
            color: var(--primary-color);
            letter-spacing: -0.3px;
        }
        .tmo-logo-print {
            height: 20px;
            width: 20px;
            aspect-ratio: 1 / 1;
        }

        /* PRINT HEADER */
        #print-info-container {
            display: none;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
        }

        .print-row {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #000;
            margin-bottom: 4px;
        }
        
        .print-label { font-weight: 700; color: #555; margin-right: 5px; }
        .print-val { font-weight: 400; }

        /* iOS Toggle - 2-way */
        .toggle-container {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            background: #e0e0e0;
            border-radius: 25px;
            padding: 4px;
            width: var(--toggle-width);
            height: 36px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.06);
            z-index: 1;
        }

        .toggle-input { display: none; }

        .toggle-labels {
            display: flex;
            width: 100%;
            justify-content: space-between;
            position: relative;
            z-index: 2;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 700;
            user-select: none;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .toggle-labels span {
            flex: 1;
            text-align: center;
            padding: 8px 0;
            transition: color 0.3s;
            color: var(--text-secondary);
        }

        .toggle-labels span.active {
            color: var(--primary-color);
        }

        .toggle-slider {
            position: absolute;
            top: 4px;
            left: 4px;
            width: calc(50% - 4px);
            height: calc(100% - 8px);
            background: white;
            border-radius: 20px;
            transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1;
        }

        .toggle-slider.position-0 { transform: translateX(0); }
        .toggle-slider.position-1 { transform: translateX(100%); }

        /* Compare Link at Bottom */
        .compare-link-wrapper {
            text-align: center;
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .compare-link-wrapper.hidden {
            display: none;
        }

        .compare-link {
            color: var(--primary-color);
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .compare-link:hover {
            opacity: 0.7;
            text-decoration: underline;
        }
        
        /* Quote title and compare section in row header */
        .quote-title-input {
            border: none !important;
            background: transparent;
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-main);
            padding: 0 2px;
            margin: 0;
            border-radius: 0;
            min-width: 1.4em;
            width: auto;
            height: 1.4em;
            line-height: 1.4;
            cursor: text;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            box-shadow: none !important;
            outline: none !important;
            font-family: inherit;
            overflow: visible;
        }
        .quote-title-input:hover,
        .quote-title-input:focus,
        .quote-title-input:active {
            border: none !important;
            outline: none !important;
            box-shadow: none !important;
        }
        .row-actions-left {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        .compare-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 600;
        }
        
        /* Disabled button state for Quotes button */
        .btn-compare-quotes:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }
        
        /* Quote Comparison Section Styles - matches compare-section pattern */
        #quote-compare-section {
            display: none;
            max-width: 100%;
            margin: 0 auto;
        }
        #quote-compare-section.active {
            display: block;
        }
        
        /* Hide elements when in quote compare mode */
        body.quote-compare-mode .toggle-container,
        body.quote-compare-mode #add-row-btn,
        body.quote-compare-mode #load-quote-btn,
        body.quote-compare-mode #compare-quotes-header-btn,
        body.quote-compare-mode .hamburger-btn,
        body.quote-compare-mode .carousel-nav,
        body.quote-compare-mode .carousel-nav-arrow,
        body.quote-compare-mode #rows-container,
        body.quote-compare-mode #compare-section,
        body.quote-compare-mode #export-pdf {
            display: none !important;
        }
        
        .quote-compare-buttons {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px 0;
        }
        .quote-compare-grid {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .quote-compare-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            flex: 1;
            min-width: 300px;
            display: flex;
            flex-direction: column;
        }
        .quote-card-content {
            flex: 1;
        }
        .quote-card-footer {
            margin-top: auto;
            padding-top: 15px;
        }
        .quote-compare-grid.two-quotes .quote-compare-card {
            max-width: calc(50% - 10px);
        }
        .quote-compare-grid.three-quotes .quote-compare-card {
            max-width: calc(33.333% - 14px);
        }
        .quote-card-header {
            text-align: center;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 0;
        }
        .quote-card-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 5px;
        }
        .quote-card-plan {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-main);
        }
        .quote-card-price {
            text-align: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 15px;
        }
        .quote-card-price-amount {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            line-height: 1.1;
        }
        .quote-card-price-tax {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-secondary);
        }
        .quote-card-price-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        .quote-card-section {
            margin-bottom: 15px;
        }
        .quote-card-section-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 8px;
        }
        .quote-card-section-content {
            font-size: 0.95rem;
            color: var(--text-main);
        }
        .quote-card-device {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .quote-card-device:last-child {
            border-bottom: none;
        }
        .quote-card-device-name {
            font-weight: 500;
        }
        .quote-card-device-price {
            color: var(--text-secondary);
        }
        .quote-card-savings-row {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .quote-card-savings {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            flex: 1;
            border: 1px solid var(--border-color);
        }
        .quote-card-savings-amount {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        .quote-card-savings-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        .quote-card-cd-subtext {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 2px;
        }
        
        /* Quote Selection Modal Styles */
        .quote-select-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        .quote-select-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .quote-select-item:hover {
            border-color: var(--primary-color);
            background: rgba(226, 0, 116, 0.03);
        }
        .quote-select-item.selected {
            border-color: var(--primary-color);
            background: rgba(226, 0, 116, 0.08);
        }
        .quote-select-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }
        .quote-select-checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s;
        }
        .quote-select-item.selected .quote-select-checkbox {
            background: var(--primary-color);
            border-color: var(--primary-color);
        }
        .quote-select-checkbox svg {
            display: none;
            width: 16px;
            height: 16px;
            color: white;
        }
        .quote-select-item.selected .quote-select-checkbox svg {
            display: block;
        }
        .quote-select-info {
            flex: 1;
        }
        .quote-select-name {
            font-weight: 600;
            color: var(--text-main);
            margin-bottom: 4px;
        }
        .quote-select-details {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        .quote-select-count {
            text-align: center;
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 15px;
        }
        
        @media (max-width: 900px) {
            .quote-compare-grid.two-quotes .quote-compare-card,
            .quote-compare-grid.three-quotes .quote-compare-card {
                max-width: 100%;
            }
        }

        .compare-buttons {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px 0;
        }

        .compare-back-btn {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .compare-back-arrow {
            font-size: 1rem;
        }

        /* Show buttons only when compare section is active */
        #compare-section.active .compare-buttons {
            display: flex;
        }

        #compare-section:not(.active) .compare-buttons {
            display: none;
        }

        /* COMPARISON SECTION */
        #compare-section {
            display: none;
            max-width: 100%;
            margin: 0 auto;
        }

        #compare-section.active {
            display: block;
        }

        /* Hide print button when compare section is active */
        #compare-section.active ~ #export-pdf {
            display: none !important;
        }

        /* Hide header elements when in compare mode */
        body.compare-mode .toggle-container,
        body.compare-mode #add-row-btn,
        body.compare-mode #load-quote-btn,
        body.compare-mode #compare-quotes-header-btn,
        body.compare-mode .hamburger-btn,
        body.compare-mode .carousel-nav,
        body.compare-mode .carousel-nav-arrow {
            display: none !important;
        }

        /* Sam's Club Benefits - visible on compare page */
        .sams-club-benefits {
            display: none;
            margin-top: 20px;
            width: 100%;
        }
        #compare-section.active .sams-club-benefits {
            display: block;
        }
        .sams-club-title {
            text-align: center;
            font-size: 1.35rem;
            font-weight: 800;
            color: #000;
            margin-bottom: 12px;
        }
        .sams-club-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 0;
            overflow: hidden;
        }
        .sams-club-card {
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .sams-club-card-top {
            background: var(--primary-color);
            padding: 12px 10px;
            text-align: center;
            font-size: 1.05rem;
            font-weight: 700;
            color: #fff;
            line-height: 1.4;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 95px;
            border-right: 1px solid #fff;
        }
        .sams-club-card:last-child .sams-club-card-top {
            border-right: none;
        }
        .sams-club-card-top strong {
            font-weight: 700;
        }
        .sams-club-card-bottom {
            background: #fff;
            padding: 12px 10px;
            text-align: center;
            font-size: 1.15rem;
            font-weight: 800;
            color: var(--primary-color);
            border: 1px solid #000;
            margin-left: -1px;
        }
        .sams-club-card:first-child .sams-club-card-bottom {
            margin-left: 0;
        }
        .sams-club-plus-row {
            display: block;
            margin-top: 8px;
            position: relative;
        }
        .sams-club-plus-arrow {
            position: absolute;
            left: calc(16.666% - 30px);
            top: 0;
            width: 60px;
            display: flex;
            align-items: flex-start;
            justify-content: center;
        }
        .sams-club-plus-arrow svg {
            width: 60px;
            height: 50px;
            overflow: visible;
        }
        .sams-club-plus-note {
            display: block;
            width: 100%;
            font-size: 1.15rem;
            font-weight: 700;
            color: #000;
            padding: 8px 10px 0 10px;
            text-align: center;
        }
        .sams-club-plus-note .every-year {
            color: var(--primary-color);
            font-weight: 800;
        }
        .sams-club-fine-print {
            font-size: 0.8rem;
            color: #000;
            text-align: center;
            margin-top: 4px;
            font-weight: 600;
        }
        /* Portrait/narrow screen fix for Sam's Club */
        @media (max-width: 850px) {
            .sams-club-card-top {
                padding: 10px 6px;
                font-size: 0.9rem;
                min-height: 85px;
            }
            .sams-club-card-bottom {
                padding: 10px 6px;
                font-size: 1rem;
            }
            .sams-club-plus-arrow {
                left: calc(16.666% - 22px);
                width: 45px;
            }
            .sams-club-plus-arrow svg {
                width: 45px;
                height: 38px;
            }
            .sams-club-plus-note {
                padding: 6px 10px 0 10px;
                font-size: 1rem;
            }
            .sams-club-fine-print {
                font-size: 0.7rem;
            }
        }

        .compare-dropdowns {
            display: grid;
            grid-template-columns: 33.333% 33.333% 33.334%;
            gap: 0;
            margin-bottom: 0;
            align-items: stretch;
        }

        .compare-dropdown-wrapper {
            display: flex;
            flex-direction: column;
            border-right: 1px solid #000;
        }

        .compare-dropdown-wrapper:last-child {
            border-right: none;
        }

        .compare-dropdown-wrapper.spacer {
            background: #000 !important;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
            border-right: 1px solid #000;
            border-bottom: 1px solid #fff;
            color: white;
            font-size: 1.6rem;
            font-weight: 800;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .compare-dropdown-wrapper.spacer div {
            color: #fff !important;
        }

        .compare-plan-trigger {
            width: 100%;
            height: 100%;
            padding: 15px;
            border: none;
            border-radius: 0;
            font-size: 1.1rem;
            font-weight: 800;
            background: white;
            color: var(--text-main);
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 60px;
            flex: 1;
        }

        .compare-dropdown-wrapper:nth-child(2) .compare-plan-trigger {
            border-top-left-radius: 0;
        }

        .compare-dropdown-wrapper:nth-child(3) .compare-plan-trigger {
            border-top-right-radius: 0;
        }

        .compare-plan-trigger:hover {
            background: #f9f9f9;
        }

        .compare-plan-trigger.has-selection {
            color: #000;
            background: #fff;
        }

        .compare-plan-trigger.has-selection:hover {
            background: #fef5fa;
        }

        .compare-plan-trigger.premium {
            background: var(--primary-color);
            color: white;
        }
        
        /* White border below premium headers */
        .compare-dropdown-wrapper:has(.compare-plan-trigger.premium) {
            border-bottom: 1px solid #fff;
            border-right-color: #fff;
        }
        
        /* White border between headers when second header is premium (use left border on second) */
        .compare-dropdown-wrapper:last-child:has(.compare-plan-trigger.premium) {
            border-left: 1px solid #fff;
            margin-left: -1px;
        }
        
        .compare-dropdown-wrapper:last-child .compare-plan-trigger.premium {
            border-right: none;
        }

        .compare-plan-trigger.premium:hover {
            background: var(--primary-hover);
        }

        .compare-vs {
            display: none;
        }

        /* Make comparison table border connect seamlessly with plan selectors */
        #compare-section .comparison-table {
            border-radius: 0;
            border-top: none;
        }

        /* Add black border-top to first row cells under non-premium headers */
        /* First value column (plan 1) - add border if plan1 is NOT premium */
        /* This targets the second child (first value cell after the name cell) */
        #compare-section .comparison-table:not(.plan1-premium) .comparison-row:first-child > :nth-child(2) {
            border-top: 1px solid #000;
        }
        
        /* Second value column (plan 2) - add border if plan2 is NOT premium */
        /* This targets the third child (second value cell) when it exists */
        #compare-section .comparison-table:not(.plan2-premium) .comparison-row:first-child > :nth-child(3) {
            border-top: 1px solid #000;
        }

        #compare-section .comparison-row:last-child .comparison-benefit-name {
            border-radius: 0;
            border-bottom: none;
        }

        #compare-section .comparison-row:last-child .comparison-benefit-value:last-child {
            border-radius: 0;
        }

        /* Make dropdowns connect to table seamlessly */
        #compare-section .compare-dropdowns {
            border: 1px solid #000;
            border-bottom: none;
            border-radius: 0;
            background: white;
        }

        /* Rounded bottom corners when no comparison table is shown */
        #compare-section .compare-dropdowns.no-content {
            border-bottom: 1px solid #000;
            border-radius: 0;
        }
        
        #compare-section .compare-dropdowns.no-content .compare-dropdown-wrapper.spacer {
            border-bottom: none;
            border-radius: 0;
        }
        
        #compare-section .compare-dropdowns.no-content .compare-dropdown-wrapper:last-child .compare-plan-trigger {
            border-radius: 0;
        }

        #compare-section .comparison-table {
            margin-top: 0;
        }

        /* Comparison Table */
        .comparison-table {
            background: white;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: none;
            border-radius: 0;
        }

        .comparison-header {
            display: grid;
            grid-template-columns: 1fr;
            background: white;
            border-bottom: 1px solid #000;
            color: #000;
            font-weight: 800;
            font-size: 1.3rem;
            text-align: center;
        }

        .comparison-header.two-plans {
            grid-template-columns: 33.333% 33.333% 33.334%;
        }

        .comparison-header-benefit {
            grid-column: 1;
            background: #000;
            color: white;
            padding: 15px;
            border-right: 1px solid #000;
            border-bottom: 1px solid #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            font-weight: 800;
        }

        .comparison-plan-name {
            padding: 15px;
            border-right: 1px solid #000;
        }

        .comparison-plan-name:last-child {
            border-right: none;
        }

        .comparison-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
        }

        .comparison-row.two-plans {
            grid-template-columns: 33.333% 33.333% 33.334%;
        }

        .comparison-row:last-child {
            border-bottom: none;
        }

        .comparison-row:last-child .comparison-benefit-value {
            border-bottom: none;
        }

        .comparison-row:last-child .comparison-benefit-name {
            border-bottom: none;
        }

        .comparison-benefit-name {
            padding: 10px 15px;
            font-weight: 800;
            color: #fff;
            background: #000;
            border-right: 1px solid #000;
            border-bottom: 1px solid #fff;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 45px;
        }

        .benefit-name-main {
            display: block;
            font-weight: 800;
            line-height: 1.3;
        }

        .benefit-name-sub {
            display: block;
            font-size: 0.55rem;
            font-weight: 700;
            color: #fff;
            margin-top: 2px;
            line-height: 1.2;
        }

        .comparison-benefit-value {
            padding: 10px 15px;
            text-align: center;
            font-weight: 700;
            position: relative;
            background: white;
            border-right: 1px solid #000;
            border-bottom: 1px solid #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 45px;
        }
        
        /* First value cell (adjacent to black name column) gets white left border */
        .comparison-benefit-value:first-of-type {
            border-left: 1px solid #fff;
        }

        .comparison-benefit-value:last-child {
            border-right: none;
        }

        /* Merged cell for matching values - NO magenta, just white background */
        .comparison-benefit-value.merged {
            grid-column: 2 / 4;
            border-right: none;
            background: white !important;
            color: var(--text-main) !important;
            border-bottom: 1px solid #000;
        }

        /* Only non-merged included cells get magenta to highlight differences */
        .comparison-benefit-value.included:not(.merged) {
            color: white;
            background: var(--primary-color);
            border-right: 1px solid #fff;
            border-bottom: 1px solid #fff;
            border-top: 1px solid #fff;
            border-left: 1px solid #fff;
            margin-top: -1px;
            margin-left: -1px;
        }
        
        /* Last included cell in row should not have right white border */
        .comparison-benefit-value.included:not(.merged):last-child {
            border-right: none;
        }

        .comparison-benefit-value.included.merged {
            background: white !important;
            color: var(--text-main) !important;
        }

        .comparison-benefit-value.not-included {
            color: var(--text-main);
        }

        .comparison-benefit-value.custom {
            color: var(--text-main);
        }

        /* Override benefit-sub color for included items */
        .comparison-benefit-value.included:not(.merged) .benefit-sub {
            color: #fff;
        }

        /* Merged cells keep normal sub text color */
        .comparison-benefit-value.included.merged .benefit-sub {
            color: var(--text-main);
        }

        .benefit-main {
            display: block;
            font-weight: 800;
            line-height: 1.3;
        }

        .benefit-sub {
            display: block;
            font-size: 0.6rem;
            color: var(--text-main);
            font-weight: 700;
            margin-top: 2px;
            line-height: 1.2;
        }

        .comparison-empty-state {
            padding: 60px 20px;
            text-align: center;
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .comparison-empty-state strong {
            color: var(--primary-color);
            display: block;
            margin-bottom: 10px;
            font-size: 1.3rem;
        }

        /* Responsive comparison */
        @media (max-width: 768px) {
            .compare-dropdowns {
                display: flex;
                flex-direction: column;
                gap: 15px;
            }

            .compare-dropdown-wrapper.spacer {
                display: none;
            }

            .compare-plan-trigger {
                border-radius: 8px;
                border-bottom: 1px solid #000;
            }

            .compare-vs {
                display: none;
            }

            .comparison-header.two-plans,
            .comparison-row.two-plans {
                grid-template-columns: 1fr;
            }

            .comparison-row {
                grid-template-columns: 1fr;
            }

            .comparison-benefit-name {
                border-right: none;
                border-bottom: 1px solid #000;
                font-size: 0.9rem;
            }

            .comparison-benefit-value {
                border-right: none;
                border-bottom: 1px solid #000;
            }

            .comparison-row:last-child .comparison-benefit-value:last-child {
                border-bottom: none;
            }

            .comparison-plan-name {
                padding: 16px;
                border-right: none;
                border-bottom: 1px solid #000;
                font-size: 1.1rem;
            }

            .comparison-header-benefit {
                border-right: none;
                border-bottom: 1px solid #000;
            }

            .comparison-row.two-plans.different .comparison-benefit-value:first-of-type::after {
                display: none;
            }

            #compare-section .comparison-table {
                border-radius: 8px;
                border-top: none;
            }
            
            /* Add black border-top to first row cells under non-premium headers (mobile) */
            #compare-section .comparison-table:not(.plan1-premium) .comparison-row:first-child > :nth-child(2) {
                border-top: 1px solid #000;
            }
            #compare-section .comparison-table:not(.plan2-premium) .comparison-row:first-child > :nth-child(3) {
                border-top: 1px solid #000;
            }
        }

        /* BUTTONS */
        .btn {
            padding: 12px 24px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-weight: 700;
            font-size: 0.9rem;
            transition: background-color 0.2s, border-color 0.2s, color 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            z-index: 2;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
        }

        .btn-primary { background-color: var(--primary-color); color: white; box-shadow: 0 2px 5px rgba(226, 0, 116, 0.3); }
        .btn-primary:hover { background-color: var(--primary-hover); }
        .btn-secondary { background-color: white; border: 2px solid var(--border-color); color: var(--text-main); }
        .btn-secondary:hover { border-color: var(--primary-color); color: var(--primary-color); }
        .btn-remove { 
            padding: 4px 10px; 
            font-size: 0.75rem; 
            border-radius: 4px; 
            border: 1px solid transparent; 
            cursor: pointer; 
            text-transform: uppercase; 
            font-weight: 700; 
            background-color: transparent; 
            color: #666; 
            line-height: 1.5;
        }
        .btn-remove:hover,
        .btn-remove:active { 
            background-color: #ffeef5;
            color: var(--primary-color);
        }
        .btn-small { padding: 4px 10px; font-size: 0.75rem; border-radius: 4px; border: 1px solid transparent; cursor: pointer; text-transform: uppercase; font-weight: 700; line-height: 1.5; }
        .btn-small-danger { background-color: #ffeef5; color: var(--danger-color); }
        .btn-small-danger:hover { background-color: #ffdceb; }
        .btn-small-confirm { background-color: var(--danger-color); color: white; }
        .btn-small-confirm:hover { background-color: var(--primary-hover); }
        .btn-small-edit { background-color: #f0f0f0; color: #333; }
        .btn-small-edit:hover { background-color: #e0e0e0; }
        .btn-small-cd-edit { background-color: #ffeef5; color: var(--primary-color); }
        .btn-small-cd-edit:hover { background-color: #ffdceb; }
        
        /* Deal pricing styles */
        .price-strikethrough { text-decoration: line-through; color: #999; font-size: 0.85em; }
        .price-deal { color: var(--primary-color); font-weight: 700; }
        .deal-badge { display: inline-block; background: var(--primary-light); color: white; font-size: 0.65rem; font-weight: 700; padding: 2px 6px; border-radius: 4px; margin-left: 6px; text-transform: uppercase; }

        .btn-export-pdf {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: auto;
            min-width: 220px;
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 5px 20px rgba(226, 0, 116, 0.4);
            font-size: 1rem;
            border-radius: 50px;
            padding: 14px 30px;
            z-index: 999;
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        .btn-export-pdf:hover {
            background-color: var(--primary-hover);
            box-shadow: 0 8px 25px rgba(226, 0, 116, 0.5);
        }

        /* CUSTOM STEPPER */
        .stepper-wrapper {
            display: flex; align-items: center; border: 2px solid var(--border-color);
            border-radius: 4px; background: white; overflow: hidden; width: 100%;
        }
        .stepper-btn {
            background: #f9f9f9; border: none; width: 40px; height: 46px;
            cursor: pointer; font-size: 1.2rem; color: var(--primary-color);
            display: flex; align-items: center; justify-content: center;
        }
        .stepper-btn:hover { background: #eee; }
        .stepper-input {
            flex: 1; text-align: center; border: none !important;
            border-left: 1px solid var(--border-color) !important;
            border-right: 1px solid var(--border-color) !important;
            border-radius: 0 !important; padding: 10px 0 !important;
            font-weight: 700; font-size: 1.1rem; height: 46px; -moz-appearance: textfield;
        }
        .stepper-input::-webkit-outer-spin-button, .stepper-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

        /* CUSTOM SEARCHABLE DROPDOWN */
        .search-select-wrapper { position: relative; width: 100%; z-index: 20; }
        .search-select-input {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            font-size: 1rem;
            box-sizing: border-box;
            background: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e") no-repeat right 1rem center;
            background-size: 1.2em;
            background-color: white;
            cursor: pointer;
        }
        .search-select-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 0 0 8px 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            max-height: 250px;
            overflow-y: auto;
            z-index: 9999;
            display: none;
        }
        .search-select-options.visible { display: block; }
        .search-option { padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #f0f0f0; }
        .search-option:hover { background-color: #ffeef5; color: var(--primary-color); }

        /* ROW CARDS */
        .calculator-row {
            background-color: var(--card-bg); border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); padding: 30px;
            margin-bottom: 25px; border: 1px solid var(--border-color);
            position: relative; animation: slideUp 0.5s ease-out;
            overflow: visible; transition: height 0.3s ease;
        }
        .calculator-row.active-dropdown { z-index: 100 !important; }
        .calculator-row[data-row-index="1"][data-mode="existing"] { }
        .calculator-row[data-row-index="1"][data-mode="existing"] .row-title { color: var(--primary-color); }
        
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInBlock { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Carousel/Stacked Mode with swipe animation */
        #rows-container.carousel-mode { 
            position: relative; 
            min-height: 600px;
            overflow: hidden;
            transition: min-height 0.3s ease;
        }
        #rows-container.carousel-mode .calculator-row { 
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            opacity: 0;
            pointer-events: none;
            z-index: 1;
            visibility: hidden;
            background: var(--card-bg);
        }
        #rows-container.carousel-mode .calculator-row.carousel-active { 
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            opacity: 1;
            pointer-events: auto;
            z-index: 10;
            visibility: visible;
            -webkit-transform: translateX(0);
            transform: translateX(0);
        }
        .carousel-nav { 
            display: flex; 
            justify-content: center; 
            align-items: center;
            gap: 15px; 
            padding: 20px 0;
            position: relative;
            z-index: 20;
        }
        .carousel-nav-arrow {
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(226, 0, 116, 0.4);
        }
        .carousel-nav-arrow svg {
            width: 24px;
            height: 24px;
            fill: none;
            stroke: white;
            stroke-width: 2.5;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        .carousel-nav-arrow.left {
            left: 15px;
        }
        .carousel-nav-arrow.right {
            right: 15px;
        }
        .carousel-nav-arrow:hover {
            background: var(--primary-hover);
            transform: translateY(-50%) scale(1.1);
            box-shadow: 0 6px 20px rgba(226, 0, 116, 0.5);
        }
        .carousel-nav-arrow:active {
            transform: translateY(-50%) scale(0.95);
        }
        .carousel-nav-arrow:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: translateY(-50%);
            box-shadow: none;
            opacity: 0.6;
        }
        .carousel-dots {
            display: flex;
            gap: 10px;
        }
        .carousel-dot { 
            width: 12px; 
            height: 12px; 
            border-radius: 50%; 
            background: var(--border-color); 
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }
        .carousel-dot.active { 
            background: var(--primary-color); 
            transform: scale(1.2);
        }
        .carousel-dot:hover { background: var(--primary-light); }

        .row-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 8px; padding-bottom: 0; border-bottom: none;
            gap: 15px;
        }
        .row-title-section { display: flex; align-items: center; gap: 10px; flex: 1; }
        .row-title-input {
            font-family: inherit; font-weight: 800; color: var(--text-main);
            text-transform: uppercase; letter-spacing: 0.05em; font-size: 1rem;
            border: none !important; background: transparent; width: 100%; max-width: 300px;
            padding: 5px 0; border-radius: 0; cursor: text;
            -webkit-appearance: none; appearance: none;
        }
        .row-title-input:focus { outline: none; background: transparent; box-shadow: none !important; }
        .row-options { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
        .row-option-label { 
            display: flex; align-items: center; gap: 4px; font-size: 0.65rem; 
            font-weight: 600; color: var(--text-secondary); cursor: pointer;
            text-transform: uppercase; letter-spacing: 0.3px;
        }
        .row-option-label input { cursor: pointer; }
        .contact-center { display: flex; flex-direction: column; align-items: center; }
        .contact-address { font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 2px; }

        .steps-container { 
            display: grid; grid-template-columns: 1fr; gap: 20px; position: relative; z-index: 1;
        }
        @media (min-width: 769px) { 
            .steps-container { grid-template-columns: 1fr 1fr; }
            .step-col-3, .step-col-rebates, .step-col-discounts { grid-column: 1 / -1; }
            .step-col-discounts { grid-column: 1 / 2; }
            .step-col-rebates { grid-column: 2 / 3; }
            .step-col-bts { grid-column: 1 / 2; }
            .step-col-internet { grid-column: 2 / 3; }
        }
        
        /* Device row - full width */
        .steps-container.steps-device-row {
            display: block;
            margin-top: 15px;
        }
        .steps-device-row .step-col-devices { width: 100%; }
        
        /* Extras row - 2 columns */
        .steps-container.steps-extras-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        @media (max-width: 768px) {
            .steps-container.steps-extras-row {
                grid-template-columns: 1fr;
            }
        }

        .step-col { background-color: #fff; display: block; position: relative; z-index: 1; }
        .step-col.active-col { z-index: 100 !important; }

        .step-col.hidden-step { display: none; }
        .step-col.visible-step { display: block; animation: fadeInBlock 0.4s ease forwards; }
        
        /* Z-Index Logic */
        .step-col:nth-child(1), .step-col:nth-child(2) { z-index: 20; }
        .step-col.step-col-3 { z-index: 10; } 
        #row-generic-col3 button, .step-col-3 button { position: relative; z-index: 30; }

        .step-label { display: block; font-weight: 700; margin-bottom: 8px; font-size: 1rem; color: var(--text-main); }
        .step-label.print-only-label { display: none; }
        .step-label.screen-only-label { display: block; }
        .step-number { display: inline-block; background-color: var(--primary-color); color: white; width: 28px; height: 28px; border-radius: 50%; text-align: center; line-height: 28px; font-size: 0.9rem; font-weight: bold; margin-right: 10px; }
        
        .step-label .print-only-text { display: none; }
        .step-label .screen-only-text { display: inline; }

        select, input[type="number"], input[type="text"], input[type="tel"] {
            width: 100%; padding: 14px; border: 2px solid var(--border-color);
            border-radius: 4px; font-size: 1rem; box-sizing: border-box;
            transition: border-color 0.2s, box-shadow 0.2s;
            color: var(--text-main);
            background-color: white;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        select {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 1.2em;
            padding-right: 40px;
            cursor: pointer;
        }
        select:focus, input[type="number"]:focus, input[type="text"]:focus, input[type="tel"]:focus {
            outline: none; border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(226, 0, 116, 0.15);
        }
        select option {
            color: var(--text-main);
        }

        .plan-select-wrapper { position: relative; }
        .plan-select-trigger {
            width: 100%; padding: 14px; border: 2px solid var(--border-color);
            border-radius: 4px; font-size: 1rem; background-color: white; cursor: pointer;
            text-align: left;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1.2em;
        }
        .plan-select-trigger:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(226, 0, 116, 0.15); }

        /* DEVICE LIST */
        .device-list-container { margin-top: 15px; display: flex; flex-direction: column; gap: 10px; }
        .device-summary-card {
            display: flex; justify-content: space-between; align-items: center;
            padding: 14px 16px; background: #f9f9f9; border-radius: 6px; border: 1px solid var(--border-color);
        }
        .device-info { display: flex; flex-direction: column; gap: 4px; }
        .device-summary-card.accessory-card {
            padding: 10px 14px;
            background: #f9f9f9;
            border: 1px solid var(--border-color);
        }
        .device-summary-card.accessory-card > .device-info {
            flex-direction: row !important;
            justify-content: space-between !important;
            align-items: center !important;
            gap: 8px !important;
        }
        .device-summary-card.accessory-card.accessory-combined > .device-info {
            flex-direction: row !important;
            justify-content: space-between !important;
            align-items: center !important;
            gap: 8px !important;
        }
        .device-summary-card.accessory-card .device-label-text {
            font-size: 1rem;
            font-weight: 700;
            flex: 1;
        }
        .device-summary-card.accessory-card .device-cost-preview {
            font-size: 0.9rem;
        }
        .device-summary-card.accessory-card .accessory-price-wrapper {
            display: flex !important;
            flex-direction: row !important;
            align-items: center !important;
            gap: 4px !important;
            flex-shrink: 0 !important;
            text-align: right !important;
        }
        .device-summary-card.accessory-card .accessory-retail-screen {
            font-size: 0.75rem;
        }
        .device-label-text { font-weight: 800; color: var(--text-main); font-size: 1.15rem; line-height: 1.3; }
        .device-cost-preview { font-size: 1rem; color: var(--primary-color); font-weight: 700; line-height: 1.3; }
        .device-detail-preview { font-size: 0.85rem; color: var(--text-secondary); line-height: 1.3; }
        .device-detail-preview.accessory-retail-print { font-size: 0.75rem; }
        .device-detail-preview.device-detail-plain { cursor: default; text-decoration: none; }
        .device-detail-preview.device-detail-clickable { cursor: pointer; text-decoration: underline dotted; }
        .device-detail-preview.device-detail-clickable:hover { color: var(--primary-color); }
        .device-trade-in { color: var(--text-secondary); font-size: inherit; font-weight: inherit; }
        .device-actions { display: flex; gap: 8px; }
        .accessory-row-break { display: none; } /* Hidden on screen, visible on print */
        .device-summary-card.accessory-card.accessory-individual { display: none !important; } /* Hidden on screen, visible on print */
        .device-summary-card.accessory-card.accessory-combined { display: flex !important; } /* Visible on screen, hidden on print */
        .cd-screen-only { display: block; } /* Visible on screen, hidden on print */
        .cd-print-only { display: none; } /* Hidden on screen, visible on print */
        .hi-screen-only { display: flex; justify-content: space-between; align-items: center; width: 100%; } /* Visible on screen, hidden on print */
        .hi-print-only { display: none; } /* Hidden on screen, visible on print */
        
        .byod-placeholder { display: none; text-align: center; padding: 15px; font-style: italic; color: var(--text-secondary); border: 2px dashed var(--border-color); border-radius: 6px; margin-top: 15px; }

        /* ROW FOOTER */
        .row-footer { margin-top: 25px; padding-top: 20px; border-top: 2px solid var(--border-color); display: flex; flex-direction: column; gap: 15px; }
        .row-footer.new-mode-footer { margin-top: 15px; }
        .footer-top { display: flex; justify-content: flex-start; align-items: stretch; gap: 20px; flex-wrap: wrap; }
        .footer-top.hide-totals .footer-totals-group { display: none; }
        .footer-top.hide-totals .notes-section { width: calc(50% - 10px); }
        .footer-top.hide-totals .due-today-group { width: calc(50% - 10px); }
        .footer-top .notes-section { width: calc(50% - 10px); }
        .due-today-group { 
            display: flex; 
            flex-direction: column; 
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 12px 16px;
            background: #f9f9f9;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            width: calc(50% - 10px);
            min-height: 60px;
            box-sizing: border-box;
        }
        .due-today-group:hover {
            border-color: var(--text-secondary);
            background: #f0f0f0;
        }
        .due-today-row {
            display: flex;
            flex-direction: row;
            align-items: flex-start;
            justify-content: center;
            gap: 20px;
        }
        .due-today-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }
        .savings-today-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            padding-left: 20px;
            border-left: 2px solid var(--border-color);
        }
        .due-today-group .totals-group-header { 
            color: var(--text-main); 
            margin-bottom: 0;
            font-size: 0.85rem;
        }
        .due-today-group .total-amount.primary { 
            color: var(--primary-color); 
            font-size: 1.5rem;
            cursor: pointer;
            text-decoration: none;
        }
        .due-today-group .total-amount.savings {
            color: var(--primary-color);
            font-size: 1.5rem;
            font-weight: 800;
        }
        .due-today-explanation {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-style: italic;
            text-align: center;
        }
        
        /* Carrier Comparison and Totals */
        .totals-group { display: flex; flex-direction: column; align-items: center; flex: 1; min-width: 0; position: relative; }
        .totals-group-header { font-size: 0.9rem; text-transform: uppercase; color: var(--text-main); font-weight: 800; margin-bottom: 4px; }
        .totals-comparison-row { display: flex; align-items: center; justify-content: center; gap: 20px; }
        .carrier-comparison { 
            display: flex; 
            align-items: center; 
            gap: 12px;
        }
        .carrier-price-block { display: flex; flex-direction: column; align-items: center; }
        .carrier-price { font-size: 2rem; font-weight: 800; color: var(--text-secondary); }
        .carrier-name { font-size: 0.65rem; color: var(--text-secondary); text-transform: uppercase; font-weight: 600; }
        .vs-indicator { font-size: 0.9rem; color: var(--text-secondary); font-weight: 600; }
        
        .totals-amounts { display: flex; flex-direction: row; gap: 30px; align-items: flex-start; justify-content: center; }
        .totals-amounts.stacked { flex-direction: row; gap: 30px; }
        .total-block { display: flex; flex-direction: column; align-items: center; }
        .total-block.secondary-block { }
        .total-label { font-size: 0.8rem; text-transform: uppercase; color: var(--text-secondary); font-weight: 600; margin-bottom: 4px; }
        .total-label-main { font-size: 0.9rem; text-transform: uppercase; color: var(--text-main); font-weight: 800; margin-bottom: 4px; }
        .total-label-sub { font-size: 0.7rem; text-transform: uppercase; color: var(--text-secondary); font-weight: 600; white-space: nowrap; margin-top: 4px; }
        .total-label-inline { font-size: 0.75rem; color: var(--text-secondary); font-weight: 600; white-space: nowrap; margin-left: 8px; }
        .total-label-below { font-size: 0.7rem; color: var(--text-secondary); font-weight: 600; text-align: center; margin-top: 2px; }
        .total-amount-row { display: flex; align-items: baseline; gap: 6px; }
        .total-amount { font-weight: 800; color: var(--text-main); }
        .total-amount.primary { font-size: 2rem; color: var(--primary-color); }
        .total-amount.secondary { font-size: 1.6rem; color: var(--primary-color); }
        .total-tax { font-size: 0.75rem; color: var(--text-secondary); font-weight: 500; }
        
        /* Carrier display */
        .carrier-display { 
            margin-top: 8px; 
            padding: 10px; 
            background: #f9f9f9; 
            border-radius: 6px; 
            border: 1px solid var(--border-color);
            font-size: 0.85rem;
        }
        .carrier-display .carrier-info-name { font-weight: 700; color: var(--text-main); }
        .carrier-display .carrier-info-price { color: var(--primary-color); font-weight: 600; }
        .carrier-display .carrier-edit-btn { 
            font-size: 0.75rem; 
            color: var(--primary-color); 
            cursor: pointer; 
            text-decoration: underline;
            margin-left: 10px;
        }
        
        /* Quote Header Row - Inline Totals - Centered */
        .quote-header-row {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        .totals-inline-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }
        .totals-header-label {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 8px;
            align-self: center;
            text-align: center;
        }
        .totals-inline-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            width: 100%;
        }
        .carrier-comparison-inline {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 60px;
        }
        .carrier-name-inline {
            font-size: 0.65rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-top: 2px;
            min-height: 16px;
        }
        .carrier-price-inline {
            font-size: 1.5rem;
            font-weight: 800;
            color: #666;
            line-height: 1;
        }
        .vs-inline {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin: 0 8px;
            align-self: center;
            font-weight: 600;
        }
        .totals-prices-inline {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 60px;
        }
        .us-label-header {
            font-size: 0.7rem;
            color: var(--primary-color);
            text-transform: uppercase;
            margin-bottom: 0;
            font-weight: 800;
            letter-spacing: 1px;
            line-height: 1.2;
            height: 14px;
        }
        .totals-amounts-row {
            display: flex;
            align-items: stretch;
            gap: 15px;
            padding: 8px 16px;
        }
        .total-inline-main {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        .total-inline-main .total-inline-amount {
            line-height: 1;
        }
        .total-inline-main .total-inline-label {
            margin-top: 4px;
            min-height: 16px;
        }
        .yearly-savings-wrapper {
            width: 100%;
            display: flex;
            justify-content: center;
            margin-top: 10px;
        }
        .total-inline-amount {
            font-weight: 800;
            line-height: 1;
        }
        .total-inline-amount.primary {
            font-size: 2rem;
            color: var(--primary-color);
        }
        .total-inline-amount.secondary {
            font-size: 1.5rem;
            color: var(--primary-color);
        }
        .tax-text {
            font-size: 0.4em;
            font-weight: 600;
            color: var(--text-secondary);
            margin-left: 4px;
            vertical-align: middle;
        }
        .total-inline-secondary {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        .total-inline-secondary .total-inline-amount {
            line-height: 1;
        }
        .total-inline-secondary .total-inline-label {
            margin-top: 4px;
            min-height: 16px;
        }
        .per-line-text {
            font-size: 0.55em;
            font-weight: 600;
            opacity: 0.8;
            display: block;
            margin-top: 2px;
        }
        .us-label {
            display: none; /* Hidden - now using us-label-header */
        }
        .total-inline-label {
            font-size: 0.65rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-top: 2px;
            min-height: 16px;
        }
        .total-inline-secondary.hidden {
            display: none;
        }
        
        /* Yearly Savings - Magenta Pill */
        .yearly-savings {
            margin-top: 10px;
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--primary-color);
            text-align: center;
            background: #ffeef5;
            padding: 6px 16px;
            border-radius: 20px;
            display: inline-block;
        }
        .yearly-savings.hidden {
            display: none;
        }
        
        /* Add-ons Display beneath Total */
        .addons-display {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-align: center;
            margin-top: 4px;
        }
        .addons-display.hidden {
            display: none;
        }
        
        /* Add-ons Display beneath Plan Name */
        .addons-display-plan {
            font-size: 0.75rem;
            color: #999;
            margin-top: 4px;
            font-style: italic;
        }
        .addons-display-plan.hidden {
            display: none;
        }
        
        /* Steps main row - animated layout stages */
        .steps-container.steps-main-row {
            display: grid !important;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            width: 100%;
            max-width: 100%;
            margin-bottom: 15px;
            transition: grid-template-columns 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        /* Default: Lines visible at 50%, Plan hidden via hidden-step class */
        .steps-container.steps-main-row .step-col-lines {
            display: block;
            opacity: 1;
            pointer-events: auto;
        }
        .steps-container.steps-main-row .step-col-plan.hidden-step {
            display: none;
        }
        .steps-container.steps-main-row .step-col-plan.visible-step {
            display: block;
            animation: fadeIn 0.3s ease forwards;
        }
        .steps-main-row .step-col { 
            width: 100%;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .steps-main-row .stepper-wrapper { 
            max-width: none; 
            height: 48px;
        }
        .steps-main-row .stepper-wrapper .stepper-btn { height: 44px; }
        .steps-main-row .stepper-wrapper .stepper-input { height: 44px; }
        .steps-main-row .plan-select-trigger { 
            height: 48px; 
            line-height: 20px;
            display: flex;
            align-items: center;
        }
        
        /* Row fade animations */
        @keyframes fadeInRow {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeOutRow {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-20px); }
        }
        .calculator-row.fade-in {
            animation: fadeInRow 0.4s ease forwards;
        }
        .calculator-row.fade-out {
            animation: fadeOutRow 0.3s ease forwards;
        }
        
        /* Row Actions - centered title with buttons below */
        .row-actions {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            padding-bottom: 12px;
            margin-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
            gap: 8px;
        }
        .row-actions-left {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
        }
        .row-actions-center {
            display: flex;
            justify-content: center;
            gap: 8px;
        }
        .row-actions-right {
            display: flex;
            justify-content: center;
            gap: 8px;
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transition: max-height 0.3s ease, opacity 0.3s ease, margin-top 0.3s ease;
            margin-top: 0;
        }
        .row-actions-right.expanded {
            max-height: 100px;
            opacity: 1;
            margin-top: 4px;
        }
        .row-actions-toggle {
            background: none;
            border: none;
            cursor: pointer;
            padding: 2px 8px;
            color: var(--text-secondary);
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: color 0.2s ease;
        }
        .row-actions-toggle:hover {
            color: var(--primary-color);
        }
        .row-actions-toggle .chevron {
            transition: transform 0.3s ease;
            font-size: 0.6rem;
        }
        .row-actions-toggle.expanded .chevron {
            transform: rotate(180deg);
        }
        .btn-action {
            padding: 8px 16px;
            font-size: 0.8rem;
            line-height: 1.2;
            box-sizing: border-box;
        }
        .btn-action.confirming {
            background-color: #dc3545 !important;
            color: white !important;
            border-color: #dc3545 !important;
        }
        
        /* Responsive stacking for small screens */
        @media (max-width: 768px) {
            .steps-container.steps-main-row {
                grid-template-columns: 1fr !important;
                gap: 10px;
            }
            .row-header {
                flex-wrap: wrap;
            }
            .row-options {
                order: 1;
                flex: 1 1 100%;
            }
            .row-actions {
                order: 2;
            }
            .quote-header-row {
                flex-direction: column;
            }
            .totals-inline-header {
                align-items: center;
            }
            .totals-header-label {
                align-self: center;
            }
            .totals-inline-wrapper {
                flex-direction: column;
                align-items: center;
                gap: 8px;
            }
            .totals-prices-inline {
                flex-direction: column;
                align-items: center;
                gap: 8px;
            }
            .carrier-comparison-inline {
                align-items: center;
            }
            .totals-amounts-row {
                justify-content: center;
            }
            .steps-container.steps-extras-row {
                grid-template-columns: 1fr !important;
            }
            /* Keep footer-top as flex row on mobile - don't stack */
            .footer-top .notes-section {
                width: 50%;
                flex: 1 1 50%;
            }
            .due-today-group { 
                margin-left: 10px;
                width: 50%;
                flex: 1 1 50%;
            }
        }
        @media (max-width: 480px) {
            .totals-amounts:not(.stacked) { flex-direction: column; gap: 15px; align-items: center; }
            .carrier-comparison { flex-direction: column; padding-right: 0; border-right: none; padding-bottom: 15px; border-bottom: 2px solid var(--border-color); }
            /* Keep footer side by side even on small screens */
        }
        
        /* Notes Section - 50% width on right, matching due-today */
        .notes-section { 
            width: calc(50% - 10px); 
            flex-shrink: 0; 
            display: flex; 
            flex-direction: column;
            box-sizing: border-box;
            min-height: 60px;
        }
        .notes-section.half-width { flex: 1; }
        .notes-section label { display: none; }
        .notes-textarea { 
            width: 100%; 
            flex: 1;
            min-height: 40px; 
            padding: 12px; 
            padding-top: 8px;
            border: 2px solid var(--border-color); 
            border-radius: 8px; 
            font-size: 0.9rem; 
            font-family: BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            resize: vertical; 
            box-sizing: border-box; 
        }
        .notes-textarea::placeholder {
            font-weight: 700;
            font-size: 0.9rem;
            color: var(--text-main);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.6;
        }
        .notes-textarea:focus { outline: none; border-color: var(--primary-color); }
        .notes-display { display: none; }
        
        /* Disclosures Section */
        .disclosures-section {
            display: none; /* Hidden on screen, shown in print */
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
        }
        .disclosure-text {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin: 0 0 5px 0;
            line-height: 1.4;
        }
        .disclosure-credit {
            font-size: 0.65rem;
            color: #999;
            margin: 0;
            font-style: italic;
        }
        
        /* Page Footer Credit - visible on screen */
        .page-footer-credit {
            text-align: center;
            font-size: 0.75rem;
            color: #999;
            font-style: italic;
            padding: 20px 0 60px 0;
            margin-top: 10px;
        }
        
        /* Summaries Row - rebates and discounts side by side, matching heights */
        .summaries-row { display: flex; gap: 15px; flex-wrap: wrap; align-items: stretch; }
        .summaries-row > div { flex: 1; min-width: 200px; max-width: calc(50% - 8px); }
        .summaries-row > div:only-child { max-width: 100%; }
        
        /* Rebate and Discount Summary Styling */
        .rebate-summary, .discount-summary { 
            background: #f9f9f9; 
            border-radius: 8px; 
            padding: 15px; 
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .rebate-summary-content, .discount-summary-content { flex: 1; }
        .rebate-summary-title { 
            font-weight: 700; 
            font-size: 0.9rem; 
            color: var(--text-main); 
            text-transform: uppercase; 
            letter-spacing: 0.5px;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }
        .rebate-summary-item { 
            padding: 6px 0;
            font-size: 0.9rem;
            color: var(--text-main);
            border-left: 3px solid var(--primary-color);
            padding-left: 10px;
            margin-bottom: 4px;
        }
        .rebate-grand-total {
            margin-top: auto;
            padding-top: 10px;
            border-top: 2px solid var(--primary-color);
            font-weight: 800;
            font-size: 1.1rem;
            color: var(--primary-color);
        }
        .discount-summary-item {
            padding: 6px 0;
            font-size: 0.9rem;
            color: var(--text-main);
            border-left: 3px solid var(--primary-color);
            padding-left: 10px;
            margin-bottom: 4px;
        }
        .discount-total {
            margin-top: auto;
            padding-top: 10px;
            border-top: 2px solid var(--primary-color);
            font-weight: 800;
            font-size: 1.1rem;
            color: var(--primary-color);
        }
        .savings-toggle-text {
            cursor: pointer;
            text-decoration: underline;
            text-decoration-style: dotted;
            text-underline-offset: 3px;
        }
        .savings-toggle-text:hover {
            text-decoration-style: solid;
        }

        /* PROTECTION / DISCOUNT MODAL LIST STYLES */
        .prot-list { display: flex; flex-direction: column; gap: 10px; }
        .prot-item { 
            display: flex; 
            flex-direction: column;
            align-items: stretch; 
            padding: 12px; 
            background: #f9f9f9; 
            border-radius: 6px; 
            gap: 10px; 
        }
        .prot-item.disabled { background: #fff; border: 1px dashed #e0e0e0; }
        .prot-item.disabled .prot-label { text-decoration: line-through; color: var(--text-secondary); }
        .prot-label { 
            font-weight: 600; 
            font-size: 0.95rem; 
            word-break: break-word; 
        }
        .prot-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }
        .prot-price-dropdown,
        .prot-price-static {
            flex: 1;
        }
        .prot-price-wrapper { display: flex; align-items: center; flex-shrink: 0; }
        .prot-price-edit { width: auto; min-width: 63px; max-width: 90px; padding: 9px 6px; border: 2px solid var(--border-color); border-radius: 4px; text-align: center; font-weight: 600; font-size: 1.1rem; }
        .prot-price-edit:focus { border-color: var(--primary-color); outline: none; }
        .prot-price-static { font-weight: 600; flex-shrink: 0; }
        .modal-list-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: #f9f9f9; border-radius: 4px; margin-bottom: 5px; }
        .modal-list-text { font-weight: 500; font-size: 0.9rem; }
        .modal-list-action { cursor: pointer; color: var(--danger-color); font-weight: bold; font-size: 1.2rem; padding: 0 5px; }
        
        /* Rebate Pills */
        .rebate-pills { display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; justify-content: center; }
        .rebate-pill { padding: 8px 16px; border-radius: 4px; border: 2px solid var(--border-color); background: white; cursor: pointer; font-weight: 600; font-size: 0.85rem; transition: all 0.2s; }
        .rebate-pill:hover { border-color: var(--primary-color); color: var(--primary-color); }
        .rebate-pill.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }
        
        /* Accessory Preset Pills - Matching Rebate Pills */
        .accessory-pills { display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; justify-content: center; }
        .acc-pill { padding: 8px 16px; border-radius: 4px; border: 2px solid var(--border-color); background: white; cursor: pointer; font-weight: 600; font-size: 0.85rem; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
        .acc-pill:hover { border-color: var(--primary-color); color: var(--primary-color); }
        .acc-pill.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }
        
        /* Hamburger Menu */
        .hamburger-btn { display: flex; flex-direction: column; justify-content: center; align-items: center; width: 40px; height: 40px; background: white; border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; gap: 4px; transition: all 0.2s; }
        .hamburger-btn:hover { border-color: var(--primary-color); }
        .hamburger-btn span { display: block; width: 18px; height: 2px; background: var(--text-main); border-radius: 1px; transition: all 0.2s; }
        .hamburger-btn:hover span { background: var(--primary-color); }
        
        /* Compare Quotes Header Button */
        .compare-quotes-header-btn { display: flex; justify-content: center; align-items: center; width: 40px; height: 40px; background: white; border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s; padding: 0; }
        .compare-quotes-header-btn:hover { border-color: var(--primary-color); }
        .compare-quotes-header-btn:hover svg { stroke: var(--primary-color); }
        .compare-quotes-header-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .compare-quotes-header-btn:disabled:hover { border-color: var(--border-color); }
        .compare-quotes-header-btn:disabled:hover svg { stroke: var(--text-main); }
        
        /* Add button - same size as hamburger */
        .add-btn { 
            width: 40px !important; 
            height: 40px !important; 
            padding: 0 !important; 
            font-size: 1.5rem !important; 
            border-radius: 8px !important;
            min-width: 40px !important;
        }
        
        /* Scan button */
        .scan-btn {
            width: 40px !important;
            height: 40px !important;
            padding: 0 !important;
            border-radius: 8px !important;
            min-width: 40px !important;
            display: flex !important;
            align-items: center;
            justify-content: center;
        }
        .scan-btn svg {
            width: 20px;
            height: 20px;
        }
        
        /* Print Barcode - hidden on screen */
        .print-qr-wrapper {
            display: none;
        }
        .print-qr-canvas {
            text-align: center;
        }
        .print-qr-canvas canvas {
            max-width: 100%;
            height: auto;
        }
        
        /* Contact header row - hidden on screen */
        .contact-header-row {
            display: none;
        }
        
        /* Scanner Modal */
        #scan-modal .modal-content { max-width: 450px; }
        .scan-result { margin-top: 15px; padding: 15px; background: #f0fff4; border: 1px solid #10b981; border-radius: 8px; text-align: center; display: none; }
        .scan-result.error { background: #fef2f2; border-color: #ef4444; }
        .scan-result.success { display: block; }
        
        /* Settings Modal (Rules) - Converted from sidebar to popup */
        .settings-sidebar { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9); width: 520px; max-width: 90vw; max-height: 85vh; background: white; box-shadow: 0 10px 40px rgba(0,0,0,0.25); z-index: 1001; transition: transform 0.2s ease, opacity 0.2s ease; overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch; -webkit-tap-highlight-color: transparent; border-radius: 12px; opacity: 0; visibility: hidden; pointer-events: none; }
        .settings-sidebar.open { transform: translate(-50%, -50%) scale(1); opacity: 1; visibility: visible; pointer-events: auto; }
        .settings-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 1000; opacity: 0; visibility: hidden; pointer-events: none; transition: opacity 0.2s ease, visibility 0.2s ease; -webkit-tap-highlight-color: transparent; }
        .settings-overlay.open { opacity: 1; visibility: visible; pointer-events: auto; }
        .settings-header { padding: 20px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: flex-start; background: white; border-radius: 12px 12px 0 0; }
        .settings-header-content { display: flex; flex-direction: column; gap: 4px; }
        .settings-header h3 { margin: 0; font-size: 1.2rem; color: var(--text-main); font-weight: 800; }
        .settings-header-subtitle { font-size: 0.75rem; color: var(--text-secondary); font-style: italic; }
        .settings-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-secondary); padding: 0; line-height: 1; }
        .settings-close:hover { color: var(--primary-color); }
        .settings-body { padding: 20px; padding-bottom: 30px; }
        .settings-section { margin-bottom: 25px; padding: 15px; background: #f9f9f9; border-radius: 8px; border: 1px solid var(--border-color); transition: transform 0.2s, box-shadow 0.2s; }
        .settings-section.draggable-section { cursor: default; }
        .settings-section.dragging { opacity: 0.8; background: #ffeef5; border: 2px solid var(--primary-color); transform: scale(1.02); box-shadow: 0 8px 25px rgba(226, 0, 116, 0.3); z-index: 100; }
        .settings-section.drag-over { border-color: var(--primary-color); background: #fff0f7; }
        .settings-section-title { font-weight: 700; font-size: 0.85rem; color: var(--text-main); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #ddd; display: flex; align-items: center; gap: 8px; }
        .drag-handle { cursor: grab; color: #999; font-size: 1rem; padding: 2px 4px; border-radius: 4px; transition: all 0.2s; user-select: none; -webkit-user-select: none; touch-action: none; -webkit-touch-callout: none; }
        .drag-handle:hover { color: var(--primary-color); background: #ffeef5; }
        .drag-handle:active { cursor: grabbing; }
        .settings-row { display: flex; gap: 8px; align-items: center; margin-bottom: 10px; }
        .settings-input { flex: 1; padding: 10px 12px; border: 2px solid var(--border-color); border-radius: 6px; font-size: 0.95rem; min-width: 0; }
        .settings-input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(226, 0, 116, 0.1); }
        .settings-input[type="number"] { flex: 1; width: auto; text-align: center; padding: 10px 8px; min-width: 0; }
        .settings-select { 
            flex: 1; 
            padding: 12px 10px; 
            border: 2px solid var(--border-color); 
            border-radius: 6px; 
            font-size: 0.9rem; 
            background: white; 
            cursor: pointer; 
            min-width: 0;
            min-height: 44px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            color: var(--text-main);
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 16px;
            padding-right: 32px;
        }
        .settings-select:focus { outline: none; border-color: var(--primary-color); }
        .settings-select option { color: var(--text-main); }
        .settings-submenu { display: flex; flex-direction: column; gap: 10px; }
        .settings-submenu-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: white; border: 1px solid var(--border-color); border-radius: 6px; }
        .settings-submenu-item span { font-weight: 500; font-size: 0.9rem; color: var(--text-main); }
        .settings-btn { padding: 12px 20px; background: var(--primary-color); color: white; border: none; border-radius: 6px; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px; font-size: 0.85rem; transition: all 0.2s; }
        .settings-btn:hover { background: var(--primary-hover); transform: translateY(-1px); }
        .adjustment-list { margin-top: 15px; position: relative; }
        .adjustment-list.edit-mode .adjustment-item { animation: shake 0.15s infinite alternate; cursor: move; }
        .adjustment-list.edit-mode .adjustment-item:nth-child(odd) { animation-delay: 0.05s; }
        .adjustment-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: white; border-radius: 6px; margin-bottom: 8px; border: 1px solid var(--border-color); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; user-select: none; -webkit-user-select: none; touch-action: none; -webkit-touch-callout: none; }
        .adjustment-item.held { transform: scale(1.03); box-shadow: 0 4px 15px rgba(0,0,0,0.15); z-index: 10; }
        .adjustment-item.dragging { opacity: 0.8; background: #ffeef5; border: 2px solid var(--primary-color); transform: scale(1.05); box-shadow: 0 8px 25px rgba(226, 0, 116, 0.3); z-index: 100; }
        .adjustment-item.drag-over { border-color: var(--primary-color); background: #ffeef5; transform: scale(1.02); }
        .adjustment-item-drag-handle { display: none; }
        .adjustment-item-content { flex: 1; display: flex; align-items: center; }
        .adjustment-item-text { font-size: 0.9rem; font-weight: 500; }
        .adjustment-item-remove { background: none; border: none; color: var(--danger-color); font-size: 1.2rem; cursor: pointer; font-weight: bold; padding: 5px 10px; }
        .adjustment-item-remove:hover { transform: scale(1.2); }
        .adjustment-list.edit-mode .adjustment-item-remove { display: none; }
        .adjustment-list-footer { display: flex; justify-content: flex-end; margin-top: 10px; }
        .done-editing-btn { display: none; padding: 8px 16px; background: var(--primary-color); color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; }
        .adjustment-list.edit-mode + .adjustment-list-footer .done-editing-btn { display: block; }
        
        @keyframes shake {
            0% { transform: rotate(-0.5deg); }
            100% { transform: rotate(0.5deg); }
        }
        
        /* Discount Button Style in Modal */
        .discount-btn-option { 
            padding: 12px 16px; 
            background: white; 
            border: 2px solid var(--border-color); 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: 600; 
            font-size: 0.9rem; 
            margin-bottom: 8px; 
            display: block; 
            width: 100%; 
            text-align: left; 
            transition: all 0.2s;
            color: var(--text-main);
            -webkit-text-fill-color: var(--text-main);
            -webkit-tap-highlight-color: transparent;
            -webkit-appearance: none;
        }
        .discount-btn-option:hover { 
            border-color: var(--primary-color); 
            background: #ffeef5; 
            color: var(--primary-color); 
            -webkit-text-fill-color: var(--primary-color);
        }
        
        /* Disabled button state */
        .btn-disabled { opacity: 0.5; pointer-events: none; cursor: not-allowed; }
        
        /* Row Contact Info (hidden on screen, visible in print) */
        .row-contact-info { display: none; }
        .contact-quote-id { display: none; }

        /* BTS AND REBATES */
        .bts-container, .rebates-container, .discounts-container, .accessories-container { display: flex; flex-direction: column; gap: 8px; }
        .item-pill { display: flex; justify-content: space-between; align-items: center; background: #ffeef5; padding: 10px 12px; border-radius: 4px; border: 1px solid var(--primary-light); min-height: 44px; box-sizing: border-box; }
        .item-text { 
            font-weight: 600; 
            font-size: 0.85rem; 
            color: #E20074 !important; 
            -webkit-text-fill-color: #E20074 !important; 
            text-decoration: none !important;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            line-height: 1.5;
        }
        .remove-x { 
            padding: 4px 10px; 
            font-size: 0.75rem; 
            border-radius: 4px; 
            border: 1px solid transparent; 
            cursor: pointer; 
            text-transform: uppercase; 
            font-weight: 700; 
            background-color: #ffeef5; 
            color: var(--primary-color); 
            margin-left: 10px; 
            line-height: 1.5;
        }
        .remove-x:hover { background-color: #ffdceb; }
        
        /* Connected Device Pill with submenu */
        .cd-pill { align-items: center; }
        .cd-pill-content { display: flex; flex-direction: column; flex: 1; line-height: 1.5; }
        .cd-units-list { display: flex; flex-direction: column; gap: 0; }
        .cd-unit-line { display: flex; flex-direction: column; align-items: flex-start; gap: 0; }
        .cd-device-submenu { font-size: 0.75rem; color: var(--text-main); font-weight: 500; margin-left: 10px; margin-top: 2px; display: block; line-height: 1.5; }
        .cd-device-submenu::before { content: ' '; color: var(--primary-color); font-weight: 700; }
        .cd-device-name { font-weight: 600; }
        .cd-promo-line { font-size: 0.65rem; color: var(--text-secondary); margin-left: 22px; margin-top: 1px; line-height: 1.5; }
        .cd-pill-actions { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
        
        .manual-discount-wrapper { 
            display: flex; 
            gap: 0; 
            align-items: center; 
            justify-content: space-between;
            padding: 10px 12px; 
            background: #ffeef5; 
            border-radius: 4px; 
            border: 1px solid var(--primary-light);
            min-height: 44px;
            box-sizing: border-box;
        }
        .manual-discount-screen {
            display: flex;
            gap: 0;
            align-items: center;
            flex: 1;
        }
        .manual-discount-print {
            display: none; /* Hidden on screen, shown in print */
        }
        .manual-discount-wrapper input[type="text"],
        .manual-discount-wrapper input[type="number"] {
            padding: 0 8px;
            border: none;
            background: transparent;
            font-size: 0.85rem;
            font-family: inherit;
            color: var(--primary-color);
            font-weight: 600;
            line-height: 1.5;
            height: auto;
        }
        .manual-discount-wrapper input::placeholder {
            color: var(--primary-color);
            opacity: 0.6;
        }
        .manual-discount-wrapper input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }
        .discount-name { flex: 1; min-width: 100px; }
        .manual-discount-wrapper .bts-price { flex: 0 0 80px; min-width: 80px; text-align: right; }

        /* Voice Line Items */
        .voice-lines-list {
            margin-top: 12px;
        }
        .voice-line-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #ffeef5;
            padding: 10px 12px;
            border-radius: 4px;
            border: 1px solid var(--primary-light);
            margin-bottom: 8px;
        }
        .voice-line-details {
            flex: 1;
        }
        .voice-line-pricing {
            font-weight: 600;
            font-size: 0.85rem;
            color: #E20074;
        }
        .voice-line-price-original {
            text-decoration: line-through;
            color: var(--primary-color);
            margin-right: 4px;
        }
        .voice-line-price-discounted {
            color: var(--primary-color);
            font-weight: 700;
        }
        
        /* BOGO Toggle Buttons */
        .btn-toggle {
            background-color: white;
            border: 2px solid var(--border-color);
            color: var(--text-main);
            transition: all 0.2s;
        }
        .btn-toggle:not(:disabled):hover {
            border-color: var(--primary-light);
        }
        .btn-toggle.active {
            border-color: var(--primary-color);
            background-color: white;
            color: var(--primary-color);
        }
        .btn-toggle:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Manual Price Wrapper with inline button */
        .manual-price-wrapper {
            position: relative;
            width: 100%;
        }
        .manual-price-wrapper .manual-price-input {
            width: 100%;
            padding-right: 150px; /* Space for the button */
        }
        .manual-price-display {
            display: none;
        }
        .manual-addons-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            padding: 8px 14px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background-color: white;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            color: var(--text-main);
            transition: all 0.2s;
        }
        .manual-addons-btn:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
        
        /* Hide number input spinner arrows */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        
        /* Options text styling */
        .options-text {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            margin-top: 8px;
            padding: 6px 12px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            display: block;
            width: 100%;
            box-sizing: border-box;
        }
        .options-text:hover {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .bts-stepper { display: flex; border: 1px solid #ddd; border-radius: 4px; overflow: hidden; width: 90px; height: 38px; }
        .bts-stepper .stepper-btn { height: 38px; width: 30px; }
        .bts-stepper .stepper-input { height: 38px; padding: 0 !important; font-size: 1rem; }

        /* TIMELINE */
        .timeline-section { background-color: #fff; border: 2px dashed #e6e6e6; border-radius: 8px; padding: 12px; display: none; }
        .timeline-section.active { display: block; animation: fadeIn 0.4s ease; }
        .timeline-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none; }
        .timeline-header:hover .applied-bill-label { color: var(--primary-hover); }
        .applied-bill-label { font-weight: 700; color: var(--primary-color); font-size: 1.1rem; display: flex; align-items: center; gap: 8px; transition: color 0.2s; }
        .collapse-icon { 
            display: inline-block;
            width: 8px; 
            height: 8px; 
            border-top: 2px solid currentColor; 
            border-right: 2px solid currentColor; 
            transform: rotate(45deg); 
            transition: transform 0.2s; 
            margin-right: 4px;
        }
        .timeline-section.expanded .collapse-icon { transform: rotate(135deg); }
        .timeline-body { display: none; margin-top: 12px; padding-top: 12px; border-top: 1px dashed #e6e6e6; animation: fadeIn 0.3s ease; }
        .timeline-section.expanded .timeline-body { display: block; }
        .timeline-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .timeline-toggle-wrapper { display: flex; align-items: center; gap: 10px; }
        .timeline-toggle-wrapper.hidden { display: none !important; }
        .timeline-toggle-label { font-size: 0.85rem; font-weight: 600; color: var(--text-secondary); }
        
        /* Timeline Protection Slider - Expanding Horizontal Style */
        .timeline-prot-slider { position: relative; display: inline-flex; background: #f0f0f0; border-radius: 20px; padding: 3px; overflow: hidden; transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; }
        .timeline-prot-slider-option { padding: 5px 12px; font-size: 0.75rem; font-weight: 600; border-radius: 16px; cursor: pointer; transition: all 0.2s ease; color: var(--text-secondary); white-space: nowrap; user-select: none; opacity: 0; max-width: 0; padding-left: 0; padding-right: 0; overflow: hidden; pointer-events: none; }
        .timeline-prot-slider-option.active { background: #ffeef5; color: var(--primary-color); opacity: 1; max-width: 100px; padding: 5px 12px; pointer-events: auto; }
        .timeline-prot-slider.open .timeline-prot-slider-option { opacity: 1; max-width: 100px; padding: 5px 12px; pointer-events: auto; }
        .timeline-prot-slider.open .timeline-prot-slider-option:hover:not(.active) { background: rgba(0,0,0,0.08); }
        .timeline-prot-slider .timeline-prot-slider-option + .timeline-prot-slider-option { margin-left: 0; }
        .timeline-prot-slider.open .timeline-prot-slider-option + .timeline-prot-slider-option { margin-left: 2px; }
        .switch-sm { position: relative; display: inline-block; width: 44px; height: 24px; flex-shrink: 0; }
        .switch-sm input { opacity: 0; width: 0; height: 0; }
        .slider-sm { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #e0e0e0; transition: .4s; border-radius: 24px; }
        .slider-sm:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider-sm { background-color: var(--primary-color); }
        input:checked + .slider-sm:before { transform: translateX(20px); }
        .timeline-container { display: flex; justify-content: space-between; position: relative; margin-top: 5px; padding: 0 10px; overflow-x: auto; padding-bottom: 5px; }
        .timeline-container::before { content: ''; position: absolute; top: 22px; left: 30px; right: 30px; height: 2px; background-color: #e6e6e6; z-index: 0; }
        .timeline-point { position: relative; z-index: 1; display: flex; flex-direction: column; align-items: center; min-width: 80px; }
        .tp-label { font-size: 0.75rem; text-transform: uppercase; color: var(--text-secondary); font-weight: 700; margin-bottom: 5px; }
        .tp-dot { width: 14px; height: 14px; background-color: white; border: 3px solid var(--primary-color); border-radius: 50%; margin-bottom: 5px; box-shadow: 0 0 0 4px #fff; }
        .tp-dot.free { border-color: var(--success-color); background-color: var(--success-color); }
        .tp-cost { font-weight: 700; color: var(--text-main); font-size: 0.9rem; }
        .tp-cost.free { color: var(--success-color); }

        /* MODALS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; pointer-events: none; transition: opacity 0.2s ease, visibility 0.2s ease; backdrop-filter: blur(4px); -webkit-tap-highlight-color: transparent; }
        .modal-overlay.open { opacity: 1; visibility: visible; pointer-events: auto; }
        .modal-content { background-color: white; padding: 25px; border-radius: 8px; width: 90%; max-width: 450px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); transform: translateY(0); max-height: 85vh; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .modal-overlay.open .modal-content { transform: translateY(0); }
        /* iPad/tablet specific modal fix */
        @media (min-width: 768px) and (max-width: 1024px) {
            .modal-content { max-height: 75vh; padding: 20px; }
            .modal-body { max-height: none !important; overflow: visible !important; }
        }
        .modal-body .input-group { margin-bottom: 15px; }
        .modal-footer { margin-top: 25px; display: flex; justify-content: flex-end; gap: 10px; }
        .radio-group { display: flex; gap: 20px; margin-top: 5px; }
        .radio-group label { display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .hidden { display: none !important; }

        /* Connected Device Modal Tabs - Matching Plan Modal Style */
        .cd-tabs-wrapper { 
            position: relative; 
            margin-bottom: 10px; 
            overflow: hidden;
            flex-shrink: 0;
        }
        .cd-tabs-container { 
            display: flex; 
            overflow-x: auto; 
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
            gap: 0;
            border-bottom: 2px solid var(--border-color);
            padding: 0 30px;
        }
        .cd-tabs-container::-webkit-scrollbar { display: none; }
        .cd-tabs { display: flex; gap: 0; margin-bottom: 15px; border-bottom: 2px solid var(--border-color); flex-wrap: wrap; }
        .cd-tab { 
            flex: 0 0 calc(33.33% - 2px); 
            min-width: calc(33.33% - 2px);
            padding: 10px 6px; 
            text-align: center; 
            cursor: pointer; 
            font-weight: 700; 
            font-size: 0.75rem; 
            color: var(--text-secondary); 
            border-bottom: 3px solid transparent; 
            margin-bottom: -2px;
            transition: all 0.2s; 
            white-space: nowrap;
            background: white;
        }
        .cd-tab:hover { color: var(--primary-color); background: #ffeef5; }
        .cd-tab.active { color: var(--primary-color); border-bottom-color: var(--primary-color); background: white; }
        .cd-tabs-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 26px;
            height: 26px;
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: all 0.2s;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        .cd-tabs-arrow:hover { border-color: var(--primary-color); color: var(--primary-color); background: #ffeef5; }
        .cd-tabs-arrow.left { left: 0; }
        .cd-tabs-arrow.right { right: 0; }
        .cd-tabs-arrow.hidden { opacity: 0.3; pointer-events: none; }
        .cd-tabs-arrow .arrow-left,
        .cd-tabs-arrow .arrow-right {
            width: 7px;
            height: 7px;
            border-top: 2px solid currentColor;
            border-right: 2px solid currentColor;
        }
        .cd-tabs-arrow .arrow-left { transform: rotate(-135deg); margin-left: 2px; }
        .cd-tabs-arrow .arrow-right { transform: rotate(45deg); margin-right: 2px; }
        
        .cd-plan-list { max-height: 250px; overflow-y: auto; border: 1px solid #eee; border-radius: 4px; }
        .cd-plan-option { padding: 12px 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; display: flex; justify-content: space-between; align-items: flex-start; gap: 8px; }
        .cd-plan-option:hover { background-color: #ffeef5; }
        .cd-plan-name { font-weight: 600; flex: 1; min-width: 0; word-wrap: break-word; }
        .cd-plan-price { font-size: 0.9rem; color: var(--text-secondary); flex-shrink: 0; text-align: right; }
        .cd-plan-price .original { text-decoration: line-through; color: #999; margin-right: 8px; }
        .cd-plan-price .discounted { color: var(--primary-color); font-weight: 700; }
        .cd-plan-price .beyond-price { color: var(--success-color); font-weight: 700; }
        
        /* MP (Magenta Pulse) Links */
        .mp-links-container { display: flex; flex-direction: column; gap: 0px; }
        .mp-links-container .mp-link { font-size: 0.7rem; line-height: 1.3; }
        .mp-link { font-size: 0.75rem; color: var(--primary-color); text-decoration: none; font-weight: 600; }
        .mp-link:hover { text-decoration: underline; }
        .mp-link-small { font-size: 0.65rem; color: var(--primary-color); text-decoration: none; display: inline-block; margin-top: 2px; padding: 1px 0; width: fit-content; }
        .mp-link-small:hover { text-decoration: underline; }
        /* Modal header with close button - flex row for proper alignment */
        .modal-header { margin-bottom: 20px; display: flex; justify-content: space-between; align-items: flex-start; }
        .modal-header h3 { margin: 0; font-size: 1.25rem; color: var(--primary-color); font-weight: 800; }
        .modal-header-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-secondary); padding: 0; line-height: 1; }
        .modal-header-close:hover { color: var(--primary-color); }
        /* Modal header with subtitle (column layout) - for CD modal with MP link */
        .modal-header.with-subtitle { flex-direction: column; gap: 2px; margin-bottom: 8px; }

        /* Connected Device Detail Panel - Fixed Layout */
        .cd-detail-panel { display: none; border-top: 1px solid #eee; padding-top: 10px; margin-top: 10px; }
        .cd-detail-panel.active { display: block; }
        .cd-detail-fields { display: flex; flex-direction: column; gap: 8px; }
        .cd-detail-fields .input-group { margin-bottom: 0; }
        .cd-selected-plan { background: #ffeef5; padding: 8px 10px; border-radius: 6px; margin-bottom: 10px; font-weight: 600; color: var(--primary-color); font-size: 0.9rem; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px; }
        .cd-selected-plan:hover { background: #ffe0ee; }
        .cd-selected-plan::before { content: ' '; font-size: 0.85rem; }

        /* CD Modal - proper sizing and layout */
        #cd-modal .modal-content {
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        #cd-modal .modal-body {
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        #cd-modal .cd-scroll-area {
            flex: 1;
            min-height: 100px;
            overflow-y: auto;
        }
        #cd-modal #cd-plan-list {
            max-height: none;
            border: 1px solid #eee;
            border-radius: 4px;
        }
        /* When detail panel is active, hide plan list and tabs */
        #cd-modal .modal-body.detail-active #cd-plan-list {
            display: none !important;
        }
        #cd-modal .modal-body.detail-active .cd-tabs-wrapper {
            display: none !important;
        }
        #cd-modal .modal-body.detail-active #cd-search-box {
            display: none !important;
        }
        /* When detail panel is active, scroll area becomes auto-height */
        #cd-modal .modal-body.detail-active .cd-scroll-area {
            flex: 0 0 auto;
            overflow-y: visible;
            min-height: auto;
        }
        /* Ensure footer stays at bottom */
        #cd-modal .modal-footer {
            flex-shrink: 0;
            margin-top: auto;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        /* Remove footer border when detail panel is active */
        #cd-modal .modal-body.detail-active + .modal-footer {
            border-top: none;
        }

        @media (max-width: 768px) {
            body { padding: 10px; }
            header { flex-direction: column; gap: 15px; margin-bottom: 20px; }
            .toggle-container { position: relative; left: auto; top: auto; transform: none; }
            .steps-container { gap: 15px; grid-template-columns: 1fr !important; }
            .stepper-wrapper { max-width: 100%; }
            .calculator-row { padding: 15px; }
            .total-amount.primary { font-size: 2rem; }
            .bts-list-item, .rebate-list-item, .discount-list-item, .manual-discount-wrapper { flex-wrap: wrap; }
            .bts-select, .rebate-name, .discount-select, .discount-name { min-width: 100%; }
            .bts-price, .rebate-val { flex-grow: 1; }
        }
        
        /* Plan Benefits Container (hidden by default, print only) */
        .plan-benefits-container { display: none; }
        .plan-benefits-page { 
            display: none;
            width: 100%;
            height: 100vh;
            page-break-before: always;
            page-break-after: always;
            page-break-inside: avoid;
        }
        .plan-benefits-page img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        /* PRINT STYLES */
        @media print {
            .hidden { display: none !important; }
            @page { 
                margin: 0.5in; 
            }
            body { 
                background: white; 
                padding: 0; 
                font-size: 11px; 
                color: #000; 
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact;
                overflow: visible;
                height: auto;
                orphans: 3;
                widows: 3;
            }
            .container { 
                max-width: 100%; 
                width: 100%; 
                padding: 0; 
                margin: 0;
                padding-bottom: 0 !important;
                overflow: visible;
                height: auto;
            }
            header, h1, .toggle-container, .btn-remove, .device-actions, #add-row-btn, #export-pdf, .timeline-toggle-wrapper, button, .btn, .step-number, .collapse-icon, .stepper-btn, .modal-overlay, .settings-sidebar, .settings-overlay, .hamburger-btn, #compare-section, .compare-link-wrapper, .quote-title-input, .compare-label { display: none !important; }
            #print-info-container { display: none !important; }
            .options-hint-text { display: none !important; }
            .savings-toggle-text { text-decoration: none !important; }
            .app-container { 
                display: block !important;
                overflow: visible;
                height: auto;
                margin: 0;
                padding: 0;
            }
            .step-col button { display: none !important; }
            
            /* Plan Benefits Pages in Print */
            .plan-benefits-container { 
                display: none !important;
                height: 0 !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            .plan-benefits-page { 
                display: block !important;
                width: 100%;
                height: auto;
                page-break-before: always;
                page-break-inside: avoid;
                page-break-after: auto;
                margin: 0;
                padding: 0;
            }
            .plan-benefits-page.page-break-after { page-break-after: always !important; }
            .plan-benefits-page.hidden { display: none !important; }
            .plan-benefits-page img {
                width: 100%;
                height: auto;
                max-height: 100vh;
                object-fit: contain;
                display: block;
            }
            
            /* Print Benefits Comparison Table */
            .print-benefits-comparison {
                width: 100%;
                padding: 0;
            }
            .print-benefits-comparison .compare-dropdowns {
                display: grid;
                grid-template-columns: 33.333% 33.333% 33.334%;
                gap: 0;
                margin-bottom: 0;
                border: 1px solid #000;
                border-bottom: none;
                border-radius: 0;
                background: white;
                align-items: stretch;
            }
            .print-benefits-comparison .compare-dropdown-wrapper {
                display: flex;
                flex-direction: column;
                border-right: 1px solid #000;
            }
            .print-benefits-comparison .compare-dropdown-wrapper:last-child {
                border-right: none;
            }
            /* White border-right when first header is premium */
            .print-benefits-comparison .compare-dropdown-wrapper:has(.compare-plan-name-header.premium) {
                border-right-color: #fff;
            }
            /* White border between headers when second header is premium */
            .print-benefits-comparison .compare-dropdown-wrapper:last-child:has(.compare-plan-name-header.premium) {
                border-left: 1px solid #fff;
                margin-left: -1px;
            }
            .print-benefits-comparison .compare-dropdown-wrapper.spacer {
                background: #000 !important;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 10px;
                border-right: 1px solid #000;
                border-bottom: 1px solid #fff;
                color: white;
                font-size: 1.6rem;
                font-weight: 800;
                letter-spacing: 3px;
            }
            /* White border for premium plan wrappers in print */
            .print-benefits-comparison .compare-dropdown-wrapper:has(.compare-plan-name-header.premium) {
                border-bottom: 1px solid #fff;
            }
            .print-benefits-comparison .compare-plan-name-header {
                width: 100%;
                height: 100%;
                padding: 10px;
                font-size: 0.95rem;
                font-weight: 800;
                background: white;
                color: #000;
                text-align: center;
                display: flex;
                justify-content: center;
                align-items: center;
                min-height: 45px;
                flex: 1;
            }
            .print-benefits-comparison .compare-plan-name-header.premium {
                background: var(--primary-color);
                color: white;
            }
            /* White border below premium headers in print */
            .print-benefits-comparison .compare-dropdown-wrapper:has(.compare-plan-name-header.premium) {
                border-bottom: 1px solid #fff;
            }
            /* Black border below non-premium (white) headers in print */
            .print-benefits-comparison .compare-dropdown-wrapper:has(.compare-plan-name-header:not(.premium)) {
                border-bottom: 1px solid #000;
            }
            .print-benefits-comparison .comparison-table {
                border: 1px solid #000;
                border-top: none !important;
                border-radius: 0;
                margin-top: 0;
            }
            .print-benefits-comparison .comparison-row {
                display: grid;
                grid-template-columns: 33.333% 33.333% 33.334%;
            }
            .print-benefits-comparison .comparison-benefit-name {
                padding: 6px 10px;
                font-weight: 800;
                color: #fff;
                background: #000;
                border-right: 1px solid #000;
                border-bottom: 1px solid #fff;
                text-align: center;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                min-height: 38px;
                font-size: 0.8rem;
            }
            .print-benefits-comparison .comparison-benefit-value {
                padding: 6px 10px;
                text-align: center;
                font-weight: 700;
                background: white;
                border-right: 1px solid #000;
                border-bottom: 1px solid #000;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                min-height: 38px;
                font-size: 0.75rem;
            }
            /* First value cell (adjacent to black name column) gets white left border */
            .print-benefits-comparison .comparison-benefit-value:first-of-type {
                border-left: 1px solid #fff;
            }
            .print-benefits-comparison .comparison-benefit-value:last-child {
                border-right: none;
            }
            .print-benefits-comparison .comparison-benefit-value.merged {
                grid-column: 2 / 4;
                border-right: none;
            }
            .print-benefits-comparison .comparison-benefit-value.included:not(.merged) {
                color: white;
                background: var(--primary-color);
                border-right: 1px solid #fff;
                border-bottom: 1px solid #fff;
            }
            .print-benefits-comparison .comparison-benefit-value.included:not(.merged):last-child {
                border-right: none;
            }
            .print-benefits-comparison .comparison-row:last-child .comparison-benefit-name {
                border-radius: 0;
                border-bottom: none;
            }
            .print-benefits-comparison .comparison-row:last-child .comparison-benefit-value:last-child {
                border-radius: 0;
            }
            .print-benefits-comparison .comparison-row:last-child .comparison-benefit-value {
                border-bottom: none;
            }
            .print-benefits-comparison .benefit-name-main {
                display: block;
                font-weight: 800;
                line-height: 1.2;
            }
            .print-benefits-comparison .benefit-name-sub {
                display: block;
                font-size: 0.5rem;
                font-weight: 700;
                color: #fff;
                margin-top: 1px;
                line-height: 1.1;
            }
            .print-benefits-comparison .benefit-main {
                display: block;
                font-weight: 800;
                line-height: 1.2;
            }
            .print-benefits-comparison .benefit-sub {
                display: block;
                font-size: 0.5rem;
                color: #262626;
                font-weight: 700;
                margin-top: 1px;
                line-height: 1.1;
            }
            .print-benefits-comparison .comparison-benefit-value.included:not(.merged) .benefit-sub {
                color: #fff;
            }
            
            /* Sam's Club Member Benefits Section - Print */
            .print-benefits-comparison .sams-club-benefits {
                margin-top: 8px;
                width: 100%;
                display: block !important;
            }
            .print-benefits-comparison .sams-club-title {
                text-align: center;
                font-size: 1.05rem;
                font-weight: 800;
                color: #000;
                margin-bottom: 5px;
            }
            .print-benefits-comparison .sams-club-grid {
                display: grid;
                grid-template-columns: 1fr 1fr 1fr;
                gap: 0;
                overflow: hidden;
            }
            .print-benefits-comparison .sams-club-card {
                display: flex;
                flex-direction: column;
            }
            .print-benefits-comparison .sams-club-card-top {
                background: var(--primary-color);
                padding: 5px 4px;
                text-align: center;
                font-size: 0.7rem;
                font-weight: 700;
                color: #fff;
                line-height: 1.25;
                flex: 1;
                display: flex;
                flex-direction: column;
                justify-content: center;
                min-height: 45px;
                border-right: 1px solid #fff;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .print-benefits-comparison .sams-club-card:last-child .sams-club-card-top {
                border-right: none;
            }
            .print-benefits-comparison .sams-club-card-bottom {
                background: #fff;
                padding: 5px 4px;
                text-align: center;
                font-size: 0.75rem;
                font-weight: 800;
                color: var(--primary-color);
                border: 1px solid #000;
                margin-left: -1px;
            }
            .print-benefits-comparison .sams-club-card:first-child .sams-club-card-bottom {
                margin-left: 0;
            }
            .print-benefits-comparison .sams-club-plus-row {
                display: block;
                margin-top: 3px;
                position: relative;
            }
            .print-benefits-comparison .sams-club-plus-arrow {
                position: absolute;
                left: calc(16.666% - 38px);
                top: 0;
                width: 38px;
                display: flex;
                align-items: flex-start;
                justify-content: center;
            }
            .print-benefits-comparison .sams-club-plus-arrow svg {
                width: 38px;
                height: 25px;
                overflow: visible;
            }
            .print-benefits-comparison .sams-club-plus-note {
                display: block;
                width: 100%;
                font-size: 0.7rem;
                font-weight: 700;
                color: #000;
                padding: 2px 5px;
                text-align: center;
            }
            .print-benefits-comparison .sams-club-plus-note .every-year {
                color: var(--primary-color);
                font-weight: 800;
            }
            .print-benefits-comparison .sams-club-fine-print {
                font-size: 0.55rem;
                color: #000;
                text-align: center;
                margin-top: 1px;
                font-weight: 600;
            }
            
            .calculator-row { 
                background: white; 
                box-shadow: none; 
                border: 1px solid #ccc; 
                border-radius: 0; 
                margin-bottom: 15px; 
                padding: 15px; 
                break-inside: avoid; 
                page-break-inside: avoid; 
                page-break-after: auto;
                overflow: visible;
                height: auto;
                position: relative;
            }
            .calculator-row.page-break-after { page-break-after: always !important; margin-bottom: 0; }
            .calculator-row[data-row-index="1"][data-mode="existing"] { border-left: 1px solid #ccc; }
            
            #rows-container {
                height: auto !important;
                overflow: visible !important;
                margin: 0;
                padding: 0;
                min-height: 0 !important;
            }
            
            /* In print, show all rows regardless of carousel mode */
            #rows-container.carousel-mode {
                overflow: visible !important;
                height: auto !important;
                min-height: 0 !important;
                position: static !important;
            }
            #rows-container.carousel-mode .calculator-row {
                position: relative !important;
                opacity: 1 !important;
                visibility: visible !important;
                transform: none !important;
                -webkit-transform: none !important;
                pointer-events: auto !important;
                display: block !important;
                z-index: auto !important;
                transition: none !important;
            }
            .calculator-row.print-visible {
                position: relative !important;
                opacity: 1 !important;
                visibility: visible !important;
                transform: none !important;
                -webkit-transform: none !important;
                display: block !important;
                transition: none !important;
            }
            
            /* Hide carousel navigation in print */
            .carousel-nav,
            .carousel-nav-arrow,
            .carousel-dots {
                display: none !important;
            }
            
            /* Row header - no outline on title */
            .row-header { margin-bottom: 10px; padding-bottom: 8px; border-bottom: none; display: none !important; }
            .row-title-section { display: flex !important; align-items: center !important; gap: 8px !important; }
            .row-title-input { border: none !important; padding: 0 !important; background: transparent !important; width: auto !important; font-size: 14px !important; font-weight: 800 !important; outline: none !important; box-shadow: none !important; display: none !important; }
            .row-options { display: none !important; }
            
            /* Contact info in print - title left, date center, names right */
            .row-contact-info { 
                display: block !important; 
                margin-bottom: 10px; 
                padding: 8px 12px; 
                background: #f5f5f5; 
                border: 1px solid #ccc; 
                font-size: 9px;
            }
            .row-contact-info .contact-row {
                display: flex !important;
                justify-content: space-between !important;
                align-items: center !important;
            }
            .row-contact-info .contact-main {
                display: flex !important;
                justify-content: space-between !important;
                align-items: center !important;
                flex: 1 !important;
                position: relative !important;
            }
            
            /* Print Barcode - positioned at bottom */
            .print-qr-wrapper {
                display: none !important;
                margin-top: 15px !important;
                padding: 8px !important;
                background: white !important;
                border: 1px solid #ccc !important;
                text-align: center !important;
            }
            .print-qr-wrapper.active {
                display: block !important;
            }
            .print-qr-canvas {
                display: flex !important;
                justify-content: center !important;
                align-items: center !important;
            }
            .print-qr-canvas canvas {
                max-width: 350px !important;
                height: auto !important;
            }
            
            /* Title wrapper - T-Mobile with date below, totals beside */
            .row-contact-info .contact-title-wrapper {
                display: flex !important;
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 0px !important;
                flex: 0 0 auto !important;
            }
            .row-contact-info .contact-header-row {
                display: flex !important;
                align-items: flex-start !important;
                gap: 15px !important;
                margin-bottom: 5px !important;
                width: 100% !important;
            }
            .row-contact-info .tmo-logo-print {
                display: inline-block !important;
                height: 36px !important;
                width: 36px !important;
                vertical-align: top !important;
            }
            .row-contact-info .tmo-text-logo-print {
                display: none !important;
            }
            .row-contact-info .contact-date {
                font-size: 9px !important;
                color: #000 !important;
            }
            .row-contact-info .contact-title {
                font-size: 14px !important;
                font-weight: 800 !important;
                color: #000;
                text-align: left;
            }
            .row-contact-info .contact-quote-id {
                display: block !important;
                font-size: 8px !important;
                font-weight: 500 !important;
                color: #666;
                text-align: left;
            }
            .row-contact-info .contact-quote-id:empty {
                display: none !important;
            }
            .row-contact-info .logo-title-group {
                display: flex !important;
                align-items: center !important;
                gap: 12px !important;
                flex: 1 !important;
            }
            .row-contact-info .title-date-group {
                display: flex !important;
                flex-direction: column !important;
                align-items: flex-start !important;
                padding-left: 12px !important;
                margin-left: 0 !important;
                border: none !important;
            }
            .row-contact-info .title-date-group:has(.contact-title:empty) {
                display: none !important;
                padding-left: 0 !important;
            }
            .row-contact-info .logo-date-column {
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
                gap: 2px !important;
            }
            .row-contact-info .header-totals-display {
                display: none !important;
            }
            .row-contact-info .header-totals-display.active {
                display: flex !important;
                flex-direction: column !important;
                align-items: flex-start !important;
                margin-left: 0 !important;
                padding-left: 0 !important;
            }
            .row-contact-info .header-total-label {
                font-size: 8px !important;
                color: #666 !important;
                text-transform: uppercase !important;
                font-weight: 600 !important;
                margin-bottom: 2px !important;
            }
            .row-contact-info .header-prices-row {
                display: flex !important;
                flex-direction: row !important;
                align-items: flex-end !important;
                gap: 8px !important;
            }
            .row-contact-info .header-carrier-comparison {
                display: none !important;
            }
            .row-contact-info .header-carrier-comparison.active {
                display: flex !important;
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 1px !important;
            }
            .row-contact-info .header-carrier-price {
                font-size: 16px !important;
                font-weight: 700 !important;
                color: #333 !important;
                line-height: 1.1 !important;
            }
            .row-contact-info .header-carrier-name {
                font-size: 7px !important;
                color: #666 !important;
                text-transform: uppercase !important;
            }
            .row-contact-info .header-vs {
                display: none !important;
            }
            .row-contact-info .header-vs.active {
                display: block !important;
                font-size: 10px !important;
                color: #666 !important;
                font-weight: 600 !important;
            }
            .row-contact-info .header-totals-amounts {
                display: flex !important;
                flex-direction: column !important;
                align-items: flex-start !important;
            }
            .row-contact-info .header-totals-display .header-total-amount {
                font-size: 24px !important;
                font-weight: 800 !important;
                color: #E20074 !important;
                line-height: 1.1 !important;
            }
            .row-contact-info .header-totals-display .header-total-sub {
                font-size: 7px !important;
                color: #666 !important;
            }
            .row-contact-info .header-per-line {
                display: none !important;
            }
            .row-contact-info .header-per-line.active {
                display: block !important;
                font-size: 7px !important;
                color: #666 !important;
            }
            .row-contact-info .header-carrier-per-line {
                display: none !important;
            }
            .row-contact-info .header-carrier-per-line.active {
                display: block !important;
                font-size: 7px !important;
                color: #666 !important;
            }
            .row-contact-info .header-total-secondary {
                display: none !important;
            }
            .row-contact-info .header-total-secondary.active {
                display: flex !important;
                flex-direction: column !important;
                align-items: flex-start !important;
                margin-left: 8px !important;
                padding-left: 8px !important;
                border-left: 1px solid #ccc !important;
            }
            .row-contact-info .header-total-amount-secondary {
                font-size: 16px !important;
                font-weight: 700 !important;
                color: #E20074 !important;
                line-height: 1.1 !important;
            }
            .row-contact-info .header-total-sub-secondary {
                font-size: 7px !important;
                color: #666 !important;
            }
            .row-contact-info .header-per-line-secondary {
                display: none !important;
            }
            .row-contact-info .header-per-line-secondary.active {
                display: block !important;
                font-size: 7px !important;
                color: #666 !important;
            }
            .row-contact-info .header-yearly-savings {
                display: none !important;
            }
            .row-contact-info .header-yearly-savings.active {
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
                gap: 1px !important;
                margin-left: 8px !important;
                padding-left: 8px !important;
                border-left: 1px solid #ccc !important;
            }
            .row-contact-info .header-yearly-amount {
                font-size: 16px !important;
                font-weight: 800 !important;
                color: #E20074 !important;
                line-height: 1.1 !important;
            }
            .row-contact-info .header-yearly-label {
                font-size: 7px !important;
                color: #666 !important;
                text-transform: uppercase !important;
            }
            .row-contact-info .contact-address {
                position: absolute !important;
                left: 50% !important;
                top: 0 !important;
                transform: translateX(-50%) !important;
                font-size: 8px !important;
                color: #555 !important;
                font-style: italic !important;
                text-align: center !important;
                white-space: nowrap !important;
            }
            .row-contact-info .contact-address:empty {
                display: none !important;
            }
            .row-contact-info .contact-names {
                flex: 0 0 auto !important;
                text-align: right;
                display: flex;
                flex-direction: column;
                gap: 2px;
                align-items: flex-end;
            }
            .row-contact-info .contact-names > div { white-space: nowrap; }
            .row-contact-info .contact-label { font-weight: 700; color: #333; }
            .row-contact-info .contact-value { color: #000; }
            
            /* Hide CD and HI sections unless they have items */
            .step-col-bts.print-hidden,
            .step-col-internet.print-hidden {
                display: none !important;
            }
            
            /* Remove QR margins - barcode now at bottom */
            .calculator-row.has-qr .steps-container {
                margin-right: 0 !important;
            }
            .calculator-row.has-qr .row-contact-info {
                margin-right: 0 !important;
            }
            
            /* Extras Row - CD and HI 50% each inline */
            .steps-container.steps-extras-row { 
                display: grid !important; 
                grid-template-columns: 1fr 1fr !important; 
                gap: 15px !important;
                margin-top: 10px !important;
            }
            /* Hide entire extras row if both children are hidden */
            .steps-container.steps-extras-row:has(.step-col-bts.print-hidden):has(.step-col-internet.print-hidden) {
                display: none !important;
            }
            .steps-container.steps-extras-row .step-col-bts:not(.print-hidden) { 
                grid-column: 1 / 2 !important; 
                display: block !important;
            }
            .steps-container.steps-extras-row .step-col-internet:not(.print-hidden) { 
                grid-column: 2 / 3 !important; 
                display: block !important;
            }
            .steps-container.steps-extras-row .step-col-bts.print-hidden,
            .steps-container.steps-extras-row .step-col-internet.print-hidden {
                display: none !important;
            }
            .steps-container.steps-extras-row .step-col-discounts { display: none !important; }
            .steps-container.steps-extras-row .step-col-rebates { display: none !important; }
            
            /* Old/existing mode steps */
            .steps-container.steps-top-row { 
                display: grid !important; 
                grid-template-columns: 1fr 1fr !important; 
                gap: 15px !important;
                margin-bottom: 10px !important;
            }
            .steps-container.steps-top-row .step-col-lines { 
                display: block !important; 
                grid-column: 1 / 2 !important; 
            }
            .steps-container.steps-top-row .step-col-plan { 
                display: block !important; 
                grid-column: 2 / 3 !important; 
            }
            
            .steps-container { display: grid !important; grid-template-columns: 1fr 1fr !important; gap: 15px !important; }
            .step-col:nth-child(1) { grid-column: 1 / 2 !important; }
            .step-col:nth-child(2) { grid-column: 2 / 3 !important; }
            .step-col.step-col-3 { grid-column: 1 / -1 !important; margin-top: 0 !important; }
            .step-col[id$="-col-voice-lines"]:not(.hidden-step) ~ .step-col-3 { margin-top: 10px !important; }
            .step-col.step-col-devices { grid-column: 1 / -1 !important; margin-top: 10px !important; }
            .step-col-bts:not(.print-hidden) { grid-column: 1 / 2 !important; }
            .step-col-internet:not(.print-hidden) { grid-column: 2 / 3 !important; }
            .step-col-bts.print-hidden { display: none !important; }
            .step-col-internet.print-hidden { display: none !important; }
            
            /* When CD is hidden but HI is visible, HI takes left column */
            .step-col-bts.print-hidden + .step-col-internet:not(.print-hidden) { grid-column: 1 / 2 !important; }

            .step-col { border: none; background: transparent; display: block !important; }
            .step-col.hidden-step { display: block !important; }
            /* Keep voice lines section hidden when empty in print */
            .step-col[id$="-col-voice-lines"].hidden-step { display: none !important; }
            .step-col.visible-step { display: block !important; }
            .step-col.step-col-3 { display: block !important; }
            .step-col.step-col-devices { display: block !important; }
            .step-col.print-hidden { display: none !important; }
            .step-col.step-col-discounts { display: none !important; }
            .step-col.step-col-rebates { display: none !important; }
            .print-hidden { display: none !important; }
            .step-label .print-only-text { display: inline; }
            .step-label .screen-only-text { display: none; }
            
            select, input { border: none; background: transparent; padding: 0; font-weight: 700; font-size: 12px; height: auto; -webkit-appearance: none; appearance: none; color: black; margin: 0; display: block; }
            .stepper-wrapper { border: 1px solid #ccc; background: #f9f9f9; border-radius: 2px; padding: 2px 4px; }
            .stepper-input { border: none !important; text-align: center !important; padding: 0 !important; font-size: 16px !important; height: 32px !important; width: 100% !important; line-height: 32px; border-radius: 0 !important; background: transparent !important; }
            input.manual-price-input { display: none !important; }
            .manual-price-display { display: block !important; font-weight: 700; font-size: 14px; text-align: center; padding: 8px; background: #f9f9f9; border: 1px solid #ccc; border-radius: 2px; }
            .plan-select-trigger { border: 1px solid #ccc !important; padding: 0 10px !important; background: #f9f9f9 !important; height: 36px !important; line-height: 36px; border-radius: 0; font-size: 12px !important; }
            .step-label { color: #333; font-size: 10px; text-transform: uppercase; margin-bottom: 4px; font-weight: 700; }
            .step-label.screen-only-label { display: none !important; }
            .step-label.print-only-label { display: block !important; }
            .step-label.print-only-label.hidden { display: none !important; }
            
            /* Print device list - 3 per row with smaller cards */
            .device-list-container { 
                margin-top: 8px; 
                gap: 0; 
                display: flex !important;
                flex-wrap: wrap !important;
                flex-direction: row !important;
                visibility: visible !important;
            }
            /* Row break to separate devices from accessories */
            .accessory-row-break {
                display: block !important;
                flex-basis: 100% !important;
                width: 100% !important;
                height: 4px !important;
                margin: 2px 0 !important;
            }
            .device-summary-card { 
                padding: 4px 6px; 
                border: 1px solid #E20074 !important; 
                background: #ffeef5 !important; 
                border-radius: 2px !important; 
                width: calc(33.333% - 4px) !important;
                flex: 0 0 calc(33.333% - 4px) !important;
                box-sizing: border-box !important;
                margin: 2px !important;
                line-height: 1.2 !important;
            }
            .device-info { gap: 1px; display: flex; flex-direction: column; }
            .device-label-text { font-size: 15px; color: #000; font-weight: 800; line-height: 1.2; margin: 0; padding: 0; }
            .device-cost-preview { color: #000; font-size: 10px; font-weight: 600; line-height: 1.2; margin: 0; padding: 0; }
            .device-detail-preview { font-size: 8px; color: #555; text-decoration: none !important; line-height: 1.2; margin: 0; padding: 0; }
            /* Accessory cards */
            .device-summary-card.accessory-card {
                background: #f9f9f9 !important;
                border: 1px solid #ccc !important;
                display: flex !important;
                visibility: visible !important;
                opacity: 1 !important;
                width: calc(33.333% - 4px) !important;
                flex: 0 0 calc(33.333% - 4px) !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                padding: 8px 10px !important;
                min-height: 0 !important;
                height: auto !important;
                margin: 2px !important;
            }
            .device-summary-card.accessory-card .device-info {
                flex-direction: row !important;
                align-items: center !important;
                justify-content: space-between !important;
                width: 100% !important;
                gap: 8px !important;
                padding: 4px 0 !important;
                margin: 0 !important;
            }
            .device-summary-card.accessory-card .device-label-text {
                font-size: 11px !important;
                color: #000 !important;
                display: inline !important;
                font-weight: 600 !important;
                white-space: nowrap !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
                max-width: 60% !important;
                line-height: 1.5 !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            .device-summary-card.accessory-card .device-cost-preview {
                font-size: 12px !important;
                color: #E20074 !important;
                display: inline !important;
                font-weight: 700 !important;
                flex-shrink: 0 !important;
                line-height: 1.5 !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            .device-summary-card.accessory-card .accessory-retail-print {
                font-size: 7px !important;
                color: #666 !important;
                display: block !important;
                line-height: 1.2 !important;
                margin-top: 1px !important;
            }
            .device-summary-card.accessory-card .accessory-price-wrapper {
                flex-direction: column !important;
                align-items: flex-end !important;
                gap: 2px !important;
            }
            .device-summary-card.accessory-card .accessory-retail-screen {
                display: none !important;
            }
            /* Show individual accessory cards in print, hide combined */
            .device-summary-card.accessory-card.accessory-individual {
                display: flex !important;
            }
            .device-summary-card.accessory-card.accessory-combined {
                display: none !important;
            }
            /* Show print summary for connected devices, hide detailed list */
            .cd-screen-only {
                display: none !important;
            }
            .cd-print-only {
                display: block !important;
            }
            .cd-print-summary {
                display: flex !important;
                flex-direction: column !important;
                width: 100% !important;
            }
            .cd-print-row {
                display: flex !important;
                justify-content: space-between !important;
                align-items: center !important;
                width: 100% !important;
            }
            .cd-print-name {
                font-weight: 600 !important;
                font-size: 11px !important;
                color: #000 !important;
            }
            .cd-print-price {
                font-weight: 700 !important;
                font-size: 11px !important;
                color: #E20074 !important;
            }
            .cd-print-price-wrapper {
                display: flex !important;
                align-items: center !important;
                gap: 6px !important;
            }
            .cd-print-original {
                font-weight: 600 !important;
                font-size: 10px !important;
                color: #999 !important;
                text-decoration: line-through !important;
            }
            .cd-print-bogo-badge {
                font-size: 8px !important;
                font-weight: 700 !important;
                background: #E20074 !important;
                color: #fff !important;
                padding: 1px 4px !important;
                border-radius: 2px !important;
            }
            .cd-print-promo {
                font-size: 9px !important;
                color: #666 !important;
                margin-top: 2px !important;
            }
            /* Home Internet print styles */
            .hi-screen-only {
                display: none !important;
            }
            .hi-print-only {
                display: flex !important;
                justify-content: space-between !important;
                align-items: center !important;
                width: 100% !important;
            }
            .hi-print-name {
                font-weight: 600 !important;
                font-size: 11px !important;
                color: #000 !important;
            }
            .hi-print-price {
                font-weight: 700 !important;
                font-size: 11px !important;
                color: #E20074 !important;
            }
            .hi-print-price-wrapper {
                display: flex !important;
                align-items: center !important;
                gap: 6px !important;
            }
            .hi-print-original {
                font-weight: 600 !important;
                font-size: 10px !important;
                color: #999 !important;
                text-decoration: line-through !important;
            }
            .byod-placeholder { display: none; border: none; font-style: normal; font-weight: 800; color: #999; text-align: left; padding: 8px 0; font-size: 14px !important; text-transform: uppercase; letter-spacing: 1px; border-left: 4px solid #999; padding-left: 10px; }
            .byod-placeholder.visible { display: block !important; }
            
            /* Timeline in print - always show when active */
            .timeline-section { 
                display: none !important;
            }
            .timeline-section.active.expanded { 
                display: block !important;
                background: #fff !important;
                border: 1px solid #ccc !important;
                border-radius: 2px !important;
                padding: 3px 6px !important;
                margin-top: 4px !important;
            }
            .timeline-section.active.expanded .timeline-header { display: none !important; }
            .timeline-section.active.expanded .timeline-body { 
                display: block !important; 
                margin-top: 0 !important; 
                padding-top: 0 !important; 
                border-top: none !important; 
            }
            .timeline-controls { margin-bottom: 2px !important; }
            .timeline-title { font-size: 7px !important; }
            .timeline-toggle-wrapper { display: none !important; }
            .timeline-section.active.expanded .timeline-container { 
                display: flex !important; 
                justify-content: space-between !important;
                padding: 1px !important;
                margin-top: 0 !important;
            }
            .timeline-container::before {
                top: 12px !important;
                height: 1px !important;
            }
            .timeline-point { min-width: 40px !important; }
            .tp-label { font-size: 6px !important; margin-bottom: 1px !important; }
            .tp-dot { width: 5px !important; height: 5px !important; border-width: 1px !important; margin-bottom: 1px !important; box-shadow: none !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            .tp-dot.free { border-color: var(--success-color) !important; background-color: var(--success-color) !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            .tp-cost { font-size: 6px !important; }
            .tp-cost.free { color: var(--success-color) !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            .applied-bill-label { display: none !important; }
            
            /* Footer with notes beside totals in print */
            .row-footer { 
                margin-top: 8px; 
                padding-top: 8px; 
                border-top: none !important; 
                display: flex !important;
                flex-direction: column !important;
                gap: 8px;
            }
            .footer-top { 
                display: flex !important; 
                justify-content: flex-start !important; 
                align-items: stretch !important; 
                gap: 10px !important;
                width: 100% !important;
                flex-wrap: nowrap !important;
                flex-direction: row !important;
            }
            .footer-top.hide-totals {
                justify-content: flex-start !important;
                align-items: stretch !important;
            }
            /* Hide regular totals-group in print - total is now in header */
            .totals-group { 
                display: none !important;
            }
            .totals-group-header {
                align-self: flex-start !important;
                font-size: 11px !important;
                font-weight: 800 !important;
                text-transform: uppercase !important;
                color: #000 !important;
                margin-bottom: 5px !important;
            }
            .totals-comparison-row {
                display: flex !important;
                align-items: center !important;
                justify-content: flex-start !important;
                gap: 15px !important;
            }
            .carrier-comparison {
                display: flex !important;
                align-items: center !important;
                gap: 10px !important;
            }
            .carrier-price-block { 
                display: flex !important; 
                flex-direction: column !important; 
                align-items: center !important; 
            }
            .carrier-price { font-size: 20px !important; font-weight: 800 !important; color: #666 !important; }
            .carrier-name { font-size: 6px !important; color: #666 !important; }
            .vs-indicator { font-size: 9px !important; color: #666 !important; }
            .totals-amounts {
                display: flex !important;
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 6px !important;
            }
            .total-block { 
                align-items: flex-start !important; 
                text-align: left !important; 
                display: flex !important; 
                flex-direction: column !important; 
            }
            .total-block.secondary-block { }
            .total-block.hidden { display: none !important; }
            .total-label { font-size: 9px; color: #333; font-weight: 700; }
            .total-label-main { font-size: 11px; color: #000; font-weight: 800; text-transform: uppercase; margin-bottom: 2px; }
            .total-label-sub { font-size: 7px; color: #666; font-weight: 600; }
            .total-label-below { font-size: 7px !important; color: #666 !important; font-weight: 600 !important; text-align: left !important; margin-top: 1px !important; }
            .total-amount-row { display: flex !important; align-items: baseline !important; gap: 4px !important; flex-wrap: nowrap !important; }
            .total-amount { font-size: 16px; color: #000; }
            .total-amount.primary { font-size: 24px; color: #E20074 !important; text-decoration: none !important; font-weight: 800; }
            .total-amount.secondary { font-size: 20px; color: #000 !important; font-weight: 800; }
            .total-amount.secondary.shrink { font-size: 18px; }
            .total-tax { font-size: 8px; color: #666; }
            
            /* Notes section in print - 50% width side by side with due-today */
            .notes-section { 
                display: flex !important;
                flex-direction: column !important;
                width: calc(50% - 5px) !important;
                flex: 1 1 calc(50% - 5px) !important;
                margin-top: 0 !important; 
                padding: 4px 8px !important; 
                background: #f9f9f9 !important; 
                box-sizing: border-box !important;
                border: 1px solid #ccc !important;
                border-radius: 2px !important;
                order: 2 !important;
                align-self: stretch !important;
            }
            .notes-section label { 
                display: block !important; 
                font-size: 9px !important; 
                color: #333 !important; 
                border-bottom: none !important; 
                padding-bottom: 0 !important; 
                margin-bottom: 2px !important; 
                font-weight: 800 !important; 
                text-transform: uppercase !important;
                letter-spacing: 0.5px !important;
            }
            .notes-section textarea { display: none !important; }
            .notes-display { display: block !important; font-size: 9px; white-space: pre-wrap; }
            
            /* New mode layout in print - inline totals at top, centered */
            .quote-main-layout {
                display: block !important;
            }
            .quote-left-section {
                width: 100% !important;
            }
            .quote-right-section {
                display: none !important;
                visibility: hidden !important;
                height: 0 !important;
                overflow: hidden !important;
            }
            .totals-group-inline {
                display: none !important;
            }
            
            /* Quote Header Row - HIDDEN in print since total is now in header */
            .quote-header-row {
                display: none !important;
                visibility: hidden !important;
                height: 0 !important;
                overflow: hidden !important;
            }
            .quote-header-row * {
                display: none !important;
            }
            .totals-inline-header {
                display: none !important;
            }
            .totals-header-label {
                font-size: 10px !important;
                font-weight: 800 !important;
                text-transform: uppercase !important;
                color: #000 !important;
                margin-bottom: 6px !important;
            }
            .totals-inline-wrapper {
                display: flex !important;
                flex-direction: row !important;
                align-items: flex-start !important;
                justify-content: center !important;
                gap: 15px !important;
            }
            .carrier-comparison-inline {
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
                text-align: center !important;
            }
            .carrier-comparison-inline.hidden,
            .carrier-comparison-inline[style*="display: none"] {
                display: none !important;
            }
            .carrier-name-inline {
                font-size: 7px !important;
                color: #666 !important;
                text-transform: uppercase !important;
                height: 12px !important;
                line-height: 12px !important;
                margin-bottom: 2px !important;
            }
            .carrier-price-inline {
                font-size: 20px !important;
                font-weight: 800 !important;
                color: #666 !important;
                padding-top: 8px !important;
                line-height: 1.1 !important;
            }
            .vs-inline {
                font-size: 10px !important;
                color: #666 !important;
                align-self: center !important;
                padding: 0 5px !important;
                margin-top: 12px !important;
            }
            .vs-inline[style*="display: none"],
            .vs-inline.hidden {
                display: none !important;
            }
            .totals-prices-inline {
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
                gap: 2px !important;
            }
            .us-label-header {
                font-size: 7px !important;
                color: #E20074 !important;
                height: 12px !important;
                line-height: 12px !important;
                margin-bottom: 2px !important;
            }
            .us-label-header[style*="display: none"] {
                display: none !important;
            }
            .totals-amounts-row {
                display: flex !important;
                align-items: stretch !important;
                gap: 10px !important;
                padding: 6px 10px !important;
            }
            .total-inline-main {
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
                justify-content: flex-end !important;
                text-align: center !important;
            }
            .total-inline-main .total-inline-amount,
            .total-inline-secondary .total-inline-amount {
                line-height: 1 !important;
            }
            .total-inline-main .total-inline-label,
            .total-inline-secondary .total-inline-label {
                margin-top: 3px !important;
            }
            .total-inline-amount.primary {
                font-size: 20px !important;
                font-weight: 800 !important;
                color: #E20074 !important;
            }
            .total-inline-amount.secondary {
                font-size: 16px !important;
                font-weight: 700 !important;
                color: #666 !important;
            }
            .total-inline-label {
                font-size: 7px !important;
                color: #666 !important;
                margin-top: 1px !important;
            }
            .us-label {
                display: none !important;
            }
            .per-line-text {
                font-size: 0.6em !important;
            }
            .tax-text {
                font-size: 0.4em !important;
                font-weight: 600 !important;
                color: #666 !important;
                margin-left: 2px !important;
            }
            .total-inline-secondary {
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
                justify-content: flex-end !important;
                text-align: center !important;
            }
            .total-inline-secondary.hidden {
                display: none !important;
            }
            
            /* Yearly Savings in print - magenta pill */
            .yearly-savings {
                margin-top: 8px !important;
                font-size: 10px !important;
                font-weight: 700 !important;
                color: #E20074 !important;
                background: #ffeef5 !important;
                padding: 4px 12px !important;
                border-radius: 12px !important;
                display: inline-block !important;
            }
            .yearly-savings.hidden {
                display: none !important;
            }
            
            /* Steps Main Row - hide carrier, Lines and Plan inline at same level */
            .steps-container.steps-main-row {
                display: flex !important;
                flex-direction: row !important;
                gap: 15px !important;
                margin-bottom: 10px !important;
                align-items: flex-start !important;
            }
            .steps-container.steps-main-row .step-col-lines {
                display: flex !important;
                flex-direction: column !important;
                flex: 1 !important;
            }
            .steps-container.steps-main-row .step-col-plan {
                display: flex !important;
                flex-direction: column !important;
                flex: 2 !important;
            }
            .steps-container.steps-main-row .step-col .step-label {
                margin-bottom: 4px !important;
                height: 14px !important;
                line-height: 14px !important;
            }
            .steps-container.steps-main-row .stepper-wrapper {
                height: 36px !important;
            }
            .steps-container.steps-main-row .plan-select-wrapper {
                height: 36px !important;
            }
            .steps-container.steps-main-row .plan-select-trigger {
                height: 36px !important;
                line-height: 32px !important;
            }
            
            /* Device Row */
            .steps-container.steps-device-row {
                display: block !important;
            }
            
            /* Hide CD and HI sections on print when empty */
            .step-col-bts.print-hidden,
            .step-col-internet.print-hidden {
                display: none !important;
            }
            
            /* Row Actions - hide in print */
            .row-actions {
                display: none !important;
            }
            
            /* For new mode in print: hide inline totals in footer but show notes and due-today side by side */
            .row-footer.new-mode-footer {
                display: flex !important;
            }
            .row-footer.new-mode-footer .footer-top {
                display: flex !important;
                flex-wrap: nowrap !important;
                flex-direction: row !important;
                align-items: stretch !important;
            }
            .row-footer.new-mode-footer .footer-top .footer-totals-group {
                display: none !important;
                visibility: hidden !important;
                height: 0 !important;
                overflow: hidden !important;
            }
            /* Hide ALL footer totals in print - total is now in header */
            .footer-totals-group {
                display: none !important;
                visibility: hidden !important;
                height: 0 !important;
                overflow: hidden !important;
            }
            .footer-totals-group * {
                display: none !important;
            }
            .totals-group.footer-totals-group {
                display: none !important;
            }
            
            /* Add-ons display - show in print aligned left beneath total in header */
            .addons-display {
                display: block !important;
                font-size: 7px !important;
                color: #666 !important;
                text-align: left !important;
                margin-top: 2px !important;
            }
            
            /* Add-ons display beneath plan name */
            .addons-display-plan:not(.hidden) {
                display: block !important;
                font-size: 8px !important;
                color: #666 !important;
                margin-top: 2px !important;
                font-style: italic !important;
            }
            .addons-display-plan.hidden {
                display: none !important;
            }
            .row-footer.new-mode-footer .footer-top .notes-section {
                width: calc(50% - 5px) !important;
                flex: 1 1 calc(50% - 5px) !important;
            }
            .row-footer.new-mode-footer .footer-top .due-today-group {
                width: calc(50% - 5px) !important;
                flex: 1 1 calc(50% - 5px) !important;
            }
            
            /* Notes section - remove underline from title */
            .notes-section label {
                border-bottom: none !important;
            }
            
            /* Override hide-totals in print to hide totals but keep due-today and notes side by side */
            .footer-top.hide-totals .footer-totals-group {
                display: none !important;
            }
            .footer-top.hide-totals .notes-section {
                width: calc(50% - 5px) !important;
                flex: 1 1 calc(50% - 5px) !important;
            }
            .footer-top.hide-totals .due-today-group {
                width: calc(50% - 5px) !important;
                flex: 1 1 calc(50% - 5px) !important;
            }
            
            /* Hide page footer credit in print */
            .page-footer-credit { display: none !important; }
            
            /* T-Mobile print logo - larger */
            .row-contact-info .tmo-text-logo-print { display: none !important; }
            .row-contact-info .tmo-logo-print { 
                display: inline-block !important; 
                height: 40px !important;
                width: auto !important;
                min-width: 40px !important;
            }
            
            /* Disclosures in print */
            .disclosures-section {
                display: block !important;
                margin-top: 10px;
                padding-top: 8px;
                border-top: 1px solid #ccc;
            }
            .disclosure-text {
                font-size: 7px !important;
                color: #666 !important;
                margin: 0 0 3px 0 !important;
                line-height: 1.3;
            }
            .disclosure-credit {
                font-size: 6px !important;
                color: #999 !important;
                margin: 0 !important;
                font-style: italic;
            }
            
            /* Discount/rebate section visibility already handled above */
            .bts-container, .rebates-container, .discounts-container, .accessories-container { 
                margin-top: 5px;
                display: flex !important;
                flex-wrap: nowrap !important;
                flex-direction: column !important;
                gap: 4px !important;
            }
            
            .due-today-group {
                padding: 4px 8px !important;
                background: #f9f9f9 !important;
                border: 1px solid #ccc !important;
                border-radius: 2px !important;
                margin-top: 0 !important;
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
                justify-content: center !important;
                gap: 2px !important;
                width: calc(50% - 5px) !important;
                flex: 1 1 calc(50% - 5px) !important;
                box-sizing: border-box !important;
                order: 1 !important;
                align-self: stretch !important;
            }
            .due-today-row {
                display: flex !important;
                flex-direction: row !important;
                align-items: flex-start !important;
                justify-content: center !important;
                gap: 15px !important;
            }
            .due-today-content {
                display: flex !important;
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 1px !important;
            }
            .savings-today-content {
                display: flex !important;
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 1px !important;
                margin-left: 0 !important;
                padding-left: 10px !important;
                border-left: 1px solid #ccc !important;
            }
            /* Hide savings-today when not visible (style.display = 'none') */
            .savings-today-content[style*="display: none"],
            .savings-today-content[style*="display:none"] {
                display: none !important;
                border-left: none !important;
                padding-left: 0 !important;
            }
            .due-today-group .totals-group-header {
                font-size: 9px !important;
                font-weight: 800 !important;
                color: #333 !important;
                margin: 0 !important;
                line-height: 1 !important;
                text-transform: uppercase !important;
                letter-spacing: 0.5px !important;
            }
            .due-today-group .total-amount.primary {
                font-size: 14px !important;
                font-weight: 800 !important;
                color: #E20074 !important;
                line-height: 1 !important;
            }
            .due-today-group .total-amount.savings {
                font-size: 14px !important;
                font-weight: 800 !important;
                color: #E20074 !important;
                line-height: 1 !important;
            }
            .due-today-explanation {
                font-size: 7px !important;
                color: #666 !important;
                font-style: italic !important;
                text-align: left !important;
                align-self: flex-start !important;
                margin-left: 0 !important;
                padding-left: 0 !important;
            }
            
            /* Hide due-today-content when nothing is due today */
            .due-today-content.hide-in-print {
                display: none !important;
            }
            /* Remove border from savings when due-today is hidden */
            .due-today-content.hide-in-print + .savings-today-content {
                border-left: none !important;
                padding-left: 0 !important;
            }
            
            /* Hide due-today and notes when both totals are 0 */
            .footer-top.hide-due-today-section .due-today-group {
                display: none !important;
            }
            .footer-top.hide-due-today-section .notes-section {
                width: 100% !important;
                flex: 1 1 100% !important;
            }
            
            /* Item pills in print - CD and HI full width within sections */
            .item-pill {
                background: #ffeef5 !important; 
                color: #000 !important; 
                border: 1px solid #E20074 !important; 
                padding: 4px 6px !important; 
                box-shadow: none !important; 
                border-radius: 2px !important;
                display: flex !important;
                flex-direction: column !important;
                align-items: flex-start !important;
                margin: 2px 0 !important;
                width: 100% !important;
                box-sizing: border-box !important;
                min-height: 0 !important;
            }
            .item-pill .remove-x { display: none !important; }
            .item-pill .cd-pill-actions { display: none !important; }
            .item-pill .item-text { font-size: 9px !important; font-weight: 700 !important; color: #000 !important; }
            .item-pill .cd-pill-content { display: flex !important; flex-direction: column !important; gap: 1px !important; width: 100% !important; }
            .item-pill .cd-units-list { display: none !important; }
            .item-pill .cd-unit-line { display: none !important; }
            .item-pill .cd-device-submenu { display: none !important; }
            .item-pill .cd-promo-line { display: none !important; }
            .item-pill .deal-badge { display: none !important; }
            .price-strikethrough { text-decoration: line-through !important; color: #666 !important; }
            .price-deal { color: #E20074 !important; font-weight: 700 !important; }
            
            /* Manual discount wrapper print styles - match item-pill styling exactly */
            .manual-discount-wrapper {
                background: #ffeef5 !important; 
                color: #000 !important; 
                border: 1px solid #E20074 !important; 
                padding: 4px 6px !important; 
                box-shadow: none !important; 
                border-radius: 2px !important;
                display: flex !important;
                flex-direction: column !important;
                align-items: flex-start !important;
                margin: 2px 0 !important;
                width: 100% !important;
                box-sizing: border-box !important;
                min-height: 0 !important;
            }
            .manual-discount-screen {
                display: none !important; /* Hide input fields in print */
            }
            .manual-discount-print {
                display: block !important; /* Show print version */
            }
            .manual-discount-print .item-text {
                font-size: 9px !important; 
                font-weight: 700 !important; 
                color: #000 !important;
            }
            
            /* Voice line items in print */
            .voice-line-item {
                background: #ffeef5 !important; 
                color: #000 !important; 
                border: 1px solid #E20074 !important; 
                padding: 8px 6px !important; 
                box-shadow: none !important; 
                border-radius: 2px !important;
                display: block !important;
                margin: 2px 0 !important;
                width: 100% !important;
                box-sizing: border-box !important;
            }
            .voice-line-item .remove-x {
                display: none !important;
            }
            .voice-line-pricing {
                font-size: 12px !important; 
                font-weight: 700 !important; 
                color: #000 !important;
            }
            .voice-line-pricing b {
                color: #000 !important;
            }
            .voice-line-price-original {
                text-decoration: line-through !important;
                color: #666 !important;
            }
            .voice-line-price-discounted {
                color: #E20074 !important;
                font-weight: 700 !important;
            }
            .voice-line-price-discounted {
                color: #E20074 !important;
                font-weight: 700 !important;
            }
            
            /* Summary sections */
            .summaries-row { 
                display: flex !important; 
                gap: 10px; 
                flex-wrap: nowrap !important; 
                margin-top: 10px;
                overflow: visible;
                height: auto;
                align-items: stretch !important;
            }
            .summaries-row > div { flex: 1 !important; min-width: 0 !important; max-width: calc(50% - 5px) !important; box-sizing: border-box !important; }
            .summaries-row > div:only-child { max-width: 100% !important; }
            .summaries-row > div.full-width { max-width: 100% !important; flex-basis: 100% !important; }
            .rebate-summary { 
                display: none; 
                border: 1px solid #E20074; 
                padding: 6px; 
                background: #ffeef5 !important; 
                border-radius: 4px; 
                overflow: visible; 
                box-sizing: border-box; 
                margin-top: 0 !important; 
                flex-direction: column !important; 
                height: auto;
            }
            .rebate-summary.visible { display: flex !important; }
            .rebate-summary-content { flex: 1; }
            .rebate-summary-title { font-size: 8px; color: #000; border-bottom: 1px solid #E20074; padding-bottom: 2px; margin-bottom: 5px; font-weight: 700; }
            .rebate-summary-item { 
                font-size: 8px; 
                padding: 3px 0 3px 8px !important; 
                margin-bottom: 3px !important;
                line-height: 1.3; 
                border-left: 2px solid #E20074 !important;
            }
            .rebate-grand-total { font-size: 9px; color: #E20074; border-top: 1px solid #E20074; padding-top: 3px; margin-top: auto; font-weight: 800; }
            .discount-summary { 
                display: none; 
                border: 1px solid #E20074; 
                padding: 6px; 
                background: #ffeef5 !important; 
                border-radius: 4px; 
                margin-top: 0 !important; 
                flex-direction: column !important; 
                height: auto;
                overflow: visible;
                box-sizing: border-box;
            }
            .discount-summary.visible { display: flex !important; }
            .discount-summary-content { flex: 1; }
            .discount-summary-item { 
                font-size: 8px; 
                padding: 3px 0 3px 8px !important; 
                margin-bottom: 3px !important;
                line-height: 1.3; 
                border-left: 2px solid #E20074 !important;
            }
            .discount-total { font-size: 9px; color: #E20074; border-top: 1px solid #E20074; padding-top: 3px; margin-top: auto; font-weight: 800; }
        }
        
        /* Plan Popup */
        #plan-modal .modal-body {
            display: flex; flex-direction: column; height: 450px;
        }
        #plan-list-container { flex: 1; overflow-y: auto; margin-bottom: 10px; border: 1px solid #eee; border-radius: 4px; }
        .plan-option { padding: 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; font-weight: 500; display: flex; justify-content: space-between; align-items: center; }
        .plan-option:hover { background-color: #ffeef5; color: var(--primary-color); }
        .plan-option.selected { background-color: #ffeef5; border-left: 4px solid var(--primary-color); }
        .plan-category-header { padding: 10px 15px; background: #f5f5f5; font-weight: 700; font-size: 0.85rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid #e0e0e0; position: sticky; top: 0; z-index: 1; }
        .plan-search-box { width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 4px; font-size: 1rem; }
        
        /* Add-ons Modal - Similar styling to Connected Devices */
        .addons-modal-page { display: none; }
        .addons-modal-page.active { display: flex; height: 100%; flex-direction: column; }
        .addon-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f9f9f9;
            border-radius: 6px;
            margin-bottom: 8px;
            border: 1px solid var(--border-color);
        }
        .addon-list-item:hover {
            background: #ffeef5;
        }
        .addon-item-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .addon-item-name {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text-main);
        }
        .addon-item-details {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        .addon-item-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .addon-form-group {
            margin-bottom: 15px;
        }
        .addon-form-label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-main);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .addon-form-input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.95rem;
        }
        .addon-form-input:focus {
            border-color: var(--primary-color);
            outline: none;
        }
        .addon-back-btn {
            background: #ffeef5;
            padding: 8px 10px;
            border-radius: 6px;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--primary-color);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            border: none;
            text-transform: none;
            letter-spacing: normal;
        }
        .addon-back-btn:hover {
            background: #ffe0ee;
        }
        .addon-back-arrow {
            font-size: 0.85rem;
        }
        
        /* Plan Modal Tabs - Scrollable with Arrows */
        .plan-tabs-wrapper { 
            position: relative; 
            margin-bottom: 15px; 
            overflow: hidden;
        }
        .plan-tabs-container { 
            display: flex; 
            overflow-x: auto; 
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
            gap: 0;
            border-bottom: 2px solid var(--border-color);
            padding: 0 30px;
        }
        .plan-tabs-container::-webkit-scrollbar { display: none; }
        .plan-tab { 
            flex: 0 0 calc(33.33% - 2px); 
            min-width: calc(33.33% - 2px);
            padding: 12px 8px; 
            text-align: center; 
            cursor: pointer; 
            font-weight: 700; 
            font-size: 0.8rem; 
            color: var(--text-secondary); 
            border-bottom: 3px solid transparent; 
            margin-bottom: -2px; 
            transition: all 0.2s;
            white-space: nowrap;
            background: white;
        }
        .plan-tab:hover { color: var(--primary-color); background: #ffeef5; }
        .plan-tab.active { color: var(--primary-color); border-bottom-color: var(--primary-color); background: white; }
        .plan-tabs-scroll-hint {
            position: absolute;
            right: 30px;
            top: 0;
            bottom: 2px;
            width: 30px;
            background: linear-gradient(to right, transparent, white);
            pointer-events: none;
            z-index: 1;
        }
        .plan-tabs-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 28px;
            height: 28px;
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: all 0.2s;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        .plan-tabs-arrow:hover { border-color: var(--primary-color); color: var(--primary-color); background: #ffeef5; }
        .plan-tabs-arrow.left { left: 0; }
        .plan-tabs-arrow.right { right: 0; }
        .plan-tabs-arrow.hidden { opacity: 0.3; pointer-events: none; }
        .plan-tabs-arrow .arrow-left,
        .plan-tabs-arrow .arrow-right {
            width: 8px;
            height: 8px;
            border-top: 2px solid currentColor;
            border-right: 2px solid currentColor;
        }
        .plan-tabs-arrow .arrow-left { transform: rotate(-135deg); margin-left: 2px; }
        .plan-tabs-arrow .arrow-right { transform: rotate(45deg); margin-right: 2px; }
        .plan-no-results { padding: 20px; text-align: center; color: var(--text-secondary); font-style: italic; }
        
        /* 3-Way Toggle for Protection Visibility */
        .three-way-toggle {
            display: flex;
            background: #e0e0e0;
            border-radius: 25px;
            padding: 4px;
            position: relative;
            height: 32px;
        }
        .three-way-toggle input { display: none; }
        .three-way-option {
            flex: 1;
            text-align: center;
            padding: 6px 8px;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            z-index: 2;
            transition: color 0.3s;
            white-space: nowrap;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .three-way-option.active { color: var(--primary-color); }
        .three-way-slider {
            position: absolute;
            top: 4px;
            height: calc(100% - 8px);
            width: calc(33.33% - 3px);
            background: white;
            border-radius: 20px;
            transition: left 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .three-way-slider[data-position="0"] { left: 4px; }
        .three-way-slider[data-position="1"] { left: calc(33.33% + 1px); }
        .three-way-slider[data-position="2"] { left: calc(66.66% - 2px); }

    </style>
</head>
<body>

    <div id="app-container" class="app-container visible">
    <div class="container">
        <!-- PRINT HEADER -->
        <div id="print-info-container">
            <div class="print-row">
                <div class="print-item">
                    <span class="print-label">Date:</span>
                    <span class="print-val" id="print-date"></span>
                </div>
            </div>
            <div class="print-row">
                <div class="print-item">
                    <span class="print-label">Prepared By:</span>
                    <span class="print-val" id="print-rep-name"></span>
                    <span class="print-val" id="print-rep-phone" style="margin-left:5px;"></span>
                </div>
                <div class="print-item">
                    <span class="print-label">Prepared For:</span>
                    <span class="print-val" id="print-cust-name"></span>
                    <span class="print-val" id="print-cust-phone" style="margin-left:5px;"></span>
                </div>
            </div>
        </div>

        <header>
            <!-- T-Mobile Logo (replace TMOBILE_LOGO_BASE64_HERE with actual base64) -->
            <div class="tmo-logo-wrapper">
                <img class="tmo-logo-img" src="data:image/png;base64,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" alt="T-Mobile" onload="this.style.display='block';this.nextElementSibling.style.display='none'" onerror="this.style.display='none';this.nextElementSibling.style.display='block'" style="display:none;">
                <span class="tmo-text-logo">T-Mobile</span>
            </div>
            
            <!-- iOS SWITCH - 2-WAY -->
            <div class="toggle-container">
                <div class="toggle-slider position-0" id="toggle-slider"></div>
                <div class="toggle-labels">
                    <span onclick="setMode('new')">New</span>
                    <span onclick="setMode('existing')">Existing</span>
                </div>
            </div>

            <div style="display: flex; gap: 10px; align-items: center;">
                <button id="add-row-btn" class="btn btn-primary add-btn">+</button>
                <button id="load-quote-btn" class="btn btn-secondary scan-btn" onclick="openLoadQuoteModal()" title="Load Quote">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="12" y1="18" x2="12" y2="12"></line>
                        <line x1="9" y1="15" x2="15" y2="15"></line>
                    </svg>
                </button>
                <button id="compare-quotes-header-btn" class="compare-quotes-header-btn" onclick="goToCompareQuotes()" title="Compare Quotes" disabled>
                    <!-- EDITABLE ICON: Replace the base64 string below to change the icon -->
                    <img id="compare-quotes-icon" width="20" height="20" src="data:image/png;base64,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" alt="Compare Quotes Icon">
                </button>
                <button class="hamburger-btn" onclick="openSettingsSidebar()">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </header>

        <div id="rows-container">
            <!-- Rows injected here -->
        </div>

        <!-- COMPARISON SECTION -->
        <div id="compare-section">
            <div class="compare-buttons">
                <button class="btn btn-secondary btn-action compare-back-btn" onclick="returnFromCompare()">
                    <span class="compare-back-arrow"></span>
                    <span>Back</span>
                </button>
                <button class="btn btn-secondary btn-action compare-reset-btn" onclick="resetComparison()">Reset</button>
            </div>
            
            <div class="compare-dropdowns no-content">
                <div class="compare-dropdown-wrapper spacer">
                    Compare:
                </div>
                <div class="compare-dropdown-wrapper">
                    <button class="compare-plan-trigger" id="compare-plan-1-trigger" onclick="openComparePlanModal(1)">
                        <span id="compare-plan-1-label">Plan 1</span>
                    </button>
                    <input type="hidden" id="compare-plan-1" value="">
                </div>
                <div class="compare-dropdown-wrapper">
                    <button class="compare-plan-trigger" id="compare-plan-2-trigger" onclick="openComparePlanModal(2)">
                        <span id="compare-plan-2-label">Plan 2</span>
                    </button>
                    <input type="hidden" id="compare-plan-2" value="">
                </div>
            </div>
            
            <div id="comparison-table-container">
            </div>
            
            <!-- Sam's Club Member Benefits Section -->
            <div id="sams-club-benefits" class="sams-club-benefits">
                <div class="sams-club-title">Sam's Club Member Benefits</div>
                <div class="sams-club-grid">
                    <div class="sams-club-card">
                        <div class="sams-club-card-top">
                            New Line Activation on<br>Experience More / Beyond Plan<br>&amp;<br>Device Purchase<br>(EIP Required)
                        </div>
                        <div class="sams-club-card-bottom"> $150 Sam's Club E-Gift Card</div>
                    </div>
                    <div class="sams-club-card">
                        <div class="sams-club-card-top">
                             New Line Activation on<br>Experience More / Beyond Plan<br><br> Device Purchase / Upgrade on<br>Eligible Plan (EIP Required)
                        </div>
                        <div class="sams-club-card-bottom">$75 Sam's Club E-Gift Card</div>
                    </div>
                    <div class="sams-club-card">
                        <div class="sams-club-card-top">
                             New Watch / Tablet Line Activation<br> New Home Internet Activation
                        </div>
                        <div class="sams-club-card-bottom">$25 Sam's Club E-Gift Card</div>
                    </div>
                </div>
                <div class="sams-club-plus-row">
                    <div class="sams-club-plus-note">
                        <span> Sam's Club <strong>PLUS</strong> Members get an additional $60 Sam's Club E-Gift Card, <span class="every-year">EVERY YEAR.</span></span>
                    </div>
                </div>
                <div class="sams-club-fine-print">Note: Must have an active Sam's Club PLUS membership at time of purchase and meet the $150 payout requirements</div>
            </div>
        </div>
        
        <!-- QUOTE COMPARISON SECTION -->
        <div id="quote-compare-section">
            <div class="quote-compare-buttons">
                <button class="btn btn-secondary btn-action compare-back-btn" onclick="closeQuoteCompareSection()">
                    <span class="compare-back-arrow"></span>
                    <span>Back</span>
                </button>
            </div>
            <div class="quote-compare-grid" id="quote-compare-grid">
                <!-- Populated dynamically -->
            </div>
        </div>
        
        <!-- Page Footer Credit (visible on screen) -->
        <div class="page-footer-credit">Quote Builder V2.46 | Made by Luke Shrader</div>
        
        <!-- Plan Benefits Pages (print only) -->
        <div id="plan-benefits-container" class="plan-benefits-container">
            <!-- Dynamically populated benefits pages -->
        </div>

        <button id="export-pdf" class="btn btn-export-pdf hidden" onclick="openContactModal()">
           Print Quote
        </button>
    </div>
    
    <!-- Settings Overlay -->
    <div id="settings-overlay" class="settings-overlay" onclick="closeSettingsSidebar()"></div>
    
    <!-- Settings Modal (Rules) -->
    <div id="settings-sidebar" class="settings-sidebar">
        <div class="settings-header">
            <div class="settings-header-content">
                <h3>Rules</h3>
                <span class="settings-header-subtitle">Rules apply to all quotes, and save even after refreshing the page</span>
            </div>
            <button class="settings-close" onclick="closeSettingsSidebar()"></button>
        </div>
        <div class="settings-body" id="settings-body">
            <!-- Show Itemized Device List -->
            <div class="settings-section draggable-section" data-section-id="itemized-prices">
                <div class="settings-section-title">
                    <span class="drag-handle"></span>
                    Show Itemized Prices
                </div>
                <p style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 12px;">Control which items show prices</p>
                <div class="settings-submenu">
                    <div class="settings-submenu-item">
                        <span>Added Devices</span>
                        <label class="switch-sm">
                            <input type="checkbox" id="show-device-prices" checked onchange="toggleItemizedCategory('devices', this.checked)">
                            <span class="slider-sm"></span>
                        </label>
                    </div>
                    <div class="settings-submenu-item">
                        <span>Connected Devices</span>
                        <label class="switch-sm">
                            <input type="checkbox" id="show-cd-prices" checked onchange="toggleItemizedCategory('connectedDevices', this.checked)">
                            <span class="slider-sm"></span>
                        </label>
                    </div>
                    <div class="settings-submenu-item">
                        <span>Internet</span>
                        <label class="switch-sm">
                            <input type="checkbox" id="show-hi-prices" checked onchange="toggleItemizedCategory('homeInternet', this.checked)">
                            <span class="slider-sm"></span>
                        </label>
                    </div>
                    <div class="settings-submenu-item">
                        <span>Accessories</span>
                        <label class="switch-sm">
                            <input type="checkbox" id="show-accessory-prices" checked onchange="toggleItemizedCategory('accessories', this.checked)">
                            <span class="slider-sm"></span>
                        </label>
                    </div>
                    <div class="settings-submenu-item">
                        <span>Add-ons</span>
                        <label class="switch-sm">
                            <input type="checkbox" id="show-addon-prices" checked onchange="toggleItemizedCategory('addons', this.checked)">
                            <span class="slider-sm"></span>
                        </label>
                    </div>
                    <div class="settings-submenu-item">
                        <span>Per Line Breakdown</span>
                        <label class="switch-sm">
                            <input type="checkbox" id="show-per-line" onchange="togglePerLinePricing(this.checked)">
                            <span class="slider-sm"></span>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Price Adjustments -->
            <div class="settings-section draggable-section" data-section-id="price-adjustments">
                <div class="settings-section-title">
                    <span class="drag-handle"></span>
                    Price Adjustments
                </div>
                <p style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 12px;">Add unlisted manual adjustments to all quotes</p>
                <div class="settings-row">
                    <input type="text" id="adjustment-name" class="settings-input" placeholder="Adjustment name">
                </div>
                <div class="settings-row" style="display: flex; gap: 8px;">
                    <input type="number" id="adjustment-value" class="settings-input" placeholder="($) Amount" style="flex: 1;">
                    <select id="adjustment-type" class="settings-select" style="flex: 1;">
                        <option value="per-line">Per Line</option>
                        <option value="per-device">Per Device</option>
                        <option value="one-time">Flat Rate</option>
                        <option value="percent">Percent</option>
                    </select>
                </div>
                <div class="settings-row">
                    <button class="settings-btn" onclick="addGlobalAdjustment()" style="width: 100%;">Add Adjustment</button>
                </div>
                <div id="adjustment-list" class="adjustment-list"></div>
            </div>
            
            <!-- Retail Price Visibility -->
            <div class="settings-section draggable-section" data-section-id="retail-visibility">
                <div class="settings-section-title">
                    <span class="drag-handle"></span>
                    Retail Price Visibility
                </div>
                <p style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 12px;">Show retail prices on added items</p>
                <div class="settings-submenu">
                    <div class="settings-submenu-item">
                        <span>Added Devices</span>
                        <label class="switch-sm">
                            <input type="checkbox" id="show-device-retail" onchange="toggleRetailVisibility('devices', this.checked)">
                            <span class="slider-sm"></span>
                        </label>
                    </div>
                    <div class="settings-submenu-item">
                        <span>Connected Devices</span>
                        <label class="switch-sm">
                            <input type="checkbox" id="show-bts-retail" onchange="toggleRetailVisibility('bts', this.checked)">
                            <span class="slider-sm"></span>
                        </label>
                    </div>
                    <div class="settings-submenu-item">
                        <span>Accessories</span>
                        <label class="switch-sm">
                            <input type="checkbox" id="show-accessory-retail" onchange="toggleRetailVisibility('accessories', this.checked)">
                            <span class="slider-sm"></span>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Total Rounding -->
            <div class="settings-section draggable-section" data-section-id="total-rounding">
                <div class="settings-section-title">
                    <span class="drag-handle"></span>
                    Total Rounding
                </div>
                <p style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 12px;">Round final totals up or down</p>
                <div class="settings-row">
                    <select id="rounding-mode" class="settings-select" style="width: 100%;" onchange="updateRoundingMode()">
                        <option value="none">No Rounding</option>
                        <option value="nearest-5">Round to Nearest $5</option>
                        <option value="nearest-10">Round to Nearest $10</option>
                        <option value="up-5">Round Up to Nearest $5</option>
                        <option value="down-5">Round Down to Nearest $5</option>
                        <option value="up-10">Round Up to Nearest $10</option>
                        <option value="down-10">Round Down to Nearest $10</option>
                    </select>
                </div>
            </div>
            
            <!-- Combine Identical Devices -->
            <div class="settings-section draggable-section" data-section-id="combine-devices">
                <div class="settings-section-title">
                    <span class="drag-handle"></span>
                    Combine Identical Devices
                </div>
                <p style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 12px;">Group identical devices together when printed (Example: "iPhone 17 x3")</p>
                <div class="settings-row" style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: 0.9rem;">Enable combining</span>
                    <label class="switch-sm">
                        <input type="checkbox" id="combine-devices" checked onchange="toggleCombineDevices(this.checked)">
                        <span class="slider-sm"></span>
                    </label>
                </div>
            </div>
            
            <!-- Quote Display Style -->
            <div class="settings-section draggable-section" data-section-id="display-style">
                <div class="settings-section-title">
                    <span class="drag-handle"></span>
                    Quote Display Style
                </div>
                <p style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 12px;">Change how quotes are displayed</p>
                <div class="settings-row">
                    <select id="display-style" class="settings-select" style="width: 100%;" onchange="updateDisplayStyle(this.value)">
                        <option value="list">List</option>
                        <option value="stacked">Swipe Between</option>
                    </select>
                </div>
            </div>
            
            <!-- Compare Page Prices -->
            <div class="settings-section draggable-section" data-section-id="compare-prices">
                <div class="settings-section-title">
                    <span class="drag-handle"></span>
                    Compare Page Prices
                </div>
                <p style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 12px;">Show itemized prices on the quote comparison page</p>
                <div class="settings-row" style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: 0.9rem;">Display itemized prices</span>
                    <label class="switch-sm">
                        <input type="checkbox" id="show-compare-prices" onchange="toggleComparePrices(this.checked)" checked>
                        <span class="slider-sm"></span>
                    </label>
                </div>
            </div>
            
            <!-- Store Address -->
            <div class="settings-section draggable-section" data-section-id="store-address">
                <div class="settings-section-title">
                    <span class="drag-handle"></span>
                    Store Address
                </div>
                <p style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 12px;">Address to display on printed quotes</p>
                <div class="settings-row">
                    <input type="text" id="store-address" class="settings-input" placeholder="Enter store address" value="1801 Windsor Square DR, Matthews, NC, 28105" oninput="saveSettingsToURL()">
                </div>
            </div>
        </div>
    </div>

    <!-- DEVICE MODAL -->
    <div id="device-modal" class="modal-overlay" onclick="if(event.target === this) closeModal()">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Add Device Details</h3>
                <button class="modal-header-close" onclick="closeModal()"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="modal-row-id">
                <input type="hidden" id="modal-edit-index" value="-1">
                
                <div class="input-group">
                    <label class="step-label" style="font-size: 0.9rem;">Device Name</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="modal-dev-label" placeholder="e.g. iPhone 17 Pro" style="flex: 1;" oninput="toggleDeviceSearchBtn()">
                        <a id="device-search-btn" class="btn btn-secondary" style="display: none; padding: 10px 15px; white-space: nowrap; text-decoration: none;" href="#" target="_blank" rel="noopener noreferrer">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="11" cy="11" r="8"></circle>
                                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                            </svg>
                        </a>
                    </div>
                </div>

                <div class="input-group">
                    <label class="step-label" style="font-size: 0.9rem;">Retail Price ($)</label>
                    <input type="number" id="modal-dev-cost" min="0" max="9999.99" step="0.01" placeholder="0.00">
                </div>

                <div class="input-group">
                    <label class="step-label" style="font-size: 0.9rem;">Promo Value ($)</label>
                    <input type="number" id="modal-dev-promo" min="0" max="9999.99" step="0.01" placeholder="0.00">
                </div>

                <div class="input-group">
                    <label class="step-label" style="font-size: 0.9rem;">Down Payment ($)</label>
                    <input type="number" id="modal-dev-down" min="0" step="0.01" placeholder="0.00">
                </div>

                <div class="input-group">
                    <label class="step-label" style="font-size: 0.9rem;">Trading in a device?</label>
                    <div class="radio-group">
                        <label><input type="radio" name="modal-trade" value="yes" onchange="toggleModalFMV(true)"> Yes</label>
                        <label><input type="radio" name="modal-trade" value="no" checked onchange="toggleModalFMV(false)"> No</label>
                    </div>
                </div>

                <div id="modal-fmv-group" class="input-group hidden">
                    <label class="step-label" style="font-size: 0.9rem;"><a href="https://www.t-mobile.com/devices/phone-trade-in" target="_blank" style="color: var(--primary-color); text-decoration: underline;">Fair Market Value (FMV)</a></label>
                    <input type="number" id="modal-dev-fmv" min="0" step="0.01" placeholder="0.00">
                </div>
                
                <div id="modal-tradein-name-group" class="input-group hidden">
                    <label class="step-label" style="font-size: 0.9rem;">Trade-In Device Name</label>
                    <input type="text" id="modal-dev-tradein-name" placeholder="e.g. iPhone 16 Pro">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveDevice(); return false;" style="width: 100%;">Save Device</button>
            </div>
        </div>
    </div>
    
    <!-- CONNECTED DEVICE MODAL (NEW with Tabs) -->
    <div id="cd-modal" class="modal-overlay" onclick="if(event.target === this) closeCDModal()">
        <div class="modal-content" style="max-width: 500px; max-height: 90vh; display: flex; flex-direction: column;">
            <div class="modal-header with-subtitle">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; width: 100%;">
                    <div>
                        <h3 id="cd-modal-title">Add Connected Device</h3>
                        <div class="mp-links-container" id="cd-mp-links-container">
                            <a href="#" id="cd-mp-link" class="mp-link" target="_blank" onclick="event.stopPropagation();">Magenta Pulse</a>
                            <a href="#" id="cd-mp-link-business" class="mp-link" target="_blank" onclick="event.stopPropagation();" style="display: none;">Business Magenta Pulse</a>
                        </div>
                    </div>
                    <button class="modal-header-close" onclick="closeCDModal()"></button>
                </div>
            </div>
            <div class="modal-body" style="display: flex; flex-direction: column; flex: 1; overflow: hidden; min-height: 0;">
                <input type="hidden" id="cd-row-id">
                <input type="hidden" id="cd-edit-index" value="-1">
                
                <!-- Tabs at top with arrows -->
                <div class="cd-tabs-wrapper" id="cd-tabs-wrapper">
                    <div class="cd-tabs-arrow left" onclick="scrollCDTabs(-1)"><span class="arrow-left"></span></div>
                    <div class="cd-tabs-container" id="cd-tabs-container" onscroll="updateCDTabArrows()">
                        <div class="cd-tab active" data-tab="Watches" onclick="switchCDTab('Watches')">Watches</div>
                        <div class="cd-tab" data-tab="Tablets" onclick="switchCDTab('Tablets')">Tablets</div>
                        <div class="cd-tab" data-tab="Data" onclick="switchCDTab('Data')">Data</div>
                        <div class="cd-tab" data-tab="SyncUp Trackers" onclick="switchCDTab('SyncUp Trackers')">Trackers</div>
                        <div class="cd-tab" data-tab="SyncUp Drive" onclick="switchCDTab('SyncUp Drive')">Drive</div>
                    </div>
                    <div class="cd-tabs-arrow right" onclick="scrollCDTabs(1)"><span class="arrow-right"></span></div>
                </div>
                
                <!-- Scrollable content area -->
                <div class="cd-scroll-area" style="flex: 1; overflow-y: auto; min-height: 0;">
                    <!-- Plan List -->
                    <div id="cd-plan-list" class="cd-plan-list">
                        <!-- Populated dynamically -->
                    </div>
                    
                    <!-- Detail Panel (shows after selecting a plan) -->
                    <div id="cd-detail-panel" class="cd-detail-panel">
                        <div class="cd-selected-plan" id="cd-selected-plan-name" onclick="deselectCDPlan()" title="Click to go back">Selected Plan</div>
                        <input type="hidden" id="cd-selected-plan-key">
                        <input type="hidden" id="cd-selected-category">
                        
                        <div class="cd-detail-fields">
                            <div class="input-group">
                                <label class="step-label" style="font-size: 0.9rem;">Quantity</label>
                                <div class="stepper-wrapper" style="width: 100%;">
                                    <button type="button" class="stepper-btn" onclick="updateCDQuantity(-1)"></button>
                                    <input type="number" id="cd-quantity" class="stepper-input" value="1" min="1" max="12" onclick="this.removeAttribute('readonly'); this.select();" onblur="this.setAttribute('readonly', true);">
                                    <button type="button" class="stepper-btn" onclick="updateCDQuantity(1)">+</button>
                                </div>
                            </div>

                            <div class="input-group">
                                <label class="step-label" style="font-size: 0.9rem;">Device Name</label>
                                <div style="display: flex; gap: 8px;">
                                    <input type="text" id="cd-dev-name" placeholder="e.g. Apple Watch SE3" style="flex: 1;" oninput="toggleCDSearchBtn()">
                                    <a id="cd-search-btn" class="btn btn-secondary" style="display: none; padding: 10px 15px; white-space: nowrap; text-decoration: none;" href="#" target="_blank" rel="noopener noreferrer">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <circle cx="11" cy="11" r="8"></circle>
                                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                        </svg>
                                    </a>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 10px;">
                                <div class="input-group" style="flex: 1;">
                                    <label class="step-label" style="font-size: 0.9rem;">Retail ($)</label>
                                    <input type="number" id="cd-dev-cost" min="0" max="9999.99" step="0.01" placeholder="0.00" oninput="updateCDSaveButtonText()">
                                </div>
                                
                                <div class="input-group" style="flex: 1;">
                                    <label class="step-label" style="font-size: 0.9rem;">Promo ($)</label>
                                    <input type="number" id="cd-dev-promo" min="0" max="9999.99" step="0.01" placeholder="0.00">
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 10px;">
                                <div class="input-group" style="flex: 1;">
                                    <label class="step-label" style="font-size: 0.9rem;">Down ($)</label>
                                    <input type="number" id="cd-dev-down" min="0" max="9999.99" step="0.01" placeholder="0.00">
                                </div>
                                
                                <div class="input-group" style="flex: 1;">
                                    <label class="step-label" style="font-size: 0.9rem;">Term</label>
                                    <select id="cd-term">
                                        <option value="24">24 Mo</option>
                                        <option value="36">36 Mo</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Search Box at Bottom (fixed) -->
                <input type="text" id="cd-search-box" class="plan-search-box" placeholder="Search all connected device plans..." oninput="filterCDPlans(this.value)" style="margin-top: 10px; flex-shrink: 0;">
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="cd-save-btn" onclick="saveCDItem(); return false;" style="display:none; width: 100%;">Add Device</button>
            </div>
        </div>
    </div>
    
    <!-- HOME INTERNET MODAL -->
    <div id="hi-modal" class="modal-overlay" onclick="if(event.target === this) closeHIModal()">
        <div class="modal-content">
            <div class="modal-header with-subtitle">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; width: 100%;">
                    <div>
                        <h3>Add Internet Plan</h3>
                        <a href="https://www.t-mobile.com/home-internet/eligibility" target="_blank" style="font-size: 0.75rem; color: var(--primary-color); text-decoration: none; font-weight: 600;">Check Eligibility</a>
                    </div>
                    <button class="modal-header-close" onclick="closeHIModal()"></button>
                </div>
            </div>
            <div class="modal-body">
                <input type="hidden" id="hi-row-id">
                
                <div id="hi-plan-list" class="cd-plan-list" style="max-height: 300px;">
                    <!-- Populated dynamically -->
                </div>
                
                <div id="hi-detail-panel" class="cd-detail-panel">
                    <div class="cd-selected-plan" id="hi-selected-plan-name" onclick="deselectHIPlan()" title="Click to go back">Selected Plan</div>
                    <input type="hidden" id="hi-selected-plan-key">
                    
                    <div class="input-group">
                        <label class="step-label" style="font-size: 0.9rem;">Label (Optional)</label>
                        <input type="text" id="hi-label" placeholder="e.g. Home WiFi">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="hi-save-btn" onclick="saveHIItem()" style="display:none;">Add</button>
            </div>
        </div>
    </div>
    
    <!-- VOICE LINE MODAL -->
    <div id="voice-line-modal" class="modal-overlay" onclick="if(event.target === this) closeVoiceLineModal()">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h3>Add Voice Lines</h3>
                <button class="modal-header-close" onclick="closeVoiceLineModal()"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="voice-line-row-id">
                
                <div class="input-group">
                    <label class="step-label" style="font-size: 0.9rem;">Cost Per Line ($)</label>
                    <input type="number" id="voice-line-cost" min="0" max="9999.99" step="0.01" placeholder="0.00">
                </div>
                
                <div class="input-group">
                    <label class="step-label" style="font-size: 0.9rem;">Number of Lines</label>
                    <div class="stepper-wrapper">
                        <button type="button" class="stepper-btn" onclick="updateVoiceLineQuantity(-1)"></button>
                        <input type="number" id="voice-line-quantity" class="stepper-input" min="1" max="12" value="1" readonly>
                        <button type="button" class="stepper-btn" onclick="updateVoiceLineQuantity(1)">+</button>
                    </div>
                </div>
                
                <div class="input-group">
                    <label class="step-label" style="font-size: 0.9rem;">BOGO Options</label>
                    <div style="display: flex; gap: 10px;">
                        <button id="voice-line-bogo-free" class="btn btn-toggle" onclick="toggleVoiceLineBogo('free')" disabled>BOGO Eligible</button>
                        <button id="voice-line-bogo-10" class="btn btn-toggle" onclick="toggleVoiceLineBogo('ten')" disabled>BOGO $10 Line Eligible</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveVoiceLines()" style="width: 100%;">Add Voice Lines</button>
            </div>
        </div>
    </div>
    
    <!-- PLAN SELECTION MODAL -->
    <div id="plan-modal" class="modal-overlay" onclick="if(event.target === this) closePlanModal()">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="plan-modal-title">Select Plan</h3>
                <button class="modal-header-close" onclick="closePlanModal()"></button>
            </div>
            <div class="modal-body" style="height: 450px; display: flex; flex-direction: column;">
                <input type="hidden" id="plan-modal-row-id">
                <input type="hidden" id="plan-modal-tab" value="Normal">
                
                <!-- Plan Type Tabs -->
                <div class="plan-tabs-wrapper">
                    <div class="plan-tabs-arrow left" onclick="scrollPlanTabs(-1)"><span class="arrow-left"></span></div>
                    <div class="plan-tabs-container" id="plan-tabs-container" onscroll="updatePlanTabArrows()">
                        <div class="plan-tab active" data-plan-type="Normal" onclick="switchPlanTab('Normal')">Consumer</div>
                        <div class="plan-tab" data-plan-type="Business" onclick="switchPlanTab('Business')">Business</div>
                        <div class="plan-tab" data-plan-type="55" onclick="switchPlanTab('55')">55+</div>
                        <div class="plan-tab" data-plan-type="Military" onclick="switchPlanTab('Military')">Military</div>
                        <div class="plan-tab" data-plan-type="FR" onclick="switchPlanTab('FR')">First Responder</div>
                        <div class="plan-tab" data-plan-type="Internet" onclick="switchPlanTab('Internet')">Internet</div>
                    </div>
                    <div class="plan-tabs-arrow right" onclick="scrollPlanTabs(1)"><span class="arrow-right"></span></div>
                    <div class="plan-tabs-scroll-hint"></div>
                </div>
                
                <div id="plan-list-container" style="flex: 1; overflow-y: auto; border: 1px solid #eee; border-radius: 4px; margin-bottom: 10px;">
                    <!-- Plans injected -->
                </div>
                
                <!-- Search at Bottom -->
                <input type="text" id="plan-search-box" class="plan-search-box" placeholder="Search plans..." onkeyup="filterPlanModal(this)">
                
                <!-- Add-ons Page (List View) -->
                <div id="addons-list-page" class="addons-modal-page">
                    <div style="padding: 0; height: 100%; display: flex; flex-direction: column;">
                        <button class="addon-back-btn" onclick="closeAddonsPage()">
                            <span class="addon-back-arrow"></span>
                            <span>Plans</span>
                        </button>
                        
                        <!-- Grey box matching Savings Today style - full height -->
                        <div style="padding: 15px; background: #f9f9f9; border-radius: 8px; border: 1px solid var(--border-color); flex: 1; display: flex; flex-direction: column; overflow-y: auto;">
                            
                            <!-- List of add-ons -->
                            <div id="addon-list-container" style="margin-bottom: 10px; flex: 1; overflow-y: auto; display: flex; flex-direction: column;">
                                <!-- Add-ons injected here or empty state message -->
                            </div>
                            
                            <!-- Add form -->
                            <div style="padding-top: 10px; border-top: 1px dashed var(--border-color); flex-shrink: 0;">
                                <p style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 8px;" id="addon-form-subtitle">Add a new add-on:</p>
                                <input type="hidden" id="addon-edit-index" value="">
                                <div class="input-group" style="margin-bottom: 8px;">
                                    <input type="text" id="addon-name-input" placeholder="e.g., Hotspot" style="font-size: 0.9rem;">
                                </div>
                                <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 10px;">
                                    <input type="number" id="addon-price-input" min="0" step="0.01" placeholder="Price ($)" style="flex: 1; font-size: 0.9rem;">
                                    <div class="stepper-wrapper" style="width: 120px;">
                                        <button type="button" class="stepper-btn" onclick="updateAddonQty(-1)"></button>
                                        <input type="number" id="addon-amount-input" class="stepper-input" min="1" max="12" value="1" style="font-size: 0.9rem;">
                                        <button type="button" class="stepper-btn" onclick="updateAddonQty(1)">+</button>
                                    </div>
                                </div>
                                <button class="btn btn-primary" onclick="saveAddon()" style="width: 100%; padding: 10px 16px;">Add</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- No separate form page needed anymore -->
                <div id="addons-form-page" class="addons-modal-page" style="display: none;">
                </div>
            </div>
            <div class="modal-footer" style="flex-direction: column; gap: 10px;">
                <button class="btn btn-secondary" id="manage-addons-link" onclick="openAddonsPage()" style="width: 100%;">
                    Manage Add-ons 
                </button>
                <button class="btn btn-primary" id="plan-modal-add-btn" onclick="openAddonsFormPage()" style="display: none; width: 100%;">Add</button>
            </div>
        </div>
    </div>

    <!-- PROTECTION MODAL (Full Screen) -->
    <div id="protection-modal" class="modal-overlay" onclick="if(event.target === this) closeProtectionModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>Quote Settings</h3>
                <button class="modal-header-close" onclick="closeProtectionModal()">&times;</button>
            </div>
            <input type="hidden" id="prot-row-id">
            <div class="modal-body" style="display: flex; flex-direction: column;">
                <input type="hidden" id="prot-modal-tab" value="Protection">
                
                <!-- Settings Tabs -->
                <div class="plan-tabs-wrapper" style="flex-shrink: 0;">
                    <div class="plan-tabs-container" style="overflow-x: visible;">
                        <div class="plan-tab active" data-settings-tab="Protection" onclick="switchSettingsTab('Protection')">Protection</div>
                        <div class="plan-tab" data-settings-tab="Misc" id="misc-tab" onclick="switchSettingsTab('Misc')">Misc</div>
                        <div class="plan-tab" data-settings-tab="Competitor" id="competitor-tab" onclick="switchSettingsTab('Competitor')">Competitor</div>
                    </div>
                </div>
                
                <!-- Protection Tab Content -->
                <div id="prot-protection-content" class="prot-tab-content" style="display: block;">
                    <!-- Protection Info Links -->
                    <div style="padding-bottom:15px; margin-bottom:15px; border-bottom:1px solid #eee; text-align: center;">
                        <a href="https://magentapulse.t-mobile.com/us/en/customer-support/device-programs/device-protection" target="_blank" style="color: var(--primary-color); text-decoration: none; font-weight: 600; font-size: 0.95rem;">
                            Protection Info
                        </a>
                        <span style="color: #ccc; margin: 0 10px;">|</span>
                        <a href="https://cts.assurant.com/ctsclient/tmo/devicereplacementcalc/default.aspx" target="_blank" style="color: var(--primary-color); text-decoration: none; font-weight: 600; font-size: 0.95rem;">
                            Savings Calculator
                        </a>
                    </div>
                    
                    <!-- Show Label Toggle -->
                    <div id="prot-show-label-wrapper" style="display:flex; justify-content:space-between; align-items:center; padding-bottom:15px; margin-bottom:15px; border-bottom:1px solid #eee;">
                        <span style="font-weight:600; font-size:0.95rem; color:var(--text-main);">Show Label</span>
                        <label class="switch-sm">
                            <input type="checkbox" id="prot-show-label" checked onchange="toggleShowLabel(this)">
                            <span class="slider-sm"></span>
                        </label>
                    </div>
                    
                    <!-- Display Standard Protection Toggle -->
                    <div id="prot-show-standard-wrapper" style="display:flex; justify-content:space-between; align-items:center; padding-bottom:15px; margin-bottom:15px; border-bottom:1px solid #eee;">
                        <span style="font-weight:600; font-size:0.95rem; color:var(--text-main);">Display Standard Protection</span>
                        <label class="switch-sm">
                            <input type="checkbox" id="prot-show-standard" onchange="toggleShowStandardProtection(this)">
                            <span class="slider-sm"></span>
                        </label>
                    </div>
                    
                    <!-- Display Unprotected Pricing Toggle -->
                    <div id="prot-show-unprotected-wrapper" style="display:flex; justify-content:space-between; align-items:center; padding-bottom:15px; margin-bottom:15px; border-bottom:1px solid #eee;">
                        <span style="font-weight:600; font-size:0.95rem; color:var(--text-main);">Display Non-Protected Pricing</span>
                        <label class="switch-sm">
                            <input type="checkbox" id="prot-show-unprotected" onchange="toggleShowUnprotected(this)">
                            <span class="slider-sm"></span>
                        </label>
                    </div>

                    <div id="prot-device-list" class="prot-list">
                        <!-- Injected here -->
                    </div>
                </div>
                
                <!-- Misc Tab Content -->
                <div id="prot-misc-content" class="prot-tab-content" style="display: none;">
                    
                    
                    <div id="misc-taxes-row" style="display:flex; justify-content:space-between; align-items:center; padding:12px 0; border-bottom:1px solid #eee;">
                        <span style="font-weight:600; font-size:0.95rem; color:var(--text-main);">Taxes Included</span>
                        <label class="switch-sm">
                            <input type="checkbox" id="prot-taxes-included" onchange="handleMiscTaxesChange()">
                            <span class="slider-sm"></span>
                        </label>
                    </div>
                    
                    <div id="misc-autopay-row" style="display:flex; justify-content:space-between; align-items:center; padding:12px 0; border-bottom:1px solid #eee;">
                        <span style="font-weight:600; font-size:0.95rem; color:var(--text-main);">Autopay Enabled</span>
                        <label class="switch-sm">
                            <input type="checkbox" id="prot-has-autopay" onchange="handleMiscAutopayChange()">
                            <span class="slider-sm"></span>
                        </label>
                    </div>
                    
                    <div id="misc-business-row" style="display:flex; justify-content:space-between; align-items:center; padding:12px 0; border-bottom:1px solid #eee;">
                        <span style="font-weight:600; font-size:0.95rem; color:var(--text-main);">Business Plan</span>
                        <label class="switch-sm">
                            <input type="checkbox" id="prot-is-business" onchange="handleMiscBusinessChange()">
                            <span class="slider-sm"></span>
                        </label>
                    </div>
                    
                    <div id="misc-beyond-row" style="display:flex; justify-content:space-between; align-items:center; padding:12px 0; border-bottom:1px solid #eee;">
                        <span style="font-weight:600; font-size:0.95rem; color:var(--text-main);">Beyond/Next Savings</span>
                        <label class="switch-sm">
                            <input type="checkbox" id="prot-beyond-savings" onchange="handleMiscBeyondChange()">
                            <span class="slider-sm"></span>
                        </label>
                    </div>
                </div>
                
                <!-- Competitor Tab Content -->
                <div id="prot-competitor-content" class="prot-tab-content" style="display: none;">
                    <!-- Competitor Info Link -->
                    
                    <div style="display:flex; gap:10px; align-items:flex-end;">
                        <div style="flex:1;">
                            <label style="font-size:0.8rem; color:var(--text-secondary); display:block; margin-bottom:4px;">Carrier Name</label>
                            <select id="prot-carrier-name" style="width:100%; padding:10px; border:2px solid var(--border-color); border-radius:4px; font-size:0.95rem; background:white;">
                                <option value="">Select Carrier...</option>
                                <option value="Verizon">Verizon</option>
                                <option value="AT&T">AT&T</option>
                                <option value="Spectrum">Spectrum</option>
                                <option value="Xfinity">Xfinity</option>
                                <option value="Google Fi">Google Fi</option>
                                <option value="Consumer Cellular">Consumer Cellular</option>
                                <option value="Boost">Boost</option>
                                <option value="Mint">Mint</option>
                                <option value="Cricket">Cricket</option>
                                <option value="Visible">Visible</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div style="flex:1;">
                            <label style="font-size:0.8rem; color:var(--text-secondary); display:block; margin-bottom:4px;">Monthly Price ($)</label>
                            <input type="number" id="prot-carrier-price" placeholder="0.00" min="0" step="0.01" style="width:100%; padding:10px; border:2px solid var(--border-color); border-radius:4px; font-size:0.95rem;">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- DISCOUNT MODAL (Full Screen) -->
    <div id="discount-modal" class="modal-overlay" onclick="if(event.target === this) closeDiscountModal()">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Discount</h3>
                <button class="modal-header-close" onclick="closeDiscountModal()"></button>
                <input type="hidden" id="disc-row-id">
            </div>
            <div class="modal-body">
                <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 15px;">Select a discount to apply to this quote:</p>
                <div id="disc-list" class="prot-list">
                    <!-- Injected here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- MANUAL DISCOUNT MODAL (Existing Mode) -->
    <div id="manual-discount-modal" class="modal-overlay" onclick="if(event.target === this) closeManualDiscountModal()">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3>Add Discount</h3>
                <button class="modal-header-close" onclick="closeManualDiscountModal()"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="manual-disc-row-id">
                
                <div class="input-group">
                    <label class="step-label" style="font-size: 0.9rem;">Discount Name</label>
                    <input type="text" id="manual-disc-name" placeholder="e.g. Employee Discount">
                </div>
                
                <div class="input-group">
                    <label class="step-label" style="font-size: 0.9rem;">Amount ($)</label>
                    <input type="number" id="manual-disc-amount" min="0" step="0.01" placeholder="0.00">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveManualDiscountItem()" style="width: 100%;">Add Discount</button>
            </div>
        </div>
    </div>

    <!-- REBATE MODAL (Add Rebate) -->
    <div id="rebate-modal" class="modal-overlay" onclick="if(event.target === this) closeRebateModal()">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Rebate</h3>
                <button class="modal-header-close" onclick="closeRebateModal()"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="rebate-row-id">
                <input type="hidden" id="rebate-pill-selected" value="">
                
                <!-- Rebate Type Pills -->
                <div class="rebate-pills" style="display: flex; gap: 8px; width: 100%;">
                    <div class="rebate-pill" style="flex: 1; text-align: center;" data-pill="Sam's Club" onclick="selectRebatePill(this, 'Sam\'s Club')">Sam's Club</div>
                    <div class="rebate-pill" style="flex: 1; text-align: center;" data-pill="T-Mobile" onclick="selectRebatePill(this, 'T-Mobile')">T-Mobile</div>
                    <div class="rebate-pill" style="flex: 1; text-align: center;" data-pill="Mastercard" onclick="selectRebatePill(this, 'Mastercard')">Mastercard</div>
                </div>
                
                <div class="input-group">
                    <label class="step-label">Rebate Name</label>
                    <input type="text" id="rebate-modal-name" placeholder="e.g. Gift Card">
                </div>
                <div class="input-group">
                    <label class="step-label">Amount ($)</label>
                    <input type="number" id="rebate-modal-value" placeholder="0.00">
                </div>
                <div class="input-group">
                    <label class="step-label">Quantity</label>
                     <div class="stepper-wrapper">
                        <button class="stepper-btn" onclick="updateRebateModalCount(-1)"></button>
                        <input type="number" id="rebate-modal-count" class="stepper-input" value="1" readonly>
                        <button class="stepper-btn" onclick="updateRebateModalCount(1)">+</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveRebateItem()" style="width: 100%;">Add Rebate</button>
            </div>
        </div>
    </div>

    <!-- ACCESSORIES MODAL -->
    <div id="accessories-modal" class="modal-overlay" onclick="if(event.target === this) closeAccessoriesModal()">
        <div class="modal-content" style="max-width: 500px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3>Accessories</h3>
                <button class="modal-header-close" onclick="closeAccessoriesModal()"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="acc-row-id">
                
                <!-- List of existing accessories -->
                <div id="acc-existing-list" style="margin-bottom: 20px;"></div>
                
                <hr style="margin: 15px 0; border: 0; border-top: 1px solid #eee;">
                
                <!-- Accessory Preset Pills -->
                <div class="accessory-pills" style="display: flex; gap: 8px; width: 100%;">
                    <div class="acc-pill" style="flex: 1; text-align: center;" onclick="selectAccessoryPill('Screen Protector')">Screen Protector</div>
                    <div class="acc-pill" style="flex: 1; text-align: center;" onclick="selectAccessoryPill('Case')">Case</div>
                    <div class="acc-pill" style="flex: 1; text-align: center;" onclick="selectAccessoryPill('Charger')">Charger</div>
                </div>
                
                <div class="input-group">
                    <label class="step-label" style="font-size: 0.9rem;">Accessory Name</label>
                    <input type="text" id="acc-name" placeholder="e.g. Screen Protector">
                </div>
                
                <div style="display: flex; gap: 15px;">
                    <div class="input-group" style="flex: 1;">
                        <label class="step-label" style="font-size: 0.9rem;">Price ($)</label>
                        <input type="number" id="acc-price" min="0" step="0.01" placeholder="0.00">
                    </div>
                    
                    <div class="input-group" style="flex: 1;">
                        <label class="step-label" style="font-size: 0.9rem;">Quantity</label>
                        <div class="stepper-wrapper">
                            <button class="stepper-btn" onclick="updateAccQty(-1)"></button>
                            <input type="number" id="acc-qty" class="stepper-input" value="1" min="1" readonly>
                            <button class="stepper-btn" onclick="updateAccQty(1)">+</button>
                        </div>
                    </div>
                </div>
                
                <div class="input-group">
                    <label class="step-label" style="font-size: 0.9rem;">Payment Method</label>
                    <div class="radio-group" style="display: flex; gap: 20px; margin-top: 8px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="radio" name="acc-payment" value="finance" checked> 
                            Finance (12 months)
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="radio" name="acc-payment" value="today"> 
                            Due Today
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveAccessoryItem()" style="width: 100%;">Add Accessory</button>
            </div>
        </div>
    </div>

    <!-- DUE TODAY MODAL -->
    <div id="due-today-modal" class="modal-overlay" onclick="if(event.target === this) closeDueTodayModal()">
        <div class="modal-content" style="max-width: 500px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3>Today Pricing</h3>
                <button class="modal-header-close" onclick="closeDueTodayModal()"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="due-today-row-id">
                
                <!-- Tax Percentage -->
                <div class="input-group" style="margin-bottom: 20px; padding: 15px; background: #f9f9f9; border-radius: 8px; border: 1px solid var(--border-color);">
                    <p style="font-size: 0.9rem; color: var(--text-main); font-weight: 700; margin-bottom: 10px;">Tax Percentage</p>
                    <p style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 10px;">Applied to retail price of devices, accessories & connected devices</p>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="number" id="tax-percentage" class="settings-input" placeholder="0" min="0" max="100" step="0.01" onchange="updateTaxPercentage(this.value)" onfocus="if(this.value==='0')this.value=''" style="flex: 1; padding: 10px;">
                        <span style="font-weight: 600; color: var(--text-secondary);">%</span>
                    </div>
                </div>
                
                <!-- Savings Today Section -->
                <div style="padding: 15px; background: #f9f9f9; border-radius: 8px; border: 1px solid var(--border-color); margin-bottom: 20px;">
                    <p style="font-size: 0.9rem; color: var(--text-main); font-weight: 700; margin-bottom: 10px;">Savings Today</p>
                    
                    <!-- Summary of saved today items -->
                    <div id="saved-today-items-list" style="margin-bottom: 10px;"></div>
                    
                    <!-- Add saved today item form -->
                    <div style="padding-top: 10px; border-top: 1px dashed var(--border-color);">
                        <div class="input-group" style="margin-bottom: 8px;">
                            <input type="text" id="saved-today-desc" placeholder="e.g. Activation Fee Waived" style="font-size: 0.9rem;">
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                            <input type="number" id="saved-today-amount-input" min="0" step="0.01" placeholder="0.00" style="flex: 1; font-size: 0.9rem;">
                            <span style="font-size: 0.8rem; color: var(--text-secondary);"></span>
                            <div class="stepper-wrapper" style="width: auto;">
                                <button type="button" class="stepper-btn" onclick="updateSavedTodayQty(-1)"></button>
                                <input type="number" id="saved-today-qty" class="stepper-input" min="1" max="99" value="1" style="width: 40px;" readonly>
                                <button type="button" class="stepper-btn" onclick="updateSavedTodayQty(1)">+</button>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="addSavedTodayItem()" style="width: 100%;">Add</button>
                    </div>
                </div>
                
                <!-- Due Today Section -->
                <div style="padding: 15px; background: #f9f9f9; border-radius: 8px; border: 1px solid var(--border-color); margin-bottom: 20px;">
                    <p style="font-size: 0.9rem; color: var(--text-main); font-weight: 700; margin-bottom: 10px;">Due Today</p>
                    
                    <!-- Summary of items due today -->
                    <div id="due-today-items-list" style="margin-bottom: 10px;"></div>
                    
                    <!-- Add due today item form -->
                    <div style="padding-top: 10px; border-top: 1px dashed var(--border-color);">
                        <div class="input-group" style="margin-bottom: 8px;">
                            <input type="text" id="due-today-desc" placeholder="e.g. DCC" style="font-size: 0.9rem;">
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                            <input type="number" id="due-today-amount" min="0" step="0.01" placeholder="0.00" style="flex: 1; font-size: 0.9rem;">
                            <span style="font-size: 0.8rem; color: var(--text-secondary);"></span>
                            <div class="stepper-wrapper" style="width: auto;">
                                <button type="button" class="stepper-btn" onclick="updateDueTodayQty(-1)"></button>
                                <input type="number" id="due-today-qty" class="stepper-input" min="1" max="99" value="1" style="width: 40px;" readonly>
                                <button type="button" class="stepper-btn" onclick="updateDueTodayQty(1)">+</button>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="addDueTodayItem()" style="width: 100%;">Add</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CONTACT INFO MODAL -->
    <div id="contact-modal" class="modal-overlay" onclick="if(event.target === this) closeContactModal()">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Contact Information</h3>
                <button class="modal-header-close" onclick="closeContactModal()"></button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label class="step-label" style="font-size: 0.9rem;">Your Name (Rep)</label>
                    <input type="text" id="contact-rep-name" placeholder="John Doe" onchange="saveSettingsToURL()">
                </div>
                <div class="input-group">
                    <label class="step-label" style="font-size: 0.9rem;">Your Phone Number</label>
                    <input type="tel" id="contact-rep-phone" placeholder="555-123-4567" oninput="formatPhone(this)" onchange="saveSettingsToURL()">
                </div>
                <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">
                <div class="input-group">
                    <label class="step-label" style="font-size: 0.9rem;">Customer Name</label>
                    <input type="text" id="contact-cust-name" placeholder="Jane Smith">
                </div>
                <div class="input-group">
                    <label class="step-label" style="font-size: 0.9rem;">Customer Phone Number</label>
                    <input type="tel" id="contact-cust-phone" placeholder="555-987-6543" oninput="formatPhone(this)">
                </div>
                <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">
                <div class="input-group" style="display: flex; justify-content: space-between; align-items: center;">
                    <label class="step-label" style="font-size: 0.9rem; margin-bottom: 0;">Include Benefits Page</label>
                    <label class="switch-sm">
                        <input type="checkbox" id="include-benefits-page" onchange="saveSettingsToURL()">
                        <span class="slider-sm"></span>
                    </label>
                </div>
                <p style="font-size: 0.75rem; color: var(--text-secondary); margin: 5px 0 0 0; line-height: 1.4;">Includes configuration on the compare page. If none are selected, it'll include the current plan with the next step higher.</p>
                <div class="input-group" style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                    <label class="step-label" style="font-size: 0.9rem; margin-bottom: 0;">Include Store Address</label>
                    <label class="switch-sm">
                        <input type="checkbox" id="include-store-address" onchange="saveSettingsToURL()">
                        <span class="slider-sm"></span>
                    </label>
                </div>
                <p style="font-size: 0.75rem; color: var(--text-secondary); margin: 5px 0 0 0; line-height: 1.4;">Configurable in the Rules menu</p>
            </div>
            <div class="modal-footer" style="justify-content: flex-end; gap: 10px;">
                <button id="save-quote-btn" class="btn btn-secondary" onclick="saveQuoteToFile()" style="display: flex; align-items: center; gap: 6px;">
                    <span id="save-quote-text">Save</span>
                </button>
                <button class="btn btn-primary" onclick="finalizePrint()">Print Quote</button>
            </div>
        </div>
    </div>
    
    <!-- LOAD QUOTE MODAL -->
    <div id="load-quote-modal" class="modal-overlay" onclick="if(event.target === this) closeLoadQuoteModal()">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3>Load Quote</h3>
                <button class="modal-header-close" onclick="closeLoadQuoteModal()"></button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; padding: 20px; background: #f9f9f9; border-radius: 8px; border: 2px dashed var(--border-color);">
                    <p style="margin: 0 0 15px 0; font-size: 0.9rem; color: var(--text-secondary);">Upload a previously saved quote file:</p>
                    <label class="btn btn-primary" style="display: inline-block; cursor: pointer;">
                        Choose Quote File
                        <input type="file" id="quote-file-input" accept=".json,.quote" style="display: none;" onchange="loadQuoteFromFile(this)">
                    </label>
                </div>
                <div id="load-result" class="scan-result" style="display: none;">
                    <span id="load-result-text"></span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- QUOTE SELECTION MODAL -->
    <div id="quote-select-modal" class="modal-overlay" onclick="if(event.target === this) closeQuoteSelectModal()">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>Compare Quotes</h3>
                <button class="modal-header-close" onclick="closeQuoteSelectModal()"></button>
            </div>
            <div class="modal-body">
                <div class="quote-select-count" id="quote-select-count">0 of 2 selected</div>
                <div class="quote-select-list" id="quote-select-list">
                    <!-- Populated dynamically -->
                </div>
                <button class="btn btn-primary" id="quote-compare-confirm-btn" onclick="confirmQuoteComparison()" disabled style="width: 100%;">Compare Selected Quotes</button>
            </div>
        </div>
    </div>
    
    </div><!-- End app-container -->


    <script>
        // ============================================
        // PLAN DATA - Add "beyond: true/false" to specify Beyond plans
        // planType: 'Normal', '55', 'Business', 'Military', 'FR'
        // minLines: minimum number of lines required (optional)
        // ============================================
       const PLANS_DATA = {
            // Consumer (Normal) Plans
            // Add 'benefitsPage' to use a custom benefits page (e.g., benefitsPage: 'essentialsBenefitsPage')
            // Add 'notes' to display text beside plan name (e.g., notes: 'Minimum of 2 Port Ins')
            "Experience Beyond": { costs: [105, 75, 50, 50, 50, 50, 50, 50, 55, 55, 55, 55], maxLines: 12, freeLineEligible: true, beyond: true, planType: 'Normal' },
            "Experience More": { costs: [90, 60, 35, 35, 35, 35, 35, 35, 40, 40, 40, 40], maxLines: 12, freeLineEligible: true, beyond: false, planType: 'Normal' },
            "Better Value": { costs: [5, 5, 145, 35, 35, 35, 35, 35, 40, 40, 40, 40], minLines: 3, maxLines: 12, freeLineEligible: false, beyond: true, planType: 'Normal', notes: 'Min 2 Port-Ins' },
            "Essentials": { costs: [65, 35, 20, 20, 20, 20], maxLines: 6, freeLineEligible: true, beyond: false, planType: 'Normal' },
            "Essentials Saver": { costs: [55, 35], maxLines: 2, freeLineEligible: false, beyond: false, planType: 'Normal' },
            "Unlimited Talk & Text Only": { costs: [20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20], autopayEligible: false, maxAutopayLines: 0, maxLines: 12, freeLineEligible: false, beyond: false, planType: 'Normal' },
            "4 For 100": { costs: [5, 5, 5, 105, 30, 30], minLines: 4, maxLines: 6, freeLineEligible: false, beyond: false, planType: 'Normal' },
            
            // 55+ Plans
            "Experience Beyond 55 Savings": { costs: [90, 50], maxLines: 2, freeLineEligible: false, beyond: true, planType: '55', keywords: ['senior', 'seniors', 'elderly', 'older', 'retirement', 'retired', 'aarp'] },
            "Experience More 55 Savings": { costs: [75, 45], maxLines: 2, freeLineEligible: false, beyond: false, planType: '55', keywords: ['senior', 'seniors', 'elderly', 'older', 'retirement', 'retired', 'aarp'] },
            "Essentials Choice 55 Savings": { costs: [50, 20], maxLines: 2, freeLineEligible: false, beyond: false, planType: '55', keywords: ['senior', 'seniors', 'elderly', 'older', 'retirement', 'retired', 'aarp'] },
            
            // Military Plans
            // keywords: array of alternate search terms (e.g., 'vet' for military plans)
            "Experience Beyond Military Savings": { costs: [90, 50, 40, 40, 40, 40, 50, 50, 50, 50, 50, 50], maxLines: 12, freeLineEligible: false, beyond: true, planType: 'Military', keywords: ['vet', 'veteran', 'army', 'navy', 'marine', 'air force', 'coast guard', 'national guard', 'reserves'] },
            "Experience More Military Savings": { costs: [75, 35, 25, 25, 25, 25, 35, 35, 35, 35, 35, 35], maxLines: 12, freeLineEligible: false, beyond: false, planType: 'Military', keywords: ['vet', 'veteran', 'army', 'navy', 'marine', 'air force', 'coast guard', 'national guard', 'reserves'] },
            "Essentials Military Savings": { costs: [50, 40, 15, 15, 15, 15], maxLines: 6, freeLineEligible: false, beyond: false, planType: 'Military', keywords: ['vet', 'veteran', 'army', 'navy', 'marine', 'air force', 'coast guard', 'national guard', 'reserves'] },
            
            // First Responder Plans
            "Experience Beyond First Responder": { costs: [90, 50, 40, 40, 40, 40, 50, 50, 50, 50, 50, 50], maxLines: 12, freeLineEligible: false, beyond: true, planType: 'FR', keywords: ['police', 'fire', 'firefighter', 'emt', 'paramedic', 'nurse', 'doctor', 'healthcare', 'emergency', '911', 'dispatcher'] },
            "Experience More First Responder": { costs: [75, 35, 25, 25, 25, 25, 35, 35, 35, 35, 35, 35], maxLines: 12, freeLineEligible: false, beyond: false, planType: 'FR', keywords: ['police', 'fire', 'firefighter', 'emt', 'paramedic', 'nurse', 'doctor', 'healthcare', 'emergency', '911', 'dispatcher'] },
            "Essentials First Responder": { costs: [50, 40, 15, 15, 15, 15], maxLines: 6, freeLineEligible: false, beyond: false, planType: 'FR', keywords: ['police', 'fire', 'firefighter', 'emt', 'paramedic', 'nurse', 'doctor', 'healthcare', 'emergency', '911', 'dispatcher'] },
            
             // Business Plans
            "Experience Beyond for Business": {costs: [105, 75, 50, 50, 50], notes:'No Autopay >5', maxLines: 12, maxAutopayLines: 5, removeAutopayAfterMax: true, ManualPricing: {6:55}, freeLineEligible: true, beyond: true, planType: 'Business' },
            "Experience Beyond w/ FR Savings for Business": { costs: [90, 50, 40, 40, 40, 40, 50, 50, 50, 50, 50, 50], maxLines: 12, freeLineEligible: false, beyond: true, planType: 'Business', keywords: ['police', 'fire', 'firefighter', 'emt', 'paramedic', 'nurse', 'doctor', 'healthcare', 'emergency', '911', 'dispatcher'] },
            "Experience Beyond w/ Military Savings for Business": { costs: [90, 50, 40, 40, 40, 40, 50, 50, 50, 50, 50, 50], maxLines: 12, freeLineEligible: false, beyond: true, planType: 'Business', keywords: ['vet', 'veteran', 'army', 'navy', 'marine', 'air force', 'coast guard', 'national guard', 'reserves'] },
            "Experience More for Business": { costs: [90, 60, 35, 35, 35], notes:'No Autopay >5', maxLines: 12, maxAutopayLines: 5, removeAutopayAfterMax: true, ManualPricing: {6:45}, freeLineEligible: true, beyond: false, planType: 'Business' },
            "Experience More w/ FR Savings for Business": { costs: [75, 35, 25, 25, 25, 25, 35, 35, 35, 35, 35, 35], maxLines: 12, freeLineEligible: false, beyond: false, planType: 'Business', keywords: ['police', 'fire', 'firefighter', 'emt', 'paramedic', 'nurse', 'doctor', 'healthcare', 'emergency', '911', 'dispatcher'] },
            "Experience More w/ Military Savings for Business": { costs: [75, 35, 25, 25, 25, 25, 35, 35, 35, 35, 35, 35], maxLines: 12, freeLineEligible: false, beyond: false, planType: 'Business', keywords: ['vet', 'veteran', 'army', 'navy', 'marine', 'air force', 'coast guard', 'national guard', 'reserves'] },
            "Better Value for Business": { costs: [5, 5, 145, 35, 35, 45, 45, 45, 45, 45, 45, 45], minLines: 3, maxLines: 12, maxAutopayLines: 5, freeLineEligible: false, beyond: true, planType: 'Business', notes: 'Autopay eligible 1-5; Min 2 Port-Ins' },
            "CoreMobile for Business": { costs: [65, 35, 20, 20, 20], notes:'No Autopay >5', maxLines: 12, maxAutopayLines: 5, removeAutopayAfterMax: true, ManualPricing: {6:25}, freeLineEligible: true, beyond: false, planType: 'Business' },
            "Unlimited Select 4 For 100 for Business": { costs: [5, 5, 5, 105, 30, 30], minLines: 4, maxLines: 6, freeLineEligible: false, beyond: false, planType: 'Business' },
            "Select Savings for Business": { costs: [55, 35, 15, 15, 15, 15], maxLines: 6, freeLineEligible: false, beyond: false, planType: 'Business' },
        };

        const PREMIUM_PLANS = ["Experience Beyond", "Experience More", "Experience Beyond for Business", "Experience More for Business"];

        // Mapping of special plans to their base versions for savings calculation
        const PLAN_BASE_MAPPING = {
            // 55+ Plans -> Base Plans
            "Experience Beyond 55 Savings": "Experience Beyond",
            "Experience More 55 Savings": "Experience More",
            "Essentials Choice 55 Savings": "Essentials",
            // Military Plans -> Base Plans
            "Experience Beyond Military Savings": "Experience Beyond",
            "Experience More Military Savings": "Experience More",
            "Essentials Military Savings": "Essentials",
            // First Responder Plans -> Base Plans
            "Experience Beyond First Responder": "Experience Beyond",
            "Experience More First Responder": "Experience More",
            "Essentials First Responder": "Essentials",
            // Business Plans
            "Experience Beyond w/ FR Savings for Business": "Experience Beyond for Business",
            "Experience Beyond w/ Military Savings for Business": "Experience Beyond for Business",
            "Experience More w/ FR Savings for Business": "Experience More for Business",
            "Experience More w/ Military Savings for Business": "Experience More for Business"
        };
        
        // Get the savings label based on plan type
        function getPlanSavingsLabel(planName) {
            if (!planName || !PLANS_DATA[planName]) return null;
            const planType = PLANS_DATA[planName].planType;
            switch(planType) {
                case '55': return '55+ Plan Savings';
                case 'Military': return 'Military Savings';
                case 'FR': return 'First Responder Savings';
                default: return null;
            }
        }
        
        // Calculate plan type savings compared to base plan
        function calculatePlanTypeSavings(planName, lineCount) {
            if (!planName || !PLAN_BASE_MAPPING[planName] || lineCount <= 0) return 0;
            
            const basePlanName = PLAN_BASE_MAPPING[planName];
            const basePlan = PLANS_DATA[basePlanName];
            const specialPlan = PLANS_DATA[planName];
            
            if (!basePlan || !specialPlan) return 0;
            
            // Calculate cost for base plan
            let baseCost = 0;
            const baseMaxLines = Math.min(lineCount, basePlan.maxLines);
            for (let i = 0; i < baseMaxLines; i++) {
                const costIndex = i < basePlan.costs.length ? i : basePlan.costs.length - 1;
                baseCost += basePlan.costs[costIndex];
            }
            
            // Calculate cost for special plan
            let specialCost = 0;
            const specialMaxLines = Math.min(lineCount, specialPlan.maxLines);
            for (let i = 0; i < specialMaxLines; i++) {
                const costIndex = i < specialPlan.costs.length ? i : specialPlan.costs.length - 1;
                specialCost += specialPlan.costs[costIndex];
            }
            
            return Math.max(0, baseCost - specialCost);
        }

        // ============================================
        // PLAN COMPARISON DATA
        // Configure plans available for comparison and their benefits
        // 
        // PLAN FORMAT:
        //   displayName: The name shown in the UI (optional, defaults to key)
        //   weight: Plan-level weight for header highlighting (optional, default: 0)
        //           When comparing two plans, the one with higher weight gets magenta header
        //   benefits: Object containing all benefits for this plan
        //
        // BENEFIT FORMAT:
        // Each benefit can be a simple string OR an object with these properties:
        //   title: (uses the key if not specified)
        //   titleStyle: CSS styles for the title (optional)
        //   subtext: Text shown below/after the title in parentheses (optional)
        //   subtextStyle: CSS styles for the subtext (optional)
        //   value: The benefit value (required) - can be string or object
        //   valueSubtext: Subtext for the value (optional)
        //   valueStyle: CSS styles for the value (optional)
        //   valueSubtextStyle: CSS styles for the value subtext (optional)
        //   weight: Number to determine highlighting priority when comparing (optional, default: 0)
        //           Higher weight = magenta background when comparing against lower weight
        //           Useful for highlighting "more" of something (e.g., 250GB hotspot vs 60GB)
        //   hidden: If true, benefit is only shown when comparing against a plan that has
        //           the same benefit NOT hidden (optional, default: false)
        //           Use this for "Not included" benefits - they'll only appear when
        //           comparing against a plan that actually has the benefit
        //
        // EXAMPLES:
        //   Simple:     "Phone Upgrades": "Every 2 years"
        //   With style: "Netflix": { subtext: "Standard with ads", subtextStyle: "color: red", value: "Included" }
        //   Full:       "Mobile Hotspot": { value: "60GB", valueSubtext: "High-speed mobile hotspot / line" }
        //   Weighted:   "Mobile Hotspot": { value: "250GB", weight: 2 }  // Will highlight over weight: 1
        //   Plan weight: "Experience Beyond": { weight: 2, displayName: "Experience Beyond", benefits: {...} }
        //   Hidden:     "HULU": { value: "Not included", hidden: true }  // Only shows in comparison
        // ============================================
        const COMPARISON_PLANS = {
            "Experience Beyond w/ Military Savings for Business": {
                displayName: "Experience Beyond w/ Military Savings for Business",
                weight: 100,
                benefits: {
                    "Phone Upgrades": { value: "Every 1 year", weight: 3 },
                    "T-Priority": { value: "Included", weight: 1 },
                    "Data": { value: "Unlimited high-speed 5G", valueSubtext: "With unlimited premium data", weight: 3 },
                    "Mobile Hotspot": { value: "300GB High-speed / line", valueSubtext: "Then unlimited at 600KBPS", weight: 5 },
                    "T-Satellite": { value: "Included", weight: 2 },
                    "HULU": { subtext: "With ads", value: "Included", weight: 1 },
                    "Apple TV": { subtext: "Discounted to $3/month", value: "Included", valueSubtext: "With sole prop accounts", weight: 1 },
                    "Netflix": { subtext: "Standard with ads", value: "Netflix or Microsoft 365", valueSubtext: "Netflix available on accounts with 1-5 lines | Microsoft 365 standard license", weight: 2 },
                    "Video Streaming": { value: "Up to 4K UHD", weight: 3 },
                    "Threat Protect": { value: "Included", weight: 3 },
                    "Traveling Abroad": { value: "15GB high-speed data", valueSubtext: "Then unlimited data of up to 256KBPS in 215+ countries & unlimited texting", weight: 3 },
                    "Canada & Mexico": { value: "30GB high-speed data", valueSubtext: "Then unlimited data of up to 256KBPS, plus unlimited talk & text", weight: 3 },
                    "In-flight Wi-Fi Connection": { value: "Premium experience", weight: 3 },
                    "Scam Shield": { value: "Premium experience", weight: 3 },
                    "1 Year AAA Membership": { value: "Included", weight: 1 },
                    "5-Year Price Guarantee": { value: "Included", weight: 2 },
                }
            },
            "Experience Beyond w/ FR Savings for Business": {
                displayName: "Experience Beyond w/ FR Savings for Business",
                weight: 100,
                benefits: {
                    "Phone Upgrades": { value: "Every 1 year", weight: 3 },
                    "T-Priority": { value: "Included", weight: 1 },
                    "Data": { value: "Unlimited high-speed 5G", valueSubtext: "With unlimited premium data", weight: 3 },
                    "Mobile Hotspot": { value: "300GB High-speed / line", valueSubtext: "Then unlimited at 600KBPS", weight: 5 },
                    "T-Satellite": { value: "Included", weight: 2 },
                    "HULU": { subtext: "With ads", value: "Included", weight: 1 },
                    "Apple TV": { subtext: "Discounted to $3/month", value: "Included", valueSubtext: "With sole prop accounts", weight: 1 },
                    "Netflix": { subtext: "Standard with ads", value: "Netflix or Microsoft 365", valueSubtext: "Netflix available on accounts with 1-5 lines | Microsoft 365 standard license", weight: 2 },
                    "Video Streaming": { value: "Up to 4K UHD", weight: 3 },
                    "Threat Protect": { value: "Included", weight: 3 },
                    "Traveling Abroad": { value: "15GB high-speed data", valueSubtext: "Then unlimited data of up to 256KBPS in 215+ countries & unlimited texting", weight: 3 },
                    "Canada & Mexico": { value: "30GB high-speed data", valueSubtext: "Then unlimited data of up to 256KBPS, plus unlimited talk & text", weight: 3 },
                    "In-flight Wi-Fi Connection": { value: "Premium experience", weight: 3 },
                    "Scam Shield": { value: "Premium experience", weight: 3 },
                    "1 Year AAA Membership": { value: "Included", weight: 1 },
                    "5-Year Price Guarantee": { value: "Included", weight: 2 },
                }
            },
            "Experience Beyond for Business": {
                displayName: "Experience Beyond for Business",
                weight: 99,
                benefits: {
                    "Phone Upgrades": { value: "Every 1 year", weight: 3 },
                    "T-Priority": { value: "Not included", hidden: true, weight: 0 },
                    "Data": { value: "Unlimited high-speed 5G", valueSubtext: "With unlimited premium data", weight: 3 },
                    "Mobile Hotspot": { value: "300GB High-speed / line", valueSubtext: "Then unlimited at 600KBPS", weight: 5 },
                    "T-Satellite": { value: "Included", weight: 2 },
                    "HULU": { subtext: "With ads", value: "Included", weight: 1 },
                    "Apple TV": { subtext: "Discounted to $3/month", value: "Included", valueSubtext: "With sole prop accounts", weight: 1 },
                    "Netflix": { subtext: "Standard with ads", value: "Netflix or Microsoft 365", valueSubtext: "Netflix available on accounts with 1-5 lines | Microsoft 365 standard license", weight: 2 },
                    "Video Streaming": { value: "Up to 4K UHD", weight: 3 },
                    "Threat Protect": { value: "Included", weight: 3 },
                    "Traveling Abroad": { value: "15GB high-speed data", valueSubtext: "Then unlimited data of up to 256KBPS in 215+ countries & unlimited texting", weight: 3 },
                    "Canada & Mexico": { value: "30GB high-speed data", valueSubtext: "Then unlimited data of up to 256KBPS, plus unlimited talk & text", weight: 3 },
                    "In-flight Wi-Fi Connection": { value: "Premium experience", weight: 3 },
                    "Scam Shield": { value: "Premium experience", weight: 3 },
                    "1 Year AAA Membership": { value: "Included", weight: 1 },
                    "5-Year Price Guarantee": { value: "Included", weight: 2 },
                }
            },
            "Experience Beyond": {
                displayName: "Experience Beyond",
                weight: 98,
                benefits: {
                    "Phone Upgrades": { value: "Every 1 year", weight: 3 },
                    "T-Priority": { value: "Not included", hidden: true, weight: 0 },
                    "Data": { value: "Unlimited high-speed 5G", valueSubtext: "With unlimited premium data", weight: 3 },
                    "Mobile Hotspot": { value: "250GB High-speed / line", valueSubtext: "Then unlimited at 600KBPS", weight: 4 },
                    "T-Satellite": { value: "Included", weight: 2 },
                    "HULU": { subtext: "With ads", value: "Included", weight: 1 },
                    "Apple TV": { subtext: "Discounted to $3/month", value: "Included", weight: 1 },
                    "Netflix": { subtext: "Standard with ads", value: "Included", weight: 1 },
                    "Video Streaming": { value: "Up to 4K UHD", weight: 3 },
                    "Threat Protect": { value: "Not Included", weight: 1, hidden: true },
                    "Traveling Abroad": { value: "15GB high-speed data", valueSubtext: "Then unlimited data of up to 256KBPS in 215+ countries & unlimited texting", weight: 3 },
                    "Canada & Mexico": { value: "30GB high-speed data", valueSubtext: "Then unlimited data of up to 256KBPS, plus unlimited talk & text", weight: 3 },
                    "In-flight Wi-Fi Connection": { value: "Premium experience", weight: 3 },
                    "Scam Shield": { value: "Premium experience", weight: 3 },
                    "1 Year AAA Membership": { value: "Included", weight: 1 },
                    "5-Year Price Guarantee": { value: "Included", weight: 2 },
                }
            },
            "Experience Beyond 55 Savings": {
                displayName: "Experience Beyond 55 Savings",
                weight: 98,
                benefits: {
                    "Phone Upgrades": { value: "Every 1 year", weight: 3 },
                    "T-Priority": { value: "Not included", hidden: true, weight: 0 },
                    "Data": { value: "Unlimited high-speed 5G", valueSubtext: "With unlimited premium data", weight: 3 },
                    "Mobile Hotspot": { value: "250GB High-speed / line", valueSubtext: "Then unlimited at 600KBPS", weight: 4 },
                    "T-Satellite": { value: "Included", weight: 2 },
                    "HULU": { subtext: "With ads", value: "Included", weight: 1 },
                    "Apple TV": { subtext: "Discounted to $3/month", value: "Included", weight: 1 },
                    "Netflix": { subtext: "Standard with ads", value: "Included", weight: 1 },
                    "Video Streaming": { value: "Up to 4K UHD", weight: 3 },
                    "Threat Protect": { value: "Not Included", weight: 1, hidden: true },
                    "Traveling Abroad": { value: "15GB high-speed data", valueSubtext: "Then unlimited data of up to 256KBPS in 215+ countries & unlimited texting", weight: 3 },
                    "Canada & Mexico": { value: "30GB high-speed data", valueSubtext: "Then unlimited data of up to 256KBPS, plus unlimited talk & text", weight: 3 },
                    "In-flight Wi-Fi Connection": { value: "Premium experience", weight: 3 },
                    "Scam Shield": { value: "Premium experience", weight: 3 },
                    "1 Year AAA Membership": { value: "Included", weight: 1 },
                    "5-Year Price Guarantee": { value: "Included", weight: 2 },
                }
            },
            "Experience Beyond Military Savings": {
                displayName: "Experience Beyond Military Savings",
                weight: 98,
                benefits: {
                    "Phone Upgrades": { value: "Every 1 year", weight: 3 },
                    "T-Priority": { value: "Included", weight: 1 },
                    "Data": { value: "Unlimited high-speed 5G", valueSubtext: "With unlimited premium data", weight: 3 },
                    "Mobile Hotspot": { value: "250GB High-speed / line", valueSubtext: "Then unlimited at 600KBPS", weight: 4 },
                    "T-Satellite": { value: "Included", weight: 2 },
                    "HULU": { subtext: "With ads", value: "Included", weight: 1 },
                    "Apple TV": { subtext: "Discounted to $3/month", value: "Included", weight: 1 },
                    "Netflix": { subtext: "Standard with ads", value: "Included", weight: 1 },
                    "Video Streaming": { value: "Up to 4K UHD", weight: 3 },
                    "Threat Protect": { value: "Not Included", weight: 1, hidden: true },
                    "Traveling Abroad": { value: "15GB high-speed data", valueSubtext: "Then unlimited data of up to 256KBPS in 215+ countries & unlimited texting", weight: 3 },
                    "Canada & Mexico": { value: "30GB high-speed data", valueSubtext: "Then unlimited data of up to 256KBPS, plus unlimited talk & text", weight: 3 },
                    "In-flight Wi-Fi Connection": { value: "Premium experience", weight: 3 },
                    "Scam Shield": { value: "Premium experience", weight: 3 },
                    "1 Year AAA Membership": { value: "Included", weight: 1 },
                    "5-Year Price Guarantee": { value: "Included", weight: 2 },
                }
            },
            "Experience Beyond First Responder": {
                displayName: "Experience Beyond First Responder",
                weight: 98,
                benefits: {
                    "Phone Upgrades": { value: "Every 1 year", weight: 3 },
                    "T-Priority": { value: "Included", weight: 1 },
                    "Data": { value: "Unlimited high-speed 5G", valueSubtext: "With unlimited premium data", weight: 3 },
                    "Mobile Hotspot": { value: "250GB High-speed / line", valueSubtext: "Then unlimited at 600KBPS", weight: 4 },
                    "T-Satellite": { value: "Included", weight: 2 },
                    "HULU": { subtext: "With ads", value: "Included", weight: 1 },
                    "Apple TV": { subtext: "Discounted to $3/month", value: "Included", weight: 1 },
                    "Netflix": { subtext: "Standard with ads", value: "Included", weight: 1 },
                    "Video Streaming": { value: "Up to 4K UHD", weight: 3 },
                    "Threat Protect": { value: "Not Included", weight: 1, hidden: true },
                    "Traveling Abroad": { value: "15GB high-speed data", valueSubtext: "Then unlimited data of up to 256KBPS in 215+ countries & unlimited texting", weight: 3 },
                    "Canada & Mexico": { value: "30GB high-speed data", valueSubtext: "Then unlimited data of up to 256KBPS, plus unlimited talk & text", weight: 3 },
                    "In-flight Wi-Fi Connection": { value: "Premium experience", weight: 3 },
                    "Scam Shield": { value: "Premium experience", weight: 3 },
                    "1 Year AAA Membership": { value: "Included", weight: 1 },
                    "5-Year Price Guarantee": { value: "Included", weight: 2 },
                }
            },
            "Experience More w/ FR Savings for Business": {
                displayName: "Experience More w/ FR Savings for Business",
                weight: 97,
                benefits: {
                    "Phone Upgrades": { value: "Every 2 years", weight: 2 },
                    "T-Priority": { value: "Included", weight: 1 },
                    "Data": { value: "Unlimited high-speed 5G", valueSubtext: "With unlimited premium data", weight: 3 },
                    "Mobile Hotspot": { value: "100GB High-speed / line", valueSubtext: "Then unlimited at 600KBPS", weight: 3 },
                    "T-Satellite": { value: "Not included", weight: 1 },
                    "HULU": { subtext: "With ads", value: "Not included", weight: 0 },
                    "Apple TV": { subtext: "Discounted to $3/month", value: "Included", valueSubtext: "With sole prop accounts", weight: 1 },
                    "Netflix": { subtext: "Standard with ads", value: "Netflix or Microsoft 365", valueSubtext: "Netflix available on accounts with 1-5 lines | Microsoft 365 standard license", weight: 2 },
                    "Video Streaming": { value: "Up to 4K UHD", weight: 3 },
                    "Threat Protect": { value: "Included", weight: 3 },
                    "Traveling Abroad": { value: "5GB high-speed data", valueSubtext: "Then unlimited data of up to 256KBPS in 215+ countries & unlimited texting", weight: 2 },
                    "Canada & Mexico": { value: "15GB high-speed data", valueSubtext: "Then unlimited data of up to 256KBPS, plus unlimited talk & text", weight: 2 },
                    "In-flight Wi-Fi Connection": { value: "Premium experience", weight: 3 },
                    "Scam Shield": { value: "Premium experience", weight: 3 },
                    "1 Year AAA Membership": { value: "Included", weight: 1 },
                    "5-Year Price Guarantee": { value: "Included", weight: 2 },
                }
            },
            "Experience More w/ Military Savings for Business": {
                displayName: "Experience More w/ FR Savings for Business",
                weight: 97,
                benefits: {
                    "Phone Upgrades": { value: "Every 2 years", weight: 2 },
                    "T-Priority": { value: "Included", weight: 1 },
                    "Data": { value: "Unlimited high-speed 5G", valueSubtext: "With unlimited premium data", weight: 3 },
                    "Mobile Hotspot": { value: "100GB High-speed / line", valueSubtext: "Then unlimited at 600KBPS", weight: 3 },
                    "T-Satellite": { value: "Not included", weight: 1 },
                    "HULU": { subtext: "With ads", value: "Not included", weight: 0 },
                    "Apple TV": { subtext: "Discounted to $3/month", value: "Included", valueSubtext: "With sole prop accounts", weight: 1 },
                    "Netflix": { subtext: "Standard with ads", value: "Netflix or Microsoft 365", valueSubtext: "Netflix available on accounts with 1-5 lines | Microsoft 365 standard license", weight: 2 },
                    "Video Streaming": { value: "Up to 4K UHD", weight: 3 },
                    "Threat Protect": { value: "Included", weight: 3 },
                    "Traveling Abroad": { value: "5GB high-speed data", valueSubtext: "Then unlimited data of up to 256KBPS in 215+ countries & unlimited texting", weight: 2 },
                    "Canada & Mexico": { value: "15GB high-speed data", valueSubtext: "Then unlimited data of up to 256KBPS, plus unlimited talk & text", weight: 2 },
                    "In-flight Wi-Fi Connection": { value: "Premium experience", weight: 3 },
                    "Scam Shield": { value: "Premium experience", weight: 3 },
                    "1 Year AAA Membership": { value: "Included", weight: 1 },
                    "5-Year Price Guarantee": { value: "Included", weight: 2 },
                }
            },
            "Experience More for Business": {
                displayName: "Experience More for Business",
                weight: 96,
                benefits: {
                    "Phone Upgrades": { value: "Every 2 years", weight: 2 },
                    "T-Priority": { value: "Not included", hidden: true, weight: 0 },
                    "Data": { value: "Unlimited high-speed 5G", valueSubtext: "With unlimited premium data", weight: 3 },
                    "Mobile Hotspot": { value: "100GB High-speed / line", valueSubtext: "Then unlimited at 600KBPS", weight: 3 },
                    "T-Satellite": { value: "Not included", weight: 1 },
                    "HULU": { subtext: "With ads", value: "Not included", weight: 0 },
                    "Apple TV": { subtext: "Discounted to $3/month", value: "Included", valueSubtext: "With sole prop accounts", weight: 1 },
                    "Netflix": { subtext: "Standard with ads", value: "Netflix or Microsoft 365", valueSubtext: "Netflix available on accounts with 1-5 lines | Microsoft 365 standard license", weight: 2 },
                    "Video Streaming": { value: "Up to 4K UHD", weight: 3 },
                    "Threat Protect": { value: "Included", weight: 3 },
                    "Traveling Abroad": { value: "5GB high-speed data", valueSubtext: "Then unlimited data of up to 256KBPS in 215+ countries & unlimited texting", weight: 2 },
                    "Canada & Mexico": { value: "15GB high-speed data", valueSubtext: "Then unlimited data of up to 256KBPS, plus unlimited talk & text", weight: 2 },
                    "In-flight Wi-Fi Connection": { value: "Premium experience", weight: 3 },
                    "Scam Shield": { value: "Premium experience", weight: 3 },
                    "1 Year AAA Membership": { value: "Included", weight: 1 },
                    "5-Year Price Guarantee": { value: "Included", weight: 2 },
                }
            },
            "Experience More": {
                displayName: "Experience More",
                weight: 95,
                benefits: {
                    "Phone Upgrades": { value: "Every 2 years", weight: 2 },
                    "T-Priority": { value: "Not included", hidden: true, weight: 0 },
                    "Data": { value: "Unlimited high-speed 5G", valueSubtext: "With unlimited premium data", weight: 3 },
                    "Mobile Hotspot": { value: "60GB High-speed / line", valueSubtext: "Then unlimited at 600KBPS", weight: 2 },
                    "T-Satellite": { value: "Not included", weight: 1 },
                    "HULU": { subtext: "With ads", value: "Not included", weight: 0 },
                    "Apple TV": { subtext: "Discounted to $3/month", value: "Included", weight: 1 },
                    "Netflix": { subtext: "Standard with ads", value: "Included", weight: 1 },
                    "Video Streaming": { value: "Up to 4K UHD", weight: 3 },
                    "Threat Protect": { value: "Not Included", weight: 1, hidden: true },
                    "Traveling Abroad": { value: "5GB high-speed data", valueSubtext: "Then unlimited data of up to 256KBPS in 215+ countries & unlimited texting", weight: 2 },
                    "Canada & Mexico": { value: "15GB high-speed data", valueSubtext: "Then unlimited data of up to 256KBPS, plus unlimited talk & text", weight: 2 },
                    "In-flight Wi-Fi Connection": { value: "Premium experience", weight: 3 },
                    "Scam Shield": { value: "Premium experience", weight: 3 },
                    "1 Year AAA Membership": { value: "Included", weight: 1 },
                    "5-Year Price Guarantee": { value: "Included", weight: 2 },
                }
            },
            "Experience More 55 Savings": {
                displayName: "Experience More 55 Savings",
                weight: 95,
                benefits: {
                    "Phone Upgrades": { value: "Every 2 years", weight: 2 },
                    "T-Priority": { value: "Not included", hidden: true, weight: 0 },
                    "Data": { value: "Unlimited high-speed 5G", valueSubtext: "With unlimited premium data", weight: 3 },
                    "Mobile Hotspot": { value: "60GB High-speed / line", valueSubtext: "Then unlimited at 600KBPS", weight: 2 },
                    "T-Satellite": { value: "Not included", weight: 1 },
                    "HULU": { subtext: "With ads", value: "Not included", weight: 0 },
                    "Apple TV": { subtext: "Discounted to $3/month", value: "Included", weight: 1 },
                    "Netflix": { subtext: "Standard with ads", value: "Included", weight: 1 },
                    "Video Streaming": { value: "Up to 4K UHD", weight: 3 },
                    "Threat Protect": { value: "Not Included", weight: 1, hidden: true },
                    "Traveling Abroad": { value: "5GB high-speed data", valueSubtext: "Then unlimited data of up to 256KBPS in 215+ countries & unlimited texting", weight: 2 },
                    "Canada & Mexico": { value: "15GB high-speed data", valueSubtext: "Then unlimited data of up to 256KBPS, plus unlimited talk & text", weight: 2 },
                    "In-flight Wi-Fi Connection": { value: "Premium experience", weight: 3 },
                    "Scam Shield": { value: "Premium experience", weight: 3 },
                    "1 Year AAA Membership": { value: "Included", weight: 1 },
                    "5-Year Price Guarantee": { value: "Included", weight: 2 },
                }
            },
            "Experience More Military Savings": {
                displayName: "Experience More Military Savings",
                weight: 95,
                benefits: {
                    "Phone Upgrades": { value: "Every 2 years", weight: 2 },
                    "T-Priority": { value: "Included", weight: 1 },
                    "Data": { value: "Unlimited high-speed 5G", valueSubtext: "With unlimited premium data", weight: 3 },
                    "Mobile Hotspot": { value: "60GB High-speed / line", valueSubtext: "Then unlimited at 600KBPS", weight: 2 },
                    "T-Satellite": { value: "Not included", weight: 1 },
                    "HULU": { subtext: "With ads", value: "Not included", weight: 0 },
                    "Apple TV": { subtext: "Discounted to $3/month", value: "Included", weight: 1 },
                    "Netflix": { subtext: "Standard with ads", value: "Included", weight: 1 },
                    "Video Streaming": { value: "Up to 4K UHD", weight: 3 },
                    "Threat Protect": { value: "Not Included", weight: 1, hidden: true },
                    "Traveling Abroad": { value: "5GB high-speed data", valueSubtext: "Then unlimited data of up to 256KBPS in 215+ countries & unlimited texting", weight: 2 },
                    "Canada & Mexico": { value: "15GB high-speed data", valueSubtext: "Then unlimited data of up to 256KBPS, plus unlimited talk & text", weight: 2 },
                    "In-flight Wi-Fi Connection": { value: "Premium experience", weight: 3 },
                    "Scam Shield": { value: "Premium experience", weight: 3 },
                    "1 Year AAA Membership": { value: "Included", weight: 1 },
                    "5-Year Price Guarantee": { value: "Included", weight: 2 },
                }
            },
            "Experience More First Responder": {
                displayName: "Experience More First Responder",
                weight: 95,
                benefits: {
                    "Phone Upgrades": { value: "Every 2 years", weight: 2 },
                    "T-Priority": { value: "Included", weight: 1 },
                    "Data": { value: "Unlimited high-speed 5G", valueSubtext: "With unlimited premium data", weight: 3 },
                    "Mobile Hotspot": { value: "60GB High-speed / line", valueSubtext: "Then unlimited at 600KBPS", weight: 2 },
                    "T-Satellite": { value: "Not included", weight: 1 },
                    "HULU": { subtext: "With ads", value: "Not included", weight: 0 },
                    "Apple TV": { subtext: "Discounted to $3/month", value: "Included", weight: 1 },
                    "Netflix": { subtext: "Standard with ads", value: "Included", weight: 1 },
                    "Video Streaming": { value: "Up to 4K UHD", weight: 3 },
                    "Threat Protect": { value: "Not Included", weight: 1, hidden: true },
                    "Traveling Abroad": { value: "5GB high-speed data", valueSubtext: "Then unlimited data of up to 256KBPS in 215+ countries & unlimited texting", weight: 2 },
                    "Canada & Mexico": { value: "15GB high-speed data", valueSubtext: "Then unlimited data of up to 256KBPS, plus unlimited talk & text", weight: 2 },
                    "In-flight Wi-Fi Connection": { value: "Premium experience", weight: 3 },
                    "Scam Shield": { value: "Premium experience", weight: 3 },
                    "1 Year AAA Membership": { value: "Included", weight: 1 },
                    "5-Year Price Guarantee": { value: "Included", weight: 2 },
                }
            },
            "Better Value for Business": {
                displayName: "Better Value for Business",
                weight: 97.99,
                benefits: {
                    "Phone Upgrades": { value: "Every 2 years", weight: 2 },
                    "T-Priority": { value: "Not included", hidden: true, weight: 0 },
                    "Data": { value: "Unlimited high-speed 5G", valueSubtext: "With unlimited premium data", weight: 3 },
                    "Mobile Hotspot": { value: "300GB High-speed / line", valueSubtext: "Then unlimited at 600KBPS", weight: 5 },
                    "T-Satellite": { value: "Included", weight: 2 },
                    "HULU": { subtext: "With ads", value: "Included", weight: 1 },
                    "Apple TV": { subtext: "Discounted to $3/month", value: "Included", valueSubtext: "With sole prop accounts", weight: 1 },
                    "Netflix": { subtext: "Standard with ads", value: "Netflix or Microsoft 365", valueSubtext: "Netflix available on accounts with 1-5 lines | Microsoft 365 standard license", weight: 2 },
                    "Video Streaming": { value: "Up to 4K UHD", weight: 3 },
                    "Threat Protect": { value: "Included", weight: 3 },
                    "Traveling Abroad": { value: "30GB high-speed data", valueSubtext: "Then unlimited data of up to 256KBPS in 215+ countries & unlimited texting", weight: 4 },
                    "Canada & Mexico": { value: "30GB high-speed data", valueSubtext: "Then unlimited data of up to 256KBPS, plus unlimited talk & text", weight: 3 },
                    "In-flight Wi-Fi Connection": { value: "Premium experience", weight: 3 },
                    "Scam Shield": { value: "Premium experience", weight: 3 },
                    "1 Year AAA Membership": { value: "Included", weight: 1 },
                    "5-Year Price Guarantee": { value: "Included", weight: 2 },
                }
            },
            "Better Value": {
                displayName: "Better Value",
                weight: 97.9,
                benefits: {
                    "Phone Upgrades": { value: "Every 2 years", weight: 2 },
                    "T-Priority": { value: "Not included", hidden: true, weight: 0 },
                    "Data": { value: "Unlimited high-speed 5G", valueSubtext: "With unlimited premium data", weight: 3 },
                    "Mobile Hotspot": { value: "250GB High-speed / line", valueSubtext: "Then unlimited at 600KBPS", weight: 4 },
                    "T-Satellite": { value: "Included", weight: 2 },
                    "HULU": { subtext: "With ads", value: "Included", weight: 1 },
                    "Apple TV": { subtext: "Discounted to $3/month", value: "Included", weight: 1 },
                    "Netflix": { subtext: "Standard with ads", value: "Included", weight: 1 },
                    "Video Streaming": { value: "Up to 4K UHD", weight: 3 },
                    "Threat Protect": { value: "Not Included", weight: 1, hidden: true },
                    "Traveling Abroad": { value: "30GB high-speed data", valueSubtext: "Then unlimited data of up to 256KBPS in 215+ countries & unlimited texting", weight: 4 },
                    "Canada & Mexico": { value: "30GB high-speed data", valueSubtext: "Then unlimited data of up to 256KBPS, plus unlimited talk & text", weight: 3 },
                    "In-flight Wi-Fi Connection": { value: "Premium experience", weight: 3 },
                    "Scam Shield": { value: "Premium experience", weight: 3 },
                    "1 Year AAA Membership": { value: "Included", weight: 1 },
                    "5-Year Price Guarantee": { value: "Included", weight: 2 },
                }
            },

            "CoreMobile for Business": {
                displayName: "CoreMobile for Business",
                weight: 84,
                benefits: {
                    "Phone Upgrades": { value: "Every 2 years", weight: 2 },
                    "T-Priority": { value: "Not included", hidden: true, weight: 0 },
                    "Data": { value: "50GB high-speed 5G", valueSubtext: "Then unlimited data with 3G speeds", weight: 2 },
                    "Mobile Hotspot": { value: "5GB High-speed / line", valueSubtext: "Then unlimited at 600KBPS", weight: 1.1 },
                    "T-Satellite": { value: "Not included", weight: 1 },
                    "HULU": { subtext: "With ads", value: "Not included", weight: 0 },
                    "Apple TV": { subtext: "Discounted to $3/month", value: "Not included", weight: 0 },
                    "Netflix": { subtext: "Standard with ads", value: "Not included", weight: 0 },
                    "Video Streaming": { value: "Up to 480p Standard", weight: 2 },
                    "Threat Protect": { value: "Not Included", valueSubtext: "Available as add-on", weight: 2 },
                    "Traveling Abroad": { value: "Data not included", valueSubtext: "Unlimited texting in 215+ countries", weight: 1 },
                    "Canada & Mexico": { value: "Up to 128Kbps", valueSubtext: "With unlimited talk, text, and data in Canada & Mexico", weight: 1 },
                    "In-flight Wi-Fi Connection": { value: "Not included", weight: 1 },
                    "Scam Shield": { value: "Standard experience", weight: 2 },
                    "1 Year AAA Membership": { value: "Not included", weight: 0 },
                    "5-Year Price Guarantee": { value: "Included", weight: 2 },
                }
            },
            "Unlimited Select 4 For 100 for Business": {
                displayName: "Unlimited Select 4 For 100 for Business",
                weight: 83,
                benefits: {
                    "Phone Upgrades": { value: "Every 2 years", weight: 2 },
                    "T-Priority": { value: "Not included", hidden: true, weight: 0 },
                    "Data": { value: "50GB high-speed 5G", valueSubtext: "Then unlimited data with 3G speeds", weight: 2 },
                    "Mobile Hotspot": { value: "5GB High-speed / line", valueSubtext: "Then unlimited at 600KBPS", weight: 1.1 },
                    "T-Satellite": { value: "Not included", weight: 1 },
                    "HULU": { subtext: "With ads", value: "Not included", weight: 0 },
                    "Apple TV": { subtext: "Discounted to $3/month", value: "Not included", weight: 0 },
                    "Netflix": { subtext: "Standard with ads", value: "Not included", weight: 0 },
                    "Video Streaming": { value: "Up to 480p Standard", weight: 2 },
                    "Threat Protect": { value: "Not Included", weight: 1 },
                    "Traveling Abroad": { value: "Data not included", valueSubtext: "Unlimited texting in 215+ countries", weight: 1 },
                    "Canada & Mexico": { value: "Up to 128Kbps", valueSubtext: "With unlimited talk, text, and data in Canada & Mexico", weight: 1 },
                    "In-flight Wi-Fi Connection": { value: "Not included", weight: 1 },
                    "Scam Shield": { value: "Standard experience", weight: 2 },
                    "1 Year AAA Membership": { value: "Not included", weight: 0 },
                    "5-Year Price Guarantee": { value: "Not included", weight: 1 },
                }
            },
            "Select Savings for Business": {
                displayName: "Select Savings for Business",
                weight: 83,
                benefits: {
                    "Phone Upgrades": { value: "Every 2 years", weight: 2 },
                    "T-Priority": { value: "Not included", hidden: true, weight: 0 },
                    "Data": { value: "50GB high-speed 5G", valueSubtext: "Then unlimited data with 3G speeds", weight: 2 },
                    "Mobile Hotspot": { value: "5GB High-speed / line", valueSubtext: "Then unlimited at 600KBPS", weight: 1.1 },
                    "T-Satellite": { value: "Not included", weight: 1 },
                    "HULU": { subtext: "With ads", value: "Not included", weight: 0 },
                    "Apple TV": { subtext: "Discounted to $3/month", value: "Not included", weight: 0 },
                    "Netflix": { subtext: "Standard with ads", value: "Not included", weight: 0 },
                    "Video Streaming": { value: "Up to 480p Standard", weight: 2 },
                    "Threat Protect": { value: "Not Included", weight: 1 },
                    "Traveling Abroad": { value: "Data not included", valueSubtext: "Unlimited texting in 215+ countries", weight: 1 },
                    "Canada & Mexico": { value: "5GB high-speed data", valueSubtext: "Then unlimited data of up to 128KBPS, plus unlimited talk & text", weight: 1 },
                    "In-flight Wi-Fi Connection": { value: "Not included", weight: 1 },
                    "Scam Shield": { value: "Standard experience", weight: 2 },
                    "1 Year AAA Membership": { value: "Not included", weight: 0 },
                    "5-Year Price Guarantee": { value: "Not included", weight: 1 },
                }
            },
            "Essentials": {
                displayName: "Essentials",
                weight: 82,
                benefits: {
                    "Phone Upgrades": { value: "Every 2 years", weight: 2 },
                    "T-Priority": { value: "Not included", hidden: true, weight: 0 },
                    "Data": { value: "50GB high-speed 5G", valueSubtext: "Then unlimited data with 3G speeds", weight: 2 },
                    "Mobile Hotspot": { value: "Unlimited, at up to 600KBPS", valueSubtext: "High-speed data not included", weight: 1 },
                    "T-Satellite": { value: "Not included", weight: 1 },
                    "HULU": { subtext: "With ads", value: "Not included", weight: 0 },
                    "Apple TV": { subtext: "Discounted to $3/month", value: "Not included", weight: 0 },
                    "Netflix": { subtext: "Standard with ads", value: "Not included", weight: 0 },
                    "Video Streaming": { value: "Up to 480p Standard", weight: 2 },
                    "Threat Protect": { value: "Not Included", weight: 1, hidden: true },
                    "Traveling Abroad": { value: "Data not included", valueSubtext: "Unlimited texting in 215+ countries", weight: 1 },
                   "Canada & Mexico": { value: "Up to 128Kbps", valueSubtext: "With unlimited talk, text, and data in Canada & Mexico", weight: 1 },
                    "In-flight Wi-Fi Connection": { value: "Not included", weight: 1 },
                    "Scam Shield": { value: "Standard experience", weight: 2 },
                    "1 Year AAA Membership": { value: "Not included", weight: 0 },
                    "5-Year Price Guarantee": { value: "Not included", weight: 1 },
                }
            },
            "4 For 100": {
                displayName: "4 For 100",
                weight: 82,
                benefits: {
                    "Phone Upgrades": { value: "Every 2 years", weight: 2 },
                    "T-Priority": { value: "Not included", hidden: true, weight: 0 },
                    "Data": { value: "50GB high-speed 5G", valueSubtext: "Then unlimited data with 3G speeds", weight: 2 },
                    "Mobile Hotspot": { value: "Unlimited, at up to 600KBPS", valueSubtext: "High-speed data not included", weight: 1 },
                    "T-Satellite": { value: "Not included", weight: 1 },
                    "HULU": { subtext: "With ads", value: "Not included", weight: 0 },
                    "Apple TV": { subtext: "Discounted to $3/month", value: "Not included", weight: 0 },
                    "Netflix": { subtext: "Standard with ads", value: "Not included", weight: 0 },
                    "Video Streaming": { value: "Up to 480p Standard", weight: 2 },
                    "Threat Protect": { value: "Not Included", weight: 1, hidden: true },
                    "Traveling Abroad": { value: "Data not included", valueSubtext: "Unlimited texting in 215+ countries", weight: 1 },
                    "Canada & Mexico": { value: "Up to 128Kbps", valueSubtext: "With unlimited talk, text, and data in Canada & Mexico", weight: 1 },
                    "In-flight Wi-Fi Connection": { value: "Not included", weight: 1 },
                    "Scam Shield": { value: "Standard experience", weight: 2 },
                    "1 Year AAA Membership": { value: "Not included", weight: 0 },
                    "5-Year Price Guarantee": { value: "Not included", weight: 1 },
                }
            },
            "Essentials Choice 55 Savings": {
                displayName: "Essentials Choice 55 Savings",
                weight: 82,
                benefits: {
                    "Phone Upgrades": { value: "Every 2 years", weight: 2 },
                    "T-Priority": { value: "Not included", hidden: true, weight: 0 },
                    "Data": { value: "50GB high-speed 5G", valueSubtext: "Then unlimited data with 3G speeds", weight: 2 },
                    "Mobile Hotspot": { value: "Unlimited, at up to 600KBPS", valueSubtext: "High-speed data not included", weight: 1 },
                    "T-Satellite": { value: "Not included", weight: 1 },
                    "HULU": { subtext: "With ads", value: "Not included", weight: 0 },
                    "Apple TV": { subtext: "Discounted to $3/month", value: "Not included", weight: 0 },
                    "Netflix": { subtext: "Standard with ads", value: "Not included", weight: 0 },
                    "Video Streaming": { value: "Up to 480p Standard", weight: 2 },
                    "Threat Protect": { value: "Not Included", weight: 1, hidden: true },
                    "Traveling Abroad": { value: "Data not included", valueSubtext: "Unlimited texting in 215+ countries", weight: 1 },
                    "Canada & Mexico": { value: "Up to 128Kbps", valueSubtext: "With unlimited talk, text, and data in Canada & Mexico", weight: 1 },
                    "In-flight Wi-Fi Connection": { value: "Not included", weight: 1 },
                    "Scam Shield": { value: "Premium experience", weight: 3 },
                    "1 Year AAA Membership": { value: "Not included", weight: 0 },
                    "5-Year Price Guarantee": { value: "Not included", weight: 1 },
                }
            },
            "Essentials Military Savings": {
                displayName: "Essentials Military Savings",
                weight: 82,
                benefits: {
                    "Phone Upgrades": { value: "Every 2 years", weight: 2 },
                    "T-Priority": { value: "Not included", hidden: true, weight: 0 },
                    "Data": { value: "50GB high-speed 5G", valueSubtext: "Then unlimited data with 3G speeds", weight: 2 },
                    "Mobile Hotspot": { value: "Unlimited, at up to 600KBPS", valueSubtext: "High-speed data not included", weight: 1 },
                    "T-Satellite": { value: "Not included", weight: 1 },
                    "HULU": { subtext: "With ads", value: "Not included", weight: 0 },
                    "Apple TV": { subtext: "Discounted to $3/month", value: "Not included", weight: 0 },
                    "Netflix": { subtext: "Standard with ads", value: "Not included", weight: 0 },
                    "Video Streaming": { value: "Up to 480p Standard", weight: 2 },
                    "Threat Protect": { value: "Not Included", weight: 1, hidden: true },
                    "Traveling Abroad": { value: "Data not included", valueSubtext: "Unlimited texting in 215+ countries", weight: 1 },
                    "Canada & Mexico": { value: "Up to 128Kbps", valueSubtext: "With unlimited talk, text, and data in Canada & Mexico", weight: 1 },
                    "In-flight Wi-Fi Connection": { value: "Not included", weight: 1 },
                    "Scam Shield": { value: "Premium experience", weight: 3 },
                    "1 Year AAA Membership": { value: "Not included", weight: 0 },
                    "5-Year Price Guarantee": { value: "Not included", weight: 1 },
                }
            },
            "Essentials First Responder": {
                displayName: "Essentials First Responder",
                weight: 82,
                benefits: {
                    "Phone Upgrades": { value: "Every 2 years", weight: 2 },
                    "T-Priority": { value: "Available as Add-On", weight: 0 },
                    "Data": { value: "50GB high-speed 5G", valueSubtext: "Then unlimited data with 3G speeds", weight: 2 },
                    "Mobile Hotspot": { value: "Unlimited, at up to 600KBPS", valueSubtext: "High-speed data not included", weight: 1 },
                    "T-Satellite": { value: "Not included", weight: 1 },
                    "HULU": { subtext: "With ads", value: "Not included", weight: 0 },
                    "Apple TV": { subtext: "Discounted to $3/month", value: "Not included", weight: 0 },
                    "Netflix": { subtext: "Standard with ads", value: "Not included", weight: 0 },
                    "Video Streaming": { value: "Up to 480p Standard", weight: 2 },
                    "Threat Protect": { value: "Not Included", weight: 1, hidden: true },
                    "Traveling Abroad": { value: "Data not included", valueSubtext: "Unlimited texting in 215+ countries", weight: 1 },
                    "Canada & Mexico": { value: "Up to 128Kbps", valueSubtext: "With unlimited talk, text, and data in Canada & Mexico", weight: 1 },
                    "In-flight Wi-Fi Connection": { value: "Not included", weight: 1 },
                    "Scam Shield": { value: "Premium experience", weight: 3 },
                    "1 Year AAA Membership": { value: "Not included", weight: 0 },
                    "5-Year Price Guarantee": { value: "Not included", weight: 1 },
                }
            },
            "Essentials Saver": {
                displayName: "Essentials Saver",
                weight: 81,
                benefits: {
                    "Phone Upgrades": { value: "Every 2 years", weight: 2 },
                    "T-Priority": { value: "Not included", hidden: true, weight: 0 },
                    "Data": { value: "50GB high-speed 5G", valueSubtext: "Then unlimited data with 3G speeds", weight: 2 },
                    "Mobile Hotspot": { value: "Unlimited, at up to 600KBPS", valueSubtext: "High-speed data not included", weight: 1 },
                    "T-Satellite": { value: "Not included", weight: 1 },
                    "HULU": { subtext: "With ads", value: "Not included", weight: 0 },
                    "Apple TV": { subtext: "Discounted to $3/month", value: "Not included", weight: 0 },
                    "Netflix": { subtext: "Standard with ads", value: "Not included", weight: 0 },
                    "Video Streaming": { value: "Up to 480p Standard", weight: 2 },
                    "Threat Protect": { value: "Not Included", weight: 1, hidden: true },
                    "Traveling Abroad": { value: "Data not included", valueSubtext: "Unlimited texting in 215+ countries", weight: 1 },
                    "Canada & Mexico": { value: "Up to 128Kbps", valueSubtext: "With unlimited talk, text, and data in Canada & Mexico", weight: 1 },
                    "In-flight Wi-Fi Connection": { value: "Not included", weight: 1 },
                    "Scam Shield": { value: "Standard experience", weight: 2 },
                    "1 Year AAA Membership": { value: "Not included", weight: 0 },
                    "5-Year Price Guarantee": { value: "Not included", weight: 1 },
                }
            },
            "Unlimited Talk & Text Only": {
                displayName: "Unlimited Talk & Text Only",
                weight: 80,
                benefits: {
                    "Phone Upgrades": { value: "Every 2 years", weight: 2 },
                    "T-Priority": { value: "Not included", hidden: true, weight: 0 },
                    "Data": { value: "Not included", weight: 0 },
                    "Mobile Hotspot": { value: "Not Included", weight: 0 },
                    "T-Satellite": { value: "Not included", weight: 1 },
                    "HULU": { subtext: "With ads", value: "Not included", weight: 0 },
                    "Apple TV": { subtext: "Discounted to $3/month", value: "Not included", weight: 0 },
                    "Netflix": { subtext: "Standard with ads", value: "Not included", weight: 0 },
                    "Video Streaming": { value: "Not included", weight: 0 },
                    "Threat Protect": { value: "Not Included", weight: 1, hidden: true },
                    "Traveling Abroad": { value: "Data not included", valueSubtext: "Unlimited texting in 215+ countries", weight: 1 },
                    "Canada & Mexico": { value: "Unlimited talk & text", valueSubtext: "Data not included", weight: 0 },
                    "In-flight Wi-Fi Connection": { value: "Not included", weight: 1 },
                    "Scam Shield": { value: "Standard experience", weight: 2 },
                    "1 Year AAA Membership": { value: "Not included", weight: 0 },
                    "5-Year Price Guarantee": { value: "Not included", weight: 1 },
                }
            },
        };

        // ============================================
        // INTERNET PLAN COMPARISON DATA
        // Benefits structure for comparing home internet plans
        // ============================================
        const COMPARISON_INTERNET_PLANS = {
            "All-In Home Internet": {
                displayName: "All-In Home Internet",
                weight: 100,
                benefits: {
                    "Monthly Price": { subtext:"w/ AutoPay, plus taxes and fees", value: "$70/month", valueSubtext:"$55 w/ voice line", weight: 1 },
                    "Contract": { value: "No annual contract", weight: 2 },
                    "5 Year Price Guarantee": { value: "Included", weight: 2 },
                    "Speed": { value: "Fastest", weight: 2 },
                    "Data": { value: "Unlimited", weight:  3},
                    
                    "Usage": { value: "At approved address", weight: 1 },
                    
                    
                    "Equipment": { value: "High-performance WiFi 7 Gateway", weight: 2 },
                    "Wi-Fi Mesh Extender": { value: "Included", weight: 2 },

                    "Standard Security": { value: "Included", weight: 1 },
                    "Advanced Cyber Security": { value: "Included", weight: 1 },

                    "Hulu": { value: "Included", subtext:"With ads", weight: 2 },
                    "Paramount+": { value: "Included", subtext:"Essential plan", weight: 2 },
                    
                    "Assurant Personal TechPro": { value: "Included", weight: 2 },
                    "Worry-free 15 day test drive": { value: "Included", weight: 1 },
                    "Simple 15-minute setup": { value: "Included", weight: 1 },

                    
                    "T-Mobile Tuesday": { value: "Included", weight: 1 },
                    
                    
                }
            },
            "Amplified Home Internet": {
                displayName: "Amplified Home Internett",
                weight: 90,
                benefits: {
                    "Monthly Price": { subtext:"w/ AutoPay, plus taxes and fees", value: "$60/month", valueSubtext:"$45 w/ voice line", weight: 1 },
                    "Contract": { value: "No annual contract", weight: 2 },
                    "5 Year Price Guarantee": { value: "Included", weight: 2 },
                    "Speed": { value: "Fastest", weight: 2 },
                    "Data": { value: "Unlimited", weight:  3},
                    
                    "Usage": { value: "At approved address", weight: 1 },
                    
                    
                    "Equipment": { value: "High-performance WiFi 7 Gateway", weight: 2 },
                    "Wi-Fi Mesh Extender": { value: "Not Included", weight: 1 },

                    "Standard Security": { value: "Included", weight: 1 },
                    "Advanced Cyber Security": { value: "Not Included", weight: 0 },

                    "Hulu": { value: "Not Included", subtext:"With ads", weight: 1 },
                    "Paramount+": { value: "Not Included", subtext:"Essential plan", weight: 1 },
                    
                    "Assurant Personal TechPro": { value: "Not Included", weight: 1 },
                    "Worry-free 15 day test drive": { value: "Included", weight: 1 },
                    "Simple 15-minute setup": { value: "Included", weight: 1 },

                    
                    "T-Mobile Tuesday": { value: "Included", weight: 1 },
                    
                }
            },
            "Rely Home Internet": {
                displayName: "Rely Home Internett",
                weight: 80,
                benefits: {
                    "Monthly Price": { subtext:"w/ AutoPay, plus taxes and fees", value: "$50/month", valueSubtext:"$35 w/ voice line", weight: 1 },
                    "Contract": { value: "No annual contract", weight: 2 },
                    "5 Year Price Guarantee": { value: "Included", weight: 2 },
                    "Speed": { value: "Fast", weight: 1 },
                    "Data": { value: "Unlimited", weight:  3},
                    
                    "Usage": { value: "At approved address", weight: 1 },
                    
                    
                    "Equipment": { value: "High-performance Gateway", weight: 1 },
                    "Wi-Fi Mesh Extender": { value: "Not Included", weight: 1 },

                    "Standard Security": { value: "Included", weight: 1 },
                    "Advanced Cyber Security": { value: "Not Included", weight: 0 },

                    "Hulu": { value: "Not Included", subtext:"With ads", weight: 1 },
                    "Paramount+": { value: "Not Included", subtext:"Essential plan", weight: 1 },
                    
                    "Assurant Personal TechPro": { value: "Not Included", weight: 1 },
                    "Worry-free 15 day test drive": { value: "Included", weight: 1 },
                    "Simple 15-minute setup": { value: "Included", weight: 1 },

                    
                    "T-Mobile Tuesday": { value: "Included", weight: 1 },
                    
                }  
            },
            "Home Internet Backup": {
                displayName: "Home Internet Backup",
                weight: 70,
                benefits: {
                    "Monthly Price": { subtext:"w/ AutoPay, plus taxes and fees", value: "$20/month", weight: 1 },
                    "Contract": { value: "No annual contract", weight: 2 },
                    "5 Year Price Guarantee": { value: "Not Included", weight: 1 },
                    "Speed": { value: "Fast", weight: 1 },
                    "Data": { value: "130GB High-speed data", valueSubtext:"Then unlimited at 600KBPS", weight:  1},
                    
                    "Usage": { value: "At approved address", weight: 1 },
                    
                    
                    "Equipment": { value: "High-performance Gateway", weight: 1 },
                    "Wi-Fi Mesh Extender": { value: "Not Included", weight: 1 },

                    "Standard Security": { value: "Included", weight: 1 },
                    "Advanced Cyber Security": { value: "Not Included", weight: 0 },

                    "Hulu": { value: "Not Included", subtext:"With ads", weight: 1 },
                    "Paramount+": { value: "Not Included", subtext:"Essential plan", weight: 1 },
                    
                    "Assurant Personal TechPro": { value: "Not Included", weight: 1 },
                    "Worry-free 15 day test drive": { value: "Included", weight: 1 },
                    "Simple 15-minute setup": { value: "Included", weight: 1 },

                    
                    "T-Mobile Tuesday": { value: "Included", weight: 1 },
                    
                    
                }
            },
            "AWAY Internet 200GB": {
                displayName: "AWAY Internet 200GB",
                weight: 110,
                benefits: {
                    "Monthly Price": { subtext:"w/ AutoPay, plus taxes and fees", value: "$110/month", weight: 1 },
                    "Contract": { value: "No annual contract", weight: 2 },
                    "5 Year Price Guarantee": { value: "Included", weight: 2 },
                    "Speed": { value: "Fast", weight: 1 },
                    "Data": { value: "200GB High-speed data", valueSubtext:"Then unlimited at 600KBPS", weight:  2},
                    
                    "Usage": { value: "Anywhere", weight: 2 },
                    
                    
                    "Equipment": { value: "High-performance Portable Gateway", weight: 3 },
                    "Wi-Fi Mesh Extender": { value: "Not Included", weight: 1 },

                    "Standard Security": { value: "Included", weight: 1 },
                    "Advanced Cyber Security": { value: "Not Included", weight: 0 },

                    "Hulu": { value: "Not Included", subtext:"With ads", weight: 1 },
                    "Paramount+": { value: "Not Included", subtext:"Essential plan", weight: 1 },
                    
                    "Assurant Personal TechPro": { value: "Not Included", weight: 1 },
                    "Worry-free 15 day test drive": { value: "Included", weight: 1 },
                    "Simple 15-minute setup": { value: "Included", weight: 1 },

                    
                    "T-Mobile Tuesday": { value: "Included", weight: 1 },
                    
                    
                }
            },
            "AWAY Internet Unlimited": {
                displayName: "AWAY Internet Unlimited",
                weight: 120,
                benefits: {
                    "Monthly Price": { subtext:"w/ AutoPay, plus taxes and fees", value: "$160/month", weight: 1 },
                    "Contract": { value: "No annual contract", weight: 2 },
                    "5 Year Price Guarantee": { value: "Included", weight: 2 },
                    "Speed": { value: "Fast", weight: 1 },
                    "Data": { value: "Unlimited", weight:  3},
                    
                    "Usage": { value: "Anywhere", weight: 2 },
                    
                    
                    "Equipment": { value: "High-performance Portable Gateway", weight: 3 },
                    "Wi-Fi Mesh Extender": { value: "Not Included", weight: 1 },

                    "Standard Security": { value: "Included", weight: 1 },
                    "Advanced Cyber Security": { value: "Not Included", weight: 0 },

                    "Hulu": { value: "Not Included", subtext:"With ads", weight: 1 },
                    "Paramount+": { value: "Not Included", subtext:"Essential plan", weight: 1 },
                    
                    "Assurant Personal TechPro": { value: "Not Included", weight: 1 },
                    "Worry-free 15 day test drive": { value: "Included", weight: 1 },
                    "Simple 15-minute setup": { value: "Included", weight: 1 },

                    
                    "T-Mobile Tuesday": { value: "Included", weight: 1 },
                    
                    
                }
            },
            "Business Unlimited Internet": {
                displayName: "Business Unlimited Internet",
                weight: 95,
                benefits: {
                    "Monthly Price": { value: "$70/mo", valueSubtext: "$40/mo with eligible voice line", weight: 3 },
                    "Speed": { value: "Up to 245 Mbps", valueSubtext: "Typical download speeds", weight: 5 },
                    "Data": { value: "Truly unlimited", valueSubtext: "No data caps", weight: 4 },
                    "Equipment": { value: "5G gateway included", weight: 2 },
                    "Contract": { value: "No annual contract", weight: 2 },
                    "Price Lock": { value: "Price lock guarantee", valueSubtext: "We won't raise your rate", weight: 3 },
                    "Autopay Discount": { value: "Not eligible", weight: 0 },
                    "Voice Line Discount": { value: "$30/mo savings", valueSubtext: "With eligible business voice plan", weight: 4 }
                }
            },
            "Business AWAY Internet Unlimited": {
                displayName: "Business AWAY Internet Unlimited",
                weight: 65,
                benefits: {
                    "Monthly Price": { value: "$160/mo", weight: 3 },
                    "Speed": { value: "5G/4G LTE speeds", valueSubtext: "Mobile network speeds", weight: 3 },
                    "Data": { value: "Truly unlimited", valueSubtext: "No data caps", weight: 4 },
                    "Equipment": { value: "5G gateway included", weight: 2 },
                    "Contract": { value: "No annual contract", weight: 2 },
                    "Price Lock": { value: "Price lock guarantee", weight: 3 },
                    "Autopay Discount": { value: "Not eligible", weight: 0 },
                    "Voice Line Discount": { value: "Not eligible", weight: 0 }
                }
            },
            "Business AWAY Internet 200GB": {
                displayName: "Business AWAY Internet 200GB",
                weight: 55,
                benefits: {
                    "Monthly Price": { value: "$110/mo", weight: 3 },
                    "Speed": { value: "5G/4G LTE speeds", valueSubtext: "Mobile network speeds", weight: 3 },
                    "Data": { value: "200GB high-speed", valueSubtext: "Then unlimited at reduced speeds", weight: 2 },
                    "Equipment": { value: "5G gateway included", weight: 2 },
                    "Contract": { value: "No annual contract", weight: 2 },
                    "Price Lock": { value: "Price lock guarantee", weight: 3 },
                    "Autopay Discount": { value: "Not eligible", weight: 0 },
                    "Voice Line Discount": { value: "Not eligible", weight: 0 }
                }
            },
            "Business Internet Backup": {
                displayName: "Business Internet Backup",
                weight: 45,
                benefits: {
                    "Monthly Price": { value: "$20/mo", weight: 3 },
                    "Speed": { value: "Up to 100 Mbps", valueSubtext: "Typical download speeds", weight: 3 },
                    "Data": { value: "Truly unlimited", valueSubtext: "No data caps", weight: 4 },
                    "Equipment": { value: "5G gateway included", weight: 2 },
                    "Contract": { value: "No annual contract", weight: 2 },
                    "Price Lock": { value: "Price lock guarantee", weight: 3 },
                    "Autopay Discount": { value: "Not eligible", weight: 0 },
                    "Voice Line Discount": { value: "Not eligible", weight: 0 }
                }
            }
        };

        // ============================================
        // PLAN COMPARISON DEFAULTS
        // When printing with benefits page enabled and no Compare page selections,
        // this table defines which plan should be compared against the user's selected plan.
        // If a plan is not in this table, it falls back to the "Beyond" plan for its type.
        // ============================================
        const PLAN_COMPARISON_DEFAULTS = {
            // Consumer Plans - compare lower tiers to Experience More


            "Unlimited Talk & Text Only": "Essentials",
            "Essentials Saver": "Essentials",
            "Essentials First Responder": "Experience More First Responder",
            "Essentials Military Savings": "Experience More Military Savings",
            "Essentials Choice 55 Savings": "Experience More 55 Savings",
            "4 For 100": "Experience More",
            "Essentials": "Experience More",
            "Select Savings for Business": "CoreMobile for Business",
            "Unlimited Select 4 For 100 for Business": "Experience More for Business",
            "CoreMobile for Business": "Experience More for Business",
            "Better Value":"Experience Beyond",
            "Better Value for Business": "Experience Beyond for Business",
            "Experience More First Responder":"Experience Beyond First Responder",
            "Experience More Military Savings":"Experience Beyond Military Savings",
            "Experience More 55 Savings":"Experience Beyond 55 Savings",
            "Experience More":"Experience Beyond",
            "Experience More for Business":"Experience Beyond for Business",
            "Experience More w/ Military Savings for Business":"Experience Beyond w/ Military Savings for Business",
            "Experience More w/ FR Savings for Business":"Experience Beyond w/ FR Savings for Business",
            "Experience Beyond First Responder":"Experience More First Responder",
            "Experience Beyond Military Savings":"Experience More Military Savings",
            "Experience Beyond 55 Savings":"Experience More 55 Savings",
            "Experience Beyond":"Experience More",
            "Experience Beyond for Business":"Experience More for Business",
            "Experience Beyond w/ FR Savings for Business":"Experience More w/ FR Savings for Business",
            "Experience Beyond w/ Military Savings for Business":"Experience More w/ Military Savings for Business"
        };

        // Fallback "Beyond" plan for each plan type (used when plan is not in PLAN_COMPARISON_DEFAULTS)
        const PLAN_TYPE_BEYOND_MAPPING = {
            "Normal": "Experience Beyond",
            "55": "Experience Beyond 55 Savings",
            "Military": "Experience Beyond Military Savings",
            "FR": "Experience Beyond First Responder",
            "Business": "Experience Beyond for Business"
        };

        // ============================================
        // INTERNET COMPARISON DEFAULTS
        // When printing with benefits page enabled and only internet plans selected (no voice lines),
        // this table defines which internet plan should be compared against the user's selected plan.
        // ============================================
        const INTERNET_COMPARISON_DEFAULTS = {
            // Consumer Home Internet Plans
            "Rely Home Internet": "Amplified Home Internet",
            "Amplified Home Internet": "All-In Home Internet",
            "All-In Home Internet": "Amplified Home Internet",
            "Home Internet Backup": "Rely Home Internet",
            "AWAY Internet 200GB": "AWAY Internet Unlimited",
            "AWAY Internet Unlimited": "AWAY Internet 200GB",
            
            // Business Home Internet Plans
            "Business Unlimited Internet": "Business AWAY Internet Unlimited",
            "Business AWAY Internet 200GB": "Business AWAY Internet Unlimited",
            "Business AWAY Internet Unlimited": "Business Unlimited Internet",
            "Business Internet Backup": "Business Unlimited Internet"
        };

        // Get the recommended comparison plan for an internet plan
        function getInternetComparisonPlanFor(planName) {
            // First check if there's a specific comparison defined
            if (INTERNET_COMPARISON_DEFAULTS[planName]) {
                return INTERNET_COMPARISON_DEFAULTS[planName];
            }
            
            // Check if it's a business plan, fall back to Business Unlimited Internet
            if (planName.includes('Business')) {
                return planName === "Business Unlimited Internet" ? "Business AWAY Internet Unlimited" : "Business Unlimited Internet";
            }
            
            // Ultimate fallback for consumer plans: All-In Home Internet
            return planName === "All-In Home Internet" ? "Amplified Home Internet" : "All-In Home Internet";
        }

        // Get the recommended comparison plan for a given plan
        function getComparisonPlanFor(planName) {
            // First check if there's a specific comparison defined
            if (PLAN_COMPARISON_DEFAULTS[planName]) {
                return PLAN_COMPARISON_DEFAULTS[planName];
            }
            
            // Fall back to the "Beyond" plan for this plan's type
            const planData = PLANS_DATA[planName];
            if (planData && planData.planType) {
                const beyondPlan = PLAN_TYPE_BEYOND_MAPPING[planData.planType];
                if (beyondPlan && beyondPlan !== planName) {
                    return beyondPlan;
                }
            }
            
            // Ultimate fallback: Experience Beyond
            return planName === "Experience Beyond" ? "Experience More" : "Experience Beyond";
        }

        // Generate comparison data for any plan dynamically
        function getComparisonDataForPlan(planKey) {
            // Check if it's an internet plan first
            const isInternetPlan = HOME_INTERNET_PLANS[planKey] || BUSINESS_HOME_INTERNET_PLANS[planKey];
            
            if (isInternetPlan) {
                // If internet plan is in COMPARISON_INTERNET_PLANS, use that data
                if (COMPARISON_INTERNET_PLANS[planKey]) {
                    return COMPARISON_INTERNET_PLANS[planKey];
                }
                
                // Fallback for internet plans not configured
                const internetPlanData = HOME_INTERNET_PLANS[planKey] || BUSINESS_HOME_INTERNET_PLANS[planKey];
                return {
                    displayName: planKey,
                    benefits: {
                        "Monthly Price": { value: `$${internetPlanData.price}/mo`, weight: 3 },
                        "Voice Line Discount": { value: internetPlanData.voicelineEligible ? `$${internetPlanData.price - internetPlanData.priceWithVoiceline}/mo savings` : "Not eligible", weight: 2 }
                    }
                };
            }
            
            // Check for regular voice plans
            const plan = PLANS_DATA[planKey];
            if (!plan) return null;
            
            // If plan is in COMPARISON_PLANS, use that data
            if (COMPARISON_PLANS[planKey]) {
                return COMPARISON_PLANS[planKey];
            }
            
            // Otherwise, generate basic comparison data
            // For plans not configured, show minimal info
            return {
                displayName: planKey,
                benefits: {
                    "Plan Available": { value: "Yes" },
                    "Benefits": { value: "Configure this plan in COMPARISON_PLANS for detailed comparison" }
                }
            };
        }


        // ============================================
        // CONNECTED DEVICE PLANS - Watches, Tablets, Data, SyncUp Trackers, SyncUp Drive
        // Each has: price, priceAutopay, savingsWithVoiceline, beyondSavings (boolean), mpLink (optional)
        // ============================================
        
        // MAGENTA PULSE LINKS - Configure links for each category/plan
       const MP_LINKS = {
            // Connected Device category links (shown at top of modal)
            cdCategories: {
                "Watches": "https://magentapulse.t-mobile.com/us/en/customer-support/plans/consumer/wearables-iot/t-mobile-watch-plans",
                "Tablets": "https://magentapulse.t-mobile.com/us/en/customer-support/plans/consumer/tablets-mobile-internet/t-mobile-tablet-plans",
                "Data": "https://magentapulse.t-mobile.com/us/en/customer-support/plans/consumer/tablets-mobile-internet/t-mobile-data-mobile-internet-plans",
                "SyncUp Trackers": "https://magentapulse.t-mobile.com/us/en/customer-support/plans/consumer/wearables-iot/syncup-tracker-rate-plan",
                "SyncUp Drive": "https://magentapulse.t-mobile.com/us/en/customer-support/plans/consumer/wearables-iot/syncup-drive-postpaid"
            },
            // Business Connected Device category links
            businessCdCategories: {
                "Watches": "https://magentapulse.t-mobile.com/us/en/customer-support/plans/business/wearables---iot/t-mobile-watch-plans-business",
                "Tablets": "https://magentapulse.t-mobile.com/us/en/customer-support/plans/business/tablets---mobile-internet/t-mobile-tablet-plans-business",
                "Data": "https://magentapulse.t-mobile.com/us/en/customer-support/plans/business/tablets---mobile-internet/t-mobile-data-mobile-internet-plans-business",
                "SyncUp Trackers": "https://magentapulse.t-mobile.com/us/en/customer-support/plans/business/wearables---iot/syncup-tracker-rate-plan-for-business",
                "SyncUp Drive": "https://magentapulse.t-mobile.com/us/en/customer-support/plans/business/wearables---iot/syncup-drive-business"
            },
            // Home Internet plan links
            homeInternet: {
                "All-In Home Internet": "https://magentapulse.t-mobile.com/us/en/customer-support/plans/consumer/t-mobile-internet/all-in-home-internet-plan",
                "Amplified Home Internet": "https://magentapulse.t-mobile.com/us/en/customer-support/plans/consumer/t-mobile-internet/amplified-home-internet-plan",
                "Rely Home Internet": "https://magentapulse.t-mobile.com/us/en/customer-support/plans/consumer/t-mobile-internet/rely-home-internet",
                "Home Internet Backup": "https://magentapulse.t-mobile.com/us/en/customer-support/plans/consumer/t-mobile-internet/hsi-backup-plan",
                "AWAY Internet 200GB": "https://magentapulse.t-mobile.com/us/en/customer-support/plans/consumer/t-mobile-internet/hsi-away",
                "AWAY Internet Unlimited": "https://magentapulse.t-mobile.com/us/en/customer-support/plans/consumer/t-mobile-internet/hsi-away",
                "Business Unlimited Internet": "https://magentapulse.t-mobile.com/us/en/customer-support/plans/business/business-internet/business-internet-plans",
                "Business Internet Backup": "https://magentapulse.t-mobile.com/us/en/customer-support/plans/business/business-internet/hsi-sbi-backup-plan",
                "Business AWAY Internet Unlimited": "https://magentapulse.t-mobile.com/us/en/customer-support/plans/business/business-internet/hsi-sbi-away",
                "Business AWAY Internet 200GB": "https://magentapulse.t-mobile.com/us/en/customer-support/plans/business/business-internet/hsi-sbi-away"
            },
            // Voice plan links (shown as MP link under each plan in Select Plan modal)
            voicePlans: {
                //Consumer
                "Unlimited Talk & Text Only":"https://magentapulse.t-mobile.com/us/en/customer-support/plans/consumer/phones/unlimited-talk-and-text-only-plan",
                "Essentials Saver": "https://magentapulse.t-mobile.com/us/en/customer-support/plans/consumer/phones/essentials-saver",
                "4 For 100": "https://magentapulse.t-mobile.com/us/en/customer-support/plans/consumer/phones/4-for-100-plan",
                "Essentials":"https://magentapulse.t-mobile.com/us/en/customer-support/plans/consumer/phones/t-mobile-essentials-voice-postpaid-te",
                "Better Value": "https://magentapulse.t-mobile.com/us/en/customer-support/plans/consumer/phones/better-value-plan-postpaid",
                "Experience More": "https://magentapulse.t-mobile.com/us/en/customer-support/plans/consumer/phones/experience-more-plan",
                "Experience Beyond": "https://magentapulse.t-mobile.com/us/en/customer-support/plans/consumer/phones/experience-beyond-plan",
                //Business
                "CoreMobile for Business":"https://magentapulse.t-mobile.com/us/en/customer-support/plans/business/phones/cm-plan",
                "Select Savings for Business":"https://magentapulse.t-mobile.com/us/en/customer-support/plans/business/phones/select-savings-business",
                "Unlimited Select 4 For 100 for Business":"https://magentapulse.t-mobile.com/us/en/customer-support/plans/business/phones/business-unlmited-select-4-for-100-promo",
                "Better Value for Business": "https://magentapulse.t-mobile.com/us/en/customer-support/plans/business/phones/better-value-plan-business",
                "Experience More for Business":"https://magentapulse.t-mobile.com/us/en/customer-support/plans/business/phones/experience-more-business-plan",
                "Experience More w/ Military Savings for Business":"https://magentapulse.t-mobile.com/us/en/customer-support/plans/business/phones/experience-more-business-military-savings-plan",
                "Experience More w/ FR Savings for Business":"https://magentapulse.t-mobile.com/us/en/customer-support/plans/business/phones/experience-more-business-first-responder-savings-plan",
                "Experience Beyond for Business":"https://magentapulse.t-mobile.com/us/en/customer-support/plans/business/phones/experience-beyond-business-plan",
                "Experience Beyond w/ Military Savings for Business":"https://magentapulse.t-mobile.com/us/en/customer-support/plans/business/phones/experience-beyond-business-military-savings-plan",
                "Experience Beyond w/ FR Savings for Business":"https://magentapulse.t-mobile.com/us/en/customer-support/plans/business/phones/experience-beyond-business-first-responder-savings-plan",
                //55
                "Essentials Choice 55 Savings":"https://magentapulse.t-mobile.com/us/en/customer-support/plans/consumer/phones/essentials-choice-55",
                "Experience More 55 Savings":"https://magentapulse.t-mobile.com/us/en/customer-support/plans/consumer/phones/experience-more-55-savings-plan",
                "Experience Beyond 55 Savings":"https://magentapulse.t-mobile.com/us/en/customer-support/plans/consumer/phones/experience-beyond-55-savings-plan",
                //Military
                "Essentials Military Savings":"https://magentapulse.t-mobile.com/us/en/customer-support/plans/consumer/phones/essentials-military-plan",
                "Experience More Military Savings":"https://magentapulse.t-mobile.com/us/en/customer-support/plans/consumer/phones/experience-more-military-savings-plan",
                "Experience Beyond Military Savings":"https://magentapulse.t-mobile.com/us/en/customer-support/plans/consumer/phones/experience-beyond-military-savings-plan",
                //FR
                "Essentials First Responder":"https://magentapulse.t-mobile.com/us/en/customer-support/plans/consumer/phones/essentials-first-responder-plan",
                "Experience More First Responder":"https://magentapulse.t-mobile.com/us/en/customer-support/plans/consumer/phones/experience-more-first-responder-savings-plan",
                "Experience Beyond First Responder":"https://magentapulse.t-mobile.com/us/en/customer-support/plans/consumer/phones/experience-beyond-first-responder-savings-plan",
            }
        };
        
        const CONNECTED_DEVICE_PLANS = {
            Watches: {
                "Watch Plan Plus with Beyond Savings": { price: 20, priceAutopay: 20, autopayEligible: false, savingsWithVoiceline: 0, beyondSavings: true, bogoCompatible: false },
                "Watch Plan Standalone with Beyond Savings": { price: 20, priceAutopay: 20, autopayEligible: false, savingsWithVoiceline: 0, beyondSavings: true, bogoCompatible: false },
                "SyncUP KIDS Watch with Beyond Savings": { price: 15, priceAutopay: 15, autopayEligible: false, savingsWithVoiceline: 0, beyondSavings: true, bogoCompatible: false },
                "Watch Plan Plus Paired": { price: 20, priceAutopay: 15, savingsWithVoiceline: 0, beyondSavings: false, bogoCompatible: true },
                "Watch Plan Plus Standalone": { price: 20, priceAutopay: 15, savingsWithVoiceline: 0, beyondSavings: false, bogoCompatible: true },
                "Watch Plan Paired": { price: 15, priceAutopay: 10, savingsWithVoiceline: 0, beyondSavings: false, bogoCompatible: true },
                "Watch Plan Standalone": { price: 15, priceAutopay: 10, savingsWithVoiceline: 0, beyondSavings: false, bogoCompatible: true },
                "SyncUP KIDS Watch": { price: 15, priceAutopay: 10, savingsWithVoiceline: 0, beyondSavings: false, bogoCompatible: true }
            },
            Tablets: {
                "25GB Tablet with Beyond Savings": { price: 30, priceAutopay: 30, autopayEligible: false, savingsWithVoiceline: 0, beyondSavings: true, bogoCompatible: false },
                "2GB Tablet Plan": { price: 55, priceAutopay: 50, savingsWithVoiceline: 40, beyondSavings: false, bogoCompatible: true },
                "Tablet Unlimited": { price: 65, priceAutopay: 60, savingsWithVoiceline: 40, beyondSavings: false, bogoCompatible: true },
                "Tablet Unlimited Plus": { price: 70, priceAutopay: 65, savingsWithVoiceline: 40, beyondSavings: false, bogoCompatible: true }
            },
            Data: {
                "25GB Data Plan with Beyond Savings": { price: 30, priceAutopay: 30, autopayEligible: false, savingsWithVoiceline: 0, beyondSavings: true, bogoCompatible: false },
                "25GB Data Plan": { price: 30, priceAutopay: 25, savingsWithVoiceline: 0, beyondSavings: false, bogoCompatible: true },
                "100GB Data Plan": { price: 55, priceAutopay: 50, savingsWithVoiceline: 0, beyondSavings: false, bogoCompatible: true },
                "5GB Data Plan (Linkport)": { price: 10, priceAutopay: 5, savingsWithVoiceline: 0, beyondSavings: false, bogoCompatible: true },
                "25GB Data Plan (Linkport)": { price: 15, priceAutopay: 10, savingsWithVoiceline: 0, beyondSavings: false, bogoCompatible: true },
            },
            "SyncUp Trackers": {
                "SyncUP Tracker": { price: 10, priceAutopay: 5, savingsWithVoiceline: 0, beyondSavings: false, bogoCompatible: false },
                "SyncUP Tracker $1 Promo": { price: 2, priceAutopay: 1, savingsWithVoiceline: 0, beyondSavings: false, bogoCompatible: false },
                "SyncUP Tracker $2 Promo": { price: 4, priceAutopay: 2, savingsWithVoiceline: 0, beyondSavings: false, bogoCompatible: false },
            },
            "SyncUp Drive": {
                "SyncUP DRIVE Unlimited w/ 2GB High-Speed": { price: 10, priceAutopay: 10, autopayEligible: false, savingsWithVoiceline: 0, beyondSavings: false, bogoCompatible: true },
                "SyncUP DRIVE Unlimited w/ 5GB High-Speed": { price: 25, priceAutopay: 20, savingsWithVoiceline: 0, beyondSavings: false, bogoCompatible: true },
                "SyncUP DRIVE Unlimited w/ 10GB High-Speed": { price: 35, priceAutopay: 30, savingsWithVoiceline: 0, beyondSavings: false, bogoCompatible: true },
                "SyncUP DRIVE Unlimited w/ 30GB High-Speed": { price: 45, priceAutopay: 40, savingsWithVoiceline: 0, beyondSavings: false, bogoCompatible: true },
                "SyncUP DRIVE Unlimited w/ 50GB High-Speed": { price: 55, priceAutopay: 50, savingsWithVoiceline: 0, beyondSavings: false, bogoCompatible: true },
            }
        };
        
        // Business versions of Connected Device Plans
        const BUSINESS_CONNECTED_DEVICE_PLANS = {
            Watches: {
                "Bus Watch Plan Plus with Beyond Savings": { price: 20, priceAutopay: 20, autopayEligible: false, savingsWithVoiceline: 0, beyondSavings: true, bogoCompatible: false },
                "Bus Watch Plan Standalone with Beyond Savings": { price: 20, priceAutopay: 20, autopayEligible: false, savingsWithVoiceline: 0, beyondSavings: true, bogoCompatible: false },
                "Bus SyncUP KIDS Watch with Beyond Savings": { price: 12, priceAutopay: 12, autopayEligible: false, savingsWithVoiceline: 0, beyondSavings: true, bogoCompatible: false },
                "Bus Watch Plan Plus Paired": { price: 20, priceAutopay: 15, savingsWithVoiceline: 0, beyondSavings: false, bogoCompatible: true },
                "Bus Watch Plan Plus Standalone": { price: 20, priceAutopay: 15, savingsWithVoiceline: 0, beyondSavings: false, bogoCompatible: true },
                "Bus Watch Plan Paired": { price: 15, priceAutopay: 10, savingsWithVoiceline: 0, beyondSavings: false, bogoCompatible: true },
                "Bus Watch Plan Standalone": { price: 15, priceAutopay: 10, savingsWithVoiceline: 0, beyondSavings: false, bogoCompatible: true },
                "Bus SyncUP KIDS Watch": { price: 15, priceAutopay: 15, autopayEligible: false, savingsWithVoiceline: 0, beyondSavings: false, bogoCompatible: true }
            },
            Tablets: {
                "Bus 25GB Tablet with Beyond Savings": { price: 30, priceAutopay: 30, autopayEligible: false, savingsWithVoiceline: 0, beyondSavings: true, bogoCompatible: false },
                "Bus 2GB Tablet Plan": { price: 55, priceAutopay: 50, savingsWithVoiceline: 40, beyondSavings: false, bogoCompatible: true },
                "Bus Tablet Unlimited": { price: 65, priceAutopay: 60, savingsWithVoiceline: 40, beyondSavings: false, bogoCompatible: true },
                "Bus Tablet Unlimited Plus": { price: 70, priceAutopay: 65, savingsWithVoiceline: 40, beyondSavings: false, bogoCompatible: true }
            },
            Data: {
                "Bus 25GB Data Plan with Beyond Savings": { price: 30, priceAutopay: 30, autopayEligible: false, savingsWithVoiceline: 0, beyondSavings: true, bogoCompatible: false },
                "Bus 25GB Data Plan": { price: 30, priceAutopay: 25, savingsWithVoiceline: 0, beyondSavings: false, bogoCompatible: true },
                "Bus 100GB Data Plan": { price: 55, priceAutopay: 50, savingsWithVoiceline: 0, beyondSavings: false, bogoCompatible: true },
                "Bus 5GB Data Plan (Linkport)": { price: 10, priceAutopay: 5, savingsWithVoiceline: 0, beyondSavings: false, bogoCompatible: false },
                "Bus 25GB Data Plan (Linkport)": { price: 15, priceAutopay: 10, savingsWithVoiceline: 0, beyondSavings: false, bogoCompatible: false },
            },
            "SyncUp Trackers": {
                "Bus SyncUP Tracker": { price: 10, priceAutopay: 5, savingsWithVoiceline: 0, beyondSavings: false, bogoCompatible: false },
                "Bus SyncUP Tracker $1 Promo": { price: 2, priceAutopay: 1, savingsWithVoiceline: 0, beyondSavings: false, bogoCompatible: false },
                "Bus SyncUP Tracker $2 Promo": { price: 4, priceAutopay: 2, savingsWithVoiceline: 0, beyondSavings: false, bogoCompatible: false },
            },
            "SyncUp Drive": {
                "Bus SyncUP DRIVE Unlimited w/ 2GB High-Speed": { price: 10, priceAutopay: 10, autopayEligible: false, savingsWithVoiceline: 0, beyondSavings: false, bogoCompatible: false },
                "Bus SyncUP DRIVE Unlimited w/ 5GB High-Speed": { price: 25, priceAutopay: 20, savingsWithVoiceline: 0, beyondSavings: false, bogoCompatible: false },
                "Bus SyncUP DRIVE Unlimited w/ 10GB High-Speed": { price: 35, priceAutopay: 30, savingsWithVoiceline: 0, beyondSavings: false, bogoCompatible: false },
                "Bus SyncUP DRIVE Unlimited w/ 30GB High-Speed": { price: 45, priceAutopay: 40, savingsWithVoiceline: 0, beyondSavings: false, bogoCompatible: false },
                "Bus SyncUP DRIVE Unlimited w/ 50GB High-Speed": { price: 55, priceAutopay: 50, savingsWithVoiceline: 0, beyondSavings: false, bogoCompatible: false },
            }
        };

        // ============================================
        // HOME INTERNET PLANS
        // Each has: price, priceWithVoiceline, autopayEligible, voicelineEligible
        // ============================================
        const HOME_INTERNET_PLANS = {
            "All-In Home Internet": { price: 75, priceWithVoiceline: 60, autopayEligible: true, voicelineEligible: true },
            "Amplified Home Internet": { price: 65, priceWithVoiceline: 50, autopayEligible: true, voicelineEligible: true },
            "Rely Home Internet": { price: 55, priceWithVoiceline: 40, autopayEligible: true, voicelineEligible: true },
            "Home Internet Backup": { price: 25, priceWithVoiceline: 25, autopayEligible: true, voicelineEligible: false },
            "AWAY Internet 200GB": { price: 115, priceWithVoiceline: 115, autopayEligible: true, voicelineEligible: false },
            "AWAY Internet Unlimited": { price: 165, priceWithVoiceline: 165, autopayEligible: true, voicelineEligible: false },
            
        };
        
        // Business Home Internet Plans
        const BUSINESS_HOME_INTERNET_PLANS = {
            "Business Unlimited Internet": { price: 70, priceWithVoiceline: 40, autopayEligible: false, voicelineEligible: true },
            "Business AWAY Internet Unlimited": { price: 160, priceWithVoiceline: 160, autopayEligible: false, voicelineEligible: false },
            "Business AWAY Internet 200GB": { price: 110, priceWithVoiceline: 110, autopayEligible: false, voicelineEligible: false },
            "Business Internet Backup": { price: 20, priceWithVoiceline: 20, autopayEligible: false, voicelineEligible: false },
        };

        // STATE: { rowId: { devices: [{...}], protectionStatus: {}, protectionCosts: {}, showUnprotected: bool, connectedDevices: [], homeInternet: [], rebates: [], discounts: [] } }
        let STATE = {}; 
        let globalAdjustments = []; // { name, value, type: 'per-line'|'per-device'|'one-time'|'percent' } 
        let taxPercentage = 0; // Tax percentage for Due Today calculation
        let rowCount = 0;
        let currentMode = 'new'; 
        let previousModeBeforeCompare = 'new'; // Track mode to return to from compare
        let currentCompareRowId = null; // Track which row's comparison is currently being viewed/edited

        let combineIdenticalDevices = true; // Combine identical devices on print
        let quoteDisplayStyle = 'list'; // 'list' or 'stacked' 
        let currentCDTab = 'Watches';
        
        // Protection tier options - combined list
        // Set defaultForBYOD: true for the option you want as BYOD default
        // Set defaultForStandard: true for the option you want as Standard (P360) default
        // Each tier has a unique id to distinguish tiers with the same price
        const PROTECTION_OPTIONS = [
            { id: 'p360-t1', value: 7, label: 'P360 Tier 1: $7' },
            { id: 'p360-t2', value: 9, label: 'P360 Tier 2: $9' },
            { id: 'p360-t3', value: 13, label: 'P360 Tier 3: $13' },
            { id: 'p360-t4', value: 16, label: 'P360 Tier 4: $16' },
            { id: 'p360-t5', value: 19, label: 'P360 Tier 5: $19', defaultForStandard: true },
            { id: 'p360-t6', value: 26, label: 'P360 Tier 6: $26' },
            { id: 'std-t1', value: 5, label: 'Standard Tier 1: $5' },
            { id: 'std-t2', value: 5, label: 'Standard Tier 2: $5' },
            { id: 'std-t3', value: 5, label: 'Standard Tier 3: $5' },
            { id: 'std-t4', value: 10, label: 'Standard Tier 4: $10' },
            { id: 'std-t5', value: 10, label: 'Standard Tier 5: $10', defaultForBYOD: true },
            { id: 'std-t6', value: 10, label: 'Standard Tier 6: $10' }
        ];
        
        // Helper function to get default protection tier ID based on device type
        function getDefaultProtectionCost(isBYOD) {
            const flagToUse = isBYOD ? 'defaultForBYOD' : 'defaultForStandard';
            const defaultOption = PROTECTION_OPTIONS.find(opt => opt[flagToUse]);
            
            if (defaultOption) {
                return defaultOption.id;
            }
            
            // Fallback to old defaults if flags aren't set
            return isBYOD ? 'std-t5' : 'p360-t5';
        }
        
        // Helper function to get numeric value from tier ID
        function getProtectionValue(tierId) {
            // Handle legacy numeric values for backwards compatibility
            if (typeof tierId === 'number') {
                return tierId;
            }
            
            const option = PROTECTION_OPTIONS.find(opt => opt.id === tierId);
            return option ? option.value : 18; // Default to 18 if not found
        }
        
        // ============================================
        // BENEFITS IMAGES - Replace these base64 strings with your actual images
        // ============================================
        // IMPORTANT: The image MUST include the data URI prefix!
        // Format: 'data:image/png;base64,YOUR_BASE64_STRING_HERE'
        // or: 'data:image/jpeg;base64,YOUR_BASE64_STRING_HERE'
        // 
        // To convert an image to base64:
        // 1. Use an online converter like base64-image.de
        // 2. Copy the FULL output including 'data:image/...'
        // 3. Paste it between the quotes below
        //
        // Benefits comparison now uses the Compare page instead of images
        // The following constants are kept for backwards compatibility but are no longer used
        const REGULAR_BENEFITS_IMAGE = ''
        const BUSINESS_BENEFITS_IMAGE = ''
        const CUSTOM_BENEFITS_PAGES = {};
        
        // Business plan keywords - plans containing these words will show business benefits
        const BUSINESS_PLAN_KEYWORDS = ['business', 'enterprise', 'work'];
        // ============================================
        
        // Rules Settings
        let showItemizedPrices = {
            devices: true,
            connectedDevices: true,
            homeInternet: true,
            accessories: true,
            addons: true
        };
        let showRetailPrices = {
            devices: false,
            bts: false,
            accessories: false
        };
        let roundingMode = 'none'; // 'none', 'up-5', 'down-5', 'up-10', 'down-10'
        let showPerLinePricing = false; // Show price per line breakdown
        let showComparePrices = true; // Show monthly prices on compare quote page

        // --- SECRET MENU FUNCTIONALITY ---
        let secretMenuTimer = null;
        const SECRET_HOLD_DURATION = 5000; // 5 seconds
        const SECRET_PASSWORD = 'Meatball4263';
        
        function initSecretMenu() {
            const logoWrapper = document.querySelector('.tmo-logo-wrapper');
            if (!logoWrapper) {
                console.log('Logo wrapper not found');
                return;
            }
            
            // Make wrapper capture events
            logoWrapper.style.cursor = 'pointer';
            logoWrapper.style.userSelect = 'none';
            logoWrapper.style.webkitUserSelect = 'none';
            logoWrapper.style.touchAction = 'none';
            
            // Prevent dragging on the logo and its children
            logoWrapper.setAttribute('draggable', 'false');
            const logoImg = logoWrapper.querySelector('img');
            if (logoImg) {
                logoImg.setAttribute('draggable', 'false');
            }
            logoWrapper.addEventListener('dragstart', (e) => e.preventDefault());
            
            // Use pointer events for unified handling
            logoWrapper.addEventListener('pointerdown', startSecretTimer);
            logoWrapper.addEventListener('pointerup', cancelSecretTimer);
            logoWrapper.addEventListener('pointerleave', cancelSecretTimer);
            logoWrapper.addEventListener('pointercancel', cancelSecretTimer);
            
            // Prevent context menu on long press
            logoWrapper.addEventListener('contextmenu', (e) => e.preventDefault());
        }
        
        function startSecretTimer(e) {
            e.preventDefault();
            e.stopPropagation();
            cancelSecretTimer();
            secretMenuTimer = setTimeout(() => {
                openSecretPasswordModal();
            }, SECRET_HOLD_DURATION);
        }
        
        function cancelSecretTimer() {
            if (secretMenuTimer) {
                clearTimeout(secretMenuTimer);
                secretMenuTimer = null;
            }
        }
        
        function openSecretPasswordModal() {
            document.getElementById('secret-password-input').value = '';
            document.getElementById('secret-password-error').style.display = 'none';
            document.getElementById('secret-password-modal').classList.add('active');
        }
        
        function closeSecretPasswordModal() {
            document.getElementById('secret-password-modal').classList.remove('active');
        }
        
        function checkSecretPassword() {
            const input = document.getElementById('secret-password-input').value;
            if (input === SECRET_PASSWORD) {
                closeSecretPasswordModal();
                openSecretMenu();
            } else {
                document.getElementById('secret-password-error').style.display = 'block';
            }
        }
        
        function openSecretMenu() {
            document.getElementById('secret-menu-modal').classList.add('active');
        }
        
        function closeSecretMenu() {
            document.getElementById('secret-menu-modal').classList.remove('active');
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Load settings from URL hash first
            loadSettingsFromURL();
            
            // Load saved section order for Rules
            loadSectionOrder();
            
            // Initialize toggle to "New" mode
            const labels = document.querySelectorAll('.toggle-labels span');
            labels[0].classList.add('active');
            
            resetCalculator();
            
            // Initialize secret menu long-press detection
            initSecretMenu();
            
            document.addEventListener('click', (e) => {
                if(!e.target.closest('.search-select-wrapper')) {
                    const activeDropdownRow = document.querySelector('.calculator-row.active-dropdown');
                    if (activeDropdownRow) activeDropdownRow.classList.remove('active-dropdown');
                    document.querySelectorAll('.search-select-options').forEach(el => el.classList.remove('visible'));
                }
            });
            
            // Handle print - ensure all carousel rows are visible
            window.addEventListener('beforeprint', () => {
                const rows = document.querySelectorAll('.calculator-row');
                rows.forEach(row => {
                    // Clear inline styles and add print-visible class
                    row.style.cssText = '';
                    row.classList.add('print-visible');
                });
            });
            
            window.addEventListener('afterprint', () => {
                const rows = document.querySelectorAll('.calculator-row');
                rows.forEach(row => {
                    row.classList.remove('print-visible');
                });
                // Restore carousel view if in carousel mode
                const container = document.getElementById('rows-container');
                if (container && container.classList.contains('carousel-mode')) {
                    updateCarouselView();
                }
            });
            
            // Handle page visibility changes - refresh button states when page becomes visible
            // NOTE: We intentionally do NOT close modals here - users need to switch tabs
            // to look up information (like device FMV values) while keeping modals open
            
            // Global function to reset any stuck interaction states
            // This fixes issues on iPad/iOS where touch handlers get stuck after tab switching
            function resetInteractionStates() {
                // Reset adjustment list drag state
                if (typeof adjustmentEditMode !== 'undefined') {
                    adjustmentEditMode = false;
                }
                if (typeof holdTimer !== 'undefined' && holdTimer) {
                    clearTimeout(holdTimer);
                    holdTimer = null;
                }
                if (typeof draggedItem !== 'undefined') {
                    draggedItem = null;
                    draggedIndex = -1;
                }
                
                // Reset section drag state
                if (typeof sectionDraggedItem !== 'undefined' && sectionDraggedItem) {
                    sectionDraggedItem.classList.remove('dragging');
                    sectionDraggedItem.style.transform = '';
                    sectionDraggedItem.style.zIndex = '';
                    sectionDraggedItem = null;
                }
                
                // Remove any stuck CSS classes
                document.querySelectorAll('.dragging').forEach(el => {
                    el.classList.remove('dragging');
                    el.style.transform = '';
                    el.style.zIndex = '';
                });
                document.querySelectorAll('.held').forEach(el => {
                    el.classList.remove('held');
                });
                document.querySelectorAll('.drag-over').forEach(el => {
                    el.classList.remove('drag-over');
                });
                
                // Re-render adjustment list to clear any stuck state
                if (typeof renderAdjustmentList === 'function' && document.getElementById('adjustment-list')) {
                    try {
                        renderAdjustmentList();
                    } catch (e) {
                        // Ignore errors during reset
                    }
                }
                
                // Ensure body is interactive
                document.body.style.overflow = '';
                document.body.style.pointerEvents = '';
                document.body.style.userSelect = '';
                document.body.style.webkitUserSelect = '';
                
                // Reset any buttons that might be stuck
                document.querySelectorAll('button, a, .btn, [onclick]').forEach(el => {
                    el.style.pointerEvents = '';
                });
            }
            
            // Track if we need to reset states on next interaction
            let needsInteractionReset = false;
            
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) {
                    // Page is visible again - mark for reset on next interaction
                    needsInteractionReset = true;
                    
                    // Also do immediate cleanup
                    document.body.style.overflow = '';
                    document.body.style.pointerEvents = '';
                    
                    // Re-enable any disabled buttons that might be stuck
                    document.querySelectorAll('button:disabled').forEach(btn => {
                        // Only re-enable buttons that shouldn't be disabled
                        if (!btn.classList.contains('btn-disabled') && !btn.hasAttribute('data-keep-disabled')) {
                            btn.disabled = false;
                        }
                    });
                    
                    // Ensure modal buttons are clickable
                    document.querySelectorAll('.modal-overlay.open button').forEach(btn => {
                        btn.style.pointerEvents = 'auto';
                    });
                    
                    // Refresh touch event handlers (iOS fix)
                    document.body.style.touchAction = 'manipulation';
                    requestAnimationFrame(() => {
                        document.body.style.touchAction = '';
                        // Do full reset after a brief delay to let the browser settle
                        setTimeout(resetInteractionStates, 100);
                    });
                } else {
                    // Page is being hidden - clear any active timers
                    if (typeof holdTimer !== 'undefined' && holdTimer) {
                        clearTimeout(holdTimer);
                        holdTimer = null;
                    }
                }
            });
            
            // Reset states on first interaction after returning to page
            document.addEventListener('touchstart', () => {
                if (needsInteractionReset) {
                    needsInteractionReset = false;
                    resetInteractionStates();
                }
            }, { passive: true, capture: true });
            
            document.addEventListener('click', () => {
                if (needsInteractionReset) {
                    needsInteractionReset = false;
                    resetInteractionStates();
                }
            }, { passive: true, capture: true });
            
            // Also reset on window focus (handles some edge cases)
            window.addEventListener('focus', () => {
                setTimeout(() => {
                    resetInteractionStates();
                }, 50);
            });
            
            // Handle page show event - just ensure body is interactive, don't close modals
            window.addEventListener('pageshow', (event) => {
                document.body.style.overflow = '';
                document.body.style.pointerEvents = '';
            });
            
            // Event delegation for modal save buttons (backup for onclick handlers)
            // This helps when iOS Safari sometimes doesn't fire onclick events
            let lastSaveTime = 0;
            let lastButtonClickTime = 0;
            
            document.addEventListener('touchend', (e) => {
                const target = e.target.closest('button, a[onclick], .compare-link, .compare-back-btn, .compare-reset-btn');
                if (!target) return;
                
                // Debounce - prevent double execution within 500ms
                const now = Date.now();
                if (now - lastSaveTime < 500) return;
                
                // Check if this is a save button in an open modal
                if (target.id === 'cd-save-btn' && target.closest('.modal-overlay.open')) {
                    lastSaveTime = now;
                    e.preventDefault();
                    saveCDItem();
                } else if (target.closest('#device-modal.open') && target.textContent.includes('Save Device')) {
                    lastSaveTime = now;
                    e.preventDefault();
                    saveDevice();
                }
            }, { passive: false });
            
            // Backup click handler for critical buttons that might become unresponsive
            // Uses event delegation at document level to ensure it always works
            document.addEventListener('click', (e) => {
                const now = Date.now();
                if (now - lastButtonClickTime < 300) return; // Debounce
                
                const target = e.target.closest('button, a, span');
                if (!target) return;
                
                // Print Quote button (in contact-modal)
                if (target.textContent.includes('Print Quote') && target.closest('#contact-modal')) {
                    if (!target.onclick || target.getAttribute('data-needs-backup')) {
                        lastButtonClickTime = now;
                        finalizePrint();
                    }
                }
                
                // Save button in contact modal
                if (target.id === 'save-quote-btn' && target.closest('#contact-modal')) {
                    if (!target.onclick || target.getAttribute('data-needs-backup')) {
                        lastButtonClickTime = now;
                        saveQuoteToFile();
                    }
                }
                
                // Add Row button
                if (target.id === 'add-row-btn') {
                    if (!target.onclick || target.getAttribute('data-needs-backup')) {
                        lastButtonClickTime = now;
                        createNewRow();
                    }
                }
                
                // Compare Plans link
                if (target.classList.contains('compare-link')) {
                    if (!target.onclick || target.getAttribute('data-needs-backup')) {
                        lastButtonClickTime = now;
                        e.preventDefault();
                        setMode('compare');
                    }
                }
                
                // Compare Back button
                if (target.classList.contains('compare-back-btn')) {
                    if (!target.onclick || target.getAttribute('data-needs-backup')) {
                        lastButtonClickTime = now;
                        e.preventDefault();
                        returnFromCompare();
                    }
                }
                
                // Compare Reset button
                if (target.classList.contains('compare-reset-btn')) {
                    if (!target.onclick || target.getAttribute('data-needs-backup')) {
                        lastButtonClickTime = now;
                        e.preventDefault();
                        resetComparison();
                    }
                }
                
                // Toggle labels (New / Existing mode switch)
                if (target.closest('.toggle-labels')) {
                    const text = target.textContent.trim().toLowerCase();
                    if (text === 'new') {
                        lastButtonClickTime = now;
                        setMode('new');
                    } else if (text === 'existing') {
                        lastButtonClickTime = now;
                        setMode('existing');
                    }
                }
                
                // Rules button
                if (target.id === 'rules-btn' || target.closest('#rules-btn')) {
                    lastButtonClickTime = now;
                    toggleSettingsPanel();
                }
                
                // Print button (floating action - opens contact modal)
                if (target.id === 'print-btn' || target.closest('#print-btn') || target.id === 'export-pdf' || target.closest('#export-pdf')) {
                    lastButtonClickTime = now;
                    openContactModal();
                }
                
                // Modal close buttons (X buttons)
                if (target.classList.contains('modal-header-close')) {
                    lastButtonClickTime = now;
                    const modal = target.closest('.modal-overlay');
                    if (modal) {
                        modal.classList.remove('open');
                    }
                }
                
                // Load Quote button
                if (target.id === 'load-quote-btn' || target.closest('#load-quote-btn')) {
                    lastButtonClickTime = now;
                    openLoadQuoteModal();
                }
            }, { capture: true });
            
            // NOTE: Removed window 'focus' event handler that was closing all modals
            // This was preventing users from looking up info in other tabs while editing
        });
        
        // Helper function to close all modals and overlays (used before printing, etc.)
        function closeAllModals() {
            // Close plan modal
            const planModal = document.getElementById('plan-modal');
            if (planModal) planModal.classList.remove('open');
            
            // Close device modal
            const deviceModal = document.getElementById('device-modal');
            if (deviceModal) deviceModal.classList.remove('open');
            
            // Close connected device modal
            const cdModal = document.getElementById('cd-modal');
            if (cdModal) cdModal.classList.remove('open');
            
            // Close home internet modal
            const hiModal = document.getElementById('hi-modal');
            if (hiModal) hiModal.classList.remove('open');
            
            // Close contact modal
            const contactModal = document.getElementById('contact-modal');
            if (contactModal) contactModal.classList.remove('open');
            
            // Close settings sidebar
            const settingsSidebar = document.getElementById('settings-sidebar');
            if (settingsSidebar) settingsSidebar.classList.remove('open');
            
            const settingsOverlay = document.getElementById('settings-overlay');
            if (settingsOverlay) settingsOverlay.classList.remove('open');
            
            // Close all modal overlays
            const modalOverlays = document.querySelectorAll('.modal-overlay');
            modalOverlays.forEach(overlay => overlay.classList.remove('open'));
            
            // Ensure body can scroll and is clickable
            refreshUIState();
        }
        
        // Helper function to ensure UI is responsive (called on visibility change)
        function refreshUIState() {
            document.body.style.overflow = '';
            document.body.style.pointerEvents = '';
        }
        
        // Save settings to URL hash
        function saveSettingsToURL() {
            const settings = {
                sip: showItemizedPrices,
                srp: showRetailPrices,
                rm: roundingMode,
                cid: combineIdenticalDevices,
                qds: quoteDisplayStyle,
                adj: globalAdjustments,
                splp: showPerLinePricing,
                scp: showComparePrices,
                // Rep info
                rn: document.getElementById('contact-rep-name')?.value || '',
                rp: document.getElementById('contact-rep-phone')?.value || '',
                // PDF options
                ibp: document.getElementById('include-benefits-page')?.checked || false,
                isa: document.getElementById('include-store-address')?.checked || false,
                // Store address
                sa: document.getElementById('store-address')?.value || '',
                // Tax percentage
                tp: taxPercentage || 0
            };
            const encoded = btoa(JSON.stringify(settings));
            window.history.replaceState(null, '', '#' + encoded);
            
            // Also save to localStorage for persistence across page reloads
            try {
                localStorage.setItem('quoteCalcSettings', JSON.stringify(settings));
            } catch(e) {
                console.log('Could not save settings to localStorage');
            }
        }
        
        // Load settings from URL hash
        function loadSettingsFromURL() {
            let settings = null;
            const hash = window.location.hash.slice(1);
            
            // Try URL hash first, then localStorage
            if (hash) {
                try {
                    settings = JSON.parse(atob(hash));
                } catch(e) {
                    console.log('Could not load settings from URL hash');
                }
            }
            
            // If no URL hash settings, try localStorage
            if (!settings) {
                try {
                    const stored = localStorage.getItem('quoteCalcSettings');
                    if (stored) {
                        settings = JSON.parse(stored);
                    }
                } catch(e) {
                    console.log('Could not load settings from localStorage');
                }
            }
            
            if (!settings) return;
            
            try {
                if (settings.sip) {
                    showItemizedPrices = settings.sip;
                    // Ensure addons defaults to true if not present in saved settings
                    if (showItemizedPrices.addons === undefined) {
                        showItemizedPrices.addons = true;
                    }
                    document.getElementById('show-device-prices').checked = showItemizedPrices.devices;
                    document.getElementById('show-cd-prices').checked = showItemizedPrices.connectedDevices;
                    document.getElementById('show-hi-prices').checked = showItemizedPrices.homeInternet;
                    const accCheck = document.getElementById('show-accessory-prices');
                    if (accCheck) accCheck.checked = showItemizedPrices.accessories !== false;
                    const addonCheck = document.getElementById('show-addon-prices');
                    if (addonCheck) addonCheck.checked = showItemizedPrices.addons !== false;
                }
                if (settings.srp) {
                    showRetailPrices = settings.srp;
                    document.getElementById('show-device-retail').checked = showRetailPrices.devices;
                    document.getElementById('show-bts-retail').checked = showRetailPrices.bts;
                    const accRetailCheck = document.getElementById('show-accessory-retail');
                    if (accRetailCheck) accRetailCheck.checked = showRetailPrices.accessories === true;
                }
                if (settings.rm) {
                    roundingMode = settings.rm;
                    document.getElementById('rounding-mode').value = roundingMode;
                }
                if (settings.cid !== undefined) {
                    combineIdenticalDevices = settings.cid;
                    document.getElementById('combine-devices').checked = combineIdenticalDevices;
                }
                if (settings.qds) {
                    quoteDisplayStyle = settings.qds;
                    document.getElementById('display-style').value = quoteDisplayStyle;
                }
                if (settings.adj && Array.isArray(settings.adj)) {
                    globalAdjustments = settings.adj;
                    renderAdjustmentList();
                }
                if (settings.splp !== undefined) {
                    showPerLinePricing = settings.splp;
                    const checkbox = document.getElementById('show-per-line');
                    if (checkbox) checkbox.checked = showPerLinePricing;
                }
                if (settings.scp !== undefined) {
                    showComparePrices = settings.scp;
                    const checkbox = document.getElementById('show-compare-prices');
                    if (checkbox) checkbox.checked = showComparePrices;
                }
                // Load rep info
                if (settings.rn) {
                    document.getElementById('contact-rep-name').value = settings.rn;
                }
                if (settings.rp) {
                    document.getElementById('contact-rep-phone').value = settings.rp;
                }
                // Load PDF options
                if (settings.ibp !== undefined) {
                    document.getElementById('include-benefits-page').checked = settings.ibp;
                }
                if (settings.isa !== undefined) {
                    document.getElementById('include-store-address').checked = settings.isa;
                }
                // Load store address
                if (settings.sa) {
                    document.getElementById('store-address').value = settings.sa;
                }
                // Load tax percentage
                if (settings.tp !== undefined) {
                    taxPercentage = settings.tp;
                    document.getElementById('tax-percentage').value = taxPercentage > 0 ? taxPercentage : '';
                }
                // Show/hide default benefits switch based on benefits page setting
                toggleDefaultBenefitsSwitch();
            } catch(e) {
                console.log('Could not apply settings');
            }
        }
        
        function toggleDefaultBenefitsSwitch() {
            // This function is no longer needed as we use comparison tables instead of images
            // Kept as empty function for backwards compatibility with any remaining calls
        }

        // Mode toggle with compare
        function setMode(mode) {
            if (mode === currentMode) return; // No change needed
            
            const previousMode = currentMode;
            
            // Track the mode before going to compare
            if (mode === 'compare' && currentMode !== 'compare') {
                previousModeBeforeCompare = currentMode;
            }
            
            currentMode = mode;
            
            // Update toggle UI
            const slider = document.getElementById('toggle-slider');
            const labels = document.querySelectorAll('.toggle-labels span');
            
            // Remove active class from all
            labels.forEach(label => label.classList.remove('active'));
            
            // Show/hide compare link
            const compareLinkWrapper = document.getElementById('compare-link-wrapper');
            
            if (mode === 'new') {
                slider.className = 'toggle-slider position-0';
                labels[0].classList.add('active');
                document.getElementById('rows-container').style.display = 'block';
                document.getElementById('compare-section').classList.remove('active');
                document.body.classList.remove('compare-mode');
                if (compareLinkWrapper) compareLinkWrapper.classList.remove('hidden');
                
                // Only reset if coming from existing mode
                if (previousMode === 'existing') {
                    resetCalculator();
                }
            } else if (mode === 'existing') {
                slider.className = 'toggle-slider position-1';
                labels[1].classList.add('active');
                document.getElementById('rows-container').style.display = 'block';
                document.getElementById('compare-section').classList.remove('active');
                document.body.classList.remove('compare-mode');
                if (compareLinkWrapper) compareLinkWrapper.classList.remove('hidden');
                
                // Only reset if coming from new mode
                if (previousMode === 'new') {
                    resetCalculator();
                }
            } else if (mode === 'compare') {
                // Don't change toggle position when going to compare
                document.getElementById('rows-container').style.display = 'none';
                document.getElementById('compare-section').classList.add('active');
                document.body.classList.add('compare-mode');
                if (compareLinkWrapper) compareLinkWrapper.classList.add('hidden');
                initializeComparisonDropdowns();
            }
        }

        // Function to return from compare mode
        function returnFromCompare() {
            setMode(previousModeBeforeCompare);
        }

        function resetComparison() {
            // Reset plan 1
            document.getElementById('compare-plan-1').value = '';
            document.getElementById('compare-plan-1-label').textContent = 'Plan 1';
            const trigger1 = document.getElementById('compare-plan-1-trigger');
            trigger1.classList.remove('has-selection', 'premium');
            
            // Reset plan 2
            document.getElementById('compare-plan-2').value = '';
            document.getElementById('compare-plan-2-label').textContent = 'Plan 2';
            const trigger2 = document.getElementById('compare-plan-2-trigger');
            trigger2.classList.remove('has-selection', 'premium');
            
            // Reset plan types tracking
            comparePlanTypes = { 1: null, 2: null };
            
            // Reset the current row's compare settings
            if (currentCompareRowId && STATE[currentCompareRowId]) {
                STATE[currentCompareRowId].compareSettings = {
                    plan1Key: '',
                    plan2Key: '',
                    hasUserModified: false
                };
            }
            
            // Clear the comparison table
            document.getElementById('comparison-table-container').innerHTML = '';
            document.querySelector('#compare-section .compare-dropdowns').classList.add('no-content');
        }

        function toggleMode() {
            // Legacy function - redirect to setMode
            const mode = currentMode === 'new' ? 'existing' : 'new';
            setMode(mode);
        }

        function initializeComparisonDropdowns() {
            // No longer needed since we're using the plan modal
            updateComparison();
        }

        let currentCompareSlot = 1; // Track which slot is being filled
        let comparePlanTypes = { 1: null, 2: null }; // Track 'phone' or 'internet' for each slot

        function openComparePlanModal(slot) {
            currentCompareSlot = slot;
            
            // Set a temporary row ID for the modal
            document.getElementById('plan-modal-row-id').value = 'compare-mode';
            document.getElementById('plan-search-box').value = '';
            
            // Hide manage add-ons button in compare mode
            const manageAddonsLink = document.getElementById('manage-addons-link');
            if (manageAddonsLink) manageAddonsLink.style.display = 'none';
            
            // Check what type of plan the OTHER slot has
            const otherSlot = slot === 1 ? 2 : 1;
            const otherSlotType = comparePlanTypes[otherSlot];
            
            // Show/hide tabs based on what the other slot has
            // Compare like with like: internet vs internet, phone vs phone
            document.querySelectorAll('.plan-tab[data-plan-type]').forEach(tab => {
                const tabType = tab.getAttribute('data-plan-type');
                if (otherSlotType === 'internet') {
                    // Other slot has internet - show ONLY Internet tab
                    tab.style.display = tabType === 'Internet' ? '' : 'none';
                } else if (otherSlotType === 'phone') {
                    // Other slot has phone plan - show phone tabs, hide Internet tab
                    tab.style.display = tabType === 'Internet' ? 'none' : '';
                } else {
                    // No selection in other slot - show all tabs
                    tab.style.display = '';
                }
            });
            
            // Get currently selected plan for this slot
            const selectedPlan = document.getElementById(`compare-plan-${slot}`).value;
            if (selectedPlan) {
                // Check if it's an internet plan
                if (HOME_INTERNET_PLANS[selectedPlan] || BUSINESS_HOME_INTERNET_PLANS[selectedPlan]) {
                    currentPlanTab = 'Internet';
                } else if (PLANS_DATA[selectedPlan]) {
                    currentPlanTab = PLANS_DATA[selectedPlan].planType || 'Normal';
                } else {
                    currentPlanTab = 'Normal';
                }
            } else {
                // Default tab based on what's available
                if (otherSlotType === 'internet') {
                    currentPlanTab = 'Internet';
                } else {
                    currentPlanTab = 'Normal';
                }
            }
            document.getElementById('plan-modal-tab').value = currentPlanTab;
            
            // Reset tabs and select the right one
            document.querySelectorAll('.plan-tab').forEach(t => t.classList.remove('active'));
            const activeTab = document.querySelector(`.plan-tab[data-plan-type="${currentPlanTab}"]`);
            if (activeTab) {
                activeTab.classList.add('active');
                setTimeout(() => {
                    activeTab.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
                }, 100);
            }
            
            renderComparePlanModalList();
            document.getElementById('plan-modal').classList.add('open');
            
            setTimeout(updatePlanTabArrows, 100);
        }

        function renderComparePlanModalList() {
            const container = document.getElementById('plan-list-container');
            container.innerHTML = '';
            
            const planType = currentPlanTab;
            const searchVal = document.getElementById('plan-search-box').value.toLowerCase();
            const currentSlot = currentCompareSlot;
            const selectedPlan = document.getElementById(`compare-plan-${currentSlot}`).value;
            
            let hasPlans = false;
            
            // If searching, show all matching plans from all tabs
            const showAllTabs = searchVal.length > 0;
            
            // Handle Internet tab separately
            if (planType === 'Internet' || (showAllTabs && searchVal)) {
                // Show internet plans
                const internetPlans = [];
                
                // Consumer internet plans
                Object.keys(HOME_INTERNET_PLANS).forEach(planName => {
                    if (!searchVal || planName.toLowerCase().includes(searchVal)) {
                        internetPlans.push({ 
                            name: planName, 
                            plan: HOME_INTERNET_PLANS[planName], 
                            category: 'Consumer Internet' 
                        });
                    }
                });
                
                // Business internet plans
                Object.keys(BUSINESS_HOME_INTERNET_PLANS).forEach(planName => {
                    if (!searchVal || planName.toLowerCase().includes(searchVal)) {
                        internetPlans.push({ 
                            name: planName, 
                            plan: BUSINESS_HOME_INTERNET_PLANS[planName], 
                            category: 'Business Internet' 
                        });
                    }
                });
                
                if (planType === 'Internet' && internetPlans.length > 0) {
                    hasPlans = true;
                    
                    // Add Consumer Internet header
                    const consumerPlans = internetPlans.filter(p => p.category === 'Consumer Internet');
                    if (consumerPlans.length > 0) {
                        const header = document.createElement('div');
                        header.className = 'plan-category-header';
                        header.textContent = 'Consumer Internet';
                        container.appendChild(header);
                        
                        consumerPlans.forEach(({ name: planName, plan }) => {
                            const div = document.createElement('div');
                            div.className = 'plan-option';
                            if (planName === selectedPlan) div.classList.add('selected');
                            
                            const priceInfo = plan.priceWithVoiceline !== plan.price 
                                ? `$${plan.price}/mo ($${plan.priceWithVoiceline} with voice line)`
                                : `$${plan.price}/mo`;
                            
                            const mpLink = MP_LINKS.homeInternet[planName] || '';
                            const mpHtml = mpLink ? `<a href="${mpLink}" target="_blank" class="mp-link-small" onclick="event.stopPropagation();">Magenta Pulse</a>` : '';
                            
                            div.innerHTML = `
                                <div style="display: flex; flex-direction: column; gap: 2px;">
                                    <span>${planName}</span>
                                    <span style="font-size: 0.75rem; color: var(--text-secondary);">${priceInfo}</span>
                                    ${mpHtml}
                                </div>
                            `;
                            div.onclick = () => selectComparePlan(planName, 'internet');
                            container.appendChild(div);
                        });
                    }
                    
                    // Add Business Internet header
                    const businessPlans = internetPlans.filter(p => p.category === 'Business Internet');
                    if (businessPlans.length > 0) {
                        const header = document.createElement('div');
                        header.className = 'plan-category-header';
                        header.textContent = 'Business Internet';
                        container.appendChild(header);
                        
                        businessPlans.forEach(({ name: planName, plan }) => {
                            const div = document.createElement('div');
                            div.className = 'plan-option';
                            if (planName === selectedPlan) div.classList.add('selected');
                            
                            const priceInfo = plan.priceWithVoiceline !== plan.price 
                                ? `$${plan.price}/mo ($${plan.priceWithVoiceline} with voice line)`
                                : `$${plan.price}/mo`;
                            
                            const mpLink = MP_LINKS.homeInternet[planName] || '';
                            const mpHtml = mpLink ? `<a href="${mpLink}" target="_blank" class="mp-link-small" onclick="event.stopPropagation();">Magenta Pulse</a>` : '';
                            
                            div.innerHTML = `
                                <div style="display: flex; flex-direction: column; gap: 2px;">
                                    <span>${planName}</span>
                                    <span style="font-size: 0.75rem; color: var(--text-secondary);">${priceInfo}</span>
                                    ${mpHtml}
                                </div>
                            `;
                            div.onclick = () => selectComparePlan(planName, 'internet');
                            container.appendChild(div);
                        });
                    }
                }
                
                // If searching, also show matching internet plans in search results
                if (showAllTabs && internetPlans.length > 0) {
                    hasPlans = true;
                    const header = document.createElement('div');
                    header.className = 'plan-category-header';
                    header.textContent = 'Internet';
                    container.appendChild(header);
                    
                    internetPlans.forEach(({ name: planName, plan }) => {
                        const div = document.createElement('div');
                        div.className = 'plan-option';
                        if (planName === selectedPlan) div.classList.add('selected');
                        
                        const priceInfo = `$${plan.price}/mo`;
                        
                        div.innerHTML = `
                            <div style="display: flex; flex-direction: column; gap: 2px;">
                                <span>${planName}</span>
                                <span style="font-size: 0.75rem; color: var(--text-secondary);">${priceInfo}</span>
                            </div>
                        `;
                        div.onclick = () => selectComparePlan(planName, 'internet');
                        container.appendChild(div);
                    });
                }
            }
            
            // Don't show phone plans if Internet tab is selected (and not searching)
            if (planType !== 'Internet' || showAllTabs) {
                // Group plans by type for search results
                const plansByType = {};
                
                Object.keys(PLANS_DATA).forEach(planName => {
                    const plan = PLANS_DATA[planName];
                    const pType = plan.planType || 'Normal';
                    
                    // Filter by plan type (unless searching)
                    if (!showAllTabs && pType !== planType) return;
                    
                    // Filter by search - check plan name and keywords
                    if (searchVal) {
                        const nameMatch = planName.toLowerCase().includes(searchVal);
                        const keywordMatch = plan.keywords && plan.keywords.some(kw => kw.toLowerCase().includes(searchVal));
                        if (!nameMatch && !keywordMatch) return;
                    }
                    
                    hasPlans = true;
                    
                    if (!plansByType[pType]) plansByType[pType] = [];
                    plansByType[pType].push({ name: planName, plan: plan });
                });
                
                // Render plans (with category headers if searching)
                Object.keys(plansByType).forEach(pType => {
                    if (showAllTabs && plansByType[pType].length > 0) {
                        // Add category header
                        const header = document.createElement('div');
                        header.className = 'plan-category-header';
                        header.textContent = pType;
                        container.appendChild(header);
                    }
                    
                    plansByType[pType].forEach(({ name: planName, plan }) => {
                        const div = document.createElement('div');
                        div.className = 'plan-option';
                        
                        // Highlight selected plan
                        if (planName === selectedPlan) {
                            div.classList.add('selected');
                        }
                        
                        // Show min/max lines info
                        let lineInfo = '';
                        if (plan.minLines && plan.maxLines) {
                            lineInfo = ` <span style="font-size: 0.75rem; color: var(--text-secondary);">(${plan.minLines}-${plan.maxLines} lines)</span>`;
                        } else if (plan.minLines) {
                            lineInfo = ` <span style="font-size: 0.75rem; color: var(--text-secondary);">(min ${plan.minLines} lines)</span>`;
                        } else if (plan.maxLines && plan.maxLines < 12) {
                            lineInfo = ` <span style="font-size: 0.75rem; color: var(--text-secondary);">(max ${plan.maxLines} lines)</span>`;
                        }
                        
                        // Get MP link for this plan
                        const mpLink = MP_LINKS.voicePlans[planName] || '';
                        const mpHtml = mpLink ? `<a href="${mpLink}" target="_blank" class="mp-link-small" onclick="event.stopPropagation();">Magenta Pulse</a>` : '';
                        
                        // Show plan notes if available
                        const planNotes = plan.notes ? ` <span style="font-size: 0.75rem; color: var(--text-secondary);">(${plan.notes})</span>` : '';
                        
                        div.innerHTML = `
                            <div style="display: flex; flex-direction: column; gap: 2px;">
                                <span>${planName}${planNotes}${lineInfo}</span>
                                ${mpHtml}
                            </div>
                        `;
                        div.onclick = () => selectComparePlan(planName, 'phone');
                        container.appendChild(div);
                    });
                });
            }
            
            if (!hasPlans) {
                container.innerHTML = '<div class="plan-no-results">No plans found</div>';
            }
            
            // Scroll to selected plan if exists
            setTimeout(() => {
                const selectedEl = container.querySelector('.plan-option.selected');
                if (selectedEl) {
                    selectedEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 100);
        }
        
        function filterComparePlanModal(input) {
            renderComparePlanModalList();
        }

        function selectComparePlan(planName, planCategory = 'phone') {
            const slot = currentCompareSlot;
            
            // Track the plan type for this slot
            comparePlanTypes[slot] = planCategory;
            
            // Update hidden input and label
            document.getElementById(`compare-plan-${slot}`).value = planName;
            document.getElementById(`compare-plan-${slot}-label`).textContent = planName;
            
            // Update trigger styling (add has-selection, premium styling handled in updateComparison)
            const trigger = document.getElementById(`compare-plan-${slot}-trigger`);
            trigger.classList.add('has-selection');
            
            // Close modal
            closePlanModal();
            
            // Update comparison display (including premium styling based on weight)
            // Pass true to mark this as a user modification since they manually selected a plan
            updateComparison(true);
        }

        function updateComparison(isUserModification = false) {
            const plan1Key = document.getElementById('compare-plan-1').value;
            const plan2Key = document.getElementById('compare-plan-2').value;
            const container = document.getElementById('comparison-table-container');
            
            // Save the current comparison settings to the row's state (if we're comparing a specific row)
            if (currentCompareRowId && STATE[currentCompareRowId]) {
                // Only mark as user-modified if this was a user action (not just loading defaults)
                const wasAlreadyModified = STATE[currentCompareRowId].compareSettings?.hasUserModified || false;
                STATE[currentCompareRowId].compareSettings = {
                    plan1Key: plan1Key,
                    plan2Key: plan2Key,
                    hasUserModified: wasAlreadyModified || isUserModification
                };
            }
            
            const trigger1 = document.getElementById('compare-plan-1-trigger');
            const trigger2 = document.getElementById('compare-plan-2-trigger');
            
            // Update premium styling based on plan weights
            const weight1 = plan1Key ? getPlanWeight(plan1Key) : 0;
            const weight2 = plan2Key ? getPlanWeight(plan2Key) : 0;
            
            // If both plans selected, compare weights - higher weight gets magenta
            if (plan1Key && plan2Key) {
                if (weight1 > weight2) {
                    trigger1.classList.add('premium');
                    trigger2.classList.remove('premium');
                } else if (weight2 > weight1) {
                    trigger1.classList.remove('premium');
                    trigger2.classList.add('premium');
                } else {
                    // Equal weights - both get premium if weight > 0, otherwise neither
                    if (weight1 > 0) {
                        trigger1.classList.add('premium');
                        trigger2.classList.add('premium');
                    } else {
                        trigger1.classList.remove('premium');
                        trigger2.classList.remove('premium');
                    }
                }
            } else {
                // Only one plan selected - show premium if it has weight > 0
                if (plan1Key) {
                    if (weight1 > 0) {
                        trigger1.classList.add('premium');
                    } else {
                        trigger1.classList.remove('premium');
                    }
                } else {
                    trigger1.classList.remove('premium');
                }
                
                if (plan2Key) {
                    if (weight2 > 0) {
                        trigger2.classList.add('premium');
                    } else {
                        trigger2.classList.remove('premium');
                    }
                } else {
                    trigger2.classList.remove('premium');
                }
            }
            
            // If neither plan selected, show empty container
            if (!plan1Key && !plan2Key) {
                container.innerHTML = '';
                document.querySelector('#compare-section .compare-dropdowns').classList.add('no-content');
                return;
            }
            
            // Content is being shown, remove no-content class
            document.querySelector('#compare-section .compare-dropdowns').classList.remove('no-content');
            
            // If only one plan selected, show single plan
            if (plan1Key && !plan2Key) {
                renderSinglePlan(plan1Key, container);
                return;
            }
            
            if (!plan1Key && plan2Key) {
                renderSinglePlan(plan2Key, container);
                return;
            }
            
            // Both plans selected - show comparison
            renderComparison(plan1Key, plan2Key, container);
        }

        // Helper to get the display value from a benefit (handles both string and object formats)
        function getBenefitValue(benefitData) {
            if (!benefitData) return 'Unknown';
            if (typeof benefitData === 'string') return benefitData;
            if (typeof benefitData === 'object' && benefitData.value !== undefined) {
                return benefitData.value;
            }
            return 'Unknown';
        }
        
        // Helper to get the weight from a benefit (default: 0)
        function getBenefitWeight(benefitData) {
            if (!benefitData) return 0;
            if (typeof benefitData === 'object' && typeof benefitData.weight === 'number') {
                return benefitData.weight;
            }
            return 0;
        }
        
        // Helper to get the weight from a plan (default: 0)
        function getPlanWeight(planKey) {
            const plan = getComparisonDataForPlan(planKey);
            if (!plan) return 0;
            if (typeof plan.weight === 'number') {
                return plan.weight;
            }
            // Fallback: check if it's a premium plan for backwards compatibility
            if (PREMIUM_PLANS.includes(planKey)) {
                return 1;
            }
            return 0;
        }
        
        // Helper to check if a benefit is hidden (only shown in comparisons)
        function isBenefitHidden(benefitData) {
            if (!benefitData) return false;
            if (typeof benefitData === 'object' && benefitData.hidden === true) {
                return true;
            }
            return false;
        }
        
        // Helper to check if two benefits have the same value
        function benefitValuesMatch(benefit1, benefit2) {
            const val1 = getBenefitValue(benefit1);
            const val2 = getBenefitValue(benefit2);
            
            // Also check valueSubtext if present
            const sub1 = (benefit1 && typeof benefit1 === 'object') ? (benefit1.valueSubtext || '') : '';
            const sub2 = (benefit2 && typeof benefit2 === 'object') ? (benefit2.valueSubtext || '') : '';
            
            return val1 === val2 && sub1 === sub2;
        }
        
        // Helper to get value class for styling
        // isPreferred: if true, forces 'included' (magenta) styling based on weight comparison
        // isOutweighed: if true, forces 'custom' (white) styling - used when other benefit has
        //               higher weight, OR when weights are equal but values differ
        function getValueClass(benefitData, isPreferred = false, isOutweighed = false) {
            // If this benefit has higher weight than comparison, use included (magenta) styling
            if (isPreferred) return 'included';
            
            // If this benefit is outweighed by the other, use white background
            if (isOutweighed) return 'custom';
            
            const value = getBenefitValue(benefitData);
            if (value === 'Unknown') return 'not-included';
            const lowerValue = value.toLowerCase();
            if (lowerValue.includes('not included')) return 'not-included';
            if (lowerValue === 'included') return 'included';
            return 'custom';
        }

        function renderSinglePlan(planKey, container) {
            const plan = getComparisonDataForPlan(planKey);
            if (!plan) return;
            
            // Check if plan is premium for styling purposes
            const weight = getPlanWeight(planKey);
            const isPremium = weight > 0;
            const tableClass = isPremium ? 'comparison-table plan1-premium' : 'comparison-table';
            
            let html = `<div class="${tableClass}">`;
            
            Object.entries(plan.benefits).forEach(([benefitKey, benefitData]) => {
                // Skip hidden benefits when showing a single plan
                if (isBenefitHidden(benefitData)) return;
                
                // For single plan view, don't highlight "Included" benefits with pink
                // Pink highlighting is meant to show advantages over another plan
                const value = getBenefitValue(benefitData);
                let valueClass = 'custom'; // Default to white background
                if (value === 'Unknown') {
                    valueClass = 'not-included';
                } else if (value.toLowerCase().includes('not included')) {
                    valueClass = 'not-included';
                }
                // Note: We intentionally don't set 'included' class here
                
                // Format benefit name and value with main/sub text
                const formattedName = formatBenefitName(benefitKey, benefitData);
                const formatted = formatBenefitValue(benefitData);
                
                html += `
                    <div class="comparison-row two-plans">
                        <div class="comparison-benefit-name">${formattedName}</div>
                        <div class="comparison-benefit-value ${valueClass}">${formatted}</div>
                        <div class="comparison-benefit-value" style="background: #f5f5f5;"></div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        function renderComparison(plan1Key, plan2Key, container) {
            const plan1 = getComparisonDataForPlan(plan1Key);
            const plan2 = getComparisonDataForPlan(plan2Key);
            
            if (!plan1 || !plan2) return;
            
            // Check if each plan header is premium (magenta) for styling purposes
            // This must match the logic in updateComparison() for trigger styling
            const planWeight1 = getPlanWeight(plan1Key);
            const planWeight2 = getPlanWeight(plan2Key);
            let isPlan1Premium = false;
            let isPlan2Premium = false;
            
            if (planWeight1 > planWeight2) {
                isPlan1Premium = true;
            } else if (planWeight2 > planWeight1) {
                isPlan2Premium = true;
            } else if (planWeight1 > 0) {
                // Equal weights and both > 0, both get premium
                isPlan1Premium = true;
                isPlan2Premium = true;
            }
            
            // Build table class based on premium status
            let tableClasses = ['comparison-table'];
            if (isPlan1Premium) tableClasses.push('plan1-premium');
            if (isPlan2Premium) tableClasses.push('plan2-premium');
            
            // Collect all unique benefits from both plans
            const allBenefits = new Set([
                ...Object.keys(plan1.benefits),
                ...Object.keys(plan2.benefits)
            ]);
            
            let html = `<div class="${tableClasses.join(' ')}">`;
            
            allBenefits.forEach(benefitKey => {
                const benefit1 = plan1.benefits[benefitKey];
                const benefit2 = plan2.benefits[benefitKey];
                
                // Check if benefits are hidden
                const isHidden1 = isBenefitHidden(benefit1);
                const isHidden2 = isBenefitHidden(benefit2);
                
                // Skip if both benefits are hidden, or if one is hidden and the other doesn't exist
                // Only show hidden benefits when comparing against a non-hidden version
                if (isHidden1 && isHidden2) return;
                if (isHidden1 && !benefit2) return;
                if (isHidden2 && !benefit1) return;
                
                // Check if values are the same
                const valuesMatch = benefitValuesMatch(benefit1, benefit2);
                
                // Get weights for comparison
                const weight1 = getBenefitWeight(benefit1);
                const weight2 = getBenefitWeight(benefit2);
                
                // Determine if either benefit is "preferred" or "outweighed" based on weight
                // Only applies when values don't match
                // If weights are equal but values differ (e.g., both "Included" with different subtext),
                // both get white background (neither is preferred)
                const isPreferred1 = !valuesMatch && weight1 > weight2;
                const isPreferred2 = !valuesMatch && weight2 > weight1;
                const isOutweighed1 = !valuesMatch && weight2 >= weight1;
                const isOutweighed2 = !valuesMatch && weight1 >= weight2;
                
                const valueClass1 = getValueClass(benefit1, isPreferred1, isOutweighed1);
                const valueClass2 = getValueClass(benefit2, isPreferred2, isOutweighed2);
                
                const differentClass = !valuesMatch ? 'different' : '';
                
                // Use the benefit data from whichever plan has it for name formatting
                // Prefer the non-hidden benefit for formatting
                const benefitData = (!isHidden1 && benefit1) ? benefit1 : benefit2;
                
                // Format benefit names and values with main/sub text
                const formattedName = formatBenefitName(benefitKey, benefitData);
                const formatted1 = formatBenefitValue(benefit1 || { value: 'Unknown' });
                const formatted2 = formatBenefitValue(benefit2 || { value: 'Unknown' });
                
                if (valuesMatch) {
                    // Merge cells for matching values
                    html += `
                        <div class="comparison-row two-plans">
                            <div class="comparison-benefit-name">${formattedName}</div>
                            <div class="comparison-benefit-value merged ${valueClass1}">${formatted1}</div>
                        </div>
                    `;
                } else {
                    // Show separate cells for different values
                    html += `
                        <div class="comparison-row two-plans ${differentClass}">
                            <div class="comparison-benefit-name">${formattedName}</div>
                            <div class="comparison-benefit-value ${valueClass1}">${formatted1}</div>
                            <div class="comparison-benefit-value ${valueClass2}">${formatted2}</div>
                        </div>
                    `;
                }
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        function formatBenefitName(benefitKey, benefitData) {
            // Handle new object format with separate title/subtext
            if (benefitData && typeof benefitData === 'object') {
                const title = benefitData.title || benefitKey;
                const titleStyle = benefitData.titleStyle ? ` style="${benefitData.titleStyle}"` : '';
                
                if (benefitData.subtext) {
                    const subtextStyle = benefitData.subtextStyle ? ` style="${benefitData.subtextStyle}"` : '';
                    return `<span class="benefit-name-main"${titleStyle}>${title}</span><span class="benefit-name-sub"${subtextStyle}>${benefitData.subtext}</span>`;
                }
                return `<span class="benefit-name-main"${titleStyle}>${title}</span>`;
            }
            
            // Legacy support: handle string format "Name (detail)"
            const name = benefitKey;
            const parenMatch = name.match(/^([^(]+)\s*\(([^)]+)\)$/);
            if (parenMatch) {
                return `<span class="benefit-name-main">${parenMatch[1].trim()}</span><span class="benefit-name-sub">${parenMatch[2].trim()}</span>`;
            }
            
            // Default: just show as main text
            return `<span class="benefit-name-main">${name}</span>`;
        }

        function formatBenefitValue(benefitData) {
            // Handle new object format with value/valueSubtext
            if (benefitData && typeof benefitData === 'object' && benefitData.value !== undefined) {
                const value = benefitData.value;
                const valueStyle = benefitData.valueStyle ? ` style="${benefitData.valueStyle}"` : '';
                
                if (benefitData.valueSubtext) {
                    const valueSubtextStyle = benefitData.valueSubtextStyle ? ` style="${benefitData.valueSubtextStyle}"` : '';
                    return `<span class="benefit-main"${valueStyle}>${value}</span><span class="benefit-sub"${valueSubtextStyle}>${benefitData.valueSubtext}</span>`;
                }
                return `<span class="benefit-main"${valueStyle}>${value}</span>`;
            }
            
            // Legacy support: handle string value
            const value = typeof benefitData === 'string' ? benefitData : String(benefitData);
            
            // Pattern: "Word (detail)" -> split on parentheses
            const parenMatch = value.match(/^([^(]+)\s*\(([^)]+)\)$/);
            if (parenMatch) {
                return `<span class="benefit-main">${parenMatch[1].trim()}</span><span class="benefit-sub">(${parenMatch[2].trim()})</span>`;
            }
            
            // Pattern: "Number + Unit + detail" (like "250GB High-Speed Mobile Hotspot / Line")
            const dataMatch = value.match(/^(\d+(?:GB|MB|TB))\s+(.+)$/);
            if (dataMatch) {
                return `<span class="benefit-main">${dataMatch[1]}</span><span class="benefit-sub">${dataMatch[2]}</span>`;
            }
            
            // Pattern: "Discounted to $X/Month"
            const discountMatch = value.match(/^(Discounted to)\s+(.+)$/);
            if (discountMatch) {
                return `<span class="benefit-main">${discountMatch[1]}</span><span class="benefit-sub">${discountMatch[2]}</span>`;
            }
            
            // Pattern: "then" separator (common in data descriptions)
            if (value.includes(' then ')) {
                const parts = value.split(' then ');
                return `<span class="benefit-main">${parts[0]}</span><span class="benefit-sub">then ${parts[1]}</span>`;
            }
            
            // Default: just show as main text
            return `<span class="benefit-main">${value}</span>`;
        }

        function toggleMode() {
            // Legacy function - for backwards compatibility
            const mode = currentMode === 'new' ? 'existing' : 'new';
            setMode(mode);
        }

        function resetCalculator() {
            // Destroy carousel if active
            const container = document.getElementById('rows-container');
            if (container.classList.contains('carousel-mode')) {
                container.classList.remove('carousel-mode');
                destroyCarousel();
            }
            
            // Remove carousel nav if exists
            const carouselNav = document.getElementById('carousel-nav');
            if (carouselNav) {
                carouselNav.remove();
            }
            
            container.innerHTML = '';
            STATE = {};
            // Note: globalAdjustments is NOT reset here to preserve settings loaded from localStorage
            rowCount = 0;
            currentCarouselIndex = 0;
            createNewRow();
            
            // Re-init carousel if in stacked mode
            if (quoteDisplayStyle === 'stacked') {
                container.classList.add('carousel-mode');
                initCarousel();
            }
        }

        function updateExportButtonVisibility() {
            const btn = document.getElementById('export-pdf');
            const rowDivs = document.querySelectorAll('.calculator-row');
            const count = rowDivs.length;
            
            let show = false;
            let text = "Print Quote";
            
            // Check if any row has valid content
            let hasContent = false;
            Object.keys(STATE).forEach(rowId => {
                const lineCount = parseInt(document.getElementById(`${rowId}-lines`)?.value) || 0;
                const planEl = document.getElementById(`${rowId}-plan`);
                const planName = planEl ? planEl.value : '';
                const cdCount = STATE[rowId].connectedDevices?.length || 0;
                const hiCount = STATE[rowId].homeInternet?.length || 0;
                
                // For existing mode, also check manual price
                const row = document.getElementById(rowId);
                const isManual = row?.getAttribute('data-mode') === 'existing';
                const manualPrice = isManual ? (parseFloat(document.getElementById(`${rowId}-manual-price`)?.value) || 0) : 0;
                
                // New mode: needs (lines + plan selected) OR CD OR HI
                // Existing mode: needs manual price OR upgrades OR CD OR HI
                if (isManual) {
                    if (manualPrice > 0 || lineCount > 0 || cdCount > 0 || hiCount > 0) {
                        hasContent = true;
                    }
                } else {
                    if ((lineCount > 0 && planName) || cdCount > 0 || hiCount > 0) {
                        hasContent = true;
                    }
                }
            });

            if (currentMode === 'new') {
                if (count >= 1 && hasContent) show = true;
                text = "Print Quote";
            } else {
                // Existing mode: show button with at least 1 row and content
                if (count >= 1 && hasContent) show = true;
                text = "Print Quote";
            }
            
            btn.textContent = text;
            if (show) btn.classList.remove('hidden');
            else btn.classList.add('hidden');
        }

        function toggleTimeline(rowId) {
            const section = document.getElementById(`${rowId}-timeline-section`);
            section.classList.toggle('expanded');
            
            // Update carousel height immediately and after animation
            updateCarouselContainerHeight();
            setTimeout(() => {
                updateCarouselContainerHeight();
            }, 100);
            setTimeout(() => {
                updateCarouselContainerHeight();
            }, 400);
        }

        function formatPhone(input) {
            let value = input.value.replace(/\D/g, ''); 
            if (value.length > 10) value = value.substring(0, 10);
            
            let formatted = '';
            if (value.length > 0) formatted = value.substring(0, 3);
            if (value.length >= 4) formatted += '-' + value.substring(3, 6);
            if (value.length >= 7) formatted += '-' + value.substring(6, 10);
            input.value = formatted;
        }
        
        // --- SETTINGS SIDEBAR ---
        function openSettingsSidebar() {
            document.getElementById('settings-sidebar').classList.add('open');
            document.getElementById('settings-overlay').classList.add('open');
            renderAdjustmentList();
            initSettingsSectionDrag();
        }
        
        function closeSettingsSidebar() {
            document.getElementById('settings-sidebar').classList.remove('open');
            document.getElementById('settings-overlay').classList.remove('open');
        }
        
        // Helper to get standard protection tier equivalent for a P360 tier
        function getStandardTierEquivalent(tierIdOrValue) {
            if (!tierIdOrValue) return 0;
            
            // If it's already a standard tier, look it up
            if (typeof tierIdOrValue === 'string' && tierIdOrValue.startsWith('std-')) {
                const opt = PROTECTION_OPTIONS.find(o => o.id === tierIdOrValue);
                return opt ? opt.value : 0;
            }
            
            // If it's a P360 tier, find the equivalent standard tier
            if (typeof tierIdOrValue === 'string' && tierIdOrValue.startsWith('p360-')) {
                const tierNum = tierIdOrValue.replace('p360-', ''); // e.g., 't5'
                const stdTierId = 'std-' + tierNum;
                const opt = PROTECTION_OPTIONS.find(o => o.id === stdTierId);
                return opt ? opt.value : 0;
            }
            
            // Legacy numeric value handling - assume no standard equivalent
            return 0;
        }
        
        // --- ITEMIZED PRICES TOGGLE ---
        function toggleItemizedCategory(category, show) {
            showItemizedPrices[category] = show;
            recalculateAllRows();
            saveSettingsToURL();
        }
        
        function toggleRetailVisibility(category, show) {
            showRetailPrices[category] = show;
            recalculateAllRows();
            saveSettingsToURL();
        }
        
        function togglePerLinePricing(enabled) {
            showPerLinePricing = enabled;
            recalculateAllRows();
            saveSettingsToURL();
        }
        
        function toggleComparePrices(enabled) {
            showComparePrices = enabled;
            saveSettingsToURL();
            // Refresh compare view if visible
            if (currentMode === 'compare') {
                refreshCompareView();
            }
        }
        
        function updateRoundingMode() {
            roundingMode = document.getElementById('rounding-mode').value;
            recalculateAllRows();
            saveSettingsToURL();
        }
        
        function toggleCombineDevices(checked) {
            combineIdenticalDevices = checked;
            saveSettingsToURL();
        }
        
        function applyRounding(value) {
            if (roundingMode === 'none') return value;
            
            const multiple = roundingMode.includes('-5') ? 5 : 10;
            
            if (roundingMode.startsWith('nearest-')) {
                // Round to nearest (standard rounding - up or down to closest)
                return Math.round(value / multiple) * multiple;
            }
            
            const direction = roundingMode.includes('up-') ? 'up' : 'down';
            
            if (direction === 'up') {
                return Math.ceil(value / multiple) * multiple;
            } else {
                return Math.floor(value / multiple) * multiple;
            }
        }
        
        // --- PLAN TABS SCROLL ARROWS ---
        function scrollPlanTabs(direction) {
            const container = document.getElementById('plan-tabs-container');
            const scrollAmount = container.offsetWidth * 0.5;
            container.scrollLeft += direction * scrollAmount;
            setTimeout(updatePlanTabArrows, 300);
        }
        
        function updatePlanTabArrows() {
            const container = document.getElementById('plan-tabs-container');
            const leftArrow = container.parentElement.querySelector('.plan-tabs-arrow.left');
            const rightArrow = container.parentElement.querySelector('.plan-tabs-arrow.right');
            
            if (leftArrow) {
                if (container.scrollLeft <= 0) {
                    leftArrow.classList.add('hidden');
                } else {
                    leftArrow.classList.remove('hidden');
                }
            }
            
            if (rightArrow) {
                if (container.scrollLeft >= container.scrollWidth - container.offsetWidth - 5) {
                    rightArrow.classList.add('hidden');
                } else {
                    rightArrow.classList.remove('hidden');
                }
            }
        }
        
        // --- CD TABS SCROLL FUNCTIONS ---
        function scrollCDTabs(direction) {
            const container = document.getElementById('cd-tabs-container');
            const scrollAmount = container.offsetWidth * 0.5;
            container.scrollLeft += direction * scrollAmount;
            setTimeout(updateCDTabArrows, 300);
        }
        
        function updateCDTabArrows() {
            const container = document.getElementById('cd-tabs-container');
            if (!container) return;
            const leftArrow = container.parentElement.querySelector('.cd-tabs-arrow.left');
            const rightArrow = container.parentElement.querySelector('.cd-tabs-arrow.right');
            
            if (leftArrow) {
                if (container.scrollLeft <= 0) {
                    leftArrow.classList.add('hidden');
                } else {
                    leftArrow.classList.remove('hidden');
                }
            }
            
            if (rightArrow) {
                if (container.scrollLeft >= container.scrollWidth - container.offsetWidth - 5) {
                    rightArrow.classList.add('hidden');
                } else {
                    rightArrow.classList.remove('hidden');
                }
            }
        }
        
        function addGlobalAdjustment() {
            let name = document.getElementById('adjustment-name').value.trim();
            const value = parseFloat(document.getElementById('adjustment-value').value) || 0;
            const type = document.getElementById('adjustment-type').value;
            
            if (value === 0) {
                alert('Please enter an amount');
                return;
            }
            
            // Default name based on type if not provided
            if (!name) {
                if (type === 'per-line') {
                    name = 'Per Line';
                } else if (type === 'per-device') {
                    name = 'Per Device';
                } else if (type === 'one-time') {
                    name = 'One Time';
                } else if (type === 'percent') {
                    name = 'Percent';
                }
            }
            
            globalAdjustments.push({ name, value, type });
            
            // Clear inputs
            document.getElementById('adjustment-name').value = '';
            document.getElementById('adjustment-value').value = '';
            
            renderAdjustmentList();
            recalculateAllRows();
            saveSettingsToURL();
        }
        
        function removeGlobalAdjustment(index) {
            globalAdjustments.splice(index, 1);
            renderAdjustmentList();
            recalculateAllRows();
            saveSettingsToURL();
        }
        
        let adjustmentEditMode = false;
        let holdTimer = null;
        let draggedItem = null;
        let draggedIndex = -1;
        let dragStartY = 0;
        let dragOffsetY = 0;
        
        function renderAdjustmentList() {
            const container = document.getElementById('adjustment-list');
            container.innerHTML = '';
            
            if (adjustmentEditMode) {
                container.classList.add('edit-mode');
            } else {
                container.classList.remove('edit-mode');
            }
            
            globalAdjustments.forEach((adj, index) => {
                const typeLabel = adj.type === 'per-line' ? '/line' : (adj.type === 'per-device' ? '/device' : (adj.type === 'percent' ? '%' : ' flat'));
                const div = document.createElement('div');
                div.className = 'adjustment-item';
                div.dataset.index = index;
                div.innerHTML = `
                    <span class="adjustment-item-content">
                        <span class="adjustment-item-text">${adj.name}: ${adj.type === 'percent' ? '' : '$'}${adj.value}${typeLabel}</span>
                    </span>
                    <button class="adjustment-item-remove" onclick="event.stopPropagation(); removeGlobalAdjustment(${index})"></button>
                `;
                
                // Long press to enter edit mode
                let pressTimer = null;
                let touchStartX = 0;
                let touchStartY = 0;
                let hasMoved = false;
                
                const startPress = (e) => {
                    if (e.type === 'touchstart') {
                        touchStartX = e.touches[0].clientX;
                        touchStartY = e.touches[0].clientY;
                        hasMoved = false;
                    }
                    
                    if (adjustmentEditMode) {
                        // In edit mode, start drag immediately
                        if (e.type === 'touchstart') {
                            e.preventDefault(); // Prevent context menu
                            draggedItem = div;
                            draggedIndex = index;
                            dragStartY = e.touches[0].clientY;
                            const rect = div.getBoundingClientRect();
                            dragOffsetY = e.touches[0].clientY - rect.top;
                            div.classList.add('dragging');
                            div.style.position = 'relative';
                            div.style.zIndex = '100';
                        }
                        return;
                    }
                    
                    pressTimer = setTimeout(() => {
                        if (!hasMoved) {
                            adjustmentEditMode = true;
                            renderAdjustmentList();
                            // Vibrate if supported
                            if (navigator.vibrate) navigator.vibrate(50);
                        }
                    }, 500);
                    div.classList.add('held');
                };
                
                const moveHandler = (e) => {
                    if (e.type === 'touchmove') {
                        const touchX = e.touches[0].clientX;
                        const touchY = e.touches[0].clientY;
                        const moveDistance = Math.sqrt(
                            Math.pow(touchX - touchStartX, 2) + 
                            Math.pow(touchY - touchStartY, 2)
                        );
                        if (moveDistance > 10) {
                            hasMoved = true;
                            if (pressTimer) {
                                clearTimeout(pressTimer);
                                pressTimer = null;
                            }
                        }
                        
                        // Handle drag in edit mode
                        if (adjustmentEditMode && draggedItem && draggedIndex === index) {
                            e.preventDefault();
                            const currentY = e.touches[0].clientY;
                            const deltaY = currentY - dragStartY;
                            div.style.transform = `translateY(${deltaY}px) scale(1.05)`;
                            
                            // Find drop target
                            const items = container.querySelectorAll('.adjustment-item');
                            items.forEach((item, idx) => {
                                if (idx === index) return;
                                const itemRect = item.getBoundingClientRect();
                                if (currentY > itemRect.top && currentY < itemRect.bottom) {
                                    item.classList.add('drag-over');
                                } else {
                                    item.classList.remove('drag-over');
                                }
                            });
                        }
                    }
                };
                
                const endPress = (e) => {
                    if (pressTimer) clearTimeout(pressTimer);
                    div.classList.remove('held');
                    
                    // Handle drag end in edit mode
                    if (adjustmentEditMode && draggedItem && draggedIndex === index) {
                        const currentY = e.changedTouches ? e.changedTouches[0].clientY : 0;
                        const items = Array.from(container.querySelectorAll('.adjustment-item'));
                        
                        // Find new position
                        let newIndex = index;
                        items.forEach((item, idx) => {
                            if (idx === index) return;
                            const itemRect = item.getBoundingClientRect();
                            const itemCenter = itemRect.top + itemRect.height / 2;
                            if (currentY > itemCenter && idx > index) {
                                newIndex = idx;
                            } else if (currentY < itemCenter && idx < index) {
                                newIndex = Math.min(newIndex, idx);
                            }
                        });
                        
                        if (newIndex !== index) {
                            const item = globalAdjustments.splice(index, 1)[0];
                            globalAdjustments.splice(newIndex, 0, item);
                            recalculateAllRows();
                            saveSettingsToURL();
                        }
                        
                        draggedItem = null;
                        draggedIndex = -1;
                        renderAdjustmentList();
                    }
                };
                
                div.addEventListener('mousedown', startPress);
                div.addEventListener('mouseup', endPress);
                div.addEventListener('mouseleave', endPress);
                
                // Use passive: false for touchstart to allow preventDefault
                div.addEventListener('touchstart', startPress, { passive: false });
                div.addEventListener('touchmove', moveHandler, { passive: false });
                div.addEventListener('touchend', endPress);
                div.addEventListener('touchcancel', endPress);
                
                // Prevent context menu on long press
                div.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    return false;
                });
                
                container.appendChild(div);
            });
            
            // Add done button if in edit mode
            let footer = document.getElementById('adjustment-list-footer');
            if (!footer) {
                footer = document.createElement('div');
                footer.id = 'adjustment-list-footer';
                footer.className = 'adjustment-list-footer';
                footer.innerHTML = '<button class="done-editing-btn" onclick="exitAdjustmentEditMode()">Done</button>';
                container.after(footer);
            }
            
            if (adjustmentEditMode) {
                footer.querySelector('.done-editing-btn').style.display = 'block';
            } else {
                footer.querySelector('.done-editing-btn').style.display = 'none';
            }
        }
        
        function exitAdjustmentEditMode() {
            adjustmentEditMode = false;
            renderAdjustmentList();
        }
        
        // Settings Section Drag Functionality
        let sectionDraggedItem = null;
        let sectionDragStartY = 0;
        
        function initSettingsSectionDrag() {
            const settingsBody = document.getElementById('settings-body');
            if (!settingsBody) return;
            
            const sections = settingsBody.querySelectorAll('.draggable-section');
            
            sections.forEach(section => {
                const handle = section.querySelector('.drag-handle');
                if (!handle) return;
                
                // Mouse events
                handle.addEventListener('mousedown', (e) => startSectionDrag(e, section));
                
                // Touch events
                handle.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    startSectionDrag(e, section);
                }, { passive: false });
            });
            
            // Global move and end events
            document.addEventListener('mousemove', moveSectionDrag);
            document.addEventListener('mouseup', endSectionDrag);
            document.addEventListener('touchmove', moveSectionDrag, { passive: false });
            document.addEventListener('touchend', endSectionDrag);
        }
        
        function startSectionDrag(e, section) {
            sectionDraggedItem = section;
            sectionDragStartY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
            section.classList.add('dragging');
            section.style.zIndex = '100';
        }
        
        function moveSectionDrag(e) {
            if (!sectionDraggedItem) return;
            
            if (e.type === 'touchmove') {
                e.preventDefault();
            }
            
            const currentY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
            const deltaY = currentY - sectionDragStartY;
            sectionDraggedItem.style.transform = `translateY(${deltaY}px)`;
            
            // Find potential drop target
            const settingsBody = document.getElementById('settings-body');
            const sections = settingsBody.querySelectorAll('.draggable-section');
            
            sections.forEach(section => {
                if (section === sectionDraggedItem) return;
                section.classList.remove('drag-over');
                
                const rect = section.getBoundingClientRect();
                if (currentY > rect.top && currentY < rect.bottom) {
                    section.classList.add('drag-over');
                }
            });
        }
        
        function endSectionDrag(e) {
            if (!sectionDraggedItem) return;
            
            const currentY = e.type.includes('touch') 
                ? (e.changedTouches ? e.changedTouches[0].clientY : 0) 
                : e.clientY;
            
            const settingsBody = document.getElementById('settings-body');
            const sections = Array.from(settingsBody.querySelectorAll('.draggable-section'));
            
            // Find drop target
            let targetSection = null;
            let insertBefore = true;
            
            sections.forEach(section => {
                if (section === sectionDraggedItem) return;
                section.classList.remove('drag-over');
                
                const rect = section.getBoundingClientRect();
                if (currentY > rect.top && currentY < rect.bottom) {
                    targetSection = section;
                    const sectionCenter = rect.top + rect.height / 2;
                    insertBefore = currentY < sectionCenter;
                }
            });
            
            // Reorder if valid target
            if (targetSection) {
                if (insertBefore) {
                    settingsBody.insertBefore(sectionDraggedItem, targetSection);
                } else {
                    settingsBody.insertBefore(sectionDraggedItem, targetSection.nextSibling);
                }
                // Save the new section order
                saveSectionOrder();
            }
            
            // Reset styles
            sectionDraggedItem.classList.remove('dragging');
            sectionDraggedItem.style.transform = '';
            sectionDraggedItem.style.zIndex = '';
            sectionDraggedItem = null;
        }
        
        function saveSectionOrder() {
            const settingsBody = document.getElementById('settings-body');
            const sections = settingsBody.querySelectorAll('.draggable-section');
            const order = Array.from(sections).map(s => s.getAttribute('data-section-id'));
            try {
                localStorage.setItem('quoteCalcSectionOrder', JSON.stringify(order));
            } catch(e) {
                console.log('Could not save section order');
            }
        }
        
        function loadSectionOrder() {
            try {
                const stored = localStorage.getItem('quoteCalcSectionOrder');
                if (!stored) return;
                
                const order = JSON.parse(stored);
                const settingsBody = document.getElementById('settings-body');
                
                // Reorder sections according to saved order
                order.forEach(sectionId => {
                    const section = settingsBody.querySelector(`[data-section-id="${sectionId}"]`);
                    if (section) {
                        settingsBody.appendChild(section);
                    }
                });
            } catch(e) {
                console.log('Could not load section order');
            }
        }
        
        function updateTaxPercentage(value) {
            taxPercentage = parseFloat(value) || 0;
            if (taxPercentage < 0) taxPercentage = 0;
            if (taxPercentage > 100) taxPercentage = 100;
            // Don't set display to 0 - let placeholder show instead
            document.getElementById('tax-percentage').value = taxPercentage > 0 ? taxPercentage : '';
            recalculateAllRows();
        }
        
        function recalculateAllRows() {
            Object.keys(STATE).forEach(rowId => {
                calculateRow(rowId);
            });
        }
        
        function calculateGlobalAdjustments(baseTotal, lineCount, deviceCount = 0) {
            let adjustment = 0;
            globalAdjustments.forEach(adj => {
                if (adj.type === 'per-line') {
                    adjustment += adj.value * lineCount;
                } else if (adj.type === 'per-device') {
                    adjustment += adj.value * deviceCount;
                } else if (adj.type === 'one-time') {
                    adjustment += adj.value;
                } else if (adj.type === 'percent') {
                    adjustment += baseTotal * (adj.value / 100);
                }
            });
            return adjustment;
        }

        function openContactModal() {
            document.getElementById('contact-modal').classList.add('open');
        }

        function closeContactModal() {
            document.getElementById('contact-modal').classList.remove('open');
        }
        
        // Load Quote Modal Functions
        function openLoadQuoteModal() {
            document.getElementById('load-quote-modal').classList.add('open');
            document.getElementById('load-result').style.display = 'none';
            document.getElementById('quote-file-input').value = '';
        }
        
        function closeLoadQuoteModal() {
            document.getElementById('load-quote-modal').classList.remove('open');
        }
        
        // Global variable to track loaded quote file
        let loadedQuoteFile = null;
        
        function loadQuoteFromFile(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Validate the data
                    if (!data.version || !data.quotes) {
                        throw new Error('Invalid quote file format');
                    }
                    
                    // Load the quote data
                    loadFullQuoteData(data);
                    
                    // Store the loaded file reference
                    loadedQuoteFile = {
                        name: file.name,
                        data: data
                    };
                    
                    // Update UI
                    document.getElementById('load-result').style.display = 'block';
                    document.getElementById('load-result').classList.add('success');
                    document.getElementById('load-result').classList.remove('error');
                    document.getElementById('load-result-text').textContent = `Quote loaded: ${data.customerName || 'Unnamed'}`;
                    
                    // Grey out load button
                    const loadBtn = document.getElementById('load-quote-btn');
                    if (loadBtn) {
                        loadBtn.classList.add('btn-disabled');
                        loadBtn.title = 'Quote already loaded';
                    }
                    
                    setTimeout(() => closeLoadQuoteModal(), 1500);
                    
                } catch (err) {
                    document.getElementById('load-result').style.display = 'block';
                    document.getElementById('load-result').classList.add('error');
                    document.getElementById('load-result').classList.remove('success');
                    document.getElementById('load-result-text').textContent = 'Error loading quote: ' + err.message;
                }
            };
            reader.readAsText(file);
        }
        
        function loadFullQuoteData(data) {
            // Reset calculator
            document.getElementById('rows-container').innerHTML = '';
            STATE = {};
            globalAdjustments = data.globalAdjustments || [];
            rowCount = 0;
            
            // Set mode - update UI directly without calling setMode to avoid resetCalculator
            const savedMode = data.mode || 'new';
            const isExistingMode = savedMode === 'existing';
            
            // Update mode and toggle UI directly
            currentMode = savedMode;
            const slider = document.getElementById('toggle-slider');
            const labels = document.querySelectorAll('.toggle-labels span');
            labels.forEach(label => label.classList.remove('active'));
            const compareLinkWrapper = document.getElementById('compare-link-wrapper');
            
            if (savedMode === 'new') {
                slider.className = 'toggle-slider position-0';
                labels[0].classList.add('active');
            } else {
                slider.className = 'toggle-slider position-1';
                labels[1].classList.add('active');
            }
            document.getElementById('rows-container').style.display = 'block';
            document.getElementById('compare-section').classList.remove('active');
            document.body.classList.remove('compare-mode');
            if (compareLinkWrapper) compareLinkWrapper.classList.remove('hidden');
            
            // Load contact info
            if (data.repName) document.getElementById('contact-rep-name').value = data.repName;
            if (data.repPhone) document.getElementById('contact-rep-phone').value = data.repPhone;
            if (data.customerName) document.getElementById('contact-cust-name').value = data.customerName;
            if (data.customerPhone) document.getElementById('contact-cust-phone').value = data.customerPhone;
            
            // Load each quote/row
            data.quotes.forEach((quoteData, index) => {
                createNewRow();
                const rowId = `row-${rowCount}`;
                
                // Set title
                const titleInput = document.getElementById(`${rowId}-quote-title`);
                if (titleInput && quoteData.title) titleInput.value = quoteData.title;
                
                // Set carrier info
                if (quoteData.carrierName) {
                    STATE[rowId].carrierName = quoteData.carrierName;
                    STATE[rowId].carrierPrice = quoteData.carrierPrice || 0;
                    STATE[rowId].carrierSkipped = quoteData.carrierSkipped || false;
                    updateCarrierDisplay(rowId);
                }
                
                // Set lines
                const linesInput = document.getElementById(`${rowId}-lines`);
                if (linesInput && quoteData.lines !== undefined) {
                    linesInput.value = quoteData.lines;
                    if (isExistingMode) {
                        validateUpgrades(linesInput, rowId);
                    } else {
                        // Lines column is always visible, just validate
                        validateLines(linesInput, rowId);
                    }
                }
                
                // Set plan
                if (!isExistingMode && quoteData.plan) {
                    document.getElementById(`${rowId}-plan`).value = quoteData.plan;
                    document.getElementById(`${rowId}-plan-trigger`).value = quoteData.plan;
                    handleStandardPlan(rowId);
                }
                
                // Set manual price for existing mode
                if (isExistingMode && quoteData.manualPrice) {
                    const manualPrice = document.getElementById(`${rowId}-manual-price`);
                    if (manualPrice) {
                        manualPrice.value = quoteData.manualPrice;
                        handleManualPrice(rowId);
                    }
                }
                
                // Load devices
                if (quoteData.devices) {
                    STATE[rowId].devices = quoteData.devices;
                    STATE[rowId].protectionStatus = quoteData.protectionStatus || {};
                    STATE[rowId].protectionCosts = quoteData.protectionCosts || {};
                    renderDeviceList(rowId);
                }
                
                // Load accessories
                if (quoteData.accessories) {
                    STATE[rowId].accessories = quoteData.accessories;
                    // Accessories are rendered in renderDeviceList, so re-render
                    renderDeviceList(rowId);
                }
                
                // Load connected devices
                if (quoteData.connectedDevices) {
                    STATE[rowId].connectedDevices = quoteData.connectedDevices.map(cd => {
                        const planData = CONNECTED_DEVICE_PLANS[cd.category]?.[cd.planKey] || {};
                        return { ...cd, planData };
                    });
                    renderCDList(rowId);
                }
                
                // Load home internet
                if (quoteData.homeInternet) {
                    STATE[rowId].homeInternet = quoteData.homeInternet.map(hi => {
                        const planData = HOME_INTERNET_PLANS[hi.planKey] || {};
                        return { ...hi, planData };
                    });
                    renderHIList(rowId);
                }
                
                // Load rebates
                if (quoteData.rebates) {
                    STATE[rowId].rebates = quoteData.rebates;
                    renderRebateList(rowId);
                }
                
                // Load discounts
                if (quoteData.discounts) {
                    STATE[rowId].discounts = quoteData.discounts;
                    renderDiscountList(rowId);
                }
                
                // Load due today items
                if (quoteData.dueTodayItems) {
                    STATE[rowId].dueTodayItems = quoteData.dueTodayItems;
                }
                
                // Load saved today items
                if (quoteData.savedTodayItems) {
                    STATE[rowId].savedTodayItems = quoteData.savedTodayItems;
                }
                
                // Load savings today
                if (quoteData.savingsToday !== undefined) {
                    STATE[rowId].savingsToday = quoteData.savingsToday;
                }
                
                // Load compare settings
                if (quoteData.compareSettings) {
                    STATE[rowId].compareSettings = {
                        plan1Key: quoteData.compareSettings.plan1Key || '',
                        plan2Key: quoteData.compareSettings.plan2Key || '',
                        hasUserModified: quoteData.compareSettings.hasUserModified || false
                    };
                }
                
                // Load notes
                const notesTextarea = document.getElementById(`${rowId}-notes`);
                if (notesTextarea && quoteData.notes) {
                    notesTextarea.value = quoteData.notes;
                }
                
                calculateRow(rowId);
            });
            
            // Render adjustments list
            renderAdjustmentList();
            
            // Update default benefits slider visibility based on loaded plans
            toggleDefaultBenefitsSwitch();
        }
        
        async function saveQuoteToFile() {
            const custName = document.getElementById('contact-cust-name').value.trim() || 'Customer';
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            
            const quoteData = {
                version: 2,
                savedAt: now.toISOString(),
                mode: currentMode,
                repName: document.getElementById('contact-rep-name').value,
                repPhone: document.getElementById('contact-rep-phone').value,
                customerName: document.getElementById('contact-cust-name').value,
                customerPhone: document.getElementById('contact-cust-phone').value,
                globalAdjustments: globalAdjustments,
                quotes: []
            };
            
            // Save each row
            Object.keys(STATE).forEach(rowId => {
                const row = document.getElementById(rowId);
                const isManualMode = row?.getAttribute('data-mode') === 'existing';
                const titleInput = document.getElementById(`${rowId}-quote-title`);
                const notesTextarea = document.getElementById(`${rowId}-notes`);
                
                const rowData = {
                    title: titleInput?.value || '',
                    carrierName: STATE[rowId].carrierName || '',
                    carrierPrice: STATE[rowId].carrierPrice || 0,
                    carrierSkipped: STATE[rowId].carrierSkipped || false,
                    lines: parseInt(document.getElementById(`${rowId}-lines`)?.value) || 0,
                    plan: document.getElementById(`${rowId}-plan`)?.value || '',
                    manualPrice: isManualMode ? parseFloat(document.getElementById(`${rowId}-manual-price`)?.value) || 0 : 0,
                    devices: STATE[rowId].devices,
                    accessories: STATE[rowId].accessories || [],
                    protectionStatus: STATE[rowId].protectionStatus,
                    protectionCosts: STATE[rowId].protectionCosts,
                    connectedDevices: STATE[rowId].connectedDevices.map(cd => ({
                        category: cd.category,
                        planKey: cd.planKey,
                        devName: cd.devName,
                        devCost: cd.devCost,
                        devDown: cd.devDown,
                        devPromo: cd.devPromo,
                        term: cd.term,
                        quantity: cd.quantity
                    })),
                    homeInternet: STATE[rowId].homeInternet.map(hi => ({
                        planKey: hi.planKey,
                        label: hi.label
                    })),
                    addons: STATE[rowId].addons || [],
                    rebates: STATE[rowId].rebates,
                    discounts: STATE[rowId].discounts,
                    dueTodayItems: STATE[rowId].dueTodayItems || [],
                    savedTodayItems: STATE[rowId].savedTodayItems || [],
                    savingsToday: STATE[rowId].savingsToday || 0,
                    compareSettings: STATE[rowId].compareSettings || { plan1Key: '', plan2Key: '', hasUserModified: false },
                    notes: notesTextarea?.value || ''
                };
                
                quoteData.quotes.push(rowData);
            });
            
            const jsonContent = JSON.stringify(quoteData, null, 2);
            const defaultFileName = `${custName.replace(/[^a-zA-Z0-9]/g, '_')}_${dateStr}.quote.json`;
            
            // Try to use the File System Access API (allows user to choose location)
            if (window.showSaveFilePicker) {
                try {
                    const fileHandle = await window.showSaveFilePicker({
                        suggestedName: defaultFileName,
                        types: [{
                            description: 'Quote Files',
                            accept: { 'application/json': ['.json', '.quote.json'] }
                        }]
                    });
                    
                    const writable = await fileHandle.createWritable();
                    await writable.write(jsonContent);
                    await writable.close();
                    
                    // Update loaded file reference
                    loadedQuoteFile = {
                        name: fileHandle.name,
                        data: quoteData
                    };
                    return;
                } catch (err) {
                    // User cancelled or API failed, fall through to legacy method
                    if (err.name === 'AbortError') return; // User cancelled
                    console.log('File picker not available, using fallback');
                }
            }
            
            // Fallback: Create and download file (auto-download)
            const blob = new Blob([jsonContent], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = defaultFileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // Update loaded file reference if this is an update
            loadedQuoteFile = {
                name: a.download,
                data: quoteData
            };
        }

        function finalizePrint() {
            const repName = document.getElementById('contact-rep-name').value;
            const repPhone = document.getElementById('contact-rep-phone').value;
            const custName = document.getElementById('contact-cust-name').value;
            const custPhone = document.getElementById('contact-cust-phone').value;
            const includeAddress = document.getElementById('include-store-address').checked;
            const storeAddress = document.getElementById('store-address').value;
            
            const now = new Date();
            const dateStr = now.toLocaleDateString();

            // Populate contact info and notes in each row
            Object.keys(STATE).forEach(rowId => {
                const titleInput = document.getElementById(`${rowId}-title`);
                const printTitle = document.getElementById(`${rowId}-print-title`);
                const printQuoteId = document.getElementById(`${rowId}-print-quote-id`);
                const repNameEl = document.getElementById(`${rowId}-rep-name`);
                const repPhoneEl = document.getElementById(`${rowId}-rep-phone`);
                const custNameEl = document.getElementById(`${rowId}-cust-name`);
                const custPhoneEl = document.getElementById(`${rowId}-cust-phone`);
                const dateEl = document.getElementById(`${rowId}-print-date`);
                const addressEl = document.getElementById(`${rowId}-contact-address`);
                const notesTextarea = document.getElementById(`${rowId}-notes`);
                const notesDisplay = document.getElementById(`${rowId}-notes-display`);
                
                if (printTitle && titleInput) printTitle.textContent = titleInput.value;
                if (printQuoteId) printQuoteId.textContent = '';
                if (repNameEl) repNameEl.textContent = repName;
                if (repPhoneEl) repPhoneEl.textContent = repPhone ? `(${repPhone})` : '';
                if (custNameEl) custNameEl.textContent = custName;
                if (custPhoneEl) custPhoneEl.textContent = custPhone ? `(${custPhone})` : '';
                if (dateEl) dateEl.textContent = dateStr;
                
                // Set address based on checkbox
                if (addressEl) {
                    addressEl.textContent = includeAddress ? storeAddress : '';
                }
                
                // Copy notes to display div for printing
                if (notesTextarea && notesDisplay) {
                    notesDisplay.textContent = notesTextarea.value;
                }
                
                // Combine identical devices for print if enabled
                if (combineIdenticalDevices) {
                    renderDeviceListForPrint(rowId);
                }
            });
            
            // Generate plan benefits pages (if enabled)
            const includeBenefits = document.getElementById('include-benefits-page').checked;
            generatePlanBenefitsPages(includeBenefits);

            // Close all modals and sidebars
            closeContactModal();
            closeSettingsSidebar();
            
            // Give time for modals to close, then print
            setTimeout(() => {
                window.print();
                
                // Restore device lists to editable state after print
                setTimeout(() => {
                    Object.keys(STATE).forEach(rowId => {
                        renderDeviceList(rowId);
                    });
                }, 500);
            }, 200);
        }
        
        function generatePlanBenefitsPages(includeBenefits) {
            // Remove any existing benefits pages
            document.querySelectorAll('.plan-benefits-page').forEach(page => page.remove());
            
            // Hide the container (we insert pages directly after rows instead)
            const container = document.getElementById('plan-benefits-container');
            if (container) container.style.display = 'none';
            
            // Remove page break classes
            document.querySelectorAll('.calculator-row').forEach(row => {
                row.classList.remove('page-break-after');
            });
            
            // Only generate benefits pages if enabled
            if (!includeBenefits) return;
            
            // Get all row IDs in order
            const rowIds = Object.keys(STATE);
            
            // Generate a benefits page after each row with that row's comparison settings
            rowIds.forEach((rowId, idx) => {
                const row = document.getElementById(rowId);
                if (!row) return;
                
                // Generate the comparison HTML for this specific row
                const comparisonHtml = generateComparisonHtmlForRow(rowId);
                
                // Add page break after quote
                row.classList.add('page-break-after');
                
                // Create benefits page with comparison table
                const page = document.createElement('div');
                page.className = 'plan-benefits-page';
                // Only add page break if NOT the last benefits page
                if (idx < rowIds.length - 1) {
                    page.classList.add('page-break-after');
                }
                page.setAttribute('data-for-row', rowId);
                
                page.innerHTML = comparisonHtml;
                
                // Insert benefits page right after the row
                row.parentNode.insertBefore(page, row.nextSibling);
            });
        }
        
        // Helper function to generate comparison HTML for a specific row
        function generateComparisonHtmlForRow(rowId) {
            const row = document.getElementById(rowId);
            const isNewMode = row?.getAttribute('data-mode') !== 'existing';
            
            // Get the row's saved comparison settings
            const savedSettings = STATE[rowId]?.compareSettings;
            const hasUserModified = savedSettings?.hasUserModified || false;
            
            let plan1Key = '';
            let plan2Key = '';
            
            // If user has modified the comparison for this row, use their saved settings
            if (hasUserModified && (savedSettings.plan1Key || savedSettings.plan2Key)) {
                plan1Key = savedSettings.plan1Key || '';
                plan2Key = savedSettings.plan2Key || '';
                
                // Fill in missing plan if only one was selected
                if (plan1Key && !plan2Key) {
                    if (COMPARISON_INTERNET_PLANS[plan1Key] || HOME_INTERNET_PLANS[plan1Key] || BUSINESS_HOME_INTERNET_PLANS[plan1Key]) {
                        plan2Key = getInternetComparisonPlanFor(plan1Key);
                    } else {
                        plan2Key = getComparisonPlanFor(plan1Key);
                    }
                } else if (!plan1Key && plan2Key) {
                    if (COMPARISON_INTERNET_PLANS[plan2Key] || HOME_INTERNET_PLANS[plan2Key] || BUSINESS_HOME_INTERNET_PLANS[plan2Key]) {
                        plan1Key = getInternetComparisonPlanFor(plan2Key);
                    } else {
                        plan1Key = getComparisonPlanFor(plan2Key);
                    }
                }
            } else {
                // Use defaults based on the row's selected plans
                let selectedPlanFromQuote = '';
                let selectedInternetPlan = '';
                let hasVoiceLines = false;
                
                if (isNewMode) {
                    const planEl = document.getElementById(`${rowId}-plan`);
                    const planName = planEl ? planEl.value : '';
                    if (planName && PLANS_DATA[planName]) {
                        selectedPlanFromQuote = planName;
                    }
                    
                    // Check for voice lines
                    const lineCount = parseInt(document.getElementById(`${rowId}-lines`)?.value) || 0;
                    if (lineCount > 0) {
                        hasVoiceLines = true;
                    }
                    
                    // Check for internet plans
                    if (STATE[rowId]?.homeInternet?.length > 0) {
                        const firstHI = STATE[rowId].homeInternet[0];
                        if (firstHI.planKey) {
                            selectedInternetPlan = firstHI.planKey;
                        }
                    }
                }
                
                if (selectedPlanFromQuote && hasVoiceLines) {
                    // User selected a voice plan with lines
                    const comparisonPlan = getComparisonPlanFor(selectedPlanFromQuote);
                    
                    // Put the "better" plan (higher weight) on the left
                    const selectedWeight = getPlanWeight(selectedPlanFromQuote);
                    const comparisonWeight = getPlanWeight(comparisonPlan);
                    
                    if (comparisonWeight >= selectedWeight) {
                        plan1Key = comparisonPlan;
                        plan2Key = selectedPlanFromQuote;
                    } else {
                        plan1Key = selectedPlanFromQuote;
                        plan2Key = comparisonPlan;
                    }
                } else if (selectedInternetPlan && !hasVoiceLines) {
                    // Only internet plan selected
                    const comparisonPlan = getInternetComparisonPlanFor(selectedInternetPlan);
                    
                    const selectedWeight = getPlanWeight(selectedInternetPlan);
                    const comparisonWeight = getPlanWeight(comparisonPlan);
                    
                    if (comparisonWeight >= selectedWeight) {
                        plan1Key = comparisonPlan;
                        plan2Key = selectedInternetPlan;
                    } else {
                        plan1Key = selectedInternetPlan;
                        plan2Key = comparisonPlan;
                    }
                } else {
                    // Default to Experience Beyond vs Experience More
                    plan1Key = 'Experience Beyond';
                    plan2Key = 'Experience More';
                }
            }
            
            // Get plan data
            const plan1 = getComparisonDataForPlan(plan1Key);
            const plan2 = getComparisonDataForPlan(plan2Key);
            
            if (!plan1 || !plan2) {
                return '<div class="print-benefits-comparison"><p>Unable to generate comparison</p></div>';
            }
            
            // Determine premium styling based on plan weights
            const weight1 = getPlanWeight(plan1Key);
            const weight2 = getPlanWeight(plan2Key);
            let isPlan1Premium = false;
            let isPlan2Premium = false;
            
            if (weight1 > weight2) {
                isPlan1Premium = true;
            } else if (weight2 > weight1) {
                isPlan2Premium = true;
            } else if (weight1 > 0) {
                isPlan1Premium = true;
                isPlan2Premium = true;
            }
            
            // Collect all unique benefits from both plans
            const allBenefits = new Set([
                ...Object.keys(plan1.benefits),
                ...Object.keys(plan2.benefits)
            ]);
            
            // Build the comparison table HTML
            let tableClasses = ['comparison-table'];
            if (isPlan1Premium) tableClasses.push('plan1-premium');
            if (isPlan2Premium) tableClasses.push('plan2-premium');
            
            let comparisonHtml = `
                <div class="print-benefits-comparison">
                    <div class="compare-dropdowns">
                        <div class="compare-dropdown-wrapper spacer">Compare:</div>
                        <div class="compare-dropdown-wrapper">
                            <div class="compare-plan-name-header ${isPlan1Premium ? 'premium' : ''}">${plan1Key}</div>
                        </div>
                        <div class="compare-dropdown-wrapper" style="border-right: none;">
                            <div class="compare-plan-name-header ${isPlan2Premium ? 'premium' : ''}">${plan2Key}</div>
                        </div>
                    </div>
                    <div class="${tableClasses.join(' ')}">
            `;
            
            allBenefits.forEach(benefitKey => {
                const benefit1 = plan1.benefits[benefitKey];
                const benefit2 = plan2.benefits[benefitKey];
                
                // Check if benefits are hidden
                const isHidden1 = isBenefitHidden(benefit1);
                const isHidden2 = isBenefitHidden(benefit2);
                
                // Skip if both benefits are hidden, or if one is hidden and the other doesn't exist
                if (isHidden1 && isHidden2) return;
                if (isHidden1 && !benefit2) return;
                if (isHidden2 && !benefit1) return;
                
                const valuesMatch = benefitValuesMatch(benefit1, benefit2);
                
                // Get weights for comparison
                const benefitWeight1 = getBenefitWeight(benefit1);
                const benefitWeight2 = getBenefitWeight(benefit2);
                
                const isPreferred1 = !valuesMatch && benefitWeight1 > benefitWeight2;
                const isPreferred2 = !valuesMatch && benefitWeight2 > benefitWeight1;
                const isOutweighed1 = !valuesMatch && benefitWeight2 >= benefitWeight1;
                const isOutweighed2 = !valuesMatch && benefitWeight1 >= benefitWeight2;
                
                const valueClass1 = getValueClass(benefit1, isPreferred1, isOutweighed1);
                const valueClass2 = getValueClass(benefit2, isPreferred2, isOutweighed2);
                
                const benefitData = (!isHidden1 && benefit1) ? benefit1 : benefit2;
                
                const formattedName = formatBenefitName(benefitKey, benefitData);
                const formatted1 = formatBenefitValue(benefit1 || { value: 'Unknown' });
                const formatted2 = formatBenefitValue(benefit2 || { value: 'Unknown' });
                
                if (valuesMatch) {
                    comparisonHtml += `
                        <div class="comparison-row">
                            <div class="comparison-benefit-name">${formattedName}</div>
                            <div class="comparison-benefit-value merged ${valueClass1}">${formatted1}</div>
                        </div>
                    `;
                } else {
                    comparisonHtml += `
                        <div class="comparison-row">
                            <div class="comparison-benefit-name">${formattedName}</div>
                            <div class="comparison-benefit-value ${valueClass1}">${formatted1}</div>
                            <div class="comparison-benefit-value ${valueClass2}">${formatted2}</div>
                        </div>
                    `;
                }
            });
            
            comparisonHtml += `
                    </div>
                    
                    <!-- Sam's Club Member Benefits Section -->
                    <div class="sams-club-benefits">
                        <div class="sams-club-title">Sam's Club Member Benefits</div>
                        <div class="sams-club-grid">
                            <div class="sams-club-card">
                                <div class="sams-club-card-top">
                                    New Line Activation on<br>Experience More / Beyond Plan<br>&amp;<br>Device Purchase<br>(EIP Required)
                                </div>
                                <div class="sams-club-card-bottom"> $150 Sam's Club E-Gift Card</div>
                            </div>
                            <div class="sams-club-card">
                                <div class="sams-club-card-top">
                                     New Line Activation on<br>Experience More / Beyond Plan<br><br> Device Purchase / Upgrade on<br>Eligible Plan (EIP Required)
                                </div>
                                <div class="sams-club-card-bottom">$75 Sam's Club E-Gift Card</div>
                            </div>
                            <div class="sams-club-card">
                                <div class="sams-club-card-top">
                                     New Watch / Tablet Line Activation<br> New Home Internet Activation
                                </div>
                                <div class="sams-club-card-bottom">$25 Sam's Club E-Gift Card</div>
                            </div>
                        </div>
                        <div class="sams-club-plus-row">
                            <div class="sams-club-plus-note">
                                <span> Sam's Club <strong>PLUS</strong> Members get an additional $60 Sam's Club E-Gift Card, <span class="every-year">EVERY YEAR.</span></span>
                            </div>
                        </div>
                        <div class="sams-club-fine-print">Note: Must have an active Sam's Club PLUS membership at time of purchase and meet the $150 payout requirements</div>
                    </div>
                </div>
            `;
            
            return comparisonHtml;
        }

        function updateLines(rowId, change) {
            const input = document.getElementById(`${rowId}-lines`);
            let currentVal = parseInt(input.value) || 0;
            let newVal = currentVal + change;
            const planName = document.getElementById(`${rowId}-plan`).value;
            let max = 12;
            let min = 0;
            if (planName && PLANS_DATA[planName]) {
                max = PLANS_DATA[planName].maxLines || 12;
                min = PLANS_DATA[planName].minLines || 0;
            }
            
            if(newVal < min) newVal = min;
            if(newVal > max) newVal = max;
            
            input.value = newVal;
            input.blur(); // Prevent keyboard on mobile
            validateLines(input, rowId);
        }

        function updateUpgrades(rowId, change) {
            const input = document.getElementById(`${rowId}-lines`);
            let currentVal = parseInt(input.value) || 0;
            let newVal = currentVal + change;
            if(newVal < 0) newVal = 0;
            if(newVal > 12) newVal = 12;
            input.value = newVal;
            input.blur(); // Prevent keyboard on mobile
            validateUpgrades(input, rowId);
        }

        function validateLines(input, rowId) {
            let val = parseInt(input.value);
            if(isNaN(val)) val = 0; 
            const planName = document.getElementById(`${rowId}-plan`).value;
            let max = 12;
            let min = 0;
            if (planName && PLANS_DATA[planName]) {
                max = PLANS_DATA[planName].maxLines || 12;
                min = PLANS_DATA[planName].minLines || 0;
            }
            
            if(input.value === '') return; 
            if(val < min) { val = min; input.value = min; }
            if(val > max) { val = max; input.value = max; }
            
            validateDiscounts(rowId);
            handleStandardLines(rowId);
        }

        function validateUpgrades(input, rowId) {
            let val = parseInt(input.value);
            if(isNaN(val)) val = 0; 
            if(input.value === '') return; 
            if(val < 0) { val = 0; input.value = 0; }
            if(val > 12) { val = 12; input.value = 12; }
            handleManualUpgrades(rowId);
        }

        // --- PLAN MODAL LOGIC ---
        let currentPlanTab = 'Normal';
        
        function openPlanModal(rowId) {
            document.getElementById('plan-modal-row-id').value = rowId;
            document.getElementById('plan-search-box').value = '';
            
            // Only expose Internet tab while in compare mode
            const isCompareView = document.body.classList.contains('compare-mode');
            const internetTab = document.querySelector('.plan-tab[data-plan-type="Internet"]');
            if (internetTab) {
                internetTab.style.display = isCompareView ? '' : 'none';
            }
            
            // Get currently selected plan and its type
            const selectedPlan = document.getElementById(`${rowId}-plan`).value;
            if (selectedPlan && PLANS_DATA[selectedPlan]) {
                currentPlanTab = PLANS_DATA[selectedPlan].planType || 'Normal';
            } else {
                currentPlanTab = 'Normal';
            }

            // Fall back to Consumer tab if Internet is hidden
            if (!isCompareView && currentPlanTab === 'Internet') {
                currentPlanTab = 'Normal';
            }
            document.getElementById('plan-modal-tab').value = currentPlanTab;
            
            // Reset tabs and select the right one
            document.querySelectorAll('.plan-tab').forEach(t => t.classList.remove('active'));
            const activeTab = document.querySelector(`.plan-tab[data-plan-type="${currentPlanTab}"]`);
            if (activeTab) {
                activeTab.classList.add('active');
                // Scroll tab into view
                setTimeout(() => {
                    activeTab.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
                }, 100);
            }
            
            renderPlanModalList(rowId);
            document.getElementById('plan-modal').classList.add('open');
            
            // Update arrow visibility after modal opens
            setTimeout(updatePlanTabArrows, 100);
        }
        
        function closePlanModal() {
            // Close the modal
            document.getElementById('plan-modal').classList.remove('open');
            
            // Reset to plan selection view in case addons page was open
            document.getElementById('plan-modal-title').textContent = 'Select Plan';
            
            // Show plan selection elements
            const planListContainer = document.getElementById('plan-list-container');
            planListContainer.style.display = '';
            planListContainer.style.flex = '1';
            planListContainer.style.overflowY = 'auto';
            
            document.getElementById('plan-search-box').style.display = '';
            document.querySelector('.plan-tabs-wrapper').style.display = '';
            const manageAddonsLink = document.getElementById('manage-addons-link');
            if (manageAddonsLink) manageAddonsLink.style.display = '';
            
            // Hide Add button in footer
            document.getElementById('plan-modal-add-btn').style.display = 'none';
            
            // Hide addons pages
            document.getElementById('addons-list-page').classList.remove('active');
            document.getElementById('addons-form-page').classList.remove('active');
            
            // Restore back button visibility
            const backBtn = document.querySelector('.addon-back-btn');
            if (backBtn) {
                backBtn.style.display = '';
            }
        }
        
        // Add-ons Management Functions
        function openAddonsPage() {
            const rowId = document.getElementById('plan-modal-row-id').value;
            
            // Change modal title
            document.getElementById('plan-modal-title').textContent = 'Add-ons';
            
            // Hide plan selection elements
            document.getElementById('plan-list-container').style.display = 'none';
            document.getElementById('plan-search-box').style.display = 'none';
            document.querySelector('.plan-tabs-wrapper').style.display = 'none';
            document.getElementById('manage-addons-link').style.display = 'none';
            
            // Hide Add button in footer since form is inline
            document.getElementById('plan-modal-add-btn').style.display = 'none';
            
            // Show addons list page
            document.getElementById('addons-list-page').classList.add('active');
            
            // Make sure back button is visible (will be hidden by openManualAddonsPage if needed)
            const backBtn = document.querySelector('.addon-back-btn');
            if (backBtn) {
                backBtn.style.display = '';
            }
            
            // Render current addons and reset form
            renderAddonsList(rowId);
            resetAddonForm(rowId);
        }
        
        function closeAddonsPage() {
            // Restore modal title
            document.getElementById('plan-modal-title').textContent = 'Select Plan';
            
            // Show plan selection elements
            const planListContainer = document.getElementById('plan-list-container');
            planListContainer.style.display = '';
            planListContainer.style.flex = '1';
            planListContainer.style.overflowY = 'auto';
            
            document.getElementById('plan-search-box').style.display = '';
            document.querySelector('.plan-tabs-wrapper').style.display = '';
            document.getElementById('manage-addons-link').style.display = '';
            
            // Hide Add button in footer
            document.getElementById('plan-modal-add-btn').style.display = 'none';
            
            // Hide addons page
            document.getElementById('addons-list-page').classList.remove('active');
        }
        
        function resetAddonForm(rowId) {
            const linesInput = document.getElementById(`${rowId}-lines`);
            const maxAmount = parseInt(linesInput.value) || 12;
            
            document.getElementById('addon-name-input').value = '';
            document.getElementById('addon-price-input').value = '';
            document.getElementById('addon-amount-input').value = '1';
            document.getElementById('addon-amount-input').max = maxAmount;
            document.getElementById('addon-edit-index').value = '';
            document.getElementById('addon-form-subtitle').textContent = 'Add a new add-on:';
        }
        
        function openAddonsFormPage() {
            // No longer needed - form is inline
        }
        
        function closeAddonsFormPage() {
            // No longer needed - form is inline
        }
        
        function editAddon(index) {
            const rowId = document.getElementById('plan-modal-row-id').value;
            const addon = STATE[rowId].addons[index];
            const linesInput = document.getElementById(`${rowId}-lines`);
            const maxAmount = parseInt(linesInput.value) || 12;
            
            // Fill form with addon data
            document.getElementById('addon-name-input').value = addon.name;
            document.getElementById('addon-price-input').value = addon.price.toFixed(2);
            document.getElementById('addon-amount-input').value = addon.amount;
            document.getElementById('addon-amount-input').max = maxAmount;
            document.getElementById('addon-edit-index').value = index;
            document.getElementById('addon-form-subtitle').textContent = 'Edit add-on:';
            
            // Scroll to form
            document.getElementById('addon-name-input').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            document.getElementById('addon-name-input').focus();
        }
        
        function deleteAddon(index) {
            const rowId = document.getElementById('plan-modal-row-id').value;
            STATE[rowId].addons.splice(index, 1);
            renderAddonsList(rowId);
            resetAddonForm(rowId);
            updateAddonsDisplay(rowId);
            calculateRow(rowId);
        }
        
        function saveAddon() {
            const rowId = document.getElementById('plan-modal-row-id').value;
            let name = document.getElementById('addon-name-input').value.trim();
            const price = parseFloat(document.getElementById('addon-price-input').value) || 0;
            let amount = parseInt(document.getElementById('addon-amount-input').value) || 1;
            const editIndex = document.getElementById('addon-edit-index').value;
            
            // Default name if empty
            if (!name) {
                name = 'Add-On';
            }
            
            // Validate price
            if (price <= 0) {
                alert('Please enter a valid price');
                return;
            }
            
            // Get max lines for this row
            const linesInput = document.getElementById(`${rowId}-lines`);
            const maxAmount = parseInt(linesInput.value) || 12;
            
            // Cap amount at selected lines
            if (amount > maxAmount) {
                amount = maxAmount;
                document.getElementById('addon-amount-input').value = amount;
            }
            
            const addon = { name, price, amount };
            
            if (editIndex !== '') {
                // Update existing addon
                STATE[rowId].addons[parseInt(editIndex)] = addon;
            } else {
                // Add new addon
                STATE[rowId].addons.push(addon);
            }
            
            renderAddonsList(rowId);
            resetAddonForm(rowId);
            updateAddonsDisplay(rowId);
            calculateRow(rowId);
        }
        
        function renderAddonsList(rowId) {
            const container = document.getElementById('addon-list-container');
            const addons = STATE[rowId].addons || [];
            
            if (addons.length === 0) {
                container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #999; font-style: italic;">No Add-On Items</div>';
                return;
            }
            
            // Match savings today item style
            container.innerHTML = addons.map((addon, index) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: white; border-radius: 4px; margin-bottom: 5px; border: 1px solid #e0e0e0;">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; font-size: 0.9rem; color: var(--text-main);">${addon.name}</div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary);">$${addon.price.toFixed(2)}  ${addon.amount} = $${(addon.price * addon.amount).toFixed(2)}</div>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <button onclick="deleteAddon(${index})" style="background: none; border: none; color: var(--danger-color); font-size: 1.2rem; font-weight: bold; cursor: pointer; padding: 0 5px;"></button>
                    </div>
                </div>
            `).join('');
        }
        
        function updateAddonsDisplay(rowId) {
            const addonsDisplayPlan = document.getElementById(`${rowId}-addons-display-plan`);
            const addons = STATE[rowId].addons || [];
            
            if (addons.length === 0) {
                if (addonsDisplayPlan) addonsDisplayPlan.classList.add('hidden');
                return;
            }
            
            // Format based on showItemizedPrices.addons setting
            // If enabled (or undefined - default to true): "Hotspot, $60/ea" x1
            // If disabled: "Hotspot" x1
            const addonTexts = addons.map(addon => {
                if (showItemizedPrices.addons !== false) {
                    return `"${addon.name}, $${addon.price.toFixed(2)}/ea" x${addon.amount}`;
                } else {
                    return `"${addon.name}" x${addon.amount}`;
                }
            });
            const displayText = `Add-ons: ${addonTexts.join(', ')}`;
            
            if (addonsDisplayPlan) {
                addonsDisplayPlan.textContent = displayText;
                addonsDisplayPlan.classList.remove('hidden');
            }
        }
        
        function switchPlanTab(planType) {
            currentPlanTab = planType;
            document.getElementById('plan-modal-tab').value = planType;
            
            // Update tab active state
            document.querySelectorAll('.plan-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.plan-tab[data-plan-type="${planType}"]`).classList.add('active');
            
            // Clear search
            document.getElementById('plan-search-box').value = '';
            
            const rowId = document.getElementById('plan-modal-row-id').value;
            
            // Check if we're in compare mode
            if (rowId === 'compare-mode') {
                renderComparePlanModalList();
            } else {
                renderPlanModalList(rowId);
            }
        }
        
        function renderPlanModalList(rowId) {
            const container = document.getElementById('plan-list-container');
            container.innerHTML = '';
            
            const planType = currentPlanTab;
            const searchVal = document.getElementById('plan-search-box').value.toLowerCase();
            const selectedPlan = document.getElementById(`${rowId}-plan`).value;
            
            let hasPlans = false;
            
            // If searching, show all matching plans from all tabs
            const showAllTabs = searchVal.length > 0;
            
            // Group plans by type for search results
            const plansByType = {};
            
            Object.keys(PLANS_DATA).forEach(planName => {
                const plan = PLANS_DATA[planName];
                const pType = plan.planType || 'Normal';
                
                // Filter by plan type (unless searching)
                if (!showAllTabs && pType !== planType) return;
                
                // Filter by search - check plan name and keywords
                if (searchVal) {
                    const nameMatch = planName.toLowerCase().includes(searchVal);
                    const keywordMatch = plan.keywords && plan.keywords.some(kw => kw.toLowerCase().includes(searchVal));
                    if (!nameMatch && !keywordMatch) return;
                }
                
                hasPlans = true;
                
                if (!plansByType[pType]) plansByType[pType] = [];
                plansByType[pType].push({ name: planName, plan: plan });
            });
            
            // Render plans (with category headers if searching)
            Object.keys(plansByType).forEach(pType => {
                if (showAllTabs && plansByType[pType].length > 0) {
                    // Add category header
                    const header = document.createElement('div');
                    header.className = 'plan-category-header';
                    header.textContent = pType;
                    container.appendChild(header);
                }
                
                plansByType[pType].forEach(({ name: planName, plan }) => {
                    const div = document.createElement('div');
                    div.className = 'plan-option';
                    
                    // Highlight selected plan
                    if (planName === selectedPlan) {
                        div.classList.add('selected');
                    }
                    
                    // Show min/max lines info
                    let lineInfo = '';
                    if (plan.minLines && plan.maxLines) {
                        lineInfo = ` <span style="font-size: 0.75rem; color: var(--text-secondary);">(${plan.minLines}-${plan.maxLines} lines)</span>`;
                    } else if (plan.minLines) {
                        lineInfo = ` <span style="font-size: 0.75rem; color: var(--text-secondary);">(min ${plan.minLines} lines)</span>`;
                    } else if (plan.maxLines && plan.maxLines < 12) {
                        lineInfo = ` <span style="font-size: 0.75rem; color: var(--text-secondary);">(max ${plan.maxLines} lines)</span>`;
                    }
                    
                    // Get MP link for this plan
                    const mpLink = MP_LINKS.voicePlans[planName] || '';
                    const mpHtml = mpLink ? `<a href="${mpLink}" target="_blank" class="mp-link-small" onclick="event.stopPropagation();">Magenta Pulse</a>` : '';
                    
                    // Show plan notes if available
                    const planNotes = plan.notes ? ` <span style="font-size: 0.75rem; color: var(--text-secondary);">(${plan.notes})</span>` : '';
                    
                    div.innerHTML = `
                        <div style="display: flex; flex-direction: column; gap: 2px;">
                            <span>${planName}${planNotes}${lineInfo}</span>
                            ${mpHtml}
                        </div>
                    `;
                    div.onclick = () => selectPlanFromModal(planName);
                    container.appendChild(div);
                });
            });
            
            if (!hasPlans) {
                container.innerHTML = '<div class="plan-no-results">No plans found</div>';
            }
            
            // Scroll to selected plan if exists
            setTimeout(() => {
                const selectedEl = container.querySelector('.plan-option.selected');
                if (selectedEl) {
                    selectedEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 100);
        }
        
        function filterPlanModal(input) {
            const rowId = document.getElementById('plan-modal-row-id').value;
            
            // Check if we're in compare mode
            if (rowId === 'compare-mode') {
                renderComparePlanModalList();
            } else {
                renderPlanModalList(rowId);
            }
        }
        
        function selectPlanFromModal(planName) {
            const rowId = document.getElementById('plan-modal-row-id').value;
            const plan = PLANS_DATA[planName];
            const linesInput = document.getElementById(`${rowId}-lines`);
            let currentLines = parseInt(linesInput.value) || 0;
            
            // Check minimum lines requirement
            if (plan.minLines && currentLines < plan.minLines) {
                // Auto-set to minimum lines
                linesInput.value = plan.minLines;
                currentLines = plan.minLines;
            }
            
            // Check maximum lines
            if (plan.maxLines && currentLines > plan.maxLines) {
                linesInput.value = plan.maxLines;
            }
            
            document.getElementById(`${rowId}-plan`).value = planName;
            document.getElementById(`${rowId}-plan-trigger`).value = planName;
            closePlanModal();
            validateLines(linesInput, rowId);
            handleStandardPlan(rowId);
            
            // Update default benefits slider visibility based on selected plan
            toggleDefaultBenefitsSwitch();
        }

        function validateDiscounts(rowId) {
            const lineCount = parseInt(document.getElementById(`${rowId}-lines`).value) || 0;
            const planEl = document.getElementById(`${rowId}-plan`);
            const planName = planEl ? planEl.value : '';
            const isPremium = PREMIUM_PLANS.includes(planName);
            const isFreeLineEligible = PLANS_DATA[planName] ? PLANS_DATA[planName].freeLineEligible : false;
            const isBusinessPlan = PLANS_DATA[planName]?.planType === 'Business';
            // Only consider autopay ineligible if a plan is selected AND it's not eligible
            const planAutopayEligible = !planName || PLANS_DATA[planName]?.autopayEligible !== false;
            
            // Check if there are connected devices or home internet that could use autopay
            const cdCount = STATE[rowId].connectedDevices?.length || 0;
            const hiCount = STATE[rowId].homeInternet?.length || 0;
            
            // Check if any CD/HI have autopay eligibility
            const hasCDWithAutopay = STATE[rowId].connectedDevices?.some(cd => {
                return cd.planData && cd.planData.autopayEligible !== false;
            }) || false;
            
            const hasHIWithAutopay = STATE[rowId].homeInternet?.some(hi => {
                const hiPlanData = HOME_INTERNET_PLANS[hi.planName];
                return hiPlanData && hiPlanData.autopayEligible !== false;
            }) || false;
            
            const hasCDorHIWithAutopay = hasCDWithAutopay || hasHIWithAutopay;
            const hasCDorHI = cdCount > 0 || hiCount > 0;
            
            // Check removeAutopayAfterMax flag
            const planData = PLANS_DATA[planName];
            const removeAutopayAfterMax = planData?.removeAutopayAfterMax === true;
            const maxAutopayLines = planData?.maxAutopayLines;
            const exceedsMaxAutopay = maxAutopayLines !== undefined && lineCount > maxAutopayLines;
            
            // Autopay should be removed if:
            // 1. Plan is not autopay eligible (autopayEligible: false) AND there are no CD/HI, OR
            // 2. removeAutopayAfterMax is true AND lines exceed maxAutopayLines AND no CD/HI with autopay eligibility
            const shouldRemoveAutopay = (!planAutopayEligible && !hasCDorHI) || 
                                       (removeAutopayAfterMax && exceedsMaxAutopay && !hasCDorHIWithAutopay);
            
            let discounts = STATE[rowId].discounts;
            for(let i = discounts.length - 1; i >= 0; i--) {
                const type = discounts[i].type;
                if (type === 'Autopay Discount' && shouldRemoveAutopay) {
                    discounts.splice(i, 1);
                } else if (type === 'Free Line' && (lineCount < 3 || !isFreeLineEligible)) {
                    discounts.splice(i, 1);
                } else if (type === 'Work Perks' && (!isPremium || lineCount > 2 || isBusinessPlan)) {
                    discounts.splice(i, 1);
                } else if (type === 'Insider Discount' && !isPremium) {
                    discounts.splice(i, 1);
                }
            }
            renderDiscountList(rowId);
        }

        // --- ROW LOGIC ---
        function createNewRow() {
            rowCount++;
            const rowId = `row-${rowCount}`;
            
            // Calculate quote number based on current number of rows (not the running rowCount)
            const currentRowCount = document.querySelectorAll('.calculator-row').length + 1;
            
            STATE[rowId] = { 
                devices: [], 
                protectionStatus: {}, 
                protectionCosts: {}, 
                showUnprotected: false,
                showStandardProtection: false,
                showProtectionLabel: true,
                showYearlySavings: false,
                quoteTitle: `Quote ${currentRowCount}`,
                connectedDevices: [], 
                homeInternet: [],
                accessories: [],
                addons: [],
                dueTodayItems: [],
                savedTodayItems: [],
                savingsToday: 0,
                rebates: [], 
                discounts: [],
                voiceLines: [],
                title: '',
                carrierName: '',
                carrierPrice: 0,
                carrierSkipped: false,
                // Per-row comparison settings
                compareSettings: {
                    plan1Key: '',
                    plan2Key: '',
                    hasUserModified: false // True when user has manually changed comparison plans
                }
            };
            
            const container = document.getElementById('rows-container');
            const rowDiv = document.createElement('div');
            
            const isManualMode = (currentMode === 'existing');
            
            rowDiv.className = 'calculator-row';
            rowDiv.id = rowId;
            rowDiv.setAttribute('data-mode', currentMode);
            rowDiv.setAttribute('data-row-index', currentRowCount);

            let title = "";
            if (isManualMode) {
                if (currentRowCount === 1) title = "Current Plan";
                else title = `Comparison Option #${currentRowCount - 1}`;
            } else {
                title = "";
            }

            let contentHTML = '';
            if (isManualMode) {
                contentHTML = `
                    <div class="quote-header-row">
                        <div class="totals-inline-header" onclick="openProtectionModal('${rowId}')" style="cursor: pointer;">
                            <div class="totals-header-label">${isManualMode ? 'New Total Monthly' : 'Total Monthly'}</div>
                            <div class="totals-inline-wrapper">
                                <div class="totals-prices-inline" id="${rowId}-totals-prices">
                                    <div class="us-label-header" style="display: none;">Us</div>
                                    <div class="totals-amounts-row">
                                        <div class="total-inline-main" id="${rowId}-block-protected">
                                            <div class="total-inline-amount primary" id="${rowId}-total-protected">$0.00</div>
                                            <div class="total-inline-label" id="${rowId}-protection-label">w/ Protection</div>
                                        </div>
                                        <div class="total-inline-secondary hidden" id="${rowId}-block-basic">
                                            <div class="total-inline-amount secondary" id="${rowId}-total-basic">$0.00</div>
                                            <div class="total-inline-label" id="${rowId}-label-basic">w/o Protection</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="yearly-savings-wrapper">
                                <div class="yearly-savings hidden" id="${rowId}-yearly-savings"></div>
                            </div>
                            <div class="options-hint-text" style="font-size: 0.7rem; color: #999; font-style: italic; margin-top: 4px;">Tap for more options</div>
                        </div>
                    </div>
                    <div class="steps-container">
                        <div class="step-col visible-step" id="${rowId}-col1">
                            <label class="step-label"><span class="step-number">1</span>Current Plan Cost</label>
                            <div class="manual-price-wrapper">
                                <input type="number" id="${rowId}-manual-price" class="manual-price-input" placeholder="0.00" min="0" step="0.01" oninput="handleManualPrice('${rowId}')">
                                <span id="${rowId}-manual-price-display" class="manual-price-display"></span>
                                <button class="manual-addons-btn" id="${rowId}-manual-addons-btn" onclick="openManualAddonsPage('${rowId}')" style="display: none;">Manage Add-ons</button>
                            </div>
                            <div class="addons-display-plan hidden" id="${rowId}-addons-display-plan"></div>
                        </div>
                        <div class="step-col hidden-step" id="${rowId}-col2">
                            <label class="step-label"><span class="step-number">2</span>Current Amount of Voice Lines</label>
                            <div class="stepper-wrapper">
                                <button class="stepper-btn" onclick="updateUpgrades('${rowId}', -1)"></button>
                                <input type="number" id="${rowId}-lines" class="stepper-input" value="0" min="0" max="12" oninput="validateUpgrades(this, '${rowId}')">
                                <button class="stepper-btn" onclick="updateUpgrades('${rowId}', 1)">+</button>
                            </div>
                        </div>
                        <div class="step-col hidden-step" id="${rowId}-col-voice-lines" style="grid-column: 1 / -1;">
                            <label id="${rowId}-add-a-lines-title" class="step-label screen-only-label" style="display: none;">Add-a-Lines</label>
                            <label id="${rowId}-added-lines-label" class="step-label print-only-label hidden" style="display: none;">Add-a-Lines</label>
                            <button id="${rowId}-add-voice-line-btn" class="btn btn-secondary" style="width: 100%; display: none;" onclick="openVoiceLineModal('${rowId}')">+ Add Voice Line</button>
                            <div id="${rowId}-voice-lines-list" class="voice-lines-list"></div>
                        </div>
                        <div class="step-col hidden-step step-col-3" id="${rowId}-col3">
                            <label class="step-label">Device Setup</label>
                            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                <button class="btn btn-secondary" style="flex: 1; position: relative; z-index: 30;" onclick="openModal('${rowId}')">+ Add Device</button>
                                <button class="btn btn-secondary" style="flex: 1;" onclick="openAccessoriesModal('${rowId}')">Manage Accessories</button>
                            </div>
                            <div id="${rowId}-device-list" class="device-list-container"></div>
                            <div id="${rowId}-byod-placeholder" class="byod-placeholder">No devices added</div>
                        </div>
                    </div>
                `;
            } else {
                contentHTML = `
                    <div class="quote-header-row">
                        <div class="totals-inline-header" onclick="openProtectionModal('${rowId}')" style="cursor: pointer;">
                            <div class="totals-header-label">Total Monthly</div>
                            <div class="totals-inline-wrapper">
                                <div class="totals-prices-inline" id="${rowId}-totals-prices">
                                    <div class="us-label-header" style="display: none;">Us</div>
                                    <div class="totals-amounts-row">
                                        <div class="total-inline-main" id="${rowId}-block-protected">
                                            <div class="total-inline-amount primary" id="${rowId}-total-protected">$0.00</div>
                                            <div class="total-inline-label" id="${rowId}-protection-label">w/ Protection</div>
                                        </div>
                                        <div class="total-inline-secondary hidden" id="${rowId}-block-basic">
                                            <div class="total-inline-amount secondary" id="${rowId}-total-basic">$0.00</div>
                                            <div class="total-inline-label" id="${rowId}-label-basic">w/o Protection</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="vs-inline hidden" id="${rowId}-vs-indicator" style="display: none;">vs</div>
                                <div class="carrier-comparison-inline hidden" id="${rowId}-carrier-comparison" style="display: none;">
                                    <div class="carrier-price-inline" id="${rowId}-carrier-price">$0</div>
                                    <div class="carrier-name-inline" id="${rowId}-carrier-name-display">Current</div>
                                </div>
                            </div>
                            <div class="yearly-savings-wrapper">
                                <div class="yearly-savings hidden" id="${rowId}-yearly-savings"></div>
                            </div>
                            <div class="options-hint-text" style="font-size: 0.7rem; color: #999; font-style: italic; margin-top: 4px;">Tap for more options</div>
                        </div>
                    </div>
                    <div class="steps-container steps-main-row" id="${rowId}-steps-main">
                        <div class="step-col step-col-lines visible-step" id="${rowId}-col1">
                            <label class="step-label"><span class="step-number">1</span><span class="print-only-text">Voice Lines</span><span class="screen-only-text">Voice Lines</span></label>
                            <div class="stepper-wrapper">
                                <button class="stepper-btn" onclick="updateLines('${rowId}', -1)"></button>
                                <input type="number" id="${rowId}-lines" class="stepper-input" value="0" min="0" max="12" oninput="validateLines(this, '${rowId}')">
                                <button class="stepper-btn" onclick="updateLines('${rowId}', 1)">+</button>
                            </div>
                        </div>
                        <div class="step-col step-col-plan hidden-step" id="${rowId}-col2">
                            <label class="step-label"><span class="step-number">2</span><span class="print-only-text">Plan</span><span class="screen-only-text">Select Plan</span></label>
                            <div class="plan-select-wrapper" id="${rowId}-plan-selector">
                                <input type="text" id="${rowId}-plan-trigger" class="plan-select-trigger" placeholder="Select Plan..." readonly onclick="openPlanModal('${rowId}')">
                                <input type="hidden" id="${rowId}-plan">
                            </div>
                            <div class="addons-display-plan hidden" id="${rowId}-addons-display-plan"></div>
                        </div>
                    </div>
                    <div class="steps-container steps-device-row">
                        <div class="step-col hidden-step step-col-devices" id="${rowId}-col3">
                            <label class="step-label"><span class="step-number">3</span>Device Setup</label>
                            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                <button class="btn btn-secondary" style="flex: 1; position: relative; z-index: 30;" onclick="openModal('${rowId}')">+ Add Device</button>
                                <button class="btn btn-secondary" style="flex: 1;" onclick="openAccessoriesModal('${rowId}')">Manage Accessories</button>
                            </div>
                            <div id="${rowId}-device-list" class="device-list-container"></div>
                            <div id="${rowId}-byod-placeholder" class="byod-placeholder">No devices added</div>
                        </div>
                    </div>
                    <div class="steps-container steps-extras-row"></div>
                `;
            }
            
            const connectedDevicesHTML = `
                <div class="step-col step-col-bts visible-step print-hidden" id="${rowId}-col-bts">
                    <label class="step-label">Connected Devices</label>
                    <button class="btn btn-secondary" style="width:100%; margin-bottom:10px;" onclick="openCDModal('${rowId}')">+ Add Connected Device</button>
                    <div id="cd-list-${rowId}" class="bts-container"></div>
                </div>
            `;
            
            const homeInternetHTML = `
                <div class="step-col step-col-internet visible-step print-hidden" id="${rowId}-col-internet">
                    <label class="step-label">Internet</label>
                    <button class="btn btn-secondary" style="width:100%; margin-bottom:10px;" onclick="openHIModal('${rowId}')">+ Add Internet Plan</button>
                    <div id="hi-list-${rowId}" class="bts-container"></div>
                </div>
            `;
            
            const discountsHTML = `
                <div class="step-col step-col-discounts visible-step print-hidden" id="${rowId}-col-discounts">
                    <label class="step-label">Service Discounts</label>
                    <button id="${rowId}-discount-btn" class="btn btn-secondary btn-disabled" style="width:100%; margin-bottom:10px;" onclick="openDiscountModal('${rowId}')">Add Discount</button>
                    <div id="discount-list-${rowId}" class="discounts-container"></div>
                </div>
            `;

            const rebatesHTML = `
                <div class="step-col step-col-rebates visible-step print-hidden" id="${rowId}-col-rebates">
                    <label class="step-label">Rebates</label>
                    <button id="${rowId}-rebate-btn" class="btn btn-secondary btn-disabled" style="width:100%; margin-bottom:10px;" onclick="openRebateModal('${rowId}')">Add Rebate</button>
                    <div id="rebate-list-${rowId}" class="rebates-container"></div>
                </div>
            `;

            rowDiv.innerHTML = `
                <div class="row-header">
                    ${isManualMode ? `
                    <div class="row-options" style="display: none;">
                        <!-- Checkboxes moved to Quote Settings Misc tab -->
                        <input type="checkbox" id="${rowId}-taxes-included" style="display:none;">
                        <input type="checkbox" id="${rowId}-has-autopay" style="display:none;">
                        <input type="checkbox" id="${rowId}-is-business" style="display:none;">
                        <input type="checkbox" id="${rowId}-beyond-savings" style="display:none;">
                    </div>
                    ` : ''}
                    <div class="row-actions" id="${rowId}-row-actions">
                        <div class="row-actions-left">
                            <input type="text" class="quote-title-input" id="${rowId}-quote-title" value="Quote ${currentRowCount}" placeholder="Quote Title" oninput="autoResizeQuoteTitle('${rowId}')" onchange="updateQuoteTitle('${rowId}', this.value)">
                            <button class="row-actions-toggle" onclick="toggleRowActions(this, '${rowId}')" aria-label="Toggle options">
                                <span class="chevron"></span>
                            </button>
                        </div>
                        <div class="row-actions-right" id="${rowId}-actions-dropdown">
                            <button class="btn btn-secondary btn-action" onclick="goToCompareWithPlan('${rowId}')">View plan benefits</button>
                            <button class="btn btn-secondary btn-action" onclick="duplicateRow('${rowId}')">Duplicate</button>
                            <button class="btn btn-secondary btn-action btn-remove-action" onclick="confirmRemoveRow(this, '${rowId}')">Remove</button>
                        </div>
                    </div>
                </div>
                <div class="row-contact-info" id="${rowId}-contact-info">
                    <div class="contact-row">
                        <div class="contact-main">
                            <div class="contact-title-wrapper">
                                <div class="contact-header-row">
                                    <div class="logo-title-group">
                                        <div class="logo-date-column">
                                            <img class="tmo-logo-print" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAfAAAAHwCAYAAABZrD3mAAAFQGlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4KPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iWE1QIENvcmUgNS41LjAiPgogPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIgogICAgeG1sbnM6ZXhpZj0iaHR0cDovL25zLmFkb2JlLmNvbS9leGlmLzEuMC8iCiAgICB4bWxuczpwaG90b3Nob3A9Imh0dHA6Ly9ucy5hZG9iZS5jb20vcGhvdG9zaG9wLzEuMC8iCiAgICB4bWxuczp0aWZmPSJodHRwOi8vbnMuYWRvYmUuY29tL3RpZmYvMS4wLyIKICAgIHhtbG5zOnhtcD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLyIKICAgIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIgogICAgeG1sbnM6c3RFdnQ9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZUV2ZW50IyIKICAgZXhpZjpDb2xvclNwYWNlPSIxIgogICBleGlmOlBpeGVsWERpbWVuc2lvbj0iNDk2IgogICBleGlmOlBpeGVsWURpbWVuc2lvbj0iNDk2IgogICBwaG90b3Nob3A6Q29sb3JNb2RlPSIzIgogICBwaG90b3Nob3A6SUNDUHJvZmlsZT0ic1JHQiBJRUM2MTk2Ni0yLjEiCiAgIHRpZmY6SW1hZ2VMZW5ndGg9IjQ5NiIKICAgdGlmZjpJbWFnZVdpZHRoPSI0OTYiCiAgIHRpZmY6UmVzb2x1dGlvblVuaXQ9IjIiCiAgIHRpZmY6WFJlc29sdXRpb249IjcyLzEiCiAgIHRpZmY6WVJlc29sdXRpb249IjcyLzEiCiAgIHhtcDpNZXRhZGF0YURhdGU9IjIw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" alt="T-Mobile" onerror="this.style.display='none';">
                                        </div>
                                        <div class="header-totals-display" id="${rowId}-header-totals">
                                            <span class="header-total-label">${isManualMode ? 'New Total Monthly' : 'Total Monthly'}</span>
                                            <div class="header-prices-row">
                                                <div class="header-totals-amounts">
                                                    <span class="header-total-amount" id="${rowId}-header-total-amount">$0.00</span>
                                                    <span class="header-total-sub" id="${rowId}-header-total-sub">w/ Protection + Tax</span>
                                                    <span class="header-per-line" id="${rowId}-header-per-line" style="display:none;"></span>
                                                </div>
                                                <div class="header-total-secondary" id="${rowId}-header-total-secondary" style="display:none;">
                                                    <span class="header-total-amount-secondary" id="${rowId}-header-total-amount-secondary">$0.00</span>
                                                    <span class="header-total-sub-secondary" id="${rowId}-header-total-sub-secondary">w/o Protection</span>
                                                    <span class="header-per-line-secondary" id="${rowId}-header-per-line-secondary" style="display:none;"></span>
                                                </div>
                                                <span class="header-vs" id="${rowId}-header-vs" style="display:none;">vs</span>
                                                <div class="header-carrier-comparison" id="${rowId}-header-carrier-comparison" style="display:none;">
                                                    <span class="header-carrier-price" id="${rowId}-header-carrier-price">$0</span>
                                                    <span class="header-carrier-name" id="${rowId}-header-carrier-name">Current</span>
                                                    <span class="header-carrier-per-line" id="${rowId}-header-carrier-per-line" style="display:none;"></span>
                                                </div>
                                                <div class="header-yearly-savings" id="${rowId}-header-yearly-savings" style="display:none;">
                                                    <span class="header-yearly-amount" id="${rowId}-header-yearly-amount">$0</span>
                                                    <span class="header-yearly-label">Yearly Savings</span>
                                                </div>
                                            </div>
                                        </div>
                                        <span class="tmo-text-logo-print" style="display:none;">T-Mobile</span>
                                        <div class="title-date-group">
                                            <div class="contact-title" id="${rowId}-print-title"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="contact-quote-id" id="${rowId}-print-quote-id"></div>
                            </div>
                            <div class="contact-address" id="${rowId}-contact-address"></div>
                            <div class="contact-names">
                                <div><span class="contact-label">Prepared By: </span><span class="contact-value" id="${rowId}-rep-name"></span> <span class="contact-value" id="${rowId}-rep-phone"></span></div>
                                <div><span class="contact-label">Prepared For: </span><span class="contact-value" id="${rowId}-cust-name"></span> <span class="contact-value" id="${rowId}-cust-phone"></span></div>
                                <div><span class="contact-label">Date: </span><span class="contact-value contact-date" id="${rowId}-print-date"></span></div>
                            </div>
                        </div>
                    </div>
                </div>
                ${contentHTML}
                <div class="row-footer ${isManualMode ? '' : 'new-mode-footer'}">
                    <div class="footer-top hide-totals">
                        <div class="totals-group footer-totals-group">
                            <div class="totals-group-header">${isManualMode ? 'New Total Monthly' : 'Total Monthly'}</div>
                            <div class="totals-comparison-row">
                                <div class="totals-amounts stacked">
                                    <div class="total-block" id="${rowId}-footer-block-protected">
                                        <div class="total-amount-row">
                                            <div class="total-amount primary" id="${rowId}-footer-total-protected">$0.00</div>
                                            <div class="total-tax" id="${rowId}-footer-tax-protected">+ Tax</div>
                                        </div>
                                        <div class="total-label-below" id="${rowId}-footer-protection-label">w/ Protection</div>
                                    </div>
                                    <div class="total-block secondary-block hidden" id="${rowId}-footer-block-basic">
                                        <div class="total-amount-row">
                                            <div class="total-amount secondary" id="${rowId}-footer-total-basic">$0.00</div>
                                            <div class="total-tax" id="${rowId}-footer-tax-basic">+ Tax</div>
                                        </div>
                                        <div class="total-label-below" id="${rowId}-footer-label-basic">w/o Protection</div>
                                    </div>
                                </div>
                                <div class="carrier-comparison footer-carrier-comparison" id="${rowId}-footer-carrier-comparison" style="display: none;">
                                    <div class="vs-indicator">vs</div>
                                    <div class="carrier-price-block">
                                        <div class="carrier-price" id="${rowId}-footer-carrier-price">$0</div>
                                        <div class="carrier-name" id="${rowId}-footer-carrier-name-display">Current</div>
                                    </div>
                                </div>
                            </div>
                            <div class="options-text" onclick="openProtectionModal('${rowId}')" style="margin-top: 12px;">Options</div>
                        </div>
                        <div class="due-today-group" id="${rowId}-due-today-group" onclick="openDueTodayModal('${rowId}')">
                            <div class="due-today-row">
                                <div class="due-today-content" id="${rowId}-due-today-content">
                                    <div class="totals-group-header">Due Today</div>
                                    <div class="total-amount primary" id="${rowId}-due-today-total">$0.00</div>
                                    <div class="due-today-explanation" id="${rowId}-due-today-explanation"></div>
                                </div>
                                <div class="savings-today-content" id="${rowId}-savings-today-content" style="display:none;">
                                    <div class="totals-group-header">Savings Today</div>
                                    <div class="total-amount savings" id="${rowId}-savings-today-total">$0.00</div>
                                    <div class="due-today-explanation" id="${rowId}-savings-today-explanation"></div>
                                </div>
                            </div>
                        </div>
                        <div class="notes-section" id="${rowId}-notes-section">
                            <label>Notes</label>
                            <textarea class="notes-textarea" id="${rowId}-notes" placeholder="NOTES"></textarea>
                            <div class="notes-display" id="${rowId}-notes-display"></div>
                        </div>
                    </div>
                    
                    <div class="summaries-row">
                        <div id="${rowId}-rebate-summary" class="rebate-summary" style="display:none;">
                            <div class="rebate-summary-content">
                                <div class="rebate-summary-title">Applied Rebates</div>
                                <div id="${rowId}-rebate-list-summary"></div>
                            </div>
                            <div id="${rowId}-rebate-grand-total" class="rebate-grand-total"></div>
                        </div>
                        
                        <div id="${rowId}-discount-summary" class="discount-summary" style="display:none;">
                            <div class="discount-summary-content">
                                <div class="rebate-summary-title">Applied Monthly Discounts</div>
                                <div id="${rowId}-discount-list-summary"></div>
                            </div>
                            <div id="${rowId}-discount-total" class="discount-total"></div>
                        </div>
                    </div>

                    <div id="${rowId}-timeline-section" class="timeline-section">
                        <div class="timeline-header" onclick="toggleTimeline('${rowId}')">
                            <div class="applied-bill-label">
                                <span class="collapse-icon"></span>
                                Applied to bill: <span id="${rowId}-fmv-total">$0.00</span>
                            </div>
                        </div>
                        <div class="timeline-body">
                            <div class="timeline-controls">
                                <div class="timeline-title" style="color:var(--primary-color); font-weight:800; font-size:0.9rem; text-transform:uppercase;">Bill Credit Timeline</div>
                                <div class="timeline-toggle-wrapper" id="${rowId}-timeline-toggle-wrap">
                                    <div class="timeline-prot-slider" id="${rowId}-timeline-prot-slider">
                                        <!-- Options will be dynamically populated -->
                                    </div>
                                    <input type="hidden" id="${rowId}-timeline-toggle" value="protected">
                                </div>
                            </div>
                            <div id="${rowId}-timeline-visual" class="timeline-container"></div>
                        </div>
                    </div>
                    
                    <div class="disclosures-section">
                        <p class="disclosure-text"> Prices quoted may include limited time offers, and may change at any time. Contact representative to obtain the most up-to-date info.</p>
                        <p class="disclosure-text"> Any applicable promotions & discounts will be applied within 2 bill cycles</p>
                        <p class="disclosure-text"> Phone eligibility subject to credit approval</p>
                        <p class="disclosure-credit">Quote generated with Quote Builder, made by Luke S.</p>
                    </div>
                    
                    <div class="print-qr-wrapper" id="${rowId}-print-qr-wrapper">
                        <div id="${rowId}-barcode-canvas" class="print-qr-canvas"></div>
                    </div>
                </div>
            `;

            container.appendChild(rowDiv);
            
            // Find the correct container for extra sections
            let extrasContainer;
            if (!isManualMode) {
                // New mode - use the steps-extras-row container
                extrasContainer = rowDiv.querySelector('.steps-extras-row');
            } else {
                // Existing mode - use the first steps-container
                extrasContainer = rowDiv.querySelector('.steps-container');
            }
            
            if (extrasContainer) {
                const d1 = document.createElement('div'); d1.innerHTML = connectedDevicesHTML;
                extrasContainer.appendChild(d1.firstElementChild);
                const d1b = document.createElement('div'); d1b.innerHTML = homeInternetHTML;
                extrasContainer.appendChild(d1b.firstElementChild);
                const d2 = document.createElement('div'); d2.innerHTML = discountsHTML;
                extrasContainer.appendChild(d2.firstElementChild);
                const d3 = document.createElement('div'); d3.innerHTML = rebatesHTML;
                extrasContainer.appendChild(d3.firstElementChild);
            }

            updateExportButtonVisibility();
            calculateRow(rowId);
            
            // Initialize voice lines list to set label visibility
            renderVoiceLinesList(rowId);
            
            // Add fade-in animation
            rowDiv.classList.add('fade-in');
            
            // Initialize quote title width
            autoResizeQuoteTitle(rowId);
            
            // Update compare quotes button state
            updateCompareQuotesButtonState();
            
            // Update carousel if in stacked mode
            if (quoteDisplayStyle === 'stacked') {
                const rows = document.querySelectorAll('.calculator-row');
                // Navigate to the new row
                currentCarouselIndex = rows.length - 1;
                requestAnimationFrame(() => {
                    updateCarouselView();
                });
            }
        }

        // Confirmation timer for remove button
        let removeConfirmTimers = {};
        
        function confirmRemoveRow(btn, rowId) {
            if (btn.classList.contains('confirming')) {
                // Second click - actually remove
                clearTimeout(removeConfirmTimers[rowId]);
                delete removeConfirmTimers[rowId];
                removeRow(rowId);
            } else {
                // First click - show confirmation
                btn.classList.add('confirming');
                btn.textContent = 'Are you sure?';
                
                // Reset after 3 seconds if not clicked again
                removeConfirmTimers[rowId] = setTimeout(() => {
                    btn.classList.remove('confirming');
                    btn.textContent = 'Remove';
                    delete removeConfirmTimers[rowId];
                }, 3000);
            }
        }
        
        function updateQuoteTitle(rowId, value) {
            if (STATE[rowId]) {
                STATE[rowId].quoteTitle = value;
            }
            // Auto-resize the input
            autoResizeQuoteTitle(rowId);
        }
        
        function autoResizeQuoteTitle(rowId) {
            const input = document.getElementById(`${rowId}-quote-title`);
            if (!input) return;
            
            // Create a temporary span to measure text width
            const span = document.createElement('span');
            span.style.visibility = 'hidden';
            span.style.position = 'absolute';
            span.style.whiteSpace = 'pre';
            span.style.font = getComputedStyle(input).font;
            span.style.fontWeight = '700';
            span.style.fontSize = '1rem';
            span.style.fontFamily = getComputedStyle(input).fontFamily;
            span.style.letterSpacing = getComputedStyle(input).letterSpacing;
            span.textContent = input.value || input.placeholder;
            document.body.appendChild(span);
            
            // Set width with extra space for cursor and padding
            const width = span.offsetWidth + 30;
            input.style.width = width + 'px';
            
            document.body.removeChild(span);
        }
        
        function toggleRowActions(button, rowId) {
            const dropdown = document.getElementById(`${rowId}-actions-dropdown`);
            if (!dropdown) return;
            
            const isExpanded = dropdown.classList.contains('expanded');
            
            if (isExpanded) {
                dropdown.classList.remove('expanded');
                button.classList.remove('expanded');
            } else {
                dropdown.classList.add('expanded');
                button.classList.add('expanded');
            }
        }
        
        // Track selected quotes for comparison
        let selectedQuotesForComparison = [];
        
        function updateCompareQuotesButtonState() {
            const rows = document.querySelectorAll('.calculator-row');
            const hasEnoughQuotes = rows.length >= 2;
            
            // Update all "Quotes" buttons in rows
            document.querySelectorAll('.btn-compare-quotes').forEach(btn => {
                btn.disabled = !hasEnoughQuotes;
            });
            
            // Update header compare button
            const headerBtn = document.getElementById('compare-quotes-header-btn');
            if (headerBtn) {
                headerBtn.disabled = !hasEnoughQuotes;
            }
        }
        
        function goToCompareQuotes() {
            // Reset selection
            selectedQuotesForComparison = [];
            
            // Populate the quote selection list
            const listContainer = document.getElementById('quote-select-list');
            listContainer.innerHTML = '';
            
            const rows = document.querySelectorAll('.calculator-row');
            rows.forEach(row => {
                const rowId = row.id;
                const state = STATE[rowId];
                if (!state) return;
                
                // Get quote title
                const titleInput = document.getElementById(`${rowId}-quote-title`);
                const quoteTitle = titleInput ? titleInput.value : (state.quoteTitle || rowId);
                
                // Get plan name
                const isManualMode = row.getAttribute('data-mode') === 'existing';
                let planName = '';
                if (!isManualMode) {
                    const planEl = document.getElementById(`${rowId}-plan`);
                    if (planEl && planEl.value) {
                        planName = planEl.value;
                    } else {
                        planName = 'No Plan Selected';
                    }
                }
                // For manual/existing mode, planName stays empty
                
                // Get line count from the lines input (not line-count)
                const linesEl = document.getElementById(`${rowId}-lines`);
                const lineCount = linesEl ? parseInt(linesEl.value) || 0 : 0;
                
                // Get Add-a-Lines count
                const voiceLines = state.voiceLines || [];
                const aalCount = voiceLines.reduce((sum, group) => sum + (group.quantity || 0), 0);
                
                // Get device count
                const deviceCount = state.devices?.length || 0;
                
                // Build details string - skip planName if empty
                let detailsParts = [];
                if (planName) detailsParts.push(planName);
                detailsParts.push(`${lineCount} line${lineCount !== 1 ? 's' : ''}`);
                if (aalCount > 0) detailsParts.push(`${aalCount} AAL`);
                detailsParts.push(`${deviceCount} device${deviceCount !== 1 ? 's' : ''}`);
                const detailsString = detailsParts.join('  ');
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'quote-select-item';
                itemDiv.setAttribute('data-row-id', rowId);
                itemDiv.innerHTML = `
                    <div class="quote-select-checkbox">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                    </div>
                    <div class="quote-select-info">
                        <div class="quote-select-name">${quoteTitle}</div>
                        <div class="quote-select-details">${detailsString}</div>
                    </div>
                `;
                itemDiv.onclick = () => toggleQuoteSelection(itemDiv, rowId);
                listContainer.appendChild(itemDiv);
            });
            
            updateQuoteSelectionCount();
            document.getElementById('quote-select-modal').classList.add('open');
        }
        
        function toggleQuoteSelection(element, rowId) {
            const isSelected = element.classList.contains('selected');
            
            if (isSelected) {
                // Deselect
                element.classList.remove('selected');
                selectedQuotesForComparison = selectedQuotesForComparison.filter(id => id !== rowId);
            } else {
                // Check if we already have 2 selected
                if (selectedQuotesForComparison.length >= 2) {
                    return; // Can't select more
                }
                element.classList.add('selected');
                selectedQuotesForComparison.push(rowId);
            }
            
            updateQuoteSelectionCount();
        }
        
        function updateQuoteSelectionCount() {
            const count = selectedQuotesForComparison.length;
            document.getElementById('quote-select-count').textContent = `${count} of 2 selected`;
            
            // Enable/disable confirm button
            const confirmBtn = document.getElementById('quote-compare-confirm-btn');
            confirmBtn.disabled = count < 2;
            
            // Disable unselected items if we have 2 selected
            document.querySelectorAll('.quote-select-item').forEach(item => {
                const rowId = item.getAttribute('data-row-id');
                if (count >= 2 && !selectedQuotesForComparison.includes(rowId)) {
                    item.classList.add('disabled');
                } else {
                    item.classList.remove('disabled');
                }
            });
        }
        
        function closeQuoteSelectModal() {
            document.getElementById('quote-select-modal').classList.remove('open');
        }
        
        function confirmQuoteComparison() {
            closeQuoteSelectModal();
            showQuoteCompareSection();
        }
        
        function showQuoteCompareSection() {
            const grid = document.getElementById('quote-compare-grid');
            grid.innerHTML = '';
            
            // Set grid class based on count
            grid.className = 'quote-compare-grid';
            if (selectedQuotesForComparison.length === 2) {
                grid.classList.add('two-quotes');
            }
            
            selectedQuotesForComparison.forEach(rowId => {
                const card = createQuoteCompareCard(rowId);
                grid.appendChild(card);
            });
            
            // Add body class and show section (matches compare-mode pattern)
            document.body.classList.add('quote-compare-mode');
            document.getElementById('quote-compare-section').classList.add('active');
        }
        
        function refreshCompareView() {
            // Only refresh if compare section is visible
            if (document.getElementById('quote-compare-section').classList.contains('active')) {
                showQuoteCompareSection();
            }
        }
        
        function createQuoteCompareCard(rowId) {
            const row = document.getElementById(rowId);
            const state = STATE[rowId];
            if (!state) return document.createElement('div');
            
            // Get quote title
            const titleInput = document.getElementById(`${rowId}-quote-title`);
            const quoteTitle = titleInput ? titleInput.value : (state.quoteTitle || rowId);
            
            // Get plan name
            const isManualMode = row.getAttribute('data-mode') === 'existing';
            let planName = '';
            if (!isManualMode) {
                const planEl = document.getElementById(`${rowId}-plan`);
                if (planEl && planEl.value) {
                    planName = planEl.value;
                } else {
                    planName = 'No Plan Selected';
                }
            }
            // For manual/existing mode, planName stays empty (no "Manual Entry")
            
            // Get line count from the lines input (not line-count)
            const linesEl = document.getElementById(`${rowId}-lines`);
            const lineCount = linesEl ? parseInt(linesEl.value) || 0 : 0;
            
            // Get monthly total and subtitle from the header
            const totalEl = document.getElementById(`${rowId}-header-total-amount`);
            const monthlyTotal = totalEl ? totalEl.textContent : '$0.00';
            
            // Get the subtitle from header-total-sub - separate "+Tax" from the rest
            const totalSubEl = document.getElementById(`${rowId}-header-total-sub`);
            let priceSubtitle = totalSubEl ? totalSubEl.textContent : 'per month';
            // Extract just "+ Tax" for inline display, keep rest for below
            let inlineTax = '';
            let subtitleText = priceSubtitle;
            if (priceSubtitle.includes('+ Tax')) {
                inlineTax = '+ Tax';
                subtitleText = priceSubtitle.replace('+ Tax', '').replace('  ', ' ').trim();
            } else if (priceSubtitle.includes('+Tax')) {
                inlineTax = '+ Tax';
                subtitleText = priceSubtitle.replace('+Tax', '').replace('  ', ' ').trim();
            }
            
            // Get devices
            const devices = state.devices || [];
            
            // Get accessories
            const accessories = state.accessories || [];
            
            // Get connected devices
            const connectedDevices = state.connectedDevices || [];
            
            // Get home internet
            const homeInternet = state.homeInternet || [];
            
            // Calculate total rebates - rebates use value * count, not amount
            const rebates = state.rebates || [];
            const totalRebates = rebates.reduce((sum, r) => sum + ((parseFloat(r.value) || 0) * (parseInt(r.count) || 1)), 0);
            
            // Get monthly savings from the discount-total element (already calculated by main page)
            let totalDiscountMonthly = 0;
            const discountTotalEl = document.getElementById(`${rowId}-discount-total`);
            if (discountTotalEl) {
                // Parse from "Total Monthly Savings: $XX.XX" or "Total Yearly Savings: $XX.XX"
                const text = discountTotalEl.textContent || '';
                const match = text.match(/\$([0-9,.]+)/);
                if (match) {
                    let val = parseFloat(match[1].replace(',', '')) || 0;
                    // If yearly, divide by 12
                    if (text.toLowerCase().includes('yearly')) {
                        val = val / 12;
                    }
                    totalDiscountMonthly = val;
                }
            }
            
            const card = document.createElement('div');
            card.className = 'quote-compare-card';
            
            // Build device list HTML and track total FMV for Account Credits
            let devicesHtml = '';
            let totalFMV = 0;
            if (devices.length > 0) {
                devices.forEach(dev => {
                    // Use label for device name (that's where the user input goes)
                    const deviceName = dev.label || 'Device';
                    // Calculate monthly cost using same formula as main page: (cost - down - (promo - fmv)) / 24
                    const retailPrice = parseFloat(dev.cost) || 0;
                    const down = parseFloat(dev.down) || 0;
                    const promo = parseFloat(dev.promo) || 0;
                    const fmv = parseFloat(dev.fmv) || 0;
                    const monthlyCost = Math.max(0, (retailPrice - down - (promo - fmv)) / 24);
                    
                    // Track total FMV for Account Credits section
                    totalFMV += fmv;
                    
                    // Show N/A for BYOD (zero retail price), otherwise show monthly cost
                    const costDisplay = retailPrice === 0 ? 'N/A' : `$${monthlyCost.toFixed(2)}/mo`;
                    
                    // Show down payment if present
                    const downDisplay = down > 0 ? `<div class="quote-card-cd-subtext">Down: $${down.toFixed(2)}</div>` : '';
                    
                    // Show trade-in device name only (no amount)
                    let tradeInDisplay = '';
                    if (fmv > 0) {
                        const tradeinName = dev.tradeinName ? dev.tradeinName.replace(/</g, '&lt;').replace(/>/g, '&gt;') : '';
                        if (tradeinName) {
                            tradeInDisplay = `<div class="quote-card-cd-subtext">Trade-In: ${tradeinName}</div>`;
                        }
                    }
                    
                    // Show promo if applicable
                    const promoDisplay = promo > 0 ? `<div class="quote-card-cd-subtext">Promo: $${promo.toFixed(2)} Off</div>` : '';
                    
                    devicesHtml += `
                        <div class="quote-card-device">
                            <div class="quote-card-device-info">
                                <span class="quote-card-device-name">${deviceName}</span>
                                ${downDisplay}
                                ${tradeInDisplay}
                                ${promoDisplay}
                            </div>
                            ${showComparePrices ? `<span class="quote-card-device-price">${costDisplay}</span>` : ''}
                        </div>
                    `;
                });
            } else {
                devicesHtml = '<div style="color: var(--text-secondary); font-size: 0.9rem;">No devices added</div>';
            }
            
            // Build accessories HTML
            let accessoriesHtml = '';
            if (accessories.length > 0) {
                accessories.forEach(acc => {
                    const accName = acc.name || 'Accessory';
                    const accPrice = parseFloat(acc.price) || 0;
                    const accQty = parseInt(acc.quantity) || 1;
                    const isFinanced = acc.paymentMethod === 'finance';
                    
                    // For financed accessories, show monthly (/mo), otherwise show one-time price
                    let priceDisplay = '';
                    if (isFinanced) {
                        const monthlyPrice = accPrice / 24;
                        priceDisplay = `$${monthlyPrice.toFixed(2)}/mo`;
                    } else {
                        priceDisplay = `$${accPrice.toFixed(2)}`;
                    }
                    
                    // Show quantity if more than 1
                    const qtyDisplay = accQty > 1 ? ` (x${accQty})` : '';
                    
                    accessoriesHtml += `
                        <div class="quote-card-device">
                            <span class="quote-card-device-name">${accName}${qtyDisplay}</span>
                            ${showComparePrices ? `<span class="quote-card-device-price">${priceDisplay}</span>` : ''}
                        </div>
                    `;
                });
            } else {
                accessoriesHtml = '<div style="color: var(--text-secondary); font-size: 0.9rem;">None</div>';
            }
            
            // Build connected devices HTML - show plan name, device name as subtext, include device financing
            let cdHtml = '';
            if (connectedDevices.length > 0) {
                // Default device names that shouldn't be displayed
                const defaultDevNames = ['Watch', 'Tablet', 'Data Device', 'Tracker', 'Drive', 'Watches', 'Tablets', 'Data', 'SyncUp Trackers', 'SyncUp Drive'];
                
                connectedDevices.forEach(cd => {
                    // Plan name is the main label
                    const cdPlanName = cd.planKey || 'Connected Device Plan';
                    // Device name is subtext only if:
                    // 1. User actually entered one (not empty)
                    // 2. It's not a default name
                    // 3. There's a device cost (matching main page behavior)
                    const devCost = cd.devCost || 0;
                    const rawDevName = cd.devName && cd.devName.trim() !== '' ? cd.devName.trim() : '';
                    const isDefaultName = defaultDevNames.includes(rawDevName);
                    const cdDeviceName = (rawDevName && !isDefaultName && devCost > 0) ? rawDevName : '';
                    
                    // Calculate total monthly: plan cost + device financing
                    const cdPlanCost = cd.planData?.price || 0;
                    const term = cd.term || 24;
                    const devDown = cd.devDown || 0;
                    const devPromo = cd.devPromo || 0;
                    const devMonthly = Math.max(0, (devCost - devDown - devPromo) / term);
                    const cdTotalMonthly = cdPlanCost + devMonthly;
                    
                    cdHtml += `
                        <div class="quote-card-device">
                            <div class="quote-card-device-info">
                                <span class="quote-card-device-name">${cdPlanName}</span>
                                ${cdDeviceName ? `<div class="quote-card-cd-subtext">${cdDeviceName}</div>` : ''}
                            </div>
                            ${showComparePrices ? `<span class="quote-card-device-price">$${cdTotalMonthly.toFixed(2)}/mo</span>` : ''}
                        </div>
                    `;
                });
            } else {
                cdHtml = '<div style="color: var(--text-secondary); font-size: 0.9rem;">None</div>';
            }
            
            // Build home internet HTML - calculate discounted price like main page
            let hiHtml = '';
            if (homeInternet.length > 0) {
                // Check conditions for discounts
                const hasVoiceline = lineCount >= 1;
                const hasAutopay = state.discounts?.some(d => d.type === 'Autopay Discount') || false;
                const is55Plan = planName && planName.includes('55');
                const existingHasPlanCost = isManualMode && (state.manualPrice > 0 || parseFloat(document.getElementById(`${rowId}-manual-price`)?.value) > 0);
                const maxHiBundleDiscount = 2;
                let hiBundleDiscountUsed = 0;
                // Track autopay usage (voice lines use first slots)
                let autopayUsed = hasAutopay ? Math.min(lineCount, 8) : 0;
                const maxAutopay = 8;
                
                homeInternet.forEach((hi, index) => {
                    const hiName = hi.label || hi.planKey || 'Internet Plan';
                    const plan = hi.planData;
                    let price = plan?.price || 0;
                    
                    // Check eligibility flags
                    const voicelineEligible = plan?.voicelineEligible !== false;
                    const autopayEligible = plan?.autopayEligible !== false;
                    
                    // Apply voiceline bundling discount (max 2 HI)
                    if ((hasVoiceline || existingHasPlanCost) && voicelineEligible && hiBundleDiscountUsed < maxHiBundleDiscount && plan?.priceWithVoiceline) {
                        price = plan.priceWithVoiceline;
                        hiBundleDiscountUsed++;
                    }
                    
                    // Apply 55+ savings for first HI
                    if (!isManualMode && is55Plan && index === 0 && voicelineEligible) {
                        price -= 5;
                    }
                    
                    // Apply autopay discount ($5 each)
                    if (hasAutopay && autopayEligible && autopayUsed < maxAutopay) {
                        price -= 5;
                        autopayUsed++;
                    }
                    
                    hiHtml += `
                        <div class="quote-card-device">
                            <span class="quote-card-device-name">${hiName}</span>
                            ${showComparePrices ? `<span class="quote-card-device-price">$${price.toFixed(2)}/mo</span>` : ''}
                        </div>
                    `;
                });
            } else {
                hiHtml = '<div style="color: var(--text-secondary); font-size: 0.9rem;">None</div>';
            }
            
            // Build Add-a-Lines (voiceLines) HTML - for Existing mode
            const voiceLines = state.voiceLines || [];
            let voiceLinesHtml = '';
            let totalAddALines = 0;
            if (voiceLines.length > 0) {
                voiceLines.forEach(group => {
                    const lineCost = group.cost || 0;
                    const qty = group.quantity || 1;
                    totalAddALines += qty;
                    
                    // Check for BOGO
                    const hasBogo = group.bogoType !== 'none' && qty >= 2;
                    const bogoPrice = group.bogoType === 'free' ? 0 : 10;
                    
                    // Generate individual line entries
                    for (let i = 0; i < qty; i++) {
                        let linePrice;
                        if (hasBogo && i === qty - 1) {
                            // Last line in a BOGO group gets the BOGO price
                            linePrice = bogoPrice;
                        } else {
                            linePrice = lineCost;
                        }
                        
                        voiceLinesHtml += `
                            <div class="quote-card-device">
                                <span class="quote-card-device-name">+1 Voice line</span>
                                ${showComparePrices ? `<span class="quote-card-device-price">$${linePrice.toFixed(2)}/mo</span>` : ''}
                            </div>
                        `;
                    }
                });
            }
            
            // Build Addons HTML
            const addons = state.addons || [];
            let addonsHtml = '';
            if (addons.length > 0) {
                addons.forEach(addon => {
                    const addonName = addon.name || 'Add-on';
                    const addonPrice = parseFloat(addon.price) || 0;
                    const addonAmount = parseInt(addon.amount) || 1;
                    const totalPrice = addonPrice * addonAmount;
                    
                    addonsHtml += `
                        <div class="quote-card-device">
                            <span class="quote-card-device-name">${addonName}${addonAmount > 1 ? ` (x${addonAmount})` : ''}</span>
                            ${showComparePrices ? `<span class="quote-card-device-price">$${totalPrice.toFixed(2)}/mo</span>` : ''}
                        </div>
                    `;
                });
            }
            
            // Check if user has yearly savings toggled
            const showYearlySavings = state.showYearlySavings || false;
            const savingsAmount = showYearlySavings ? totalDiscountMonthly * 12 : totalDiscountMonthly;
            const savingsLabel = showYearlySavings ? 'Yearly Savings' : 'Monthly Savings';
            const savingsDisplay = showYearlySavings ? `$${savingsAmount.toFixed(2)}` : `$${savingsAmount.toFixed(2)}/mo`;
            
            // Calculate Due Today from the displayed element (already calculated by main page)
            const dueTodayEl = document.getElementById(`${rowId}-due-today-total`);
            const dueTodayText = dueTodayEl ? dueTodayEl.textContent : '$0.00';
            const dueTodayMatch = dueTodayText.match(/\$([0-9,.]+)/);
            const dueToday = dueTodayMatch ? parseFloat(dueTodayMatch[1].replace(',', '')) || 0 : 0;
            
            // Calculate Saved Today from items
            const savedTodayItems = state.savedTodayItems || [];
            const savedToday = savedTodayItems.reduce((sum, item) => sum + ((item.amount || 0) * (item.quantity || 1)), 0);
            
            card.innerHTML = `
                <div class="quote-card-header">
                    <div class="quote-card-title">${quoteTitle}</div>
                </div>
                <div class="quote-card-price">
                    <div class="quote-card-price-amount">${monthlyTotal} <span class="quote-card-price-tax">${inlineTax}</span></div>
                    ${subtitleText ? `<div class="quote-card-price-label">${subtitleText}</div>` : ''}
                </div>
                <div class="quote-card-section">
                    ${planName ? `
                    <div class="quote-card-section-title">Plan</div>
                    <div class="quote-card-section-content">
                        <div class="quote-card-device">
                            <span class="quote-card-device-name">${planName}</span>
                            <span class="quote-card-device-price">${lineCount} line${lineCount !== 1 ? 's' : ''}</span>
                        </div>
                    </div>
                    ` : `
                    <div class="quote-card-section-title" style="display: flex; justify-content: space-between; align-items: center;">Current Amount of Lines <span class="quote-card-device-price" style="text-transform: none; font-size: 0.95rem; font-weight: 400;">${lineCount} line${lineCount !== 1 ? 's' : ''}</span></div>
                    `}
                </div>
                ${totalAddALines > 0 ? `
                <div class="quote-card-section">
                    <div class="quote-card-section-title">Add-A-Lines</div>
                    <div class="quote-card-section-content">${voiceLinesHtml}</div>
                </div>
                ` : ''}
                ${addons.length > 0 ? `
                <div class="quote-card-section">
                    <div class="quote-card-section-title">Add-ons (${addons.length})</div>
                    <div class="quote-card-section-content">${addonsHtml}</div>
                </div>
                ` : ''}
                <div class="quote-card-section">
                    <div class="quote-card-section-title">Devices (${devices.length})</div>
                    <div class="quote-card-section-content">${devicesHtml}</div>
                </div>
                ${accessories.length > 0 ? `
                <div class="quote-card-section">
                    <div class="quote-card-section-title">Accessories (${accessories.length})</div>
                    <div class="quote-card-section-content">${accessoriesHtml}</div>
                </div>
                ` : ''}
                <div class="quote-card-section">
                    <div class="quote-card-section-title">Connected Devices (${connectedDevices.length})</div>
                    <div class="quote-card-section-content">${cdHtml}</div>
                </div>
                <div class="quote-card-section">
                    <div class="quote-card-section-title">Home Internet (${homeInternet.length})</div>
                    <div class="quote-card-section-content">${hiHtml}</div>
                </div>
                <div class="quote-card-footer">
                <div style="border-top: 1px solid var(--border-color); margin-bottom: 15px;"></div>
                <div class="quote-card-section" ${dueToday > 0 ? '' : 'style="display: none;"'}>
                    <div class="quote-card-section-title" style="display: flex; justify-content: space-between; align-items: center;">Due Today <span class="quote-card-device-price" style="text-transform: none; font-size: 0.95rem; font-weight: 400;">$${dueToday.toFixed(2)}</span></div>
                </div>
                <div class="quote-card-section" ${totalFMV > 0 ? '' : 'style="display: none;"'}>
                    <div class="quote-card-section-title" style="display: flex; justify-content: space-between; align-items: center;">Account Credits <span class="quote-card-device-price" style="text-transform: none; font-size: 0.95rem; font-weight: 400;">$${totalFMV.toFixed(2)}</span></div>
                </div>
                <div class="quote-card-section" ${savedToday > 0 ? '' : 'style="display: none;"'}>
                    <div class="quote-card-section-title" style="display: flex; justify-content: space-between; align-items: center;">Saved Today <span class="quote-card-device-price" style="text-transform: none; font-size: 0.95rem; font-weight: 400;">$${savedToday.toFixed(2)}</span></div>
                </div>
                <div class="quote-card-section">
                    <div class="quote-card-section-title" style="display: flex; justify-content: space-between; align-items: center;">${savingsLabel} <span class="quote-card-device-price" style="text-transform: none; font-size: 0.95rem; font-weight: 400;">${savingsDisplay}</span></div>
                </div>
                <div class="quote-card-section">
                    <div class="quote-card-section-title" style="display: flex; justify-content: space-between; align-items: center;">Total Rebates <span class="quote-card-device-price" style="text-transform: none; font-size: 0.95rem; font-weight: 400;">$${totalRebates.toFixed(2)}</span></div>
                </div>
                </div>
            `;
            
            return card;
        }
        
        function closeQuoteCompareSection() {
            document.body.classList.remove('quote-compare-mode');
            document.getElementById('quote-compare-section').classList.remove('active');
        }
        
        function goToCompareWithPlan(rowId) {
            const row = document.getElementById(rowId);
            if (!row) return;
            
            // Track which row's comparison we're viewing
            currentCompareRowId = rowId;
            
            const isManualMode = row.getAttribute('data-mode') === 'existing';
            
            // Get the plan from this row
            let planName = '';
            if (!isManualMode) {
                const planEl = document.getElementById(`${rowId}-plan`);
                planName = planEl ? planEl.value : '';
            }
            
            // Check if this row has saved comparison settings that were user-modified
            const savedSettings = STATE[rowId]?.compareSettings;
            const hasUserModified = savedSettings?.hasUserModified || false;
            
            // Switch to compare mode
            setMode('compare');
            
            // Wait for the compare section to be visible and initialized
            setTimeout(() => {
                // If user has previously modified this row's comparison, restore their selections
                if (hasUserModified && (savedSettings.plan1Key || savedSettings.plan2Key)) {
                    // Restore Plan 1
                    const plan1El = document.getElementById('compare-plan-1');
                    const plan1Label = document.getElementById('compare-plan-1-label');
                    const trigger1 = document.getElementById('compare-plan-1-trigger');
                    if (plan1El && plan1Label && trigger1) {
                        if (savedSettings.plan1Key) {
                            plan1El.value = savedSettings.plan1Key;
                            plan1Label.textContent = savedSettings.plan1Key;
                            trigger1.classList.add('has-selection');
                            // Determine plan type
                            if (HOME_INTERNET_PLANS[savedSettings.plan1Key] || BUSINESS_HOME_INTERNET_PLANS[savedSettings.plan1Key]) {
                                comparePlanTypes[1] = 'internet';
                            } else {
                                comparePlanTypes[1] = 'phone';
                            }
                        } else {
                            plan1El.value = '';
                            plan1Label.textContent = 'Plan 1';
                            trigger1.classList.remove('has-selection', 'premium');
                            comparePlanTypes[1] = null;
                        }
                    }
                    
                    // Restore Plan 2
                    const plan2El = document.getElementById('compare-plan-2');
                    const plan2Label = document.getElementById('compare-plan-2-label');
                    const trigger2 = document.getElementById('compare-plan-2-trigger');
                    if (plan2El && plan2Label && trigger2) {
                        if (savedSettings.plan2Key) {
                            plan2El.value = savedSettings.plan2Key;
                            plan2Label.textContent = savedSettings.plan2Key;
                            trigger2.classList.add('has-selection');
                            // Determine plan type
                            if (HOME_INTERNET_PLANS[savedSettings.plan2Key] || BUSINESS_HOME_INTERNET_PLANS[savedSettings.plan2Key]) {
                                comparePlanTypes[2] = 'internet';
                            } else {
                                comparePlanTypes[2] = 'phone';
                            }
                        } else {
                            plan2El.value = '';
                            plan2Label.textContent = 'Plan 2';
                            trigger2.classList.remove('has-selection', 'premium');
                            comparePlanTypes[2] = null;
                        }
                    }
                    
                    // Trigger the comparison update
                    updateComparison();
                } else {
                    // Use defaults based on the row's selected plan
                    if (planName && PLANS_DATA[planName]) {
                        const comparisonPlan = getComparisonPlanFor(planName);
                        
                        // Set Plan 1 (the comparison/better plan)
                        const plan1El = document.getElementById('compare-plan-1');
                        const plan1Label = document.getElementById('compare-plan-1-label');
                        const trigger1 = document.getElementById('compare-plan-1-trigger');
                        if (plan1El && plan1Label && trigger1) {
                            plan1El.value = comparisonPlan;
                            plan1Label.textContent = comparisonPlan;
                            trigger1.classList.add('has-selection');
                            comparePlanTypes[1] = 'phone';
                        }
                        
                        // Set Plan 2 (the customer's current/selected plan)
                        const plan2El = document.getElementById('compare-plan-2');
                        const plan2Label = document.getElementById('compare-plan-2-label');
                        const trigger2 = document.getElementById('compare-plan-2-trigger');
                        if (plan2El && plan2Label && trigger2) {
                            plan2El.value = planName;
                            plan2Label.textContent = planName;
                            trigger2.classList.add('has-selection');
                            comparePlanTypes[2] = 'phone';
                        }
                        
                        // Trigger the comparison update
                        updateComparison();
                    } else {
                        // No plan selected - check for internet plans
                        let selectedInternetPlan = '';
                        if (STATE[rowId]?.homeInternet?.length > 0) {
                            const firstHI = STATE[rowId].homeInternet[0];
                            if (firstHI.planKey) {
                                selectedInternetPlan = firstHI.planKey;
                            }
                        }
                        
                        if (selectedInternetPlan) {
                            const comparisonPlan = getInternetComparisonPlanFor(selectedInternetPlan);
                            
                            // Set Plan 1 (the comparison/better plan)
                            const plan1El = document.getElementById('compare-plan-1');
                            const plan1Label = document.getElementById('compare-plan-1-label');
                            const trigger1 = document.getElementById('compare-plan-1-trigger');
                            if (plan1El && plan1Label && trigger1) {
                                plan1El.value = comparisonPlan;
                                plan1Label.textContent = comparisonPlan;
                                trigger1.classList.add('has-selection');
                                comparePlanTypes[1] = 'internet';
                            }
                            
                            // Set Plan 2 (the customer's selected plan)
                            const plan2El = document.getElementById('compare-plan-2');
                            const plan2Label = document.getElementById('compare-plan-2-label');
                            const trigger2 = document.getElementById('compare-plan-2-trigger');
                            if (plan2El && plan2Label && trigger2) {
                                plan2El.value = selectedInternetPlan;
                                plan2Label.textContent = selectedInternetPlan;
                                trigger2.classList.add('has-selection');
                                comparePlanTypes[2] = 'internet';
                            }
                            
                            // Trigger the comparison update
                            updateComparison();
                        } else {
                            // Default to Experience Beyond vs Experience More
                            resetComparison();
                            
                            const plan1El = document.getElementById('compare-plan-1');
                            const plan1Label = document.getElementById('compare-plan-1-label');
                            const trigger1 = document.getElementById('compare-plan-1-trigger');
                            if (plan1El && plan1Label && trigger1) {
                                plan1El.value = 'Experience Beyond';
                                plan1Label.textContent = 'Experience Beyond';
                                trigger1.classList.add('has-selection');
                                comparePlanTypes[1] = 'phone';
                            }
                            
                            const plan2El = document.getElementById('compare-plan-2');
                            const plan2Label = document.getElementById('compare-plan-2-label');
                            const trigger2 = document.getElementById('compare-plan-2-trigger');
                            if (plan2El && plan2Label && trigger2) {
                                plan2El.value = 'Experience More';
                                plan2Label.textContent = 'Experience More';
                                trigger2.classList.add('has-selection');
                                comparePlanTypes[2] = 'phone';
                            }
                            
                            updateComparison();
                        }
                    }
                }
            }, 50); // Small delay to let DOM update
        }

        function removeRow(rowId) {
            const row = document.getElementById(rowId);
            if(row) {
                // Add fade-out animation
                row.classList.add('fade-out');
                // Remove after animation completes
                setTimeout(() => {
                    row.remove();
                    delete STATE[rowId];
                    updateExportButtonVisibility();
                    // Update carousel if in stacked mode
                    if (quoteDisplayStyle === 'stacked') {
                        // Adjust index if needed
                        const remainingRows = document.querySelectorAll('.calculator-row');
                        if (currentCarouselIndex >= remainingRows.length) {
                            currentCarouselIndex = Math.max(0, remainingRows.length - 1);
                        }
                        updateCarouselView();
                    }
                    // Update default benefits slider visibility
                    toggleDefaultBenefitsSwitch();
                    // Update compare quotes button state
                    updateCompareQuotesButtonState();
                }, 300);
            } else {
                updateExportButtonVisibility();
                toggleDefaultBenefitsSwitch();
                updateCompareQuotesButtonState();
            }
        }

        function duplicateRow(sourceRowId) {
            // Create a new row first
            createNewRow();
            
            // Get the new row ID (it's the latest one)
            const newRowId = `row-${rowCount}`;
            
            // Copy state from source to new row
            const sourceState = STATE[sourceRowId];
            STATE[newRowId] = {
                devices: JSON.parse(JSON.stringify(sourceState.devices)),
                protectionStatus: { ...sourceState.protectionStatus },
                protectionCosts: { ...sourceState.protectionCosts },
                showUnprotected: sourceState.showUnprotected,
                showStandardProtection: sourceState.showStandardProtection,
                showProtectionLabel: sourceState.showProtectionLabel !== false,
                connectedDevices: JSON.parse(JSON.stringify(sourceState.connectedDevices)),
                homeInternet: JSON.parse(JSON.stringify(sourceState.homeInternet)),
                accessories: JSON.parse(JSON.stringify(sourceState.accessories || [])),
                dueTodayItems: JSON.parse(JSON.stringify(sourceState.dueTodayItems || [])),
                savedTodayItems: JSON.parse(JSON.stringify(sourceState.savedTodayItems || [])),
                rebates: JSON.parse(JSON.stringify(sourceState.rebates)),
                discounts: JSON.parse(JSON.stringify(sourceState.discounts)),
                voiceLines: JSON.parse(JSON.stringify(sourceState.voiceLines || [])),
                title: sourceState.title,
                // Copy carrier info
                carrierName: sourceState.carrierName || '',
                carrierPrice: sourceState.carrierPrice || 0,
                carrierSkipped: sourceState.carrierSkipped || false,
                // Copy compare settings (but reset hasUserModified so duplicated row uses defaults unless modified)
                compareSettings: {
                    plan1Key: sourceState.compareSettings?.plan1Key || '',
                    plan2Key: sourceState.compareSettings?.plan2Key || '',
                    hasUserModified: sourceState.compareSettings?.hasUserModified || false
                }
            };
            
            // Copy form values
            const sourceRow = document.getElementById(sourceRowId);
            const newRow = document.getElementById(newRowId);
            const isManualMode = sourceRow.getAttribute('data-mode') === 'existing';
            
            if (isManualMode) {
                const sourcePrice = document.getElementById(`${sourceRowId}-manual-price`);
                const newPrice = document.getElementById(`${newRowId}-manual-price`);
                if (sourcePrice && newPrice) newPrice.value = sourcePrice.value;
            } else {
                const sourcePlan = document.getElementById(`${sourceRowId}-plan`);
                const newPlan = document.getElementById(`${newRowId}-plan`);
                const newTrigger = document.getElementById(`${newRowId}-plan-trigger`);
                if (sourcePlan && newPlan) {
                    newPlan.value = sourcePlan.value;
                    if (newTrigger) newTrigger.value = sourcePlan.value;
                }
                
                // Update carrier display for new mode
                updateCarrierDisplay(newRowId);
            }
            
            const sourceLines = document.getElementById(`${sourceRowId}-lines`);
            const newLines = document.getElementById(`${newRowId}-lines`);
            if (sourceLines && newLines) newLines.value = sourceLines.value;
            
            // Copy notes
            const sourceNotes = document.getElementById(`${sourceRowId}-notes`);
            const newNotes = document.getElementById(`${newRowId}-notes`);
            if (sourceNotes && newNotes) newNotes.value = sourceNotes.value;
            
            // Copy existing mode checkboxes
            if (isManualMode) {
                const sourceTaxes = document.getElementById(`${sourceRowId}-taxes-included`);
                const newTaxes = document.getElementById(`${newRowId}-taxes-included`);
                if (sourceTaxes && newTaxes) newTaxes.checked = sourceTaxes.checked;
                
                const sourceBusiness = document.getElementById(`${sourceRowId}-is-business`);
                const newBusiness = document.getElementById(`${newRowId}-is-business`);
                if (sourceBusiness && newBusiness) newBusiness.checked = sourceBusiness.checked;
            }
            
            // Copy title without modification
            const sourceTitleInput = sourceRow.querySelector('.row-title-input');
            const newTitleInput = newRow.querySelector('.row-title-input');
            if (sourceTitleInput && newTitleInput) {
                newTitleInput.value = sourceTitleInput.value;
            }
            
            // Reveal steps and render lists
            // Lines column is always visible by default
            // If lines > 0, show plan column
            if (!isManualMode) {
                if (parseInt(newLines.value) > 0) {
                    revealStep(newRowId, 'col2'); // Plan
                    
                    // If plan is selected, show device setup
                    if (document.getElementById(`${newRowId}-plan`).value) {
                        revealStep(newRowId, 'col3'); // Device setup
                    }
                }
            } else if (isManualMode && parseInt(newLines.value) > 0) {
                revealStep(newRowId, 'col3');
            }
            
            // Update carrier display if carrier info exists
            if (STATE[newRowId].carrierName && STATE[newRowId].carrierPrice > 0) {
                updateCarrierDisplay(newRowId);
            }
            
            renderDeviceList(newRowId);
            renderCDList(newRowId);
            renderHIList(newRowId);
            renderVoiceLinesList(newRowId);
            renderDiscountList(newRowId);
            renderRebateList(newRowId);
            renderAccessoriesList(newRowId);
            renderDueTodayItemsList(newRowId);
            renderSavedTodayItemsList(newRowId);
            
            // Update savings today total from items (important for duplication)
            updateSavingsTodayFromItems(newRowId);
            
            calculateRow(newRowId);
            
            // Update default benefits slider visibility
            toggleDefaultBenefitsSwitch();
        }

        function handleStandardLines(rowId) { 
            const val = parseInt(document.getElementById(`${rowId}-lines`).value) || 0;
            const planName = document.getElementById(`${rowId}-plan`).value;
            
            if (val > 0) {
                // Show plan column when lines > 0
                revealStep(rowId, 'col2');
                
                // If plan is selected, show device setup
                if (planName) {
                    revealStep(rowId, 'col3');
                }
            } else {
                // Hide plan and device columns when lines = 0
                hideStep(rowId, 'col2');
                hideStep(rowId, 'col3');
                
                // Remove devices when lines go to 0
                STATE[rowId].devices = [];
                STATE[rowId].protectionStatus = {};
                STATE[rowId].protectionCosts = {};
                renderDeviceList(rowId);
                
                // Clear plan selection when lines = 0
                document.getElementById(`${rowId}-plan`).value = '';
                document.getElementById(`${rowId}-plan-trigger`).value = '';
                
                // Clear all discounts when lines = 0
                STATE[rowId].discounts = [];
                renderDiscountList(rowId);
            }
            // Always show connected devices, home internet, discounts, and rebates
            revealStep(rowId, 'col-bts'); 
            revealStep(rowId, 'col-internet');
            revealStep(rowId, 'col-discounts');
            revealStep(rowId, 'col-rebates');
            calculateRow(rowId); 
        }
        function handleStandardPlan(rowId) { 
            validateDiscounts(rowId);
            
            // Check if selected plan is business or regular
            const planEl = document.getElementById(`${rowId}-plan`);
            const planName = planEl ? planEl.value : '';
            
            if (planName) {
                const isBusinessPlan = BUSINESS_PLAN_KEYWORDS.some(keyword => 
                    planName.toLowerCase().includes(keyword)
                );
                
                // Filter out incompatible home internet plans
                const originalHILength = STATE[rowId].homeInternet.length;
                STATE[rowId].homeInternet = STATE[rowId].homeInternet.filter(hi => {
                    const hiIsBusiness = hi.isBusinessPlan === true;
                    // Keep if types match: business plan + business internet OR regular plan + regular internet
                    return isBusinessPlan === hiIsBusiness;
                });
                
                // Re-render if we removed any
                if (STATE[rowId].homeInternet.length !== originalHILength) {
                    renderHIList(rowId);
                }
                
                // Filter out incompatible connected devices
                const originalCDLength = STATE[rowId].connectedDevices.length;
                STATE[rowId].connectedDevices = STATE[rowId].connectedDevices.filter(cd => {
                    const cdIsBusiness = cd.isBusinessPlan === true;
                    // Keep if types match: business plan + business CD OR regular plan + regular CD
                    return isBusinessPlan === cdIsBusiness;
                });
                
                // Re-render if we removed any
                if (STATE[rowId].connectedDevices.length !== originalCDLength) {
                    renderCDList(rowId);
                }
            }
            
            // If lines are already > 0, show device setup
            const lineCount = parseInt(document.getElementById(`${rowId}-lines`).value) || 0;
            if (lineCount > 0) {
                revealStep(rowId, 'col3');
            }
            calculateRow(rowId); 
        }
        function handleManualPrice(rowId) { 
            const priceInput = document.getElementById(`${rowId}-manual-price`);
            const priceDisplay = document.getElementById(`${rowId}-manual-price-display`);
            const addonsBtn = document.getElementById(`${rowId}-manual-addons-btn`);
            const price = parseFloat(priceInput.value);
            
            // Update the formatted display for print
            if (priceDisplay) {
                if (price > 0) {
                    priceDisplay.textContent = `$${price.toFixed(2)}`;
                } else {
                    priceDisplay.textContent = '';
                }
            }
            
            if(price >= 0) {
                revealStep(rowId, 'col2'); 
                calculateRow(rowId); 
            }
            
            // Show/hide Manage Add-ons button based on whether there's a price
            if (addonsBtn) {
                if (price > 0) {
                    addonsBtn.style.display = 'block';
                } else {
                    addonsBtn.style.display = 'none';
                }
            }
            
            // Always show connected devices, home internet, discounts, and rebates
            revealStep(rowId, 'col-bts'); 
            revealStep(rowId, 'col-internet');
            revealStep(rowId, 'col-discounts');
            revealStep(rowId, 'col-rebates');
        }
        
        function openManualAddonsPage(rowId) {
            // Set the rowId in the plan modal
            document.getElementById('plan-modal-row-id').value = rowId;
            
            // Open the plan modal
            document.getElementById('plan-modal').classList.add('open');
            
            // Immediately navigate to the add-ons page
            openAddonsPage();
            
            // Hide the back button since we're in manual mode (no plans to go back to)
            const backBtn = document.querySelector('.addon-back-btn');
            if (backBtn) {
                backBtn.style.display = 'none';
            }
        }
        
        function handleManualUpgrades(rowId) { 
             const val = parseInt(document.getElementById(`${rowId}-lines`).value) || 0;
             if(val > 0) {
                 revealStep(rowId, 'col3');
                 revealStep(rowId, 'col-voice-lines');
             } else {
                 hideStep(rowId, 'col3');
                 hideStep(rowId, 'col-voice-lines');
             }
             
             // Update voice lines visibility based on whether any exist
             renderVoiceLinesList(rowId);
             
             // Show/hide Add Voice Line button based on line count
             const addVoiceLineBtn = document.getElementById(`${rowId}-add-voice-line-btn`);
             const addALinesTitle = document.getElementById(`${rowId}-add-a-lines-title`);
             if (addVoiceLineBtn) {
                 addVoiceLineBtn.style.display = val > 0 ? 'block' : 'none';
             }
             if (addALinesTitle) {
                 addALinesTitle.style.display = val > 0 ? 'block' : 'none';
             }
             
             calculateRow(rowId); 
        }
        
        function handleExistingAutopayChange(rowId) {
            // Recalculate to apply/remove autopay discounts
            calculateRow(rowId);
            // Re-render CD and HI lists to show updated prices
            renderCDList(rowId);
            renderHIList(rowId);
        }
        
        function handleAutopayCheckboxChange(rowId) {
            // Re-render CD and HI lists to show updated pricing
            renderCDList(rowId);
            renderHIList(rowId);
            calculateRow(rowId);
        }
        
        function handleBusinessCheckboxChange(rowId) {
            const businessCheckbox = document.getElementById(`${rowId}-is-business`);
            const isBusinessPlan = businessCheckbox ? businessCheckbox.checked : false;
            
            // Filter out incompatible home internet plans
            const originalHILength = STATE[rowId].homeInternet.length;
            STATE[rowId].homeInternet = STATE[rowId].homeInternet.filter(hi => {
                const hiIsBusiness = hi.isBusinessPlan === true;
                // Keep if types match
                return isBusinessPlan === hiIsBusiness;
            });
            
            // Re-render if we removed any
            if (STATE[rowId].homeInternet.length !== originalHILength) {
                renderHIList(rowId);
            }
            
            // Filter out incompatible connected devices
            const originalCDLength = STATE[rowId].connectedDevices.length;
            STATE[rowId].connectedDevices = STATE[rowId].connectedDevices.filter(cd => {
                const cdIsBusiness = cd.isBusinessPlan === true;
                // Keep if types match
                return isBusinessPlan === cdIsBusiness;
            });
            
            // Re-render if we removed any
            if (STATE[rowId].connectedDevices.length !== originalCDLength) {
                renderCDList(rowId);
            }
            
            calculateRow(rowId);
        }
        
        function handleBeyondSavingsCheckboxChange(rowId) {
            // Re-render CD list to update pricing based on beyond savings
            renderCDList(rowId);
            calculateRow(rowId);
        }

        function revealStep(rowId, colId) {
            const col = document.getElementById(`${rowId}-${colId}`);
            if(col) {
                col.classList.remove('hidden-step');
                col.classList.add('visible-step');
            }
            
            // Update grid stages for main row
            updateGridStage(rowId);
        }
        
        function updateGridStage(rowId) {
            // Update "Us" label visibility based on carrier state
            updateUsLabelVisibility(rowId);
        }
        
        function updateUsLabelVisibility(rowId) {
            const usLabel = document.querySelector(`#${rowId}-totals-prices .us-label-header`);
            if (!usLabel) return;
            
            // Always hide - removed per user request
            usLabel.style.display = 'none';
        }
        
        function hideStep(rowId, colId) {
            const col = document.getElementById(`${rowId}-${colId}`);
            if(col) {
                col.classList.add('hidden-step');
                col.classList.remove('visible-step');
            }
            
            // Update grid stages for main row
            updateGridStage(rowId);
        }

        function toggleModalFMV(show) {
            const grp = document.getElementById('modal-fmv-group');
            const nameGrp = document.getElementById('modal-tradein-name-group');
            if (show) {
                grp.classList.remove('hidden');
                nameGrp.classList.remove('hidden');
            } else {
                grp.classList.add('hidden');
                nameGrp.classList.add('hidden');
            }
        }
        
        function toggleDeviceSearchBtn() {
            const input = document.getElementById('modal-dev-label');
            const btn = document.getElementById('device-search-btn');
            if (input.value.trim().length > 0) {
                const searchUrl = `https://www.t-mobile.com/search?q=${encodeURIComponent(input.value.trim())}`;
                btn.href = searchUrl;
                btn.style.display = 'inline-flex';
            } else {
                btn.href = '#';
                btn.style.display = 'none';
            }
        }

        function toggleCDSearchBtn() {
            const input = document.getElementById('cd-dev-name');
            const btn = document.getElementById('cd-search-btn');
            if (input.value.trim().length > 0) {
                const searchUrl = `https://www.t-mobile.com/search?category=devices&q=${encodeURIComponent(input.value.trim())}`;
                btn.href = searchUrl;
                btn.style.display = 'inline-flex';
            } else {
                btn.href = '#';
                btn.style.display = 'none';
            }
        }

        function openModal(rowId, index = -1) {
            // If index is -1, this is a new device
            if (index === -1) {
                // Check if this is "existing" mode - if so, open the modal
                const rowElement = document.getElementById(rowId);
                const isManualMode = rowElement && rowElement.getAttribute('data-mode') === 'existing';
                
                if (isManualMode) {
                    // In existing mode, open the add device modal normally
                    document.getElementById('modal-row-id').value = rowId;
                    document.getElementById('modal-edit-index').value = -1;
                    document.getElementById('modal-title').textContent = "Add Device";
                    
                    document.getElementById('modal-dev-label').value = '';
                    document.getElementById('modal-dev-cost').value = '';
                    document.getElementById('modal-dev-down').value = '';
                    document.getElementById('modal-dev-promo').value = '';
                    document.getElementById('modal-dev-fmv').value = '';
                    document.getElementById('modal-dev-tradein-name').value = '';
                    toggleDeviceSearchBtn();
                    const radios = document.getElementsByName('modal-trade');
                    radios.forEach(r => r.value === 'no' ? r.checked=true : null);
                    toggleModalFMV(false);
                    
                    document.getElementById('device-modal').classList.add('open');
                    return;
                }
                
                // In "new" mode, check line limits
                if (currentMode === 'new') {
                    const linesInput = document.getElementById(`${rowId}-lines`);
                    const maxDevices = parseInt(linesInput.value) || 0;
                    const currentCount = STATE[rowId].devices.length;
                    if (maxDevices > 0 && currentCount >= maxDevices) {
                        alert(`You cannot add more devices than the number of lines selected (${maxDevices}).`);
                        return;
                    }
                }
                
                // Add BYOD device directly (only in new mode)
                const newDevice = {
                    label: 'BYOD',
                    tradeinName: '',
                    cost: 0,
                    down: 0,
                    promo: 0,
                    fmv: 0
                };
                
                STATE[rowId].devices.push(newDevice);
                const newIndex = STATE[rowId].devices.length - 1;
                STATE[rowId].protectionStatus[newIndex] = true;
                
                // Apply BYOD default protection using flag
                STATE[rowId].protectionCosts[newIndex] = getDefaultProtectionCost(true);
                
                renderDeviceList(rowId);
                calculateRow(rowId);
                return;
            }
            
            // If index >= 0, we're editing an existing device
            document.getElementById('modal-row-id').value = rowId;
            document.getElementById('modal-edit-index').value = index;
            const titleEl = document.getElementById('modal-title');
            
            document.getElementById('modal-dev-label').value = '';
            document.getElementById('modal-dev-cost').value = '';
            document.getElementById('modal-dev-down').value = '';
            document.getElementById('modal-dev-promo').value = '';
            document.getElementById('modal-dev-fmv').value = '';
            document.getElementById('modal-dev-tradein-name').value = '';
            toggleDeviceSearchBtn(); // Reset search button visibility
            const radios = document.getElementsByName('modal-trade');
            radios.forEach(r => r.value === 'no' ? r.checked=true : null);
            toggleModalFMV(false);
            
            titleEl.textContent = "Edit Device";
            const dev = STATE[rowId].devices[index];
            const devLabelInput = document.getElementById('modal-dev-label');
            
            // For editing devices, use consistent placeholder
            const rowElement = document.getElementById(rowId);
            const isNewMode = rowElement && rowElement.getAttribute('data-mode') === 'new';
            
            if (isNewMode) {
                // For BYOD devices (no retail price), only clear label if it's still the default 'BYOD'
                // If user has entered a custom name, preserve it
                const isBYODDevice = dev.cost === 0;
                const isDefaultBYODLabel = dev.label === 'BYOD';
                devLabelInput.value = (isBYODDevice && isDefaultBYODLabel) ? '' : (dev.label || '');
                devLabelInput.placeholder = 'e.g. iPhone 17 Pro';
            } else {
                devLabelInput.value = dev.label || '';
                devLabelInput.placeholder = 'e.g. iPhone 17 Pro';
            }
            
            toggleDeviceSearchBtn(); // Update search button visibility
            
            // For BYOD devices in new mode (no retail price), use empty placeholders instead of 0 values
            const isBYOD = dev.cost === 0;
            const isExistingMode = !isNewMode;
            
            // Show empty instead of 0 for cost/promo when they are 0
            if (isBYOD || (isExistingMode && dev.cost === 0)) {
                document.getElementById('modal-dev-cost').value = '';
            } else {
                document.getElementById('modal-dev-cost').value = dev.cost;
            }
            
            document.getElementById('modal-dev-down').value = dev.down || '';
            
            // Show empty instead of 0 for promo
            if ((isBYOD && isNewMode) || (isExistingMode && dev.promo === 0)) {
                document.getElementById('modal-dev-promo').value = '';
            } else {
                document.getElementById('modal-dev-promo').value = dev.promo || '';
            }
            
            if(dev.fmv > 0) {
                 radios.forEach(r => r.value === 'yes' ? r.checked=true : null);
                 toggleModalFMV(true);
                 document.getElementById('modal-dev-fmv').value = dev.fmv;
                 document.getElementById('modal-dev-tradein-name').value = dev.tradeinName || '';
            }
            
            document.getElementById('device-modal').classList.add('open');
            // No auto-focus on mobile
        }

        function closeModal() { document.getElementById('device-modal').classList.remove('open'); }

        let _saveDeviceDebounce = 0;
        function saveDevice() {
            // Debounce - prevent double execution within 500ms
            const now = Date.now();
            if (now - _saveDeviceDebounce < 500) return;
            _saveDeviceDebounce = now;
            
            const rowId = document.getElementById('modal-row-id').value;
            const index = parseInt(document.getElementById('modal-edit-index').value);
            
            // Validate rowId
            if (!rowId || !STATE[rowId]) {
                console.warn('saveDevice: Invalid rowId or STATE not found', rowId);
                return;
            }
            
            // Capture all values from form immediately
            let label = document.getElementById('modal-dev-label').value.trim();
            const cost = Math.min(parseFloat(document.getElementById('modal-dev-cost').value) || 0, 9999.99);
            const down = Math.min(parseFloat(document.getElementById('modal-dev-down').value) || 0, 9999.99);
            const promo = Math.min(parseFloat(document.getElementById('modal-dev-promo').value) || 0, 9999.99);
            let fmv = 0;
            let tradeinName = '';
            const tradeRadio = document.querySelector('input[name="modal-trade"]:checked');
            const isTrade = tradeRadio && tradeRadio.value === 'yes';
            if (isTrade) {
                fmv = Math.min(parseFloat(document.getElementById('modal-dev-fmv').value) || 0, 9999.99);
                tradeinName = document.getElementById('modal-dev-tradein-name').value.trim();
            }
            
            // Check if this is existing mode
            const rowElement = document.getElementById(rowId);
            const isManualMode = rowElement && rowElement.getAttribute('data-mode') === 'existing';
            
            // If editing a BYOD device in new mode and label is empty, keep it as 'BYOD'
            if (index >= 0 && !isManualMode) {
                const oldDevice = STATE[rowId].devices[index];
                // A device is considered BYOD if it has no retail price
                const wasBYOD = oldDevice && oldDevice.cost === 0;
                if (wasBYOD && !label && cost === 0) {
                    label = 'BYOD';
                }
            }

            const deviceObj = { label, cost, down, promo, fmv, tradeinName };

            if (index >= 0) {
                // Editing existing device
                if (index >= STATE[rowId].devices.length) {
                    console.warn('saveDevice: Invalid device index', index);
                    return;
                }
                
                const oldDevice = STATE[rowId].devices[index];
                // A device is BYOD if cost is 0 (regardless of label)
                const wasBYOD = oldDevice ? oldDevice.cost === 0 : false;
                const isBYOD = cost === 0;
                
                STATE[rowId].devices[index] = deviceObj;
                
                // Only do BYOD conversion logic in "new" mode
                if (!isManualMode) {
                    // If converting from BYOD to regular device or vice versa, update protection
                    if (wasBYOD && !isBYOD) {
                        // Converting from BYOD to regular device (added retail price) - use Standard (P360) default
                        STATE[rowId].protectionCosts[index] = getDefaultProtectionCost(false);
                    } else if (!wasBYOD && isBYOD) {
                        // Converting from regular to BYOD (removed retail price) - use BYOD default
                        STATE[rowId].protectionCosts[index] = getDefaultProtectionCost(true);
                    }
                }
            } else {
                // Adding new device
                STATE[rowId].devices.push(deviceObj);
                const newIndex = STATE[rowId].devices.length - 1;
                STATE[rowId].protectionStatus[newIndex] = true;
                
                // In existing mode, always use Standard (P360) protection
                if (isManualMode) {
                    STATE[rowId].protectionCosts[newIndex] = getDefaultProtectionCost(false);
                } else {
                    // In new mode, determine protection based on whether it has a retail price
                    // BYOD = no retail price (cost === 0)
                    const isBYOD = cost === 0;
                    STATE[rowId].protectionCosts[newIndex] = getDefaultProtectionCost(isBYOD);
                }
            }
            
            // Render and calculate BEFORE closing modal to ensure state is captured
            renderDeviceList(rowId);
            calculateRow(rowId);
            
            // Close modal after state is saved
            closeModal();
        }

        function deleteDevice(rowId, index) {
            STATE[rowId].devices.splice(index, 1);
            const newProtStatus = {};
            const newProtCosts = {};
            const oldStatus = STATE[rowId].protectionStatus;
            const oldCosts = STATE[rowId].protectionCosts;
            
            Object.keys(oldStatus).forEach(k => {
                const i = parseInt(k);
                if (i < index) {
                    newProtStatus[i] = oldStatus[i];
                    newProtCosts[i] = oldCosts[i];
                }
                else if (i > index) {
                    newProtStatus[i-1] = oldStatus[i];
                    newProtCosts[i-1] = oldCosts[i];
                }
            });
            STATE[rowId].protectionStatus = newProtStatus;
            STATE[rowId].protectionCosts = newProtCosts;

            renderDeviceList(rowId);
            calculateRow(rowId);
        }

        function togglePromoDisplay(el, rawPromo, netPromo) {
            let state = el.getAttribute('data-view') || 'promo';
            const retailPrice = el.getAttribute('data-retail');
            const hasRetail = retailPrice && showRetailPrices.devices;
            
            // Store original HTML on first click if not stored
            if (!el.hasAttribute('data-original-html')) {
                el.setAttribute('data-original-html', el.innerHTML);
            }
            
            if (state === 'promo') {
                // Include retail price in "After FMV" view if enabled
                const retailText = hasRetail ? ` | Retail: $${retailPrice}` : '';
                el.innerHTML = `After FMV: $${netPromo}${retailText}`;
                el.setAttribute('data-view', 'net');
            } else {
                // Restore original HTML
                const storedHTML = el.getAttribute('data-original-html');
                if (storedHTML) {
                    el.innerHTML = storedHTML;
                }
                el.setAttribute('data-view', 'promo');
            }
        }

        function renderDeviceList(rowId) {
            const listContainer = document.getElementById(`${rowId}-device-list`);
            const byod = document.getElementById(`${rowId}-byod-placeholder`);
            const deviceCol = document.getElementById(`${rowId}-col3`);
            
            listContainer.innerHTML = '';
            
            const hasDevicesOrAccessories = STATE[rowId].devices.length > 0 || STATE[rowId].accessories.length > 0;
            
            if (hasDevicesOrAccessories) {
                if(byod) {
                    byod.style.display = 'none'; 
                    byod.classList.remove('visible'); 
                }
                deviceCol.classList.remove('print-hidden');
            } else {
                // Show placeholder in both new and existing modes
                if(byod) {
                    byod.style.display = 'block'; 
                    byod.classList.add('visible'); 
                }
                deviceCol.classList.remove('print-hidden');
            }

            STATE[rowId].devices.forEach((dev, index) => {
                const monthly = calculateDeviceMonthly(dev.cost, dev.down || 0, dev.promo, dev.fmv).toFixed(2);
                const rawLabel = dev.label ? dev.label : `Device #${index + 1}`;
                const displayName = rawLabel.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                const rawPromo = dev.promo.toFixed(2);
                const retailPrice = dev.cost.toFixed(2);
                const netPromo = (dev.promo - (dev.fmv || 0)).toFixed(2);
                const hasFMV = dev.fmv && dev.fmv > 0;
                const card = document.createElement('div');
                card.className = 'device-summary-card';
                
                // Conditionally show monthly price based on showItemizedPrices setting
                const priceDisplay = showItemizedPrices.devices ? `<span class="device-cost-preview">$${monthly}/mo</span>` : '';
                const downDisplay = (dev.down && dev.down > 0) ? `<span class="device-detail-preview device-detail-plain">Down: $${dev.down.toFixed(2)}</span>` : '';
                
                // Conditionally show retail price and promo with FMV toggle
                let detailDisplay = '';
                // Build trade-in text with optional device name
                let tradeInText = '';
                if (hasFMV) {
                    const tradeinDeviceName = dev.tradeinName ? dev.tradeinName.replace(/</g, '&lt;').replace(/>/g, '&gt;') : '';
                    tradeInText = tradeinDeviceName 
                        ? ` <span class="device-trade-in">(Trade-In: ${tradeinDeviceName})</span>` 
                        : ' <span class="device-trade-in">(Trade-In)</span>';
                }
                if (hasFMV) {
                    // Clickable promo that toggles to show after-FMV value
                    if (showRetailPrices.devices) {
                        detailDisplay = `<span class="device-detail-preview device-detail-clickable" data-view="promo" data-retail="${retailPrice}" onclick="togglePromoDisplay(this, '${rawPromo}', '${netPromo}')">Promo: $${rawPromo} Off${tradeInText} | Retail: $${retailPrice}</span>`;
                    } else {
                        detailDisplay = `<span class="device-detail-preview device-detail-clickable" data-view="promo" onclick="togglePromoDisplay(this, '${rawPromo}', '${netPromo}')">Promo: $${rawPromo} Off${tradeInText}</span>`;
                    }
                } else {
                    // Non-clickable (no FMV)
                    if (showRetailPrices.devices) {
                        detailDisplay = `<span class="device-detail-preview device-detail-plain">Promo: $${rawPromo} Off | Retail: $${retailPrice}</span>`;
                    } else {
                        detailDisplay = `<span class="device-detail-preview device-detail-plain">Promo: $${rawPromo} Off</span>`;
                    }
                }
                
                card.innerHTML = `
                    <div class="device-info">
                        <span class="device-label-text">${displayName}</span>
                        ${priceDisplay}
                        ${downDisplay}
                        ${detailDisplay}
                    </div>
                    <div class="device-actions">
                        <button class="btn btn-small btn-small-edit" onclick="duplicateDevice('${rowId}', ${index})">Copy</button>
                        <button class="btn btn-small btn-small-edit" onclick="openModal('${rowId}', ${index})">Edit</button>
                        <button class="btn btn-small btn-small-edit" onclick="deleteDevice('${rowId}', ${index})"></button>
                    </div>
                `;
                listContainer.appendChild(card);
            });
            
            // Render combined accessories listing
            const accessories = STATE[rowId].accessories;
            if (accessories.length > 0) {
                // Add row separator before accessories
                const separator = document.createElement('div');
                separator.className = 'accessory-row-break';
                listContainer.appendChild(separator);
                
                // Separate financed and due-today accessories
                const financedAccs = accessories.filter(a => a.paymentMethod === 'finance');
                const todayAccs = accessories.filter(a => a.paymentMethod === 'today');
                
                // Calculate totals
                let financedMonthly = 0;
                let todayTotal = 0;
                const financedNames = [];
                const todayNames = [];
                
                financedAccs.forEach(acc => {
                    const qtyPrefix = acc.quantity > 1 ? `${acc.quantity}x ` : '';
                    financedNames.push(qtyPrefix + acc.name);
                    financedMonthly += (acc.price * acc.quantity) / 12;
                });
                
                todayAccs.forEach(acc => {
                    const qtyPrefix = acc.quantity > 1 ? `${acc.quantity}x ` : '';
                    todayNames.push(qtyPrefix + acc.name);
                    todayTotal += acc.price * acc.quantity;
                });
                
                // Create combined card for financed accessories (screen only)
                if (financedAccs.length > 0) {
                    const card = document.createElement('div');
                    card.className = 'device-summary-card accessory-card accessory-combined';
                    const namesDisplay = financedNames.join(', ').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    
                    // Retail price for combined financed accessories
                    let retailHtml = '';
                    if (showRetailPrices.accessories) {
                        const totalRetail = financedAccs.reduce((sum, acc) => sum + (acc.price * acc.quantity), 0);
                        retailHtml = `<span class="device-detail-preview accessory-retail-screen">(Retail: $${totalRetail.toFixed(2)})</span>`;
                    }
                    
                    const priceHtml = showItemizedPrices.accessories ? `<span class="device-cost-preview">$${financedMonthly.toFixed(2)}/mo</span>` : '';
                    
                    card.innerHTML = `
                        <div class="device-info">
                            <span class="device-label-text">${namesDisplay}</span>
                            <div class="accessory-price-wrapper">
                                ${priceHtml}
                                ${retailHtml}
                            </div>
                        </div>
                    `;
                    listContainer.appendChild(card);
                }
                
                // Create combined card for due-today accessories (screen only)
                if (todayAccs.length > 0) {
                    const card = document.createElement('div');
                    card.className = 'device-summary-card accessory-card accessory-combined';
                    const namesDisplay = todayNames.join(', ').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    
                    // Retail price for combined today accessories
                    let retailHtml = '';
                    if (showRetailPrices.accessories) {
                        const totalRetail = todayAccs.reduce((sum, acc) => sum + (acc.price * acc.quantity), 0);
                        retailHtml = `<span class="device-detail-preview accessory-retail-screen">(Retail: $${totalRetail.toFixed(2)})</span>`;
                    }
                    
                    const priceHtml = showItemizedPrices.accessories ? `<span class="device-cost-preview" style="color: var(--primary-color);">$${todayTotal.toFixed(2)} today</span>` : '';
                    
                    card.innerHTML = `
                        <div class="device-info">
                            <span class="device-label-text">${namesDisplay}</span>
                            <div class="accessory-price-wrapper">
                                ${priceHtml}
                                ${retailHtml}
                            </div>
                        </div>
                    `;
                    listContainer.appendChild(card);
                }
                
                // Create individual cards for each accessory (print only)
                accessories.forEach((acc, index) => {
                    const card = document.createElement('div');
                    card.className = 'device-summary-card accessory-card accessory-individual';
                    card.style.display = 'none'; // Hidden on screen, CSS will show on print
                    const qtyPrefix = acc.quantity > 1 ? `${acc.quantity}x ` : '';
                    const nameDisplay = (qtyPrefix + acc.name).replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    
                    let priceHtml = '';
                    if (showItemizedPrices.accessories) {
                        let priceDisplay = '';
                        if (acc.paymentMethod === 'finance') {
                            const monthly = (acc.price * acc.quantity) / 12;
                            priceDisplay = `$${monthly.toFixed(2)}/mo`;
                        } else {
                            const total = acc.price * acc.quantity;
                            priceDisplay = `$${total.toFixed(2)} today`;
                        }
                        priceHtml = `<span class="device-cost-preview">${priceDisplay}</span>`;
                    }
                    
                    // Retail price display for accessories
                    let retailHtml = '';
                    if (showRetailPrices.accessories) {
                        const retailTotal = acc.price * acc.quantity;
                        retailHtml = `<div class="device-detail-preview accessory-retail-print">Retail: $${retailTotal.toFixed(2)}</div>`;
                    }
                    
                    card.innerHTML = `
                        <div class="device-info">
                            <span class="device-label-text">${nameDisplay}</span>
                            <div class="accessory-price-wrapper">
                                ${priceHtml}
                                ${retailHtml}
                            </div>
                        </div>
                    `;
                    listContainer.appendChild(card);
                });
            }
        }
        
        function duplicateDevice(rowId, index) {
            const row = document.getElementById(rowId);
            const isManualMode = (row.getAttribute('data-mode') === 'existing');
            
            // Check line limit for new mode
            if (!isManualMode) {
                const linesInput = document.getElementById(`${rowId}-lines`);
                const maxDevices = parseInt(linesInput.value) || 0;
                const currentCount = STATE[rowId].devices.length;
                if (maxDevices > 0 && currentCount >= maxDevices) {
                    alert(`You cannot add more devices than the number of lines selected (${maxDevices}).`);
                    return;
                }
            }
            
            const sourceDev = STATE[rowId].devices[index];
            const newDev = {
                label: sourceDev.label || '',
                cost: sourceDev.cost,
                down: sourceDev.down || 0,
                promo: sourceDev.promo,
                fmv: sourceDev.fmv,
                tradeinName: sourceDev.tradeinName || ''
            };
            
            STATE[rowId].devices.push(newDev);
            const newIndex = STATE[rowId].devices.length - 1;
            STATE[rowId].protectionStatus[newIndex] = STATE[rowId].protectionStatus[index] !== false;
            STATE[rowId].protectionCosts[newIndex] = STATE[rowId].protectionCosts[index] || 'p360-t5';
            
            renderDeviceList(rowId);
            calculateRow(rowId);
        }
        
        // Render device list for print with identical devices combined
        function renderDeviceListForPrint(rowId) {
            const listContainer = document.getElementById(`${rowId}-device-list`);
            if (!listContainer || !combineIdenticalDevices) return;
            
            const devices = STATE[rowId].devices;
            const byod = document.getElementById(`${rowId}-byod-placeholder`);
            
            if (devices.length === 0) {
                // Show placeholder in print mode when no devices
                if (byod) {
                    byod.style.display = 'block';
                    byod.classList.add('visible');
                }
                return;
            }
            
            // Hide placeholder when there are devices
            if (byod) {
                byod.style.display = 'none';
                byod.classList.remove('visible');
            }
            
            // Group identical devices by all key properties
            const deviceGroups = {};
            devices.forEach((dev, idx) => {
                const monthly = calculateDeviceMonthly(dev.cost, dev.down || 0, dev.promo, dev.fmv).toFixed(2);
                // Create key from all device properties that make them identical
                // Normalize floating point numbers to avoid precision issues
                // Explicitly handle all properties to ensure consistency
                const key = JSON.stringify({
                    label: (dev.label || '').trim(),
                    cost: parseFloat((dev.cost || 0).toFixed(2)),
                    promo: parseFloat((dev.promo || 0).toFixed(2)),
                    fmv: parseFloat((dev.fmv || 0).toFixed(2)),
                    down: parseFloat((dev.down || 0).toFixed(2)),
                    tradeinName: (dev.tradeinName || '').trim()
                });
                
                if (deviceGroups[key]) {
                    deviceGroups[key].count++;
                    deviceGroups[key].totalMonthly += parseFloat(monthly);
                } else {
                    deviceGroups[key] = {
                        device: dev,
                        monthly: monthly,
                        count: 1,
                        totalMonthly: parseFloat(monthly)
                    };
                }
            });
            
            // Rebuild list with combined devices
            listContainer.innerHTML = '';
            Object.values(deviceGroups).forEach(group => {
                const dev = group.device;
                const displayName = group.count > 1 
                    ? `${dev.label || 'Device'} x${group.count}`
                    : (dev.label || 'Device');
                const displayMonthly = group.count > 1 
                    ? group.totalMonthly.toFixed(2)
                    : group.monthly;
                    
                const card = document.createElement('div');
                card.className = 'device-summary-card';
                
                let tradeInText = '';
                if (dev.fmv > 0) {
                    tradeInText = dev.tradeinName 
                        ? ` <span class="device-trade-in">(Trade-In: ${dev.tradeinName})</span>` 
                        : ' <span class="device-trade-in">(Trade-In)</span>';
                }
                
                // Retail price display for devices
                let retailHtml = '';
                if (showRetailPrices.devices && dev.cost > 0) {
                    if (group.count > 1) {
                        // For combined devices, show per-phone price
                        retailHtml = `<span class="device-detail-preview" style="display: block;">Retail: $${dev.cost.toFixed(2)}/Phone</span>`;
                    } else {
                        retailHtml = `<span class="device-detail-preview" style="display: block;">Retail: $${dev.cost.toFixed(2)}</span>`;
                    }
                }
                
                // Down payment display
                let downHtml = '';
                if (dev.down && dev.down > 0) {
                    if (group.count > 1) {
                        // For combined devices, show per-phone down payment
                        downHtml = `<span class="device-detail-preview device-detail-plain">Down: $${dev.down.toFixed(2)}/Phone</span>`;
                    } else {
                        downHtml = `<span class="device-detail-preview device-detail-plain">Down: $${dev.down.toFixed(2)}</span>`;
                    }
                }
                
                // Promo display - add /Phone for combined devices
                const promoText = group.count > 1 
                    ? `Promo: $${dev.promo.toFixed(2)} Off/Phone${tradeInText}`
                    : `Promo: $${dev.promo.toFixed(2)} Off${tradeInText}`;
                
                card.innerHTML = `
                    <div class="device-info">
                        <span class="device-label-text">${displayName}</span>
                        <span class="device-cost-preview">$${displayMonthly}/mo</span>
                        ${retailHtml}
                        ${downHtml}
                        <span class="device-detail-preview">${promoText}</span>
                    </div>
                `;
                listContainer.appendChild(card);
            });
            
            // Also render accessories after devices (full width)
            const accessories = STATE[rowId].accessories;
            if (accessories.length > 0) {
                // Add row separator before accessories (forces new line)
                const separator = document.createElement('div');
                separator.className = 'accessory-row-break';
                listContainer.appendChild(separator);
                
                // Group identical accessories by all key properties (like we do for devices)
                const accGroups = {};
                accessories.forEach(acc => {
                    const key = JSON.stringify({
                        name: acc.name,
                        price: acc.price,
                        paymentMethod: acc.paymentMethod
                    });
                    
                    if (accGroups[key]) {
                        accGroups[key].totalQty += (acc.quantity || 1);
                    } else {
                        accGroups[key] = {
                            accessory: acc,
                            totalQty: acc.quantity || 1
                        };
                    }
                });
                
                // Render each grouped accessory individually for print (hidden on screen)
                Object.values(accGroups).forEach(group => {
                    const acc = group.accessory;
                    const totalQty = group.totalQty;
                    const card = document.createElement('div');
                    card.className = 'device-summary-card accessory-card accessory-individual';
                    const qtyPrefix = totalQty > 1 ? `${totalQty}x ` : '';
                    const nameDisplay = (qtyPrefix + acc.name).replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    
                    let priceDisplay = '';
                    if (showItemizedPrices.accessories) {
                        if (acc.paymentMethod === 'finance') {
                            const monthly = (acc.price * totalQty) / 12;
                            priceDisplay = `$${monthly.toFixed(2)}/mo`;
                        } else {
                            const total = acc.price * totalQty;
                            priceDisplay = `$${total.toFixed(2)} today`;
                        }
                    }
                    
                    // Retail price display for accessories - shown beneath the monthly price
                    let retailHtml = '';
                    if (showRetailPrices.accessories) {
                        const retailTotal = acc.price * totalQty;
                        retailHtml = `<div class="device-detail-preview accessory-retail-print">Retail: $${retailTotal.toFixed(2)}</div>`;
                    }
                    
                    card.innerHTML = `
                        <div class="device-info">
                            <span class="device-label-text">${nameDisplay}</span>
                            <div class="accessory-price-wrapper">
                                ${priceDisplay ? `<span class="device-cost-preview">${priceDisplay}</span>` : ''}
                                ${retailHtml}
                            </div>
                        </div>
                    `;
                    listContainer.appendChild(card);
                });
            }
        }
        
        // Update display style (list vs stacked/carousel)
        function updateDisplayStyle(style) {
            quoteDisplayStyle = style;
            const container = document.getElementById('rows-container');
            
            if (style === 'stacked') {
                container.classList.add('carousel-mode');
                initCarousel();
            } else {
                container.classList.remove('carousel-mode');
                destroyCarousel();
            }
            saveSettingsToURL();
        }
        
        let currentCarouselIndex = 0;
        let carouselInitialized = false;
        
        function initCarousel() {
            const rows = document.querySelectorAll('.calculator-row');
            if (rows.length === 0) return;
            
            currentCarouselIndex = 0;
            
            // Use requestAnimationFrame to ensure DOM is ready
            requestAnimationFrame(() => {
                updateCarouselView();
            });
            
            // Only add event listeners once
            if (!carouselInitialized) {
                const container = document.getElementById('rows-container');
                let startX = 0;
                let startY = 0;
                
                container.addEventListener('touchstart', (e) => {
                    startX = e.touches[0].clientX;
                    startY = e.touches[0].clientY;
                }, { passive: true });
                
                container.addEventListener('touchend', (e) => {
                    if (!container.classList.contains('carousel-mode')) return;
                    const endX = e.changedTouches[0].clientX;
                    const endY = e.changedTouches[0].clientY;
                    const diffX = startX - endX;
                    const diffY = startY - endY;
                    
                    // Only trigger if horizontal swipe is greater than vertical
                    if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
                        if (diffX > 0) {
                            navigateCarousel(1); // Swipe left = next
                        } else {
                            navigateCarousel(-1); // Swipe right = prev
                        }
                    }
                }, { passive: true });
                
                carouselInitialized = true;
            }
        }
        
        function destroyCarousel() {
            const rows = document.querySelectorAll('.calculator-row');
            rows.forEach(row => {
                row.classList.remove('carousel-hidden', 'carousel-active', 'carousel-left', 'carousel-right');
                row.style.cssText = '';
            });
            
            // Remove fixed arrows
            document.querySelectorAll('.carousel-nav-arrow').forEach(el => el.remove());
            
            // Remove carousel nav
            const nav = document.getElementById('carousel-nav');
            if (nav) nav.remove();
            
            // Reset container
            const container = document.getElementById('rows-container');
            if (container) {
                container.dataset.animating = 'false';
            }
        }
        
        function updateCarouselContainerHeight() {
            const container = document.getElementById('rows-container');
            if (!container || !container.classList.contains('carousel-mode')) return;
            
            const activeRow = container.querySelector('.carousel-active');
            if (activeRow) {
                // Use requestAnimationFrame to get accurate height after DOM updates
                requestAnimationFrame(() => {
                    const newHeight = activeRow.offsetHeight;
                    container.style.minHeight = newHeight + 'px';
                });
            }
        }
        
        function updateCarouselView(direction = 0) {
            const rows = document.querySelectorAll('.calculator-row');
            const container = document.getElementById('rows-container');
            
            rows.forEach((row, idx) => {
                row.classList.remove('carousel-active', 'carousel-hidden',
                                     'carousel-left', 'carousel-right');
                row.style.cssText = '';
                
                if (idx === currentCarouselIndex) {
                    row.classList.add('carousel-active');
                }
            });
            
            // Update container height to match active row
            const activeRow = container.querySelector('.carousel-active');
            if (activeRow) {
                setTimeout(() => {
                    container.style.minHeight = activeRow.offsetHeight + 'px';
                }, 50);
            }
            
            // Reset animation state
            container.dataset.animating = 'false';
            
            // Update navigation indicators
            updateCarouselNav();
        }
        
        function navigateCarousel(direction) {
            const rows = document.querySelectorAll('.calculator-row');
            const oldIndex = currentCarouselIndex;
            const newIndex = currentCarouselIndex + direction;
            
            if (newIndex < 0 || newIndex >= rows.length) return;
            
            const container = document.getElementById('rows-container');
            
            // Prevent rapid clicks during animation
            if (container.dataset.animating === 'true') return;
            container.dataset.animating = 'true';
            
            const oldRow = rows[oldIndex];
            const newRow = rows[newIndex];
            
            // Set container height
            const maxHeight = Math.max(oldRow.offsetHeight, newRow.offsetHeight);
            container.style.minHeight = maxHeight + 'px';
            
            // Remove active class from old row
            oldRow.classList.remove('carousel-active');
            
            // Set up both rows as visible and absolute
            const setupStyles = {
                position: 'absolute',
                top: '0',
                left: '0',
                width: '100%',
                visibility: 'visible',
                opacity: '1',
                pointerEvents: 'none',
                background: 'var(--card-bg)'
            };
            
            Object.assign(oldRow.style, setupStyles);
            oldRow.style.zIndex = '5';
            
            Object.assign(newRow.style, setupStyles);
            newRow.style.zIndex = '10';
            
            // Animation settings
            const duration = 400;
            const easing = 'ease-in-out';
            
            // Animate old row out
            const oldEndX = direction > 0 ? '-100%' : '100%';
            oldRow.animate([
                { transform: 'translateX(0)' },
                { transform: 'translateX(' + oldEndX + ')' }
            ], { duration: duration, easing: easing, fill: 'forwards' });
            
            // Animate new row in
            const newStartX = direction > 0 ? '100%' : '-100%';
            const newAnimation = newRow.animate([
                { transform: 'translateX(' + newStartX + ')' },
                { transform: 'translateX(0)' }
            ], { duration: duration, easing: easing, fill: 'forwards' });
            
            currentCarouselIndex = newIndex;
            
            // Clean up after animation
            newAnimation.onfinish = function() {
                oldRow.style.cssText = '';
                newRow.style.cssText = '';
                oldRow.getAnimations().forEach(a => a.cancel());
                newRow.getAnimations().forEach(a => a.cancel());
                newRow.classList.add('carousel-active');
                container.dataset.animating = 'false';
            };
            
            // Fallback timeout
            setTimeout(function() {
                if (container.dataset.animating === 'true') {
                    oldRow.style.cssText = '';
                    newRow.style.cssText = '';
                    newRow.classList.add('carousel-active');
                    container.dataset.animating = 'false';
                }
            }, 500);
            
            updateCarouselNav();
        }
        
        function goToCarouselIndex(idx) {
            const rows = document.querySelectorAll('.calculator-row');
            if (idx < 0 || idx >= rows.length || idx === currentCarouselIndex) return;
            
            const direction = idx > currentCarouselIndex ? 1 : -1;
            navigateCarousel(direction);
        }
        
        function updateCarouselNav() {
            // Remove old arrows if they exist
            document.querySelectorAll('.carousel-nav-arrow').forEach(el => el.remove());
            
            const rows = document.querySelectorAll('.calculator-row');
            
            // Create or update navigation dots (always show in stacked mode)
            let nav = document.getElementById('carousel-nav');
            if (quoteDisplayStyle === 'stacked') {
                if (!nav) {
                    nav = document.createElement('div');
                    nav.id = 'carousel-nav';
                    nav.className = 'carousel-nav';
                    document.getElementById('rows-container').after(nav);
                }
                
                nav.innerHTML = '';
                
                // Only show dots if more than 1 row
                if (rows.length > 1) {
                    const dotsContainer = document.createElement('div');
                    dotsContainer.className = 'carousel-dots';
                    rows.forEach((_, idx) => {
                        const dot = document.createElement('button');
                        dot.className = `carousel-dot ${idx === currentCarouselIndex ? 'active' : ''}`;
                        dot.onclick = () => goToCarouselIndex(idx);
                        dotsContainer.appendChild(dot);
                    });
                    nav.appendChild(dotsContainer);
                }
            } else if (nav) {
                nav.remove();
            }
            
            // Create fixed position arrows in body (only if more than 1 row)
            if (quoteDisplayStyle === 'stacked' && rows.length > 1) {
                // SVG arrow icons
                const leftSvg = '<svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"></polyline></svg>';
                const rightSvg = '<svg viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"></polyline></svg>';
                
                // Left arrow
                const leftArrow = document.createElement('button');
                leftArrow.className = 'carousel-nav-arrow left';
                leftArrow.innerHTML = leftSvg;
                leftArrow.disabled = currentCarouselIndex === 0;
                leftArrow.onclick = () => navigateCarousel(-1);
                document.body.appendChild(leftArrow);
                
                // Right arrow
                const rightArrow = document.createElement('button');
                rightArrow.className = 'carousel-nav-arrow right';
                rightArrow.innerHTML = rightSvg;
                rightArrow.disabled = currentCarouselIndex === rows.length - 1;
                rightArrow.onclick = () => navigateCarousel(1);
                document.body.appendChild(rightArrow);
            }
        }

        function openProtectionModal(rowId) {
            if (!rowId || !STATE[rowId]) return;
            
            document.getElementById('prot-row-id').value = rowId;
            renderProtectionList(rowId);
            document.getElementById('protection-modal').classList.add('open');
            const isShowUnprotected = STATE[rowId].showUnprotected;
            document.getElementById('prot-show-unprotected').checked = isShowUnprotected;
            
            // Initialize Show Standard Protection toggle
            const isShowStandard = STATE[rowId].showStandardProtection;
            const stdCheckbox = document.getElementById('prot-show-standard');
            if (stdCheckbox) stdCheckbox.checked = isShowStandard;
            
            // Initialize Show Label toggle (default true if not set)
            const isShowLabel = STATE[rowId].showProtectionLabel !== false;
            document.getElementById('prot-show-label').checked = isShowLabel;
            
            // Populate carrier fields
            const carrierNameEl = document.getElementById('prot-carrier-name');
            const carrierPriceEl = document.getElementById('prot-carrier-price');
            if (carrierNameEl) carrierNameEl.value = STATE[rowId].carrierName || '';
            if (carrierPriceEl) carrierPriceEl.value = STATE[rowId].carrierPrice || '';
            
            // Check if existing mode
            const row = document.getElementById(rowId);
            const isManualMode = row && row.getAttribute('data-mode') === 'existing';
            
            // Hide Competitor tab and Misc tab in new mode
            const competitorTab = document.getElementById('competitor-tab');
            const miscTab = document.getElementById('misc-tab');
            const miscTaxesRow = document.getElementById('misc-taxes-row');
            const miscAutopayRow = document.getElementById('misc-autopay-row');
            const miscBusinessRow = document.getElementById('misc-business-row');
            const miscBeyondRow = document.getElementById('misc-beyond-row');
            
            if (competitorTab) {
                competitorTab.style.display = isManualMode ? 'none' : 'block';
            }
            
            // Hide Misc tab in new mode (only show in existing mode)
            if (miscTab) {
                miscTab.style.display = isManualMode ? 'block' : 'none';
            }
            
            // Show/hide Misc tab rows based on mode
            if (miscTaxesRow) miscTaxesRow.style.display = isManualMode ? 'flex' : 'none';
            if (miscAutopayRow) miscAutopayRow.style.display = isManualMode ? 'flex' : 'none';
            if (miscBusinessRow) miscBusinessRow.style.display = isManualMode ? 'flex' : 'none';
            if (miscBeyondRow) miscBeyondRow.style.display = isManualMode ? 'flex' : 'none';
            
            // Grey out "Display Non-Protected Pricing" toggle if all devices have protection disabled
            updateNonProtectedToggleState(rowId);
            
            // Sync Misc tab switches with hidden checkboxes (existing mode only)
            if (isManualMode) {
                const taxesCheckbox = document.getElementById(`${rowId}-taxes-included`);
                const autopayCheckbox = document.getElementById(`${rowId}-has-autopay`);
                const businessCheckbox = document.getElementById(`${rowId}-is-business`);
                const beyondCheckbox = document.getElementById(`${rowId}-beyond-savings`);
                
                document.getElementById('prot-taxes-included').checked = taxesCheckbox ? taxesCheckbox.checked : false;
                document.getElementById('prot-has-autopay').checked = autopayCheckbox ? autopayCheckbox.checked : false;
                document.getElementById('prot-is-business').checked = businessCheckbox ? businessCheckbox.checked : false;
                document.getElementById('prot-beyond-savings').checked = beyondCheckbox ? beyondCheckbox.checked : false;
            }
            
            // Switch to Protection tab
            switchSettingsTab('Protection');
        }
        
        // Misc tab change handlers
        function handleMiscTaxesChange() {
            const rowId = document.getElementById('prot-row-id').value;
            const checkbox = document.getElementById(`${rowId}-taxes-included`);
            if (checkbox) {
                checkbox.checked = document.getElementById('prot-taxes-included').checked;
                calculateRow(rowId);
            }
        }
        
        function handleMiscAutopayChange() {
            const rowId = document.getElementById('prot-row-id').value;
            const checkbox = document.getElementById(`${rowId}-has-autopay`);
            if (checkbox) {
                checkbox.checked = document.getElementById('prot-has-autopay').checked;
                handleAutopayCheckboxChange(rowId);
            }
        }
        
        function handleMiscBusinessChange() {
            const rowId = document.getElementById('prot-row-id').value;
            const checkbox = document.getElementById(`${rowId}-is-business`);
            if (checkbox) {
                checkbox.checked = document.getElementById('prot-is-business').checked;
                handleBusinessCheckboxChange(rowId);
            }
        }
        
        function handleMiscBeyondChange() {
            const rowId = document.getElementById('prot-row-id').value;
            const checkbox = document.getElementById(`${rowId}-beyond-savings`);
            if (checkbox) {
                checkbox.checked = document.getElementById('prot-beyond-savings').checked;
                handleBeyondSavingsCheckboxChange(rowId);
            }
        }
        
        function switchSettingsTab(tabName) {
            const tabs = document.querySelectorAll('[data-settings-tab]');
            tabs.forEach(tab => {
                if (tab.dataset.settingsTab === tabName) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            document.getElementById('prot-modal-tab').value = tabName;
            document.getElementById('prot-protection-content').style.display = tabName === 'Protection' ? 'block' : 'none';
            document.getElementById('prot-competitor-content').style.display = tabName === 'Competitor' ? 'block' : 'none';
            
            // Handle Misc tab
            const miscContent = document.getElementById('prot-misc-content');
            if (miscContent) {
                miscContent.style.display = tabName === 'Misc' ? 'block' : 'none';
            }
        }
        

        function closeProtectionModal() {
            try {
                const rowId = document.getElementById('prot-row-id').value;
                if (rowId && STATE[rowId]) {
                    // Save carrier info
                    const carrierNameEl = document.getElementById('prot-carrier-name');
                    const carrierPriceEl = document.getElementById('prot-carrier-price');
                    const carrierName = carrierNameEl ? carrierNameEl.value.trim() : '';
                    const carrierPrice = carrierPriceEl ? (parseFloat(carrierPriceEl.value) || 0) : 0;
                    
                    STATE[rowId].carrierName = carrierName;
                    STATE[rowId].carrierPrice = carrierPrice;
                    
                    // Update carrier display
                    updateCarrierDisplay(rowId);
                    calculateRow(rowId);
                }
            } catch (e) {
                console.error('Error in closeProtectionModal:', e);
            }
            
            // Always close the modal
            document.getElementById('protection-modal').classList.remove('open');
        }
        
        function updateCarrierDisplay(rowId) {
            const carrierComparison = document.getElementById(`${rowId}-carrier-comparison`);
            const vsIndicator = document.getElementById(`${rowId}-vs-indicator`);
            
            // If carrier comparison elements don't exist (existing mode), skip
            if (!carrierComparison || !vsIndicator) {
                return;
            }
            
            // Get line count for per-line pricing
            const lineCount = parseInt(document.getElementById(`${rowId}-lines`)?.value) || 0;
            const getCarrierPerLineText = (total) => {
                if (!showPerLinePricing || lineCount === 0) return '';
                const perLine = total / lineCount;
                return `<span class="per-line-text"> ($${perLine.toFixed(2)}/line)</span>`;
            };
            
            if (STATE[rowId].carrierName && STATE[rowId].carrierPrice > 0) {
                const priceText = `$${STATE[rowId].carrierPrice.toFixed(0)}${getCarrierPerLineText(STATE[rowId].carrierPrice)}`;
                document.getElementById(`${rowId}-carrier-name-display`).textContent = STATE[rowId].carrierName;
                document.getElementById(`${rowId}-carrier-price`).innerHTML = priceText;
                carrierComparison.style.display = 'flex';
                carrierComparison.classList.remove('hidden');
                vsIndicator.style.display = 'block';
                vsIndicator.classList.remove('hidden');
            } else {
                carrierComparison.style.display = 'none';
                carrierComparison.classList.add('hidden');
                vsIndicator.style.display = 'none';
                vsIndicator.classList.add('hidden');
            }
        }
        
        function toggleShowUnprotected(checkbox) {
            const rowId = document.getElementById('prot-row-id').value;
            STATE[rowId].showUnprotected = checkbox.checked;
            // Mutually exclusive with showStandardProtection - only one secondary display at a time
            if (checkbox.checked) {
                STATE[rowId].showStandardProtection = false;
                const stdCheckbox = document.getElementById('prot-show-standard');
                if (stdCheckbox) stdCheckbox.checked = false;
            }
            if (!checkbox.checked) {
                // Reset timeline protection slider to first protection option
                const timelineToggle = document.getElementById(`${rowId}-timeline-toggle`);
                if (timelineToggle) {
                    // Set to protected/p360 depending on what options are available
                    const sliderContainer = document.getElementById(`${rowId}-timeline-prot-slider`);
                    if (sliderContainer) {
                        const firstOption = sliderContainer.querySelector('.timeline-prot-slider-option');
                        if (firstOption && firstOption.dataset.value !== 'none') {
                            timelineToggle.value = firstOption.dataset.value;
                        }
                    }
                }
            }
            calculateRow(rowId);
        }
        
        function toggleShowStandardProtection(checkbox) {
            const rowId = document.getElementById('prot-row-id').value;
            STATE[rowId].showStandardProtection = checkbox.checked;
            // Mutually exclusive with showUnprotected - only one secondary display at a time
            if (checkbox.checked) {
                STATE[rowId].showUnprotected = false;
                const unprotCheckbox = document.getElementById('prot-show-unprotected');
                if (unprotCheckbox) unprotCheckbox.checked = false;
            }
            calculateRow(rowId);
        }
        
        function toggleShowLabel(checkbox) {
            const rowId = document.getElementById('prot-row-id').value;
            STATE[rowId].showProtectionLabel = checkbox.checked;
            calculateRow(rowId);
        }

        function renderProtectionList(rowId) {
            const container = document.getElementById('prot-device-list');
            container.innerHTML = '';
            const devices = STATE[rowId].devices;
            if (devices.length === 0) {
                container.innerHTML = '<div style="color:#666; text-align:center;">No devices added</div>';
                return;
            }
            
            // Use global PROTECTION_OPTIONS constant
            const protectionOptions = PROTECTION_OPTIONS;
            
            devices.forEach((dev, idx) => {
                const label = dev.label || `Device #${idx+1}`;
                const isProtected = STATE[rowId].protectionStatus[idx] !== false;
                const tierIdOrValue = STATE[rowId].protectionCosts[idx] || 'p360-t4';
                const item = document.createElement('div');
                item.className = `prot-item ${isProtected ? '' : 'disabled'}`;
                
                // Build dropdown options - use tier ID as value
                let optionsHtml = '';
                protectionOptions.forEach(opt => {
                    // Handle both legacy numeric values and new ID system
                    const isSelected = (opt.id === tierIdOrValue) || 
                                     (typeof tierIdOrValue === 'number' && opt.value === tierIdOrValue);
                    const selected = isSelected ? 'selected' : '';
                    optionsHtml += `<option value="${opt.id}" ${selected}>${opt.label}</option>`;
                });
                
                const priceHtml = isProtected 
                    ? `<select class="prot-price-dropdown" onchange="updateProtectionCost('${rowId}', ${idx}, this.value)" onclick="event.stopPropagation()">${optionsHtml}</select>`
                    : `<span class="prot-price-static">$0</span>`;
                    
                item.innerHTML = `
                    <span class="prot-label">${label}</span>
                    <div class="prot-controls">
                        ${priceHtml}
                        <label class="switch-sm" style="flex-shrink: 0;">
                            <input type="checkbox" ${isProtected ? 'checked' : ''} onchange="toggleDeviceProtection('${rowId}', ${idx}, this)">
                            <span class="slider-sm"></span>
                        </label>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function toggleDeviceProtection(rowId, devIndex, checkbox) {
            STATE[rowId].protectionStatus[devIndex] = checkbox.checked;
            renderProtectionList(rowId); 
            calculateRow(rowId);
            updateNonProtectedToggleState(rowId);
        }
        
        function updateNonProtectedToggleState(rowId) {
            // Grey out "Display Non-Protected Pricing" toggle if all devices have protection disabled
            const allDevicesUnprotected = STATE[rowId].devices.length > 0 && 
                STATE[rowId].devices.every((_, idx) => STATE[rowId].protectionStatus[idx] === false);
            const unprotectedToggleWrapper = document.getElementById('prot-show-unprotected-wrapper');
            const unprotectedToggle = document.getElementById('prot-show-unprotected');
            if (unprotectedToggleWrapper) {
                if (allDevicesUnprotected) {
                    // Auto-disable the toggle when all devices become unprotected
                    if (unprotectedToggle && unprotectedToggle.checked) {
                        unprotectedToggle.checked = false;
                        toggleShowUnprotected(unprotectedToggle);
                    }
                    unprotectedToggleWrapper.style.opacity = '0.4';
                    unprotectedToggleWrapper.style.pointerEvents = 'none';
                } else {
                    unprotectedToggleWrapper.style.opacity = '1';
                    unprotectedToggleWrapper.style.pointerEvents = 'auto';
                }
            }
            
            // Also update standard protection toggle state
            updateStandardProtectionToggleState(rowId);
        }
        
        function updateStandardProtectionToggleState(rowId) {
            // Grey out "Display Standard Protection" toggle if:
            // 1. All devices have protection disabled, OR
            // 2. All protected devices (excluding BYOD devices with cost === 0) use standard protection
            //    (showing a secondary "Standard Protection" price would be the same)
            const allDevicesUnprotected = STATE[rowId].devices.length > 0 && 
                STATE[rowId].devices.every((_, idx) => STATE[rowId].protectionStatus[idx] === false);
            
            // Check if main display is already showing standard protection
            // This happens when any non-BYOD device has standard protection assigned
            let hasNonBYODStandardProtection = false;
            const protectedDevices = STATE[rowId].devices.filter((_, idx) => STATE[rowId].protectionStatus[idx] !== false);
            if (protectedDevices.length > 0) {
                hasNonBYODStandardProtection = STATE[rowId].devices.some((dev, idx) => {
                    if (STATE[rowId].protectionStatus[idx] === false) return false;
                    if (dev.cost === 0) return false; // Skip BYOD devices
                    const tierIdOrValue = STATE[rowId].protectionCosts[idx] || 'p360-t5';
                    return typeof tierIdOrValue === 'string' && tierIdOrValue.startsWith('std-');
                });
            }
            
            const standardToggleWrapper = document.getElementById('prot-show-standard-wrapper');
            const standardToggle = document.getElementById('prot-show-standard');
            if (standardToggleWrapper) {
                if (allDevicesUnprotected || hasNonBYODStandardProtection) {
                    // Auto-disable the toggle
                    if (standardToggle && standardToggle.checked) {
                        standardToggle.checked = false;
                        STATE[rowId].showStandardProtection = false;
                        calculateRow(rowId);
                    }
                    standardToggleWrapper.style.opacity = '0.4';
                    standardToggleWrapper.style.pointerEvents = 'none';
                } else {
                    standardToggleWrapper.style.opacity = '1';
                    standardToggleWrapper.style.pointerEvents = 'auto';
                }
            }
        }
        
        function updateProtectionCost(rowId, devIndex, val) {
            // Store the tier ID directly (val is now a tier ID like 'std-t5')
            STATE[rowId].protectionCosts[devIndex] = val;
            calculateRow(rowId);
            updateStandardProtectionToggleState(rowId);
        }

        // ============================================
        // CONNECTED DEVICE MODAL LOGIC (NEW with Tabs)
        // ============================================
        function openCDModal(rowId, editIndex = -1) {
            document.getElementById('cd-row-id').value = rowId;
            document.getElementById('cd-edit-index').value = editIndex;
            document.getElementById('cd-detail-panel').classList.remove('active');
            document.getElementById('cd-save-btn').style.display = 'none';
            document.getElementById('cd-dev-name').value = '';
            document.getElementById('cd-dev-cost').value = '';
            document.getElementById('cd-dev-down').value = '';
            document.getElementById('cd-dev-promo').value = '';
            document.getElementById('cd-term').value = '24';
            document.getElementById('cd-quantity').value = '1';
            document.getElementById('cd-search-box').value = '';
            
            const modalBody = document.querySelector('#cd-modal .modal-body');
            const modalTitle = document.getElementById('cd-modal-title');
            const tabsWrapper = document.getElementById('cd-tabs-wrapper');
            const planList = document.getElementById('cd-plan-list');
            const searchBox = document.getElementById('cd-search-box');
            
            if (editIndex >= 0) {
                // Editing existing item
                const item = STATE[rowId].connectedDevices[editIndex];
                modalTitle.textContent = 'Edit Connected Device';
                tabsWrapper.style.display = 'none';
                planList.style.display = 'none';
                searchBox.style.display = 'none';
                modalBody.classList.add('detail-active');
                
                // Pre-fill values
                document.getElementById('cd-selected-plan-key').value = item.planKey;
                document.getElementById('cd-selected-category').value = item.category;
                document.getElementById('cd-selected-plan-name').textContent = `${item.category}: ${item.planKey}`;
                document.getElementById('cd-dev-name').value = item.devName || '';
                document.getElementById('cd-dev-cost').value = item.devCost || '';
                document.getElementById('cd-dev-down').value = item.devDown || '';
                document.getElementById('cd-dev-promo').value = item.devPromo || '';
                document.getElementById('cd-term').value = item.term || '24';
                document.getElementById('cd-quantity').value = item.quantity || '1';
                
                document.getElementById('cd-detail-panel').classList.add('active');
                document.getElementById('cd-save-btn').style.display = 'inline-flex';
                document.getElementById('cd-save-btn').textContent = 'Save Changes';
                currentCDTab = item.category;
            } else {
                // Adding new item
                modalTitle.textContent = 'Add Connected Device';
                tabsWrapper.style.display = 'block';
                planList.style.display = 'block';
                searchBox.style.display = 'block';
                modalBody.classList.remove('detail-active');
                document.getElementById('cd-save-btn').textContent = 'Add Device';
                currentCDTab = 'Watches';
                
                document.querySelectorAll('.cd-tab').forEach(t => t.classList.remove('active'));
                document.querySelector('.cd-tab[data-tab="Watches"]').classList.add('active');
                
                // Reset scroll position and update arrows
                const tabsContainer = document.getElementById('cd-tabs-container');
                if (tabsContainer) tabsContainer.scrollLeft = 0;
                
                renderCDPlanList(rowId);
            }
            
            // Update MP link
            updateCDMPLink();
            
            document.getElementById('cd-modal').classList.add('open');
            
            // Update tab arrows after modal is open
            setTimeout(updateCDTabArrows, 100);
        }
        
        function updateCDMPLink() {
            const mpLink = document.getElementById('cd-mp-link');
            const mpLinkBusiness = document.getElementById('cd-mp-link-business');
            const rowId = document.getElementById('cd-row-id').value;
            const row = document.getElementById(rowId);
            const isManualMode = row ? (row.getAttribute('data-mode') === 'existing') : false;
            const planEl = document.getElementById(`${rowId}-plan`);
            const planName = planEl ? planEl.value : '';
            const hasPlanSelected = planName && planName.trim() !== '';
            const isBusinessPlan = isRowBusinessPlan(rowId);
            const showBothTypes = !hasPlanSelected && !isManualMode;
            
            // Format category name for display (add "Plans" to Data category)
            const formatCategoryName = (category) => {
                if (category === 'Data') return 'Data Plans';
                return category;
            };
            
            // Consumer link
            if (mpLink) {
                if (showBothTypes) {
                    // Show consumer link when both types are displayed
                    if (MP_LINKS.cdCategories[currentCDTab]) {
                        mpLink.href = MP_LINKS.cdCategories[currentCDTab];
                        mpLink.textContent = `${formatCategoryName(currentCDTab)} | Magenta Pulse`;
                        mpLink.style.display = 'inline';
                    } else {
                        mpLink.style.display = 'none';
                    }
                } else if (!isBusinessPlan && MP_LINKS.cdCategories[currentCDTab]) {
                    // Consumer plan selected - show consumer link only
                    mpLink.href = MP_LINKS.cdCategories[currentCDTab];
                    mpLink.textContent = `${formatCategoryName(currentCDTab)} | Magenta Pulse`;
                    mpLink.style.display = 'inline';
                } else if (isBusinessPlan && MP_LINKS.businessCdCategories[currentCDTab]) {
                    // Business plan selected - use consumer link element for business
                    mpLink.href = MP_LINKS.businessCdCategories[currentCDTab];
                    mpLink.textContent = `${formatCategoryName(currentCDTab)} | Magenta Pulse`;
                    mpLink.style.display = 'inline';
                } else {
                    mpLink.style.display = 'none';
                }
            }
            
            // Business link (only shown when both types are displayed)
            if (mpLinkBusiness) {
                if (showBothTypes && MP_LINKS.businessCdCategories[currentCDTab]) {
                    mpLinkBusiness.href = MP_LINKS.businessCdCategories[currentCDTab];
                    mpLinkBusiness.textContent = `Business ${formatCategoryName(currentCDTab)} | Magenta Pulse`;
                    mpLinkBusiness.style.display = 'inline';
                } else {
                    mpLinkBusiness.style.display = 'none';
                }
            }
        }
        
        function updateCDQuantity(change) {
            const input = document.getElementById('cd-quantity');
            let val = parseInt(input.value) + change;
            if (val < 1) val = 1;
            if (val > 12) val = 12;
            input.value = val;
        }
        
        function closeCDModal() {
            document.getElementById('cd-modal').classList.remove('open');
            document.querySelector('#cd-modal .modal-body').classList.remove('detail-active');
        }
        
        function switchCDTab(tab) {
            currentCDTab = tab;
            document.querySelectorAll('.cd-tab').forEach(t => t.classList.remove('active'));
            const activeTab = document.querySelector(`.cd-tab[data-tab="${tab}"]`);
            if (activeTab) {
                activeTab.classList.add('active');
                // Scroll the active tab into view
                activeTab.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }
            document.getElementById('cd-detail-panel').classList.remove('active');
            document.getElementById('cd-save-btn').style.display = 'none';
            document.getElementById('cd-search-box').value = '';
            document.querySelector('#cd-modal .modal-body').classList.remove('detail-active');
            const rowId = document.getElementById('cd-row-id').value;
            renderCDPlanList(rowId);
            updateCDMPLink();
            setTimeout(updateCDTabArrows, 300);
        }
        
        function filterCDPlans(searchTerm) {
            const rowId = document.getElementById('cd-row-id').value;
            if (!searchTerm.trim()) {
                // No search term - show current tab
                document.getElementById('cd-tabs-wrapper').style.display = 'block';
                renderCDPlanList(rowId);
                return;
            }
            
            // Hide tabs during search
            document.getElementById('cd-tabs-wrapper').style.display = 'none';
            
            const container = document.getElementById('cd-plan-list');
            container.innerHTML = '';
            
            const row = document.getElementById(rowId);
            const isManualMode = (row.getAttribute('data-mode') === 'existing');
            const planEl = document.getElementById(`${rowId}-plan`);
            const planName = planEl ? planEl.value : '';
            const isBeyondPlan = planName && PLANS_DATA[planName] ? PLANS_DATA[planName].beyond : false;
            const isBusinessPlan = isRowBusinessPlan(rowId);
            
            // Determine which plan source to use
            const planSource = isBusinessPlan ? BUSINESS_CONNECTED_DEVICE_PLANS : CONNECTED_DEVICE_PLANS;
            
            const searchLower = searchTerm.toLowerCase();
            let resultsFound = false;
            
            // Search across all categories
            Object.keys(planSource).forEach(category => {
                const plans = planSource[category] || {};
                Object.keys(plans).forEach(planKey => {
                    const plan = plans[planKey];
                    // Check plan name and keywords
                    const nameMatch = planKey.toLowerCase().includes(searchLower);
                    const keywordMatch = plan.keywords && plan.keywords.some(kw => kw.toLowerCase().includes(searchLower));
                    if (nameMatch || keywordMatch) {
                        
                        // Skip plans with beyondSavings if not on a beyond plan
                        if (plan.beyondSavings && !isBeyondPlan) {
                            return;
                        }
                        
                        resultsFound = true;
                        const div = document.createElement('div');
                        div.className = 'cd-plan-option';
                        div.innerHTML = `
                            <div>
                                <span class="cd-plan-name">${planKey}</span>
                                <span style="font-size: 0.7rem; color: var(--text-secondary); margin-left: 8px;">(${category})</span>
                            </div>
                            <span class="cd-plan-price">$${plan.price}/mo</span>
                        `;
                        div.onclick = () => {
                            currentCDTab = category;
                            selectCDPlan(rowId, planKey);
                        };
                        container.appendChild(div);
                    }
                });
            });
            
            if (!resultsFound) {
                container.innerHTML = '<div style="padding: 15px; text-align: center; color: var(--text-secondary);">No plans found matching your search.</div>';
            }
        }
        
        function isRowBusinessPlan(rowId) {
            const row = document.getElementById(rowId);
            const isManualMode = (row.getAttribute('data-mode') === 'existing');
            
            if (isManualMode) {
                const businessCheckbox = document.getElementById(`${rowId}-is-business`);
                return businessCheckbox ? businessCheckbox.checked : false;
            } else {
                const planEl = document.getElementById(`${rowId}-plan`);
                const planName = planEl ? planEl.value : '';
                return BUSINESS_PLAN_KEYWORDS.some(keyword => 
                    planName.toLowerCase().includes(keyword)
                );
            }
        }
        
        function renderCDPlanList(rowId) {
            const container = document.getElementById('cd-plan-list');
            container.innerHTML = '';
            
            const row = document.getElementById(rowId);
            const isManualMode = (row.getAttribute('data-mode') === 'existing');
            const planEl = document.getElementById(`${rowId}-plan`);
            const planName = planEl ? planEl.value : '';
            
            // Determine if we should show both consumer and business plans
            // Show both when: no plan selected (new mode) or existing mode with no business checkbox
            const hasPlanSelected = planName && planName.trim() !== '';
            const isBusinessPlan = isRowBusinessPlan(rowId);
            const showBothTypes = !hasPlanSelected && !isManualMode;
            
            // Determine which plan sources to use
            let planSources = [];
            if (showBothTypes) {
                planSources = [
                    { source: CONNECTED_DEVICE_PLANS, label: 'Consumer', isBusiness: false },
                    { source: BUSINESS_CONNECTED_DEVICE_PLANS, label: 'Business', isBusiness: true }
                ];
            } else if (isBusinessPlan) {
                planSources = [{ source: BUSINESS_CONNECTED_DEVICE_PLANS, label: null, isBusiness: true }];
            } else {
                planSources = [{ source: CONNECTED_DEVICE_PLANS, label: null, isBusiness: false }];
            }
            
            const lineCount = parseInt(document.getElementById(`${rowId}-lines`).value) || 0;
            
            // Check if beyond savings applies - from plan (new mode) or checkbox (existing mode)
            let isBeyondPlan = planName && PLANS_DATA[planName] ? PLANS_DATA[planName].beyond : false;
            if (isManualMode) {
                const beyondCheckbox = document.getElementById(`${rowId}-beyond-savings`);
                isBeyondPlan = beyondCheckbox ? beyondCheckbox.checked : false;
            }
            
            // Check for autopay - either from discounts (new mode) or checkbox (existing mode)
            let hasAutopay = STATE[rowId].discounts.some(d => d.type === 'Autopay Discount');
            if (isManualMode) {
                const autopayCheckbox = document.getElementById(`${rowId}-has-autopay`);
                hasAutopay = autopayCheckbox ? autopayCheckbox.checked : false;
            }
            const hasVoiceline = lineCount >= 1;
            
            // For existing mode, check if plan cost is filled to determine bundle eligibility
            const baseTotal = isManualMode ? (parseFloat(document.getElementById(`${rowId}-manual-price`)?.value) || 0) : 0;
            const existingHasPlanCost = isManualMode && baseTotal > 0;
            
            // Calculate autopay slots used
            const voicePlanAutopayEligible = PLANS_DATA[planName]?.autopayEligible !== false;
            const maxAutopayLines = PLANS_DATA[planName]?.maxAutopayLines;
            
            let voiceAutopayUsed = 0;
            if (isManualMode) {
                voiceAutopayUsed = hasAutopay ? Math.min(lineCount, 8) : 0;
                
                // Add voice lines to the count
                if (STATE[rowId].voiceLines && STATE[rowId].voiceLines.length > 0) {
                    STATE[rowId].voiceLines.forEach(group => {
                        voiceAutopayUsed = Math.min(voiceAutopayUsed + group.quantity, 8);
                    });
                }
            } else {
                const voiceLinesForAutopay = maxAutopayLines !== undefined 
                    ? Math.min(lineCount, maxAutopayLines) 
                    : lineCount;
                voiceAutopayUsed = voicePlanAutopayEligible ? Math.min(voiceLinesForAutopay, 8) : 0;
            }
            
            // Count only autopay-eligible HI plans
            const autopayEligibleHI = STATE[rowId].homeInternet.filter(hi => hi.planData?.autopayEligible !== false).length;
            const hiAutopayUsed = Math.min(autopayEligibleHI, Math.max(0, 8 - voiceAutopayUsed));
            
            // Count already-added connected devices that would get autopay
            let cdAutopayUsed = 0;
            if (hasAutopay) {
                // Expand CD items by quantity and count autopay-eligible ones
                const expandedCD = [];
                STATE[rowId].connectedDevices.forEach(item => {
                    const qty = item.quantity || 1;
                    for (let i = 0; i < qty; i++) {
                        if (item.planData?.autopayEligible !== false && !item.planData?.beyondSavings) {
                            expandedCD.push(item.planData.price);
                        }
                    }
                });
                // Sort by price descending (higher priced items get autopay first)
                expandedCD.sort((a, b) => b - a);
                // Count how many would get autopay
                const remainingAfterVoiceAndHI = 8 - voiceAutopayUsed - hiAutopayUsed;
                cdAutopayUsed = Math.min(expandedCD.length, Math.max(0, remainingAfterVoiceAndHI));
            }
            
            const autopayUsed = voiceAutopayUsed + hiAutopayUsed + cdAutopayUsed;
            const autopayAvailable = autopayUsed < 8;
            
            planSources.forEach(({ source, label, isBusiness }) => {
                const plans = source[currentCDTab] || {};
                
                // Add section header if showing both types
                if (label && Object.keys(plans).length > 0) {
                    const header = document.createElement('div');
                    header.className = 'cd-section-header';
                    header.innerHTML = `<span style="font-weight: 700; font-size: 0.8rem; color: var(--text-secondary); text-transform: uppercase; padding: 8px 15px; display: block; background: #f0f0f0;">${label}</span>`;
                    container.appendChild(header);
                }
                
                Object.keys(plans).forEach(planKey => {
                    const plan = plans[planKey];
                    
                    // Skip plans with beyondSavings if not on a beyond plan (unless no plan selected in new mode)
                    // In existing mode, always filter based on the checkbox
                    if (plan.beyondSavings && !isBeyondPlan) {
                        if (isManualMode || hasPlanSelected) {
                            return;
                        }
                    }
                    
                    const div = document.createElement('div');
                    div.className = 'cd-plan-option';
                    
                    let priceHtml = '';
                    let displayPrice = plan.price;
                    let showBeyondPrice = false;
                    
                    // Check for beyond savings first
                    if (plan.beyondSavings && isBeyondPlan) {
                        showBeyondPrice = true;
                    }
                    
                    if (showBeyondPrice) {
                        // Beyond savings - always $5
                        priceHtml = `<span class="cd-plan-price"><span class="original">$${plan.price}</span><span class="beyond-price">$5/mo</span></span>`;
                    } else if ((hasVoiceline || existingHasPlanCost) && plan.savingsWithVoiceline > 0) {
                        // Has voiceline savings (or existing mode with plan cost)
                        let priceWithVoiceline = plan.price - plan.savingsWithVoiceline;
                        const canGetAutopay = hasAutopay && autopayAvailable && (plan.autopayEligible !== false);
                        if (canGetAutopay) {
                            priceWithVoiceline = plan.priceAutopay - plan.savingsWithVoiceline;
                            priceHtml = `<span class="cd-plan-price"><span class="original">$${plan.price}</span><span class="discounted">$${priceWithVoiceline}/mo</span></span>`;
                        } else {
                            priceHtml = `<span class="cd-plan-price"><span class="original">$${plan.price}</span><span class="discounted">$${priceWithVoiceline}/mo</span></span>`;
                        }
                    } else if (hasAutopay && autopayAvailable && (plan.autopayEligible !== false)) {
                        priceHtml = `<span class="cd-plan-price"><span class="original">$${plan.price}</span><span class="discounted">$${plan.priceAutopay}/mo</span></span>`;
                    } else {
                        priceHtml = `<span class="cd-plan-price">$${plan.price}/mo</span>`;
                    }
                    
                    div.innerHTML = `
                        <span class="cd-plan-name">${planKey}</span>
                        ${priceHtml}
                    `;
                    div.onclick = () => selectCDPlan(rowId, planKey, isBusiness);
                    container.appendChild(div);
                });
            });
            
            // Show message if no plans available
            if (container.children.length === 0) {
                container.innerHTML = '<div style="padding: 15px; text-align: center; color: var(--text-secondary);">No plans available for this category with current plan selection.</div>';
            }
        }
        
        function selectCDPlan(rowId, planKey, isBusiness = false) {
            // Check if clicking the same plan - if so, deselect and go back
            const currentSelectedPlan = document.getElementById('cd-selected-plan-key').value;
            if (currentSelectedPlan === planKey) {
                deselectCDPlan();
                return;
            }
            
            document.getElementById('cd-selected-plan-key').value = planKey;
            document.getElementById('cd-selected-category').value = currentCDTab;
            document.getElementById('cd-selected-plan-name').textContent = `${currentCDTab}: ${planKey}`;
            document.getElementById('cd-detail-panel').classList.add('active');
            document.getElementById('cd-save-btn').style.display = 'inline-flex';
            // Store business flag for saving
            document.getElementById('cd-detail-panel').dataset.isBusiness = isBusiness;
            // Add detail-active class to modal body to hide plan list and show form properly
            document.querySelector('#cd-modal .modal-body').classList.add('detail-active');
            
            // Set button text based on whether we're editing or adding new
            const editIndex = parseInt(document.getElementById('cd-edit-index').value);
            if (editIndex < 0) {
                // Adding new - check if retail price has value
                updateCDSaveButtonText();
            }
        }
        
        function updateCDSaveButtonText() {
            const editIndex = parseInt(document.getElementById('cd-edit-index').value);
            if (editIndex >= 0) return; // Don't change text in edit mode
            
            const retailPrice = parseFloat(document.getElementById('cd-dev-cost').value) || 0;
            const saveBtn = document.getElementById('cd-save-btn');
            if (retailPrice > 0) {
                saveBtn.textContent = 'Add device and service';
            } else {
                saveBtn.textContent = 'Skip and Add Service';
            }
        }
        
        function deselectCDPlan() {
            // Deselect - go back to plan list
            document.getElementById('cd-selected-plan-key').value = '';
            document.getElementById('cd-selected-category').value = '';
            document.getElementById('cd-detail-panel').classList.remove('active');
            document.getElementById('cd-save-btn').style.display = 'none';
            document.querySelector('#cd-modal .modal-body').classList.remove('detail-active');
            
            // Show tabs and plan list when going back (important for edit mode)
            const tabsWrapper = document.getElementById('cd-tabs-wrapper');
            const planList = document.getElementById('cd-plan-list');
            const searchBox = document.getElementById('cd-search-box');
            const rowId = document.getElementById('cd-row-id').value;
            
            if (tabsWrapper) tabsWrapper.style.display = 'block';
            if (planList) planList.style.display = 'block';
            if (searchBox) searchBox.style.display = 'block';
            
            // Re-render the plan list
            if (rowId) {
                renderCDPlanList(rowId);
            }
        }
        
        let _saveCDItemDebounce = 0;
        function saveCDItem() {
            // Debounce - prevent double execution within 500ms
            const now = Date.now();
            if (now - _saveCDItemDebounce < 500) return;
            _saveCDItemDebounce = now;
            
            const rowId = document.getElementById('cd-row-id').value;
            const editIndex = parseInt(document.getElementById('cd-edit-index').value);
            const planKey = document.getElementById('cd-selected-plan-key').value;
            const category = document.getElementById('cd-selected-category').value;
            
            // Validate required fields
            if (!rowId || !planKey || !category) {
                console.warn('saveCDItem: Missing required fields', { rowId, planKey, category });
                return;
            }
            
            // Ensure STATE exists for this row
            if (!STATE[rowId]) {
                console.warn('saveCDItem: STATE not found for row', rowId);
                return;
            }
            
            // Get business flag from detail panel or row
            const detailPanel = document.getElementById('cd-detail-panel');
            const isBusinessFromSelection = detailPanel.dataset.isBusiness === 'true';
            const isBusinessPlan = isBusinessFromSelection || isRowBusinessPlan(rowId);
            
            const planSource = isBusinessPlan ? BUSINESS_CONNECTED_DEVICE_PLANS : CONNECTED_DEVICE_PLANS;
            const plan = planSource[category]?.[planKey] || CONNECTED_DEVICE_PLANS[category]?.[planKey];
            
            // Validate plan exists
            if (!plan) {
                console.warn('saveCDItem: Plan not found', { category, planKey, isBusinessPlan });
                return;
            }
            
            const quantity = parseInt(document.getElementById('cd-quantity').value) || 1;
            
            // Check max connected devices (15)
            if (editIndex < 0 && STATE[rowId].connectedDevices.length >= 15) {
                alert('Maximum of 15 connected devices allowed per quote.');
                return;
            }
            
            // Default device name to category (singular form)
            let defaultDevName = category;
            if (category === 'Watches') defaultDevName = 'Watch';
            else if (category === 'Tablets') defaultDevName = 'Tablet';
            else if (category === 'Data') defaultDevName = 'Data Device';
            else if (category === 'SyncUp Trackers') defaultDevName = 'Tracker';
            else if (category === 'SyncUp Drive') defaultDevName = 'Drive';
            
            // Get values from form - capture them before any async operations
            const devName = document.getElementById('cd-dev-name').value || defaultDevName;
            const devCost = Math.min(parseFloat(document.getElementById('cd-dev-cost').value) || 0, 9999.99);
            const devDown = Math.min(parseFloat(document.getElementById('cd-dev-down').value) || 0, 9999.99);
            const devPromo = Math.min(parseFloat(document.getElementById('cd-dev-promo').value) || 0, 9999.99);
            const term = parseInt(document.getElementById('cd-term').value) || 24;
            
            const item = {
                category: category,
                planKey: planKey,
                planData: plan,
                devName: devName,
                devCost: devCost,
                devDown: devDown,
                devPromo: devPromo,
                term: term,
                quantity: quantity,
                isBusinessPlan: isBusinessPlan
            };
            
            if (editIndex >= 0) {
                // Update existing item
                STATE[rowId].connectedDevices[editIndex] = item;
            } else {
                // Add new item(s)
                STATE[rowId].connectedDevices.push(item);
            }
            
            validateDiscounts(rowId);
            
            // Render and calculate BEFORE closing modal to ensure state is captured
            renderCDList(rowId);
            calculateRow(rowId);
            
            // Close modal after state is saved
            closeCDModal();
        }
        
        function removeCDItem(rowId, index) {
            if (!STATE[rowId] || index < 0 || index >= STATE[rowId].connectedDevices.length) {
                console.warn('removeCDItem: Invalid parameters', { rowId, index });
                return;
            }
            STATE[rowId].connectedDevices.splice(index, 1);
            validateDiscounts(rowId);
            renderCDList(rowId);
            calculateRow(rowId);
        }
        
        function renderCDList(rowId) {
            const container = document.getElementById(`cd-list-${rowId}`);
            container.innerHTML = '';
            
            const row = document.getElementById(rowId);
            const isManualMode = (row.getAttribute('data-mode') === 'existing');
            const lineCount = parseInt(document.getElementById(`${rowId}-lines`).value) || 0;
            const planEl = document.getElementById(`${rowId}-plan`);
            const planName = planEl ? planEl.value : '';
            
            // Check if beyond savings applies - from plan (new mode) or checkbox (existing mode)
            let isBeyondPlan = planName && PLANS_DATA[planName] ? PLANS_DATA[planName].beyond : false;
            if (isManualMode) {
                const beyondCheckbox = document.getElementById(`${rowId}-beyond-savings`);
                isBeyondPlan = beyondCheckbox ? beyondCheckbox.checked : false;
            }
            
            // Check for autopay - either from discounts (new mode) or checkbox (existing mode)
            let hasAutopay = STATE[rowId].discounts.some(d => d.type === 'Autopay Discount');
            if (isManualMode) {
                const autopayCheckbox = document.getElementById(`${rowId}-has-autopay`);
                hasAutopay = autopayCheckbox ? autopayCheckbox.checked : false;
            }
            const hasVoiceline = lineCount >= 1;
            
            // For existing mode, check if plan cost is filled to determine bundle eligibility
            const baseTotal = isManualMode ? (parseFloat(document.getElementById(`${rowId}-manual-price`)?.value) || 0) : 0;
            const existingHasPlanCost = isManualMode && baseTotal > 0;
            
            // Calculate autopay slots: Voice first, then HI, then CD
            // Voice lines get autopay up to maxAutopayLines (if defined) or all lines
            const voicePlanAutopayEligible = PLANS_DATA[planName]?.autopayEligible !== false;
            const maxAutopayLines = PLANS_DATA[planName]?.maxAutopayLines;
            
            // In existing mode with autopay enabled, lines count towards autopay limit
            let voiceAutopayUsed = 0;
            if (isManualMode) {
                // In existing mode, if autopay is enabled, all lines count towards the limit
                voiceAutopayUsed = hasAutopay ? Math.min(lineCount, 8) : 0;
                
                // Add voice lines to the count
                if (STATE[rowId].voiceLines && STATE[rowId].voiceLines.length > 0) {
                    STATE[rowId].voiceLines.forEach(group => {
                        voiceAutopayUsed = Math.min(voiceAutopayUsed + group.quantity, 8);
                    });
                }
            } else {
                // In new mode, use the plan's autopay eligibility
                const voiceLinesForAutopay = maxAutopayLines !== undefined 
                    ? Math.min(lineCount, maxAutopayLines) 
                    : lineCount;
                voiceAutopayUsed = voicePlanAutopayEligible ? Math.min(voiceLinesForAutopay, 8) : 0;
            }
            
            const hiCount = STATE[rowId].homeInternet.length;
            const autopayEligibleHI = STATE[rowId].homeInternet.filter(hi => hi.planData?.autopayEligible !== false).length;
            const hiAutopayUsed = Math.min(autopayEligibleHI, Math.max(0, 8 - voiceAutopayUsed));
            let autopayUsed = voiceAutopayUsed + hiAutopayUsed;
            const maxAutopay = 8;
            
            // Expand all items by quantity into individual units, tracking original index
            const expandedItems = [];
            STATE[rowId].connectedDevices.forEach((item, origIndex) => {
                const qty = item.quantity || 1;
                for (let i = 0; i < qty; i++) {
                    expandedItems.push({
                        ...item,
                        originalIndex: origIndex,
                        unitIndex: i,
                        isBeyond: item.planData.beyondSavings && isBeyondPlan,
                        isBogoCompatible: item.planData.bogoCompatible !== false
                    });
                }
            });
            
            // Separate beyond and non-beyond items
            const beyondItems = expandedItems.filter(i => i.isBeyond);
            const nonBeyondItems = expandedItems.filter(i => !i.isBeyond);
            
            // BOGO Logic: Only BOGO-compatible items count for pairing AND receive discount
            // Non-compatible items (like SyncUP Tracker) don't participate in BOGO at all
            const bogoEligibleItems = nonBeyondItems.filter(i => i.isBogoCompatible);
            const discountsAvailable = Math.floor(bogoEligibleItems.length / 2);
            
            // Sort by price (lowest first - cheapest get the discount)
            bogoEligibleItems.sort((a, b) => a.planData.price - b.planData.price);
            
            // Mark the first N eligible items as half price (where N = discountsAvailable)
            const halfPriceSet = new Set();
            for (let i = 0; i < discountsAvailable; i++) {
                const item = bogoEligibleItems[i];
                halfPriceSet.add(`${item.originalIndex}-${item.unitIndex}`);
            }
            
            // Apply half price flag to items
            nonBeyondItems.forEach((item) => {
                const key = `${item.originalIndex}-${item.unitIndex}`;
                item.isHalfPrice = halfPriceSet.has(key);
            });
            
            // Combine back and sort by original order for display
            const allItems = [...beyondItems, ...nonBeyondItems];
            allItems.sort((a, b) => {
                if (a.originalIndex !== b.originalIndex) return a.originalIndex - b.originalIndex;
                return a.unitIndex - b.unitIndex;
            });
            
            // Calculate autopay assignments (non-beyond items sorted by price descending)
            // Only count items that are autopay eligible (defined in plan data)
            const autopayAssigned = new Set();
            const sortedForAutopay = [...nonBeyondItems].sort((a, b) => b.planData.price - a.planData.price);
            sortedForAutopay.forEach((item, idx) => {
                const isAutopayEligible = item.planData.autopayEligible !== false;
                if (hasAutopay && isAutopayEligible && autopayUsed < maxAutopay) {
                    autopayAssigned.add(`${item.originalIndex}-${item.unitIndex}`);
                    autopayUsed++;
                }
            });
            
            // Group consecutive items with same originalIndex for display
            let currentOrigIndex = -1;
            let groupDiv = null;
            let groupTotal = 0;
            let groupOriginalTotal = 0;
            let groupHasBogo = false;
            let groupHasDiscount = false;
            let groupUnitCount = 0;
            let groupPlanKey = '';
            let groupDevPromo = 0;
            let groupDevCost = 0;
            let groupDevName = '';
            
            allItems.forEach((item, displayIdx) => {
                const plan = item.planData;
                let servicePrice = plan.price;
                let originalServicePrice = plan.price; // This will be the full price before any discounts
                let hasServiceDiscount = false; // Track if any discount was applied
                
                // Check beyond savings first
                if (item.isBeyond) {
                    servicePrice = 5;
                    originalServicePrice = plan.price; // Keep original for display
                    hasServiceDiscount = plan.price !== 5;
                } else {
                    // Check if this unit gets autopay
                    const autopayKey = `${item.originalIndex}-${item.unitIndex}`;
                    if (autopayAssigned.has(autopayKey)) {
                        servicePrice = plan.priceAutopay;
                        // originalServicePrice stays at plan.price
                        if (plan.price !== plan.priceAutopay) {
                            hasServiceDiscount = true;
                        }
                    }
                    
                    // Apply voiceline savings
                    // In existing mode, apply if plan cost is filled
                    if ((hasVoiceline || existingHasPlanCost) && plan.savingsWithVoiceline > 0) {
                        servicePrice -= plan.savingsWithVoiceline;
                        hasServiceDiscount = true;
                    }
                    
                    // Apply half-price deal
                    if (item.isHalfPrice) {
                        servicePrice = servicePrice / 2;
                        hasServiceDiscount = true;
                    }
                }
                
                const term = item.term || 24;
                const devDown = item.devDown || 0;
                const devPayment = Math.max(0, (item.devCost - devDown - item.devPromo) / term);
                const lineTotal = servicePrice + devPayment;
                const originalTotal = originalServicePrice + devPayment;
                
                // Create new group if different original index
                if (item.originalIndex !== currentOrigIndex) {
                    // Finalize previous group's print summary
                    if (groupDiv && groupUnitCount > 0) {
                        const printSummary = groupDiv.querySelector('.cd-print-summary');
                        const qtyText = groupUnitCount > 1 ? ` x${groupUnitCount}` : '';
                        let priceHtml = '';
                        if (showItemizedPrices.connectedDevices) {
                            if (groupHasBogo && groupOriginalTotal > groupTotal) {
                                priceHtml = `
                                    <span class="cd-print-price-wrapper">
                                        <span class="cd-print-bogo-badge">BOGO</span>
                                        <span class="cd-print-original">$${groupOriginalTotal.toFixed(2)}</span>
                                        <span class="cd-print-price">$${groupTotal.toFixed(2)}/mo</span>
                                    </span>
                                `;
                            } else {
                                priceHtml = `<span class="cd-print-price">$${groupTotal.toFixed(2)}/mo</span>`;
                            }
                        }
                        // Add promo info for multiplied items
                        let promoHtml = '';
                        if (groupUnitCount > 1 && groupDevPromo > 0) {
                            if (showRetailPrices.bts) {
                                promoHtml = `<div class="cd-print-promo">$${groupDevPromo.toFixed(2)} Off/Each | Retail: $${groupDevCost.toFixed(2)}</div>`;
                            } else {
                                promoHtml = `<div class="cd-print-promo">$${groupDevPromo.toFixed(2)} Off/Each</div>`;
                            }
                        }
                        printSummary.innerHTML = `
                            <div class="cd-print-row">
                                <span class="cd-print-name">${groupPlanKey}${qtyText}</span>
                                ${priceHtml}
                            </div>
                            ${promoHtml}
                        `;
                    }
                    
                    currentOrigIndex = item.originalIndex;
                    groupTotal = 0;
                    groupOriginalTotal = 0;
                    groupHasBogo = false;
                    groupHasDiscount = false;
                    groupUnitCount = 0;
                    groupPlanKey = item.planKey;
                    groupDevPromo = item.devPromo || 0;
                    groupDevCost = item.devCost || 0;
                    groupDevName = item.devName || '';
                    
                    groupDiv = document.createElement('div');
                    groupDiv.className = 'item-pill cd-pill';
                    
                    groupDiv.innerHTML = `
                        <div class="cd-pill-content">
                            <div class="cd-units-list cd-screen-only"></div>
                            <div class="cd-print-summary cd-print-only"></div>
                        </div>
                        <div class="cd-pill-actions">
                            <button class="btn btn-small btn-small-cd-edit" onclick="openCDModal('${rowId}', ${item.originalIndex})">Edit</button>
                            <button class="btn btn-small btn-small-cd-edit" onclick="removeCDItem('${rowId}', ${item.originalIndex})"></button>
                        </div>
                    `;
                    container.appendChild(groupDiv);
                }
                
                // Track group totals for print summary
                groupTotal += lineTotal;
                groupOriginalTotal += originalTotal;
                if (item.isHalfPrice) groupHasBogo = true;
                if (hasServiceDiscount) groupHasDiscount = true;
                groupUnitCount++;
                
                // Add unit line to the group (screen only)
                const unitsList = groupDiv.querySelector('.cd-units-list');
                const unitLine = document.createElement('div');
                unitLine.className = 'cd-unit-line';
                
                // First line: Plan title and service price
                let planPriceText = '';
                if (showItemizedPrices.connectedDevices) {
                    if (hasServiceDiscount && originalServicePrice !== servicePrice) {
                        planPriceText = ` <span class="price-strikethrough">$${originalServicePrice.toFixed(2)}</span> <span class="price-deal">$${servicePrice.toFixed(2)}/mo</span>`;
                    } else {
                        planPriceText = ` ($${servicePrice.toFixed(2)}/mo)`;
                    }
                }
                
                const dealBadge = item.isHalfPrice ? '<span class="deal-badge">BOGO Half Off!</span>' : '';
                
                // Second line: Show device info only if there's a device cost
                let deviceLine = '';
                if (item.devCost > 0) {
                    // Device name (bold) and payment
                    let devicePaymentText = '';
                    if (devPayment > 0 && showItemizedPrices.connectedDevices) {
                        devicePaymentText = `: $${devPayment.toFixed(2)}/mo`;
                    }
                    
                    // Promo line
                    let promoLine = '';
                    if (item.devPromo > 0) {
                        if (showRetailPrices.bts) {
                            promoLine = `<div class="cd-promo-line">Promo: $${item.devPromo.toFixed(2)} Off | Retail: $${item.devCost.toFixed(2)}</div>`;
                        } else {
                            promoLine = `<div class="cd-promo-line">Promo: $${item.devPromo.toFixed(2)} Off</div>`;
                        }
                    } else if (showRetailPrices.bts) {
                        promoLine = `<div class="cd-promo-line">Retail: $${item.devCost.toFixed(2)}</div>`;
                    }
                    
                    deviceLine = `<div class="cd-device-submenu"><span class="cd-device-name">${item.devName}</span>${devicePaymentText}</div>${promoLine}`;
                }
                
                unitLine.innerHTML = `
                    <div><span class="item-text">${item.planKey}${planPriceText}</span>${dealBadge}</div>
                    ${deviceLine}
                `;
                unitsList.appendChild(unitLine);
            });
            
            // Finalize last group's print summary
            if (groupDiv && groupUnitCount > 0) {
                const printSummary = groupDiv.querySelector('.cd-print-summary');
                const qtyText = groupUnitCount > 1 ? ` x${groupUnitCount}` : '';
                let priceHtml = '';
                if (showItemizedPrices.connectedDevices) {
                    if (groupHasBogo && groupOriginalTotal > groupTotal) {
                        priceHtml = `
                            <span class="cd-print-price-wrapper">
                                <span class="cd-print-bogo-badge">BOGO</span>
                                <span class="cd-print-original">$${groupOriginalTotal.toFixed(2)}</span>
                                <span class="cd-print-price">$${groupTotal.toFixed(2)}/mo</span>
                            </span>
                        `;
                    } else {
                        priceHtml = `<span class="cd-print-price">$${groupTotal.toFixed(2)}/mo</span>`;
                    }
                }
                // Add promo info for multiplied items
                let promoHtml = '';
                if (groupUnitCount > 1 && groupDevPromo > 0) {
                    if (showRetailPrices.bts) {
                        promoHtml = `<div class="cd-print-promo">$${groupDevPromo.toFixed(2)} Off/Each | Retail: $${groupDevCost.toFixed(2)}</div>`;
                    } else {
                        promoHtml = `<div class="cd-print-promo">$${groupDevPromo.toFixed(2)} Off/Each</div>`;
                    }
                }
                printSummary.innerHTML = `
                    <div class="cd-print-row">
                        <span class="cd-print-name">${groupPlanKey}${qtyText}</span>
                        ${priceHtml}
                    </div>
                    ${promoHtml}
                `;
            }
            
            const cdWrapper = document.getElementById(`${rowId}-col-bts`);
            if (STATE[rowId].connectedDevices.length === 0) cdWrapper.classList.add('print-hidden');
            else cdWrapper.classList.remove('print-hidden');
        }

        // ============================================
        // HOME INTERNET MODAL LOGIC
        // ============================================
        function openHIModal(rowId) {
            document.getElementById('hi-row-id').value = rowId;
            document.getElementById('hi-detail-panel').classList.remove('active');
            document.getElementById('hi-save-btn').style.display = 'none';
            document.getElementById('hi-label').value = '';
            renderHIPlanList(rowId);
            document.getElementById('hi-modal').classList.add('open');
        }
        
        function closeHIModal() {
            document.getElementById('hi-modal').classList.remove('open');
        }
        
        // Voice Line Modal Functions
        function openVoiceLineModal(rowId) {
            document.getElementById('voice-line-row-id').value = rowId;
            document.getElementById('voice-line-cost').value = '';
            document.getElementById('voice-line-quantity').value = '1';
            document.getElementById('voice-line-bogo-free').classList.remove('active');
            document.getElementById('voice-line-bogo-10').classList.remove('active');
            document.getElementById('voice-line-bogo-free').disabled = true;
            document.getElementById('voice-line-bogo-10').disabled = true;
            document.getElementById('voice-line-modal').classList.add('open');
        }
        
        function closeVoiceLineModal() {
            document.getElementById('voice-line-modal').classList.remove('open');
        }
        
        function updateVoiceLineBogoButtons() {
            const quantity = parseInt(document.getElementById('voice-line-quantity').value) || 0;
            const bogoFreeBtn = document.getElementById('voice-line-bogo-free');
            const bogo10Btn = document.getElementById('voice-line-bogo-10');
            
            if (quantity >= 2) {
                bogoFreeBtn.disabled = false;
                bogo10Btn.disabled = false;
            } else {
                bogoFreeBtn.disabled = true;
                bogo10Btn.disabled = true;
                bogoFreeBtn.classList.remove('active');
                bogo10Btn.classList.remove('active');
            }
        }
        
        function toggleVoiceLineBogo(type) {
            const bogoFreeBtn = document.getElementById('voice-line-bogo-free');
            const bogo10Btn = document.getElementById('voice-line-bogo-10');
            
            // Prevent toggling if buttons are disabled
            if (type === 'free' && bogoFreeBtn.disabled) return;
            if (type === 'ten' && bogo10Btn.disabled) return;
            
            if (type === 'free') {
                if (bogoFreeBtn.classList.contains('active')) {
                    bogoFreeBtn.classList.remove('active');
                } else {
                    bogoFreeBtn.classList.add('active');
                    bogo10Btn.classList.remove('active');
                }
            } else if (type === 'ten') {
                if (bogo10Btn.classList.contains('active')) {
                    bogo10Btn.classList.remove('active');
                } else {
                    bogo10Btn.classList.add('active');
                    bogoFreeBtn.classList.remove('active');
                }
            }
        }
        
        function updateVoiceLineQuantity(delta) {
            const input = document.getElementById('voice-line-quantity');
            let value = parseInt(input.value) || 1;
            value += delta;
            if (value < 1) value = 1;
            if (value > 12) value = 12;
            input.value = value;
            updateVoiceLineBogoButtons();
        }
        
        function saveVoiceLines() {
            const rowId = document.getElementById('voice-line-row-id').value;
            const cost = parseFloat(document.getElementById('voice-line-cost').value) || 0;
            const quantity = parseInt(document.getElementById('voice-line-quantity').value) || 1;
            const bogoFree = document.getElementById('voice-line-bogo-free').classList.contains('active');
            const bogo10 = document.getElementById('voice-line-bogo-10').classList.contains('active');
            
            if (cost <= 0) {
                alert('Please enter a cost per line');
                return;
            }
            
            const voiceLineGroup = {
                cost: cost,
                quantity: quantity,
                bogoType: bogoFree ? 'free' : (bogo10 ? 'ten' : 'none')
            };
            
            if (!STATE[rowId].voiceLines) {
                STATE[rowId].voiceLines = [];
            }
            
            STATE[rowId].voiceLines.push(voiceLineGroup);
            renderVoiceLinesList(rowId);
            calculateRow(rowId);
            closeVoiceLineModal();
        }
        
        function renderVoiceLinesList(rowId) {
            const container = document.getElementById(`${rowId}-voice-lines-list`);
            if (!container) return;
            
            container.innerHTML = '';
            
            // Hide entire col-voice-lines section and label if no voice lines
            const addedLinesLabel = document.getElementById(`${rowId}-added-lines-label`);
            const colVoiceLines = document.getElementById(`${rowId}-col-voice-lines`);
            
            if (!STATE[rowId].voiceLines || STATE[rowId].voiceLines.length === 0) {
                if (addedLinesLabel) addedLinesLabel.classList.add('hidden');
                if (colVoiceLines) colVoiceLines.classList.add('hidden-step');
                return;
            }
            
            // Show "Added Lines" label and section when there are voice lines
            if (addedLinesLabel) addedLinesLabel.classList.remove('hidden');
            if (colVoiceLines) colVoiceLines.classList.remove('hidden-step');
            
            STATE[rowId].voiceLines.forEach((group, index) => {
                const div = document.createElement('div');
                div.className = 'voice-line-item';
                
                let pricingText = '';
                let bogoBadge = '';
                if (group.bogoType !== 'none' && group.quantity >= 2) {
                    const regularLines = group.quantity - 1;
                    const regularTotal = regularLines * group.cost;
                    const bogoPrice = group.bogoType === 'free' ? 0 : 10;
                    const total = regularTotal + bogoPrice;
                    
                    // Add BOGO badge with text based on bogo type
                    const bogoText = group.bogoType === 'free' ? 'BOGO FREE' : 'BOGO $10';
                    bogoBadge = `<span class="deal-badge" style="margin-left: 8px;">${bogoText}</span>`;
                    
                    pricingText = `
                        <div class="voice-line-pricing">
                            <b>${group.quantity}</b> lines ($${group.cost.toFixed(2)}/ea): 
                            <span class="voice-line-price-original">$${(group.cost * group.quantity).toFixed(2)}</span><span class="voice-line-price-discounted">$${total.toFixed(2)}/mo</span>
                            ${bogoBadge}
                        </div>
                    `;
                } else if (group.quantity === 1) {
                    pricingText = `<div class="voice-line-pricing"><b>1</b> line: <span class="voice-line-price-discounted">$${group.cost.toFixed(2)}/mo</span></div>`;
                } else {
                    const total = group.cost * group.quantity;
                    pricingText = `<div class="voice-line-pricing"><b>${group.quantity}</b> lines ($${group.cost.toFixed(2)}/ea): <span class="voice-line-price-discounted">$${total.toFixed(2)}/mo</span></div>`;
                }
                
                div.innerHTML = `
                    <div class="voice-line-details">
                        ${pricingText}
                    </div>
                    <span class="remove-x" onclick="removeVoiceLine('${rowId}', ${index})"></span>
                `;
                
                container.appendChild(div);
            });
        }
        
        function removeVoiceLine(rowId, index) {
            STATE[rowId].voiceLines.splice(index, 1);
            renderVoiceLinesList(rowId);
            calculateRow(rowId);
        }
        
        function deselectHIPlan() {
            // Go back to plan list
            document.getElementById('hi-selected-plan-key').value = '';
            document.getElementById('hi-detail-panel').classList.remove('active');
            document.getElementById('hi-save-btn').style.display = 'none';
        }
        
        function renderHIPlanList(rowId) {
            const container = document.getElementById('hi-plan-list');
            container.innerHTML = '';
            
            const row = document.getElementById(rowId);
            const isManualMode = (row.getAttribute('data-mode') === 'existing');
            const lineCount = parseInt(document.getElementById(`${rowId}-lines`).value) || 0;
            const planEl = document.getElementById(`${rowId}-plan`);
            const planName = planEl ? planEl.value : '';
            const is55Plan = planName && planName.includes('55');
            const hasVoiceline = lineCount >= 1;
            
            // Check if business plan (for new mode) or business checkbox (for existing mode)
            let isBusinessPlan = false;
            let noPlanSelected = false;
            if (isManualMode) {
                const businessCheckbox = document.getElementById(`${rowId}-is-business`);
                isBusinessPlan = businessCheckbox ? businessCheckbox.checked : false;
            } else {
                // If no plan selected, show both regular and business internet options
                if (!planName) {
                    noPlanSelected = true;
                } else {
                    isBusinessPlan = BUSINESS_PLAN_KEYWORDS.some(keyword => 
                        planName.toLowerCase().includes(keyword)
                    );
                }
            }
            
            // Check for autopay - either from discounts (new mode) or checkbox (existing mode)
            let hasAutopay = STATE[rowId].discounts.some(d => d.type === 'Autopay Discount');
            if (isManualMode) {
                const autopayCheckbox = document.getElementById(`${rowId}-has-autopay`);
                hasAutopay = autopayCheckbox ? autopayCheckbox.checked : false;
            }
            
            // For existing mode, check if plan cost is filled to determine bundle eligibility
            const baseTotal = isManualMode ? (parseFloat(document.getElementById(`${rowId}-manual-price`)?.value) || 0) : 0;
            const existingHasPlanCost = isManualMode && baseTotal > 0;
            
            // Check if autopay slots available for HI (only count HI plans that are autopay eligible)
            // Voice lines get autopay up to maxAutopayLines (if defined) or all lines
            const voicePlanAutopayEligible = PLANS_DATA[planName]?.autopayEligible !== false;
            const maxAutopayLines = PLANS_DATA[planName]?.maxAutopayLines;
            
            // In existing mode with autopay enabled, lines count towards autopay limit
            let voiceAutopayUsed = 0;
            if (isManualMode) {
                // In existing mode, if autopay is enabled, all lines count towards the limit
                voiceAutopayUsed = hasAutopay ? Math.min(lineCount, 8) : 0;
                
                // Add voice lines to the count
                if (STATE[rowId].voiceLines && STATE[rowId].voiceLines.length > 0) {
                    STATE[rowId].voiceLines.forEach(group => {
                        voiceAutopayUsed = Math.min(voiceAutopayUsed + group.quantity, 8);
                    });
                }
            } else {
                // In new mode, use the plan's autopay eligibility
                const voiceLinesForAutopay = maxAutopayLines !== undefined 
                    ? Math.min(lineCount, maxAutopayLines) 
                    : lineCount;
                voiceAutopayUsed = voicePlanAutopayEligible ? Math.min(voiceLinesForAutopay, 8) : 0;
            }
            
            // Count already-added connected devices that would get autopay
            let cdAutopayUsed = 0;
            if (hasAutopay) {
                const expandedCD = [];
                STATE[rowId].connectedDevices.forEach(item => {
                    const qty = item.quantity || 1;
                    for (let i = 0; i < qty; i++) {
                        if (item.planData?.autopayEligible !== false && !item.planData?.beyondSavings) {
                            expandedCD.push(item.planData.price);
                        }
                    }
                });
                expandedCD.sort((a, b) => b - a);
                const remainingAfterVoice = 8 - voiceAutopayUsed;
                cdAutopayUsed = Math.min(expandedCD.length, Math.max(0, remainingAfterVoice));
            }
            
            const autopayEligibleHI = STATE[rowId].homeInternet.filter(hi => hi.planData.autopayEligible !== false).length;
            const autopayAvailableForNewHI = hasAutopay && (voiceAutopayUsed + cdAutopayUsed + autopayEligibleHI < 8);
            
            // Check if 55+ savings applies (only for first HI on 55+ plans, new mode only)
            const hiCount = STATE[rowId].homeInternet.length;
            const is55SavingsEligible = !isManualMode && is55Plan && hiCount === 0;
            
            // Helper function to render a plan option
            const renderPlanOption = (planKey, plan, isBusiness) => {
                const div = document.createElement('div');
                div.className = 'cd-plan-option';
                
                let priceHtml = '';
                let displayPrice = plan.price;
                let hasDiscount = false;
                
                // Check if this plan is eligible for discounts
                const voicelineEligible = plan.voicelineEligible !== false;
                const autopayEligible = plan.autopayEligible !== false;
                
                // Apply voiceline discount first (or existing mode with plan cost) - only if eligible
                if ((hasVoiceline || existingHasPlanCost) && voicelineEligible) {
                    displayPrice = plan.priceWithVoiceline;
                    hasDiscount = true;
                }
                
                // Apply 55+ savings ($5 off) for first HI - only if voiceline eligible
                if (is55SavingsEligible && voicelineEligible) {
                    displayPrice -= 5;
                    hasDiscount = true;
                }
                
                // Apply autopay discount ($5) if available and eligible
                if (autopayAvailableForNewHI && autopayEligible) {
                    displayPrice -= 5;
                    hasDiscount = true;
                }
                
                // Show pricing based on discounts
                if (hasDiscount) {
                    priceHtml = `<span class="cd-plan-price"><span class="original">$${plan.price}</span><span class="discounted">$${displayPrice}/mo</span></span>`;
                } else {
                    priceHtml = `<span class="cd-plan-price">$${plan.price}/mo</span>`;
                }
                
                // Get MP link for this plan
                const mpLink = MP_LINKS.homeInternet[planKey] || '';
                const mpHtml = mpLink ? `<a href="${mpLink}" target="_blank" class="mp-link-small" onclick="event.stopPropagation();">Magenta Pulse</a>` : '';
                
                div.innerHTML = `
                    <div style="display: flex; flex-direction: column; gap: 2px;">
                        <span class="cd-plan-name">${planKey}</span>
                        ${mpHtml}
                    </div>
                    ${priceHtml}
                `;
                div.onclick = () => selectHIPlan(rowId, planKey, isBusiness);
                container.appendChild(div);
            };
            
            // If no plan selected, show both regular and business options
            if (noPlanSelected) {
                // Add section header for Home Internet
                const hiHeader = document.createElement('div');
                hiHeader.style.cssText = 'padding: 8px 12px; background: #f0f0f0; font-weight: 700; font-size: 0.85rem; color: var(--text-main); text-transform: uppercase;';
                hiHeader.textContent = 'Internet';
                container.appendChild(hiHeader);
                
                Object.keys(HOME_INTERNET_PLANS).forEach(planKey => {
                    renderPlanOption(planKey, HOME_INTERNET_PLANS[planKey], false);
                });
                
                // Add section header for Business Internet
                const bizHeader = document.createElement('div');
                bizHeader.style.cssText = 'padding: 8px 12px; background: #f0f0f0; font-weight: 700; font-size: 0.85rem; color: var(--text-main); text-transform: uppercase; margin-top: 10px;';
                bizHeader.textContent = 'Business Internet';
                container.appendChild(bizHeader);
                
                Object.keys(BUSINESS_HOME_INTERNET_PLANS).forEach(planKey => {
                    renderPlanOption(planKey, BUSINESS_HOME_INTERNET_PLANS[planKey], true);
                });
            } else {
                // Plan selected - show filtered based on plan type
                const plansToShow = isBusinessPlan ? BUSINESS_HOME_INTERNET_PLANS : HOME_INTERNET_PLANS;
                Object.keys(plansToShow).forEach(planKey => {
                    renderPlanOption(planKey, plansToShow[planKey], isBusinessPlan);
                });
            }
        }
        
        function selectHIPlan(rowId, planKey, isBusinessPlan = false) {
            // Check max home internet (4)
            if (STATE[rowId].homeInternet.length >= 4) {
                alert('Maximum of 4 internet plans allowed per quote.');
                return;
            }
            
            // Get plan from appropriate list
            const planList = isBusinessPlan ? BUSINESS_HOME_INTERNET_PLANS : HOME_INTERNET_PLANS;
            const plan = planList[planKey];
            
            const item = {
                planKey: planKey,
                planData: plan,
                label: planKey,
                isBusinessPlan: isBusinessPlan
            };
            
            STATE[rowId].homeInternet.push(item);
            validateDiscounts(rowId);
            renderHIList(rowId);
            calculateRow(rowId);
            closeHIModal();
        }
        
        function saveHIItem() {
            // Keep for compatibility but selectHIPlan now handles this
            const rowId = document.getElementById('hi-row-id').value;
            
            // Check max home internet (4)
            if (STATE[rowId].homeInternet.length >= 4) {
                alert('Maximum of 4 internet plans allowed per quote.');
                return;
            }
            
            const planKey = document.getElementById('hi-selected-plan-key').value;
            // Check both plan lists
            const plan = HOME_INTERNET_PLANS[planKey] || BUSINESS_HOME_INTERNET_PLANS[planKey];
            const isBusinessPlan = !!BUSINESS_HOME_INTERNET_PLANS[planKey];
            
            const item = {
                planKey: planKey,
                planData: plan,
                label: planKey,
                isBusinessPlan: isBusinessPlan
            };
            
            STATE[rowId].homeInternet.push(item);
            validateDiscounts(rowId);
            closeHIModal();
            // Use setTimeout to ensure DOM updates after modal closes
            setTimeout(() => {
                renderHIList(rowId);
                calculateRow(rowId);
            }, 0);
        }
        
        function removeHIItem(rowId, index) {
            STATE[rowId].homeInternet.splice(index, 1);
            validateDiscounts(rowId);
            // Use setTimeout to ensure DOM updates properly
            setTimeout(() => {
                renderHIList(rowId);
                calculateRow(rowId);
            }, 0);
        }
        
        function renderHIList(rowId) {
            const container = document.getElementById(`hi-list-${rowId}`);
            container.innerHTML = '';
            
            const row = document.getElementById(rowId);
            const isManualMode = (row.getAttribute('data-mode') === 'existing');
            const lineCount = parseInt(document.getElementById(`${rowId}-lines`).value) || 0;
            const planEl = document.getElementById(`${rowId}-plan`);
            const planName = planEl ? planEl.value : '';
            const is55Plan = planName && planName.includes('55');
            const hasVoiceline = lineCount >= 1;
            
            // Check for autopay - either from discounts (new mode) or checkbox (existing mode)
            let hasAutopay = STATE[rowId].discounts.some(d => d.type === 'Autopay Discount');
            if (isManualMode) {
                const autopayCheckbox = document.getElementById(`${rowId}-has-autopay`);
                hasAutopay = autopayCheckbox ? autopayCheckbox.checked : false;
            }
            
            // For existing mode, check if plan cost is filled to determine bundle eligibility
            const baseTotal = isManualMode ? (parseFloat(document.getElementById(`${rowId}-manual-price`)?.value) || 0) : 0;
            const existingHasPlanCost = isManualMode && baseTotal > 0;
            
            // Calculate autopay slots available for HI (only count autopay-eligible HI)
            // Voice lines get autopay up to maxAutopayLines (if defined) or all lines
            const voicePlanAutopayEligible = PLANS_DATA[planName]?.autopayEligible !== false;
            const maxAutopayLines = PLANS_DATA[planName]?.maxAutopayLines;
            
            // In existing mode with autopay enabled, lines count towards autopay limit
            let voiceAutopayUsed = 0;
            if (isManualMode) {
                // In existing mode, if autopay is enabled, all lines count towards the limit
                voiceAutopayUsed = hasAutopay ? Math.min(lineCount, 8) : 0;
                
                // Add voice lines to the count
                if (STATE[rowId].voiceLines && STATE[rowId].voiceLines.length > 0) {
                    STATE[rowId].voiceLines.forEach(group => {
                        voiceAutopayUsed = Math.min(voiceAutopayUsed + group.quantity, 8);
                    });
                }
            } else {
                // In new mode, use the plan's autopay eligibility
                const voiceLinesForAutopay = maxAutopayLines !== undefined 
                    ? Math.min(lineCount, maxAutopayLines) 
                    : lineCount;
                voiceAutopayUsed = voicePlanAutopayEligible ? Math.min(voiceLinesForAutopay, 8) : 0;
            }
            
            let autopayUsed = voiceAutopayUsed;
            const maxAutopay = 8;
            const maxBundleDiscount = 2; // Max 2 HI can get bundle discount
            let bundleDiscountUsed = 0;
            
            STATE[rowId].homeInternet.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'item-pill';
                
                const plan = item.planData;
                let price = plan.price;
                let originalPrice = plan.price;
                let hasDiscount = false;
                
                // Check eligibility flags
                const voicelineEligible = plan.voicelineEligible !== false;
                const autopayEligible = plan.autopayEligible !== false;
                
                // Apply voiceline bundling only to first 2 eligible HI
                // In existing mode, apply if plan cost is filled
                if ((hasVoiceline || existingHasPlanCost) && voicelineEligible && bundleDiscountUsed < maxBundleDiscount) {
                    price = plan.priceWithVoiceline;
                    hasDiscount = true;
                    bundleDiscountUsed++;
                }
                
                // Apply 55+ savings ($5 off) for first HI on 55+ plans (new mode only, voiceline eligible)
                if (!isManualMode && is55Plan && index === 0 && voicelineEligible) {
                    price -= 5;
                    hasDiscount = true;
                }
                
                // Apply autopay ($5 off) if slots available and eligible
                if (hasAutopay && autopayEligible && autopayUsed < maxAutopay) {
                    price -= 5;
                    autopayUsed++;
                    hasDiscount = true;
                }
                
                // Conditionally show price based on showItemizedPrices setting
                let priceText = '';
                if (showItemizedPrices.homeInternet) {
                    if (hasDiscount) {
                        priceText = ` <span class="price-strikethrough">$${originalPrice}</span> <span class="price-deal">$${price.toFixed(2)}/mo</span>`;
                    } else {
                        priceText = ` ($${price.toFixed(2)}/mo)`;
                    }
                }
                
                // Print price (only shown if itemized prices enabled)
                let printPriceHtml = '';
                if (showItemizedPrices.homeInternet) {
                    if (hasDiscount) {
                        printPriceHtml = `
                            <span class="hi-print-price-wrapper">
                                <span class="hi-print-original">$${originalPrice}</span>
                                <span class="hi-print-price">$${price.toFixed(2)}/mo</span>
                            </span>
                        `;
                    } else {
                        printPriceHtml = `<span class="hi-print-price">$${price.toFixed(2)}/mo</span>`;
                    }
                }
                
                div.innerHTML = `
                    <div class="hi-screen-only">
                        <span class="item-text">${item.label}${priceText}</span>
                        <span class="remove-x" onclick="removeHIItem('${rowId}', ${index})"></span>
                    </div>
                    <div class="hi-print-only">
                        <span class="hi-print-name">${item.label}</span>
                        ${printPriceHtml}
                    </div>
                `;
                container.appendChild(div);
            });
            
            const hiWrapper = document.getElementById(`${rowId}-col-internet`);
            if (STATE[rowId].homeInternet.length === 0) hiWrapper.classList.add('print-hidden');
            else hiWrapper.classList.remove('print-hidden');
        }

        // --- DISCOUNT LOGIC ---
        function openDiscountModal(rowId) {
            // Check if button is disabled
            const btn = document.getElementById(`${rowId}-discount-btn`);
            if (btn && btn.classList.contains('btn-disabled')) return;
            
            const row = document.getElementById(rowId);
            const isManualMode = (row.getAttribute('data-mode') === 'existing');
            
            if (isManualMode) {
                // Open the manual discount modal for existing mode
                document.getElementById('manual-disc-row-id').value = rowId;
                document.getElementById('manual-disc-name').value = '';
                document.getElementById('manual-disc-amount').value = '';
                document.getElementById('manual-discount-modal').classList.add('open');
            } else {
                document.getElementById('disc-row-id').value = rowId;
                renderDiscountModalList(rowId);
                document.getElementById('discount-modal').classList.add('open');
            }
        }
        
        function closeDiscountModal() {
             document.getElementById('discount-modal').classList.remove('open');
        }
        
        function closeManualDiscountModal() {
            document.getElementById('manual-discount-modal').classList.remove('open');
        }
        
        function saveManualDiscountItem() {
            const rowId = document.getElementById('manual-disc-row-id').value;
            const name = document.getElementById('manual-disc-name').value.trim();
            const amount = parseFloat(document.getElementById('manual-disc-amount').value) || 0;
            
            if (!name) {
                alert('Please enter a discount name');
                return;
            }
            
            STATE[rowId].discounts.push({type:'Manual', name: name, amount: amount});
            renderDiscountList(rowId);
            calculateRow(rowId);
            closeManualDiscountModal();
        }

        function addDiscountItem(rowId) { 
            STATE[rowId].discounts.push({type:'Manual', name:'', amount:0}); 
            renderDiscountList(rowId); calculateRow(rowId); 
        }

        function removeDiscountItem(rowId, i) { 
            STATE[rowId].discounts.splice(i,1); 
            renderDiscountList(rowId); 
            calculateRow(rowId); 
        }
        function updateManualDiscount(rowId, i, f, v) { if(f==='amount') STATE[rowId].discounts[i].amount=parseFloat(v)||0; else STATE[rowId].discounts[i].name=v; calculateRow(rowId); }
        
        function formatDiscountAmount(input, rowId, index) {
            // Parse the value
            const amount = parseFloat(input.value) || 0;
            
            // Update the state with the amount
            STATE[rowId].discounts[index].amount = amount;
            
            // Convert back to text type and format with parentheses
            input.type = 'text';
            if (amount > 0) {
                input.value = `($${amount.toFixed(2)})`;
            } else {
                input.value = '';
                input.placeholder = 'Amount';
            }
            
            calculateRow(rowId);
        }
        
        function addDiscountOption(rowId, type) {
             const discounts = STATE[rowId].discounts;
             if (!discounts.find(d => d.type === type)) {
                 discounts.push({ type: type });
             }
             calculateRow(rowId); 
             renderDiscountList(rowId);
             renderCDList(rowId);
             renderHIList(rowId);
             closeDiscountModal();
        }
        
        function removeDiscountByType(rowId, type) {
             const discounts = STATE[rowId].discounts;
             const idx = discounts.findIndex(d => d.type === type);
             if (idx > -1) discounts.splice(idx, 1);
             calculateRow(rowId); 
             renderDiscountList(rowId);
             renderCDList(rowId);
             renderHIList(rowId);
        }

        function renderDiscountModalList(rowId) {
             const container = document.getElementById('disc-list');
             container.innerHTML = '';
             
             const lineCount = parseInt(document.getElementById(`${rowId}-lines`).value) || 0;
             const planName = document.getElementById(`${rowId}-plan`).value;
             const isPremium = PREMIUM_PLANS.includes(planName);
             const isBusinessPlan = PLANS_DATA[planName]?.planType === 'Business';
             const currentDiscounts = STATE[rowId].discounts.map(d => d.type);
             // Only hide autopay if a plan is selected AND it's not autopay eligible
             const planAutopayEligible = !planName || PLANS_DATA[planName]?.autopayEligible !== false;
             // Check maxAutopayLines and removeAutopayAfterMax
             const planData = PLANS_DATA[planName];
             const maxAutopayLines = planData?.maxAutopayLines;
             const removeAutopayAfterMax = planData?.removeAutopayAfterMax === true;
             const exceedsMaxAutopay = maxAutopayLines !== undefined && lineCount > maxAutopayLines;
             
             // Check if there are connected devices or home internet that could use autopay
             const cdCount = STATE[rowId].connectedDevices?.length || 0;
             const hiCount = STATE[rowId].homeInternet?.length || 0;
             const hasCDorHI = cdCount > 0 || hiCount > 0;
             
             // Check if any CD/HI have autopay eligibility
             const hasCDWithAutopay = STATE[rowId].connectedDevices?.some(cd => {
                 return cd.planData && cd.planData.autopayEligible !== false;
             }) || false;
             
             const hasHIWithAutopay = STATE[rowId].homeInternet?.some(hi => {
                 const hiPlanData = HOME_INTERNET_PLANS[hi.planName];
                 return hiPlanData && hiPlanData.autopayEligible !== false;
             }) || false;
             
             const hasCDorHIWithAutopay = hasCDWithAutopay || hasHIWithAutopay;
             
             // Autopay is valid if:
             // 1. Plan is autopay eligible (maxAutopayLines just limits it, doesn't disable), OR
             // 2. Has CD/HI with autopay eligibility, OR
             // 3. removeAutopayAfterMax is NOT active (either flag is false or lines don't exceed max)
             // Autopay is INVALID if:
             // removeAutopayAfterMax is true AND lines exceed maxAutopayLines AND no CD/HI with autopay
             const autopayValid = (planAutopayEligible || hasCDorHIWithAutopay) && 
                                 !(removeAutopayAfterMax && exceedsMaxAutopay && !hasCDorHIWithAutopay);
             
             // Build autopay label
             let autopayLabel = 'Autopay ($5/line)';
             if (!planAutopayEligible && hasCDorHI) {
                 autopayLabel = 'Autopay (CD/HI only)';
             } else if (maxAutopayLines !== undefined && lineCount > maxAutopayLines) {
                 autopayLabel = `Autopay ($5/line, up to ${maxAutopayLines} lines)`;
             }
             
             // Check if Work Perks or Insider is already applied (they're mutually exclusive)
             const hasWorkPerks = currentDiscounts.includes('Work Perks');
             const hasInsider = currentDiscounts.includes('Insider Discount');
             
             // Work Perks: valid if premium, 2 or fewer lines, NOT a business plan, and Insider not applied
             const workPerksValid = isPremium && lineCount <= 2 && !isBusinessPlan && !hasInsider;
             // Insider: valid if premium and Work Perks not applied
             const insiderValid = isPremium && !hasWorkPerks;
             
             const options = [
                 { type: 'Autopay Discount', label: autopayLabel, valid: autopayValid },
                 { type: 'Free Line', label: '3rd Line Free', valid: lineCount >= 3 && PLANS_DATA[planName] && PLANS_DATA[planName].freeLineEligible !== false },
                 { type: 'Work Perks', label: 'Work Perks (15%)', valid: workPerksValid },
                 { type: 'Insider Discount', label: 'Insider Discount (20%)', valid: insiderValid }
             ];
             
             let availableCount = 0;
             options.forEach(opt => {
                 // Only show if valid AND not already applied
                 if(opt.valid && !currentDiscounts.includes(opt.type)) {
                     availableCount++;
                     const btn = document.createElement('button');
                     btn.className = 'discount-btn-option';
                     btn.textContent = opt.label;
                     btn.onclick = () => addDiscountOption(rowId, opt.type);
                     container.appendChild(btn);
                 }
             });
             
             if (availableCount === 0) {
                 container.innerHTML = '<div style="text-align:center; color:#666; padding: 20px;">No more discounts available for this configuration.</div>';
             }
        }

        function renderDiscountList(rowId) { 
             const container = document.getElementById(`discount-list-${rowId}`); container.innerHTML = '';
             const row = document.getElementById(rowId); const isManual = (row.getAttribute('data-mode')==='existing');
             
             if (isManual) {
                 STATE[rowId].discounts.forEach((item, index) => {
                     const div = document.createElement('div'); 
                     div.className = 'item-pill';
                     const displayName = item.name || 'Discount';
                     div.innerHTML = `<span class="item-text">${displayName}</span><span class="remove-x" onclick="removeDiscountItem('${rowId}', ${index})"></span>`;
                     container.appendChild(div);
                 });
             } else {
                 STATE[rowId].discounts.forEach((item, index) => {
                     const div = document.createElement('div'); 
                     div.className = 'item-pill';
                     const escapedType = (item.type || '').replace(/'/g, "\\'");
                     div.innerHTML = `<span class="item-text">${item.type}</span><span class="remove-x" onclick="removeDiscountByType('${rowId}', '${escapedType}')"></span>`;
                     container.appendChild(div);
                 });
             }

             const w = document.getElementById(`${rowId}-col-discounts`); 
             if(STATE[rowId].discounts.length===0 && !isManual) w.classList.add('print-hidden'); 
             else w.classList.remove('print-hidden');
        }

        // --- REBATE MODAL LOGIC ---
        function openRebateModal(rowId) {
            // Check if button is disabled
            const btn = document.getElementById(`${rowId}-rebate-btn`);
            if (btn && btn.classList.contains('btn-disabled')) return;
            
            document.getElementById('rebate-row-id').value = rowId;
            document.getElementById('rebate-pill-selected').value = '';
            // Reset pills
            document.querySelectorAll('.rebate-pill').forEach(p => p.classList.remove('active'));
            document.getElementById('rebate-modal-name').value = '';
            document.getElementById('rebate-modal-value').value = '';
            document.getElementById('rebate-modal-count').value = '1';
            document.getElementById('rebate-modal').classList.add('open');
        }
        
        function selectRebatePill(el, pillValue) {
            const nameInput = document.getElementById('rebate-modal-name');
            // Toggle off if already selected
            if (el.classList.contains('active')) {
                el.classList.remove('active');
                document.getElementById('rebate-pill-selected').value = '';
                // Clear the name if it matches the pill value
                if (nameInput.value === pillValue) {
                    nameInput.value = '';
                }
            } else {
                // Deselect all, select this one
                document.querySelectorAll('.rebate-pill').forEach(p => p.classList.remove('active'));
                el.classList.add('active');
                document.getElementById('rebate-pill-selected').value = pillValue;
                // Auto-fill the rebate name
                nameInput.value = pillValue;
            }
        }

        function closeRebateModal() {
            document.getElementById('rebate-modal').classList.remove('open');
        }
        
        function updateRebateModalCount(change) {
             const input = document.getElementById('rebate-modal-count');
             let val = parseInt(input.value) + change;
             if(val < 1) val = 1;
             input.value = val;
        }

        function saveRebateItem() {
            const rowId = document.getElementById('rebate-row-id').value;
            let name = document.getElementById('rebate-modal-name').value.trim();
            const pillValue = document.getElementById('rebate-pill-selected').value;
            const val = parseFloat(document.getElementById('rebate-modal-value').value) || 0;
            const count = parseInt(document.getElementById('rebate-modal-count').value) || 1;
            
            // Handle rebate name with pill value
            // If pill is selected and name is exactly the pill value (not modified), add "Gift Card"
            // If name was modified by user, use it as-is (user already included what they want)
            if (pillValue && name === pillValue) {
                // User selected pill but didn't modify the auto-filled name
                name = `${pillValue} Gift Card`;
            } else if (!name && pillValue) {
                // No name entered but pill selected
                name = `${pillValue} Gift Card`;
            }
            // Otherwise use the name as-is (user entered custom name)
            
            if(name) {
                STATE[rowId].rebates.push({ name: name, value: val, count: count });
                renderRebateList(rowId); 
                calculateRow(rowId);
            }
            document.getElementById('rebate-modal-name').value = '';
            document.getElementById('rebate-modal-value').value = '';
            document.getElementById('rebate-modal-count').value = '1';
            document.getElementById('rebate-pill-selected').value = '';
            document.querySelectorAll('.rebate-pill').forEach(p => p.classList.remove('active'));
            
            closeRebateModal();
        }

        function removeRebateItem(rowId, i) { 
            STATE[rowId].rebates.splice(i,1); 
            renderRebateList(rowId); 
            calculateRow(rowId); 
        }

        function renderRebateList(rowId) { 
            const container = document.getElementById(`rebate-list-${rowId}`); container.innerHTML = '';
            STATE[rowId].rebates.forEach((item, index) => {
                const div = document.createElement('div'); 
                div.className = 'item-pill';
                const totalVal = (item.value * item.count).toFixed(2);
                div.innerHTML = `<span class="item-text">${item.count}x ${item.name} ($${totalVal})</span><span class="remove-x" onclick="removeRebateItem('${rowId}', ${index})"></span>`;
                container.appendChild(div);
            });
            const w = document.getElementById(`${rowId}-col-rebates`); if(STATE[rowId].rebates.length===0) w.classList.add('print-hidden'); else w.classList.remove('print-hidden');
        }
        
        // --- ACCESSORIES MODAL LOGIC ---
        function openAccessoriesModal(rowId) {
            document.getElementById('acc-row-id').value = rowId;
            document.getElementById('acc-name').value = '';
            document.getElementById('acc-price').value = '';
            document.getElementById('acc-qty').value = '1';
            document.querySelector('input[name="acc-payment"][value="finance"]').checked = true;
            // Clear pill selections
            document.querySelectorAll('.acc-pill').forEach(p => p.classList.remove('active'));
            renderAccessoriesModalList(rowId);
            document.getElementById('accessories-modal').classList.add('open');
        }
        
        function closeAccessoriesModal() {
            document.getElementById('accessories-modal').classList.remove('open');
            const rowId = document.getElementById('acc-row-id').value;
            if (rowId) {
                renderAccessoriesList(rowId);
                calculateRow(rowId);
            }
        }
        
        function updateAccQty(change) {
            const input = document.getElementById('acc-qty');
            let val = parseInt(input.value) + change;
            if (val < 1) val = 1;
            input.value = val;
        }
        
        function selectAccessoryPill(name) {
            // Set the accessory name input
            document.getElementById('acc-name').value = name;
            // Toggle active state on pills
            document.querySelectorAll('.acc-pill').forEach(p => {
                if (p.textContent === name) {
                    p.classList.add('active');
                } else {
                    p.classList.remove('active');
                }
            });
        }
        
        function saveAccessoryItem() {
            const rowId = document.getElementById('acc-row-id').value;
            let name = document.getElementById('acc-name').value.trim();
            const price = parseFloat(document.getElementById('acc-price').value) || 0;
            const qty = parseInt(document.getElementById('acc-qty').value) || 1;
            const paymentMethod = document.querySelector('input[name="acc-payment"]:checked').value;
            
            // Default to "Accessory" if no name entered
            if (!name) {
                name = 'Accessory';
            }
            
            STATE[rowId].accessories.push({
                name: name,
                price: price,
                quantity: qty,
                paymentMethod: paymentMethod // 'finance' or 'today'
            });
            
            // Clear inputs and pills
            document.getElementById('acc-name').value = '';
            document.getElementById('acc-price').value = '';
            document.getElementById('acc-qty').value = '1';
            document.querySelectorAll('.acc-pill').forEach(p => p.classList.remove('active'));
            
            renderAccessoriesModalList(rowId);
            renderDeviceList(rowId);
            calculateRow(rowId);
        }
        
        function removeAccessoryItem(rowId, index) {
            STATE[rowId].accessories.splice(index, 1);
            renderAccessoriesModalList(rowId);
            renderDeviceList(rowId);
            calculateRow(rowId);
        }
        
        function editAccessoryItem(rowId, index) {
            const acc = STATE[rowId].accessories[index];
            document.getElementById('acc-name').value = acc.name;
            document.getElementById('acc-price').value = acc.price;
            document.getElementById('acc-qty').value = acc.quantity;
            document.querySelector(`input[name="acc-payment"][value="${acc.paymentMethod}"]`).checked = true;
            
            // Remove the item and let user re-add it with changes
            STATE[rowId].accessories.splice(index, 1);
            renderAccessoriesModalList(rowId);
            renderDeviceList(rowId);
            calculateRow(rowId);
        }
        
        function renderAccessoriesModalList(rowId) {
            const container = document.getElementById('acc-existing-list');
            container.innerHTML = '';
            
            if (STATE[rowId].accessories.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); font-style: italic;">No accessories added yet</div>';
                return;
            }
            
            STATE[rowId].accessories.forEach((item, index) => {
                const totalPrice = (item.price * item.quantity).toFixed(2);
                const paymentText = item.paymentMethod === 'finance' ? `$${(item.price / 12).toFixed(2)}/mo  12` : `Due Today`;
                const div = document.createElement('div');
                div.className = 'modal-list-item';
                div.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: #f9f9f9; border-radius: 6px; margin-bottom: 8px;';
                div.innerHTML = `
                    <div>
                        <div style="font-weight: 600;">${item.quantity}x ${item.name}</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">$${totalPrice} - ${paymentText}</div>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <button class="btn btn-small btn-small-edit" onclick="editAccessoryItem('${rowId}', ${index})">Edit</button>
                        <span style="cursor: pointer; color: var(--danger-color); font-weight: bold; font-size: 1.2rem; padding: 0 5px;" onclick="removeAccessoryItem('${rowId}', ${index})"></span>
                    </div>
                `;
                container.appendChild(div);
            });
        }
        
        function renderAccessoriesList(rowId) {
            // Accessories are now rendered directly into the device list by renderDeviceList
            // This function is kept for compatibility but the actual rendering happens in renderDeviceList
        }
        
        // --- DUE TODAY MODAL FUNCTIONS ---
        function openDueTodayModal(rowId) {
            document.getElementById('due-today-row-id').value = rowId;
            document.getElementById('due-today-desc').value = '';
            document.getElementById('due-today-amount').value = '';
            document.getElementById('saved-today-desc').value = '';
            document.getElementById('saved-today-amount-input').value = '';
            document.getElementById('tax-percentage').value = taxPercentage > 0 ? taxPercentage : '';
            renderDueTodayItemsList(rowId);
            renderSavedTodayItemsList(rowId);
            document.getElementById('due-today-modal').classList.add('open');
        }
        
        function closeDueTodayModal() {
            document.getElementById('due-today-modal').classList.remove('open');
            const rowId = document.getElementById('due-today-row-id').value;
            if (rowId) {
                calculateRow(rowId);
            }
        }
        
        function updateDueTodayQty(delta) {
            const input = document.getElementById('due-today-qty');
            let val = parseInt(input.value) || 1;
            val = Math.max(1, Math.min(99, val + delta));
            input.value = val;
        }
        
        function updateSavedTodayQty(delta) {
            const input = document.getElementById('saved-today-qty');
            let val = parseInt(input.value) || 1;
            val = Math.max(1, Math.min(99, val + delta));
            input.value = val;
        }
        
        function updateAddonQty(delta) {
            const input = document.getElementById('addon-amount-input');
            let val = parseInt(input.value) || 1;
            val = Math.max(1, Math.min(12, val + delta));
            input.value = val;
        }
        
        function addDueTodayItem() {
            const rowId = document.getElementById('due-today-row-id').value;
            const description = document.getElementById('due-today-desc').value.trim();
            const amount = parseFloat(document.getElementById('due-today-amount').value) || 0;
            const quantity = parseInt(document.getElementById('due-today-qty').value) || 1;
            
            if (!description || amount <= 0) {
                alert('Please enter a description and amount');
                return;
            }
            
            STATE[rowId].dueTodayItems.push({ description, amount, quantity });
            
            document.getElementById('due-today-desc').value = '';
            document.getElementById('due-today-amount').value = '';
            document.getElementById('due-today-qty').value = '1';
            
            renderDueTodayItemsList(rowId);
            calculateRow(rowId);
        }
        
        function removeDueTodayItem(rowId, index) {
            STATE[rowId].dueTodayItems.splice(index, 1);
            renderDueTodayItemsList(rowId);
            calculateRow(rowId);
        }
        
        function renderDueTodayItemsList(rowId) {
            const container = document.getElementById('due-today-items-list');
            container.innerHTML = '';
            
            // Show accessories marked as "due today"
            const accessoriesDueToday = STATE[rowId].accessories.filter(a => a.paymentMethod === 'today');
            
            // Show custom due today items
            const customItems = STATE[rowId].dueTodayItems || [];
            
            if (accessoriesDueToday.length === 0 && customItems.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); font-style: italic; padding: 10px;">No items due today</div>';
                return;
            }
            
            // Render accessories due today
            accessoriesDueToday.forEach((acc, idx) => {
                const totalPrice = (acc.price * acc.quantity).toFixed(2);
                const div = document.createElement('div');
                div.className = 'modal-list-item';
                div.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: #f9f9f9; border-radius: 6px; margin-bottom: 8px;';
                div.innerHTML = `
                    <div>
                        <div style="font-weight: 600;">${acc.quantity}x ${acc.name}</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">Accessory</div>
                    </div>
                    <div style="font-weight: 700; color: var(--primary-color);">$${totalPrice}</div>
                `;
                container.appendChild(div);
            });
            
            // Render custom items
            customItems.forEach((item, index) => {
                const qty = item.quantity || 1;
                const totalAmount = item.amount * qty;
                const div = document.createElement('div');
                div.className = 'modal-list-item';
                div.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: #f9f9f9; border-radius: 6px; margin-bottom: 8px;';
                div.innerHTML = `
                    <div>
                        <div style="font-weight: 600;">${qty > 1 ? qty + 'x ' : ''}${item.description}</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">${qty > 1 ? ' ($' + item.amount.toFixed(2) + ' each)' : ''}</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-weight: 700; color: var(--primary-color);">$${totalAmount.toFixed(2)}</span>
                        <span style="cursor: pointer; color: var(--danger-color); font-weight: bold; font-size: 1.2rem;" onclick="removeDueTodayItem('${rowId}', ${index})"></span>
                    </div>
                `;
                container.appendChild(div);
            });
        }
        
        function addSavedTodayItem() {
            const rowId = document.getElementById('due-today-row-id').value;
            const description = document.getElementById('saved-today-desc').value.trim();
            const amount = parseFloat(document.getElementById('saved-today-amount-input').value) || 0;
            const quantity = parseInt(document.getElementById('saved-today-qty').value) || 1;
            
            if (!description || amount <= 0) {
                alert('Please enter a description and amount');
                return;
            }
            
            if (!STATE[rowId].savedTodayItems) {
                STATE[rowId].savedTodayItems = [];
            }
            STATE[rowId].savedTodayItems.push({ description, amount, quantity });
            
            document.getElementById('saved-today-desc').value = '';
            document.getElementById('saved-today-amount-input').value = '';
            document.getElementById('saved-today-qty').value = '1';
            
            renderSavedTodayItemsList(rowId);
            // Update savingsToday total with all saved items
            updateSavingsTodayFromItems(rowId);
            calculateRow(rowId);
        }
        
        function removeSavedTodayItem(rowId, index) {
            STATE[rowId].savedTodayItems.splice(index, 1);
            renderSavedTodayItemsList(rowId);
            updateSavingsTodayFromItems(rowId);
            calculateRow(rowId);
        }
        
        function updateSavingsTodayFromItems(rowId) {
            const savedItems = STATE[rowId].savedTodayItems || [];
            const total = savedItems.reduce((sum, item) => sum + (item.amount * (item.quantity || 1)), 0);
            STATE[rowId].savingsToday = total;
        }
        
        function renderSavedTodayItemsList(rowId) {
            const container = document.getElementById('saved-today-items-list');
            container.innerHTML = '';
            
            const savedItems = STATE[rowId].savedTodayItems || [];
            
            if (savedItems.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); font-style: italic; padding: 10px;">No savings items</div>';
                return;
            }
            
            // Render saved items
            let totalSaved = 0;
            savedItems.forEach((item, index) => {
                const qty = item.quantity || 1;
                const totalAmount = item.amount * qty;
                totalSaved += totalAmount;
                const div = document.createElement('div');
                div.className = 'modal-list-item';
                div.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: #f9f9f9; border-radius: 6px; margin-bottom: 8px;';
                div.innerHTML = `
                    <div>
                        <div style="font-weight: 600;">${qty > 1 ? qty + 'x ' : ''}${item.description}</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">${qty > 1 ? ' ($' + item.amount.toFixed(2) + ' each)' : ''}</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-weight: 700; color: var(--primary-color);">$${totalAmount.toFixed(2)}</span>
                        <span style="cursor: pointer; color: #ef4444; font-weight: bold; font-size: 1.2rem;" onclick="removeSavedTodayItem('${rowId}', ${index})"></span>
                    </div>
                `;
                container.appendChild(div);
            });
            
            // Add total if multiple items
            if (savedItems.length > 1) {
                const totalDiv = document.createElement('div');
                totalDiv.style.cssText = 'display: flex; justify-content: space-between; padding: 8px 12px; background: var(--primary-color); color: white; border-radius: 6px; font-weight: 700;';
                totalDiv.innerHTML = `<span>Total Savings</span><span>$${totalSaved.toFixed(2)}</span>`;
                container.appendChild(totalDiv);
            }
        }
        
        // --- RENDER SUMMARIES ---
        function renderRebateSummary(rowId) {
            const container = document.getElementById(`${rowId}-rebate-summary`);
            const list = document.getElementById(`${rowId}-rebate-list-summary`);
            const grandTotalEl = document.getElementById(`${rowId}-rebate-grand-total`);
            
            if (STATE[rowId].rebates.length === 0) { 
                container.classList.remove('visible'); 
                container.style.display = 'none';
                list.innerHTML = ''; // Clear stale list
                grandTotalEl.textContent = ''; // Clear stale total
                return; 
            }
            
            container.classList.add('visible');
            container.style.display = 'flex';
            
            let html = '';
            let grandTotal = 0;
            const map = {}; 
            STATE[rowId].rebates.forEach(r => { 
                const key = `${r.name}-${r.value}`; 
                if(!map[key]) map[key] = { ...r, totalCount: 0 }; 
                map[key].totalCount += r.count; 
            });
            
            Object.values(map).forEach(reb => {
                const name = reb.name || 'Rebate'; 
                const totalVal = (reb.value * reb.totalCount);
                grandTotal += totalVal;
                const countText = reb.totalCount > 1 ? `${reb.totalCount}x ` : '';
                const perItemText = reb.totalCount > 1 ? ` ($${reb.value.toFixed(2)}/ea)` : '';
                html += `<div class="rebate-summary-item">${countText}${name}: <b>$${totalVal.toFixed(2)}${perItemText}</b></div>`;
            });
            list.innerHTML = html;
            grandTotalEl.textContent = `Up to $${grandTotal.toFixed(2)} in Rebates`;
        }

        function renderDiscountSummary(rowId, savingsData) {
            const container = document.getElementById(`${rowId}-discount-summary`);
            const list = document.getElementById(`${rowId}-discount-list-summary`);
            const totalEl = document.getElementById(`${rowId}-discount-total`);
            
            const {
                autopaySavingsVoice = 0,
                autopaySavingsHI = 0,
                autopaySavingsCD = 0,
                freeLineSavings = 0,
                percentageSavings = 0,
                percentageSavingsType = '',
                planTypeSavings = 0,
                planTypeSavingsLabel = '',
                devicePromoSavings = 0,
                hiBundlingSavings = 0,
                hi55Savings = 0,
                cdBeyondSavings = 0,
                cdBundlingSavings = 0,
                cdDevicePromoSavings = 0,
                cd2for1Savings = 0,
                manualDiscounts = 0,
                voiceLineBogo = 0
            } = savingsData;

            const totalSavings = autopaySavingsVoice + autopaySavingsHI + autopaySavingsCD + 
                                 freeLineSavings + percentageSavings + planTypeSavings + devicePromoSavings + 
                                 hiBundlingSavings + hi55Savings + cdBeyondSavings + cdBundlingSavings + 
                                 cdDevicePromoSavings + cd2for1Savings + manualDiscounts + voiceLineBogo;

            if (totalSavings <= 0) {
                container.classList.remove('visible');
                container.style.display = 'none';
                totalEl.innerHTML = ''; // Clear stale data
                list.innerHTML = ''; // Clear stale list
                return;
            }
            
            container.classList.add('visible');
            container.style.display = 'flex'; 

            let html = '';
            const row = document.getElementById(rowId);
            const isManualMode = (row.getAttribute('data-mode') === 'existing');

            // Plan Type Savings (Military, 55+, First Responder)
            if (planTypeSavings > 0) {
                html += `<div class="discount-summary-item">${planTypeSavingsLabel}: <b>-$${planTypeSavings.toFixed(2)}/mo</b></div>`;
            }
            
            // Voice Line BOGO savings (existing mode)
            if (voiceLineBogo > 0) {
                html += `<div class="discount-summary-item">BOGO Deal: <b>-$${voiceLineBogo.toFixed(2)}/mo</b></div>`;
            }

            // Autopay savings breakdown
            const totalAutopaySavings = autopaySavingsVoice + autopaySavingsHI + autopaySavingsCD;
            if (totalAutopaySavings > 0) {
                html += `<div class="discount-summary-item">Autopay Discount: <b>-$${totalAutopaySavings.toFixed(2)}/mo</b></div>`;
            }
            
            // Free line savings
            if (freeLineSavings > 0) {
                html += `<div class="discount-summary-item">3rd Line Free: <b>-$${freeLineSavings.toFixed(2)}/mo</b></div>`;
            }
            
            // Percentage savings (Work Perks / Insider) with specific labels
            if (percentageSavings > 0) {
                let discountLabel = 'Plan Discount';
                if (percentageSavingsType === 'Work Perks') {
                    discountLabel = 'Work Perks Savings';
                } else if (percentageSavingsType === 'Insider') {
                    discountLabel = 'Insider Discount';
                }
                html += `<div class="discount-summary-item">${discountLabel}: <b>-$${percentageSavings.toFixed(2)}/mo</b></div>`;
            }

            // Phone device promo savings
            if (devicePromoSavings > 0) {
                html += `<div class="discount-summary-item">Phone Promos: <b>-$${devicePromoSavings.toFixed(2)}/mo</b></div>`;
            }
            
            // Home Internet bundling savings
            if (hiBundlingSavings > 0) {
                html += `<div class="discount-summary-item">Internet Bundle Savings: <b>-$${hiBundlingSavings.toFixed(2)}/mo</b></div>`;
            }
            
            // 55+ Savings for Home Internet
            if (hi55Savings > 0) {
                html += `<div class="discount-summary-item">55+ Internet Savings: <b>-$${hi55Savings.toFixed(2)}/mo</b></div>`;
            }
            
            // Connected Device savings breakdown
            if (cdBeyondSavings > 0) {
                html += `<div class="discount-summary-item">Beyond Plan Connected Device Savings: <b>-$${cdBeyondSavings.toFixed(2)}/mo</b></div>`;
            }
            if (cdBundlingSavings > 0) {
                html += `<div class="discount-summary-item">Connected Device Bundle Savings: <b>-$${cdBundlingSavings.toFixed(2)}/mo</b></div>`;
            }
            if (cd2for1Savings > 0) {
                html += `<div class="discount-summary-item">Connected Device BOGO  Off: <b>-$${cd2for1Savings.toFixed(2)}/mo</b></div>`;
            }
            if (cdDevicePromoSavings > 0) {
                html += `<div class="discount-summary-item">Connected Device Promos: <b>-$${cdDevicePromoSavings.toFixed(2)}/mo</b></div>`;
            }
            
            // Manual discounts (existing mode)
            if (isManualMode && manualDiscounts > 0) {
                STATE[rowId].discounts.forEach(d => {
                    if (d.amount > 0) {
                        html += `<div class="discount-summary-item">${d.name || 'Discount'}: <b>-$${d.amount.toFixed(2)}/mo</b></div>`;
                    }
                });
            }

            list.innerHTML = html;
            
            // Display total with toggle between monthly and yearly
            const showYearly = STATE[rowId].showYearlySavings;
            if (showYearly) {
                const yearlySavings = totalSavings * 12;
                totalEl.innerHTML = `<span class="savings-toggle-text" onclick="toggleSavingsPeriod('${rowId}')" style="cursor:pointer;">Total Yearly Savings: $${yearlySavings.toFixed(2)}</span>`;
            } else {
                totalEl.innerHTML = `<span class="savings-toggle-text" onclick="toggleSavingsPeriod('${rowId}')" style="cursor:pointer;">Total Monthly Savings: $${totalSavings.toFixed(2)}</span>`;
            }
        }
        
        function toggleSavingsPeriod(rowId) {
            STATE[rowId].showYearlySavings = !STATE[rowId].showYearlySavings;
            // Re-render to update display - we need to call calculateRow to get savingsData
            calculateRow(rowId);
        }
        
        function updateSummaryWidths(rowId) {
            const rebateSummary = document.getElementById(`${rowId}-rebate-summary`);
            const discountSummary = document.getElementById(`${rowId}-discount-summary`);
            
            const rebateVisible = rebateSummary.style.display !== 'none';
            const discountVisible = discountSummary.style.display !== 'none';
            
            // Reset classes and widths
            rebateSummary.classList.remove('full-width');
            discountSummary.classList.remove('full-width');
            rebateSummary.style.maxWidth = '';
            discountSummary.style.maxWidth = '';
            
            // If only one is visible, make it full width
            if (rebateVisible && !discountVisible) {
                rebateSummary.classList.add('full-width');
                rebateSummary.style.maxWidth = '100%';
            } else if (!rebateVisible && discountVisible) {
                discountSummary.classList.add('full-width');
                discountSummary.style.maxWidth = '100%';
            } else if (rebateVisible && discountVisible) {
                rebateSummary.style.maxWidth = 'calc(50% - 8px)';
                discountSummary.style.maxWidth = 'calc(50% - 8px)';
            }
        }

        // --- CALCULATION CORE ---
        function calculateDeviceMonthly(cost, down, promo, fmv) {
            return (cost - down - (promo - fmv)) / 24;
        }

        function calculateRow(rowId) {
            let baseTotal = 0;
            let totalFMV = 0;
            let currentLineCosts = [];
            
            const row = document.getElementById(rowId);
            const isManualMode = (row.getAttribute('data-mode') === 'existing');

            let lineCount = 0;
            let planName = '';
            
            // Savings tracking
            let savingsData = {
                autopaySavingsVoice: 0,
                autopaySavingsHI: 0,
                autopaySavingsCD: 0,
                freeLineSavings: 0,
                percentageSavings: 0,
                percentageSavingsType: '', // 'Work Perks' or 'Insider'
                planTypeSavings: 0,
                planTypeSavingsLabel: '',
                devicePromoSavings: 0,
                hiBundlingSavings: 0,
                hi55Savings: 0,
                cdBeyondSavings: 0,
                cdBundlingSavings: 0,
                cdDevicePromoSavings: 0,
                cd2for1Savings: 0,
                manualDiscounts: 0,
                voiceLineBogo: 0
            };

            if (isManualMode) {
                baseTotal = parseFloat(document.getElementById(`${rowId}-manual-price`).value) || 0;
                lineCount = parseInt(document.getElementById(`${rowId}-lines`).value) || 0;
                
                // Add voice lines to base total
                if (STATE[rowId].voiceLines && STATE[rowId].voiceLines.length > 0) {
                    STATE[rowId].voiceLines.forEach(group => {
                        const regularLines = group.quantity - (group.bogoType !== 'none' && group.quantity >= 2 ? 1 : 0);
                        const regularCost = regularLines * group.cost;
                        
                        if (group.bogoType === 'free' && group.quantity >= 2) {
                            baseTotal += regularCost;
                            savingsData.voiceLineBogo += group.cost;
                        } else if (group.bogoType === 'ten' && group.quantity >= 2) {
                            baseTotal += regularCost + 10;
                            savingsData.voiceLineBogo += (group.cost - 10);
                        } else {
                            baseTotal += group.cost * group.quantity;
                        }
                    });
                }
            } else {
                lineCount = parseInt(document.getElementById(`${rowId}-lines`).value) || 0;
                planName = document.getElementById(`${rowId}-plan`).value;
                if (lineCount > 0 && planName && PLANS_DATA[planName]) {
                    const planData = PLANS_DATA[planName];
                    const planCostArray = planData.costs;
                    
                    // Check for ManualPricing override
                    if (planData.ManualPricing) {
                        // ManualPricing format: {4:25, 8:45}
                        // After 4 lines, every line is $25; after 8 lines, every line is $45
                        const thresholds = Object.keys(planData.ManualPricing)
                            .map(k => parseInt(k))
                            .sort((a, b) => a - b);
                        
                        for (let i = 0; i < lineCount; i++) {
                            let price = planCostArray[i < planCostArray.length ? i : planCostArray.length - 1];
                            
                            // Find the applicable threshold
                            for (let j = thresholds.length - 1; j >= 0; j--) {
                                if (lineCount >= thresholds[j]) {
                                    price = planData.ManualPricing[thresholds[j]];
                                    break;
                                }
                            }
                            
                            currentLineCosts.push(price);
                        }
                    } else {
                        // Standard pricing
                        for (let i = 0; i < lineCount; i++) {
                            const costIndex = i < planCostArray.length ? i : planCostArray.length - 1;
                            currentLineCosts.push(planCostArray[costIndex]);
                        }
                    }
                }
            }

            // Check for autopay - either from discounts (new mode) or checkbox (existing mode)
            let hasAutopay = STATE[rowId].discounts.some(d => d.type === 'Autopay Discount');
            if (isManualMode) {
                const autopayCheckbox = document.getElementById(`${rowId}-has-autopay`);
                hasAutopay = autopayCheckbox ? autopayCheckbox.checked : false;
            }
            const hasVoiceline = lineCount >= 1;
            
            // Check if beyond savings applies - from plan (new mode) or checkbox (existing mode)
            let isBeyondPlan = planName && PLANS_DATA[planName] ? PLANS_DATA[planName].beyond : false;
            if (isManualMode) {
                const beyondCheckbox = document.getElementById(`${rowId}-beyond-savings`);
                isBeyondPlan = beyondCheckbox ? beyondCheckbox.checked : false;
            }
            const is55Plan = planName && planName.includes('55');
            
            // Calculate plan type savings (Military, 55+, First Responder) compared to base plan
            if (!isManualMode && planName && lineCount > 0) {
                const planTypeSavingsAmount = calculatePlanTypeSavings(planName, lineCount);
                if (planTypeSavingsAmount > 0) {
                    savingsData.planTypeSavings = planTypeSavingsAmount;
                    savingsData.planTypeSavingsLabel = getPlanSavingsLabel(planName) || 'Plan Savings';
                }
            }
            
            // Track autopay slots used (max 8 total)
            let autopayUsed = 0;
            const maxAutopay = 8;
            
            if (isManualMode) {
                // In existing mode with autopay enabled, lines count towards autopay limit
                if (hasAutopay) {
                    autopayUsed = Math.min(lineCount, 8);
                    
                    // Add voice lines to the count
                    if (STATE[rowId].voiceLines && STATE[rowId].voiceLines.length > 0) {
                        STATE[rowId].voiceLines.forEach(group => {
                            autopayUsed = Math.min(autopayUsed + group.quantity, 8);
                        });
                    }
                }
                STATE[rowId].discounts.forEach(d => { 
                    savingsData.manualDiscounts += (d.amount || 0); 
                });
            } else {
                const activeDiscounts = STATE[rowId].discounts.map(d => d.type);
                
                // 1. Autopay for voice lines FIRST (up to 8 global max, $5 each)
                // Only apply if the plan is autopay eligible
                const planAutopayEligible = PLANS_DATA[planName]?.autopayEligible !== false;
                // Check if plan has maxAutopayLines property - this limits how many lines get autopay
                const maxAutopayLines = PLANS_DATA[planName]?.maxAutopayLines;
                // Check if removeAutoPayAfterMax is set - this removes autopay eligibility after max lines
                const removeAutoPayAfterMax = PLANS_DATA[planName]?.removeAutoPayAfterMax;
                
                // Determine if autopay should be completely disabled due to removeAutoPayAfterMax
                let autopayDisabled = false;
                if (removeAutoPayAfterMax && maxAutopayLines !== undefined && currentLineCosts.length > maxAutopayLines) {
                    // Check if there are CD or HI plans with autopay eligibility
                    const hasCDorHIWithAutopay = 
                        STATE[rowId].connectedDevices.some(cd => cd.planData?.autopayEligible) ||
                        STATE[rowId].homeInternet.some(hi => hi.planData?.autopayEligible);
                    
                    // Only disable if no CD/HI with autopay
                    if (!hasCDorHIWithAutopay) {
                        autopayDisabled = true;
                    }
                }
                
                // Calculate how many lines can get autopay (limited by maxAutopayLines if defined)
                const voiceLinesForAutopay = maxAutopayLines !== undefined 
                    ? Math.min(currentLineCosts.length, maxAutopayLines) 
                    : currentLineCosts.length;
                
                // Apply autopay discount up to the limit (only if not disabled)
                if (activeDiscounts.includes('Autopay Discount') && planAutopayEligible && !autopayDisabled) {
                    const linesToDiscount = Math.min(voiceLinesForAutopay, maxAutopay - autopayUsed);
                    for(let i=0; i<linesToDiscount; i++) {
                        if(currentLineCosts[i] >= 5) {
                            currentLineCosts[i] -= 5;
                            savingsData.autopaySavingsVoice += 5;
                            autopayUsed++;
                        }
                    }
                }
                
                // 2. Free Line
                const isFreeLineEligible = PLANS_DATA[planName] ? PLANS_DATA[planName].freeLineEligible : false;

                if (activeDiscounts.includes('Free Line') && isFreeLineEligible) {
                    if (currentLineCosts.length >= 3) {
                        const costOfLine3 = currentLineCosts[2]; 
                        // Free line always credits the full cost of the line
                        // (currentLineCosts contains base prices, autopay is applied separately)
                        const creditAmount = costOfLine3;
                        savingsData.freeLineSavings = creditAmount;
                        currentLineCosts[2] -= creditAmount;
                    }
                }

                // 3. Percentage Discounts (Work Perks / Insider)
                const isPremium = PREMIUM_PLANS.includes(planName);
                let planSubtotal = currentLineCosts.reduce((a,b)=>a+b, 0);
                
                if (isPremium && !isManualMode) {
                    if (activeDiscounts.includes('Work Perks') && lineCount <= 2) {
                        savingsData.percentageSavings = planSubtotal * 0.15;
                        savingsData.percentageSavingsType = 'Work Perks';
                    } else if (activeDiscounts.includes('Insider Discount')) {
                        savingsData.percentageSavings = planSubtotal * 0.20;
                        savingsData.percentageSavingsType = 'Insider';
                    }
                }
                
                // 4. Calculate 55+ Voice Plan Savings
                if (is55Plan && planName && PLANS_DATA[planName]) {
                    // Find the base plan version to compare savings
                    let basePlanName = '';
                    if (planName.includes('Experience Beyond')) {
                        basePlanName = 'Experience Beyond';
                    } else if (planName.includes('Experience More')) {
                        basePlanName = 'Experience More';
                    } else if (planName.includes('Essentials')) {
                        basePlanName = 'Essentials';
                    }
                    
                    if (basePlanName && PLANS_DATA[basePlanName]) {
                        const baseCosts = PLANS_DATA[basePlanName].costs;
                        let baseTotal = 0;
                        for (let i = 0; i < lineCount; i++) {
                            const costIndex = i < baseCosts.length ? i : baseCosts.length - 1;
                            baseTotal += baseCosts[costIndex];
                        }
                        
                        const plan55Costs = PLANS_DATA[planName].costs;
                        let plan55Total = 0;
                        for (let i = 0; i < lineCount; i++) {
                            const costIndex = i < plan55Costs.length ? i : plan55Costs.length - 1;
                            plan55Total += plan55Costs[costIndex];
                        }
                        
                        savingsData.voice55Savings = baseTotal - plan55Total;
                    }
                }
            }

            if (!isManualMode) {
                let netPlanCost = currentLineCosts.reduce((a,b)=>a+b, 0);
                const activeDiscounts = STATE[rowId].discounts.map(d => d.type);
                const isPremium = PREMIUM_PLANS.includes(planName);
                let percentageDisc = 0;
                
                if (isPremium) {
                    if (activeDiscounts.includes('Work Perks') && lineCount <= 2) {
                        percentageDisc = netPlanCost * 0.15;
                    } else if (activeDiscounts.includes('Insider Discount')) {
                        percentageDisc = netPlanCost * 0.20;
                    }
                }
                baseTotal = netPlanCost - percentageDisc;
                
            } else {
                baseTotal -= savingsData.manualDiscounts;
            }

            // Calculate device monthly payments and promo savings
            let devicesMonthly = 0;
            STATE[rowId].devices.forEach((dev, idx) => {
                devicesMonthly += calculateDeviceMonthly(dev.cost, dev.down || 0, dev.promo, dev.fmv);
                if(dev.fmv > 0) totalFMV += dev.fmv;
                
                // Track promo savings
                const monthlyPromo = (dev.promo - dev.fmv) / 24;
                if (monthlyPromo > 0) {
                    savingsData.devicePromoSavings += monthlyPromo;
                }
            });

            // Calculate Home Internet cost with autopay SECOND (after voice lines)
            let hiCost = 0;
            const hiCount = STATE[rowId].homeInternet.length;
            const maxHiBundleDiscount = 2; // Max 2 HI can get bundle discount
            let hiBundleDiscountUsed = 0;
            
            // For existing mode, check if plan cost is filled to determine bundle eligibility
            const existingHasPlanCost = isManualMode && baseTotal > 0;
            
            STATE[rowId].homeInternet.forEach((item, index) => {
                const plan = item.planData;
                let price = plan.price;
                
                // Check eligibility flags
                const voicelineEligible = plan.voicelineEligible !== false;
                const autopayEligible = plan.autopayEligible !== false;
                
                // Apply voiceline bundling discount only to first 2 eligible HI
                // In existing mode, apply if plan cost is filled
                if ((hasVoiceline || existingHasPlanCost) && voicelineEligible && hiBundleDiscountUsed < maxHiBundleDiscount) {
                    const bundlingSavings = plan.price - plan.priceWithVoiceline;
                    savingsData.hiBundlingSavings += bundlingSavings;
                    price = plan.priceWithVoiceline;
                    hiBundleDiscountUsed++;
                }
                
                // Apply 55+ Savings: extra $5 off for first HI on 55+ plans (new mode only, voiceline eligible)
                if (!isManualMode && is55Plan && index === 0 && voicelineEligible) {
                    savingsData.hi55Savings = 5;
                    price -= 5;
                }
                
                // Apply autopay discount to HI ($5 each) if slots available and eligible
                if (hasAutopay && autopayEligible && autopayUsed < maxAutopay) {
                    savingsData.autopaySavingsHI += 5;
                    price -= 5;
                    autopayUsed++;
                }
                
                hiCost += price;
            });

            // Calculate Connected Devices cost THIRD (remaining autopay slots)
            // Expand quantities for proper BOGO calculation (matching renderCDList logic)
            let cdCost = 0;
            
            // Expand all items by quantity into individual units
            const expandedCDItems = [];
            STATE[rowId].connectedDevices.forEach((item, origIndex) => {
                const qty = item.quantity || 1;
                for (let i = 0; i < qty; i++) {
                    expandedCDItems.push({
                        ...item,
                        originalIndex: origIndex,
                        unitIndex: i,
                        isBeyond: item.planData.beyondSavings && isBeyondPlan,
                        isBogoCompatible: item.planData.bogoCompatible !== false
                    });
                }
            });
            
            // Separate beyond and non-beyond items
            const beyondCDItems = expandedCDItems.filter(i => i.isBeyond);
            const nonBeyondCDItems = expandedCDItems.filter(i => !i.isBeyond);
            
            // BOGO Logic: Only BOGO-compatible items count for pairing AND receive discount
            // Non-compatible items (like SyncUP Tracker) don't participate in BOGO at all
            const bogoEligibleItems = nonBeyondCDItems.filter(i => i.isBogoCompatible);
            const discountsAvailable = Math.floor(bogoEligibleItems.length / 2);
            
            // Sort by price (lowest first - cheapest get the discount)
            bogoEligibleItems.sort((a, b) => a.planData.price - b.planData.price);
            
            // Mark the first N eligible items as half price (where N = discountsAvailable)
            const halfPriceSet = new Set();
            for (let i = 0; i < discountsAvailable; i++) {
                const item = bogoEligibleItems[i];
                halfPriceSet.add(`${item.originalIndex}-${item.unitIndex}`);
            }
            
            // Apply half price flag to items
            nonBeyondCDItems.forEach((item) => {
                const key = `${item.originalIndex}-${item.unitIndex}`;
                item.isHalfPrice = halfPriceSet.has(key);
            });
            
            // Calculate autopay assignments (non-beyond items)
            // Only count items that are autopay eligible (defined in plan data)
            const cdAutopayAssigned = new Set();
            // Sort by price descending for autopay assignment (highest price gets autopay first)
            const sortedForAutopay = [...nonBeyondCDItems].sort((a, b) => b.planData.price - a.planData.price);
            sortedForAutopay.forEach((item) => {
                const isAutopayEligible = item.planData.autopayEligible !== false;
                if (hasAutopay && isAutopayEligible && autopayUsed < maxAutopay) {
                    cdAutopayAssigned.add(`${item.originalIndex}-${item.unitIndex}`);
                    autopayUsed++;
                }
            });
            
            // Process beyond items
            beyondCDItems.forEach((item) => {
                const plan = item.planData;
                const originalPrice = plan.price;
                savingsData.cdBeyondSavings += (originalPrice - 5);
                
                const term = item.term || 24;
                const devDown = item.devDown || 0;
                const devPayment = Math.max(0, (item.devCost - devDown - item.devPromo) / term);
                if (item.devPromo > 0) {
                    savingsData.cdDevicePromoSavings += (item.devPromo / term);
                }
                cdCost += (5 + devPayment);
            });
            
            // Process non-beyond items
            nonBeyondCDItems.forEach((item) => {
                const plan = item.planData;
                let servicePrice = plan.price;
                
                // Apply autopay if assigned
                const autopayKey = `${item.originalIndex}-${item.unitIndex}`;
                if (cdAutopayAssigned.has(autopayKey)) {
                    const autopayDiscount = plan.price - plan.priceAutopay;
                    savingsData.autopaySavingsCD += autopayDiscount;
                    servicePrice = plan.priceAutopay;
                }
                
                // Apply voiceline savings (bundling discount)
                // In existing mode, apply if plan cost is filled
                if ((hasVoiceline || existingHasPlanCost) && plan.savingsWithVoiceline > 0) {
                    savingsData.cdBundlingSavings += plan.savingsWithVoiceline;
                    servicePrice -= plan.savingsWithVoiceline;
                }
                
                // Apply BOGO half price deal
                if (item.isHalfPrice) {
                    const halfPriceSavings = servicePrice / 2;
                    savingsData.cd2for1Savings += halfPriceSavings;
                    servicePrice = servicePrice / 2;
                }
                
                // Calculate device payment
                const term = item.term || 24;
                const devDown = item.devDown || 0;
                const devPayment = Math.max(0, (item.devCost - devDown - item.devPromo) / term);
                if (item.devPromo > 0) {
                    savingsData.cdDevicePromoSavings += (item.devPromo / term);
                }
                
                cdCost += (servicePrice + devPayment);
            });
            
            let protectionSum = 0;
            let standardProtectionSum = 0;
            STATE[rowId].devices.forEach((_, idx) => {
                if (STATE[rowId].protectionStatus[idx] !== false) {
                    const tierIdOrValue = STATE[rowId].protectionCosts[idx] !== undefined ? STATE[rowId].protectionCosts[idx] : 'p360-t5';
                    const cost = getProtectionValue(tierIdOrValue);
                    protectionSum += cost;
                    // Also calculate standard protection equivalent
                    const stdCost = getStandardTierEquivalent(tierIdOrValue);
                    standardProtectionSum += stdCost;
                }
            });

            // Calculate accessories costs
            let accessoriesMonthly = 0;
            let accessoriesDueToday = 0;
            let accessoriesRetailTotal = 0;
            STATE[rowId].accessories.forEach(acc => {
                const totalPrice = acc.price * acc.quantity;
                accessoriesRetailTotal += totalPrice;
                if (acc.paymentMethod === 'finance') {
                    accessoriesMonthly += totalPrice / 12;
                } else {
                    accessoriesDueToday += totalPrice;
                }
            });
            
            // Calculate add-ons costs
            let addonsCost = 0;
            (STATE[rowId].addons || []).forEach(addon => {
                addonsCost += addon.price * addon.amount;
            });
            
            // Calculate total retail price of devices for tax
            let devicesRetailTotal = 0;
            let devicesDownPayment = 0;
            STATE[rowId].devices.forEach(dev => {
                devicesRetailTotal += dev.cost || 0;
                devicesDownPayment += dev.down || 0;
            });
            
            // Calculate total retail price of connected devices for tax and down payments
            let cdRetailTotal = 0;
            let cdDownPayment = 0;
            STATE[rowId].connectedDevices.forEach(cd => {
                cdRetailTotal += cd.devCost || 0;
                cdDownPayment += cd.devDown || 0;
            });
            
            // Add custom due today items
            let customDueToday = 0;
            (STATE[rowId].dueTodayItems || []).forEach(item => {
                customDueToday += item.amount * (item.quantity || 1);
            });
            
            // Calculate tax on retail prices if tax percentage is set
            let taxAmount = 0;
            if (taxPercentage > 0) {
                const taxableTotal = devicesRetailTotal + accessoriesRetailTotal + cdRetailTotal;
                taxAmount = taxableTotal * (taxPercentage / 100);
            }
            
            // Down payments are NOT affected by tax
            const totalDueToday = accessoriesDueToday + customDueToday + taxAmount + devicesDownPayment + cdDownPayment;

            const subtotalBasic = baseTotal + devicesMonthly + cdCost + hiCost + accessoriesMonthly + addonsCost;
            
            // Only apply global adjustments when there's actual service cost
            // In new mode: requires a plan to be selected
            // In existing mode: requires manual price to be entered
            const hasPlanSelected = !isManualMode && planName && PLANS_DATA[planName];
            const hasManualPrice = isManualMode && (parseFloat(document.getElementById(`${rowId}-manual-price`)?.value) || 0) > 0;
            const shouldApplyAdjustments = hasPlanSelected || hasManualPrice;
            
            const deviceCount = STATE[rowId].devices.length;
            const globalAdj = shouldApplyAdjustments ? calculateGlobalAdjustments(subtotalBasic, lineCount, deviceCount) : 0;
            const totalBasicRaw = subtotalBasic + globalAdj;
            const totalProtectedRaw = totalBasicRaw + protectionSum;
            const totalStandardProtectedRaw = totalBasicRaw + standardProtectionSum;
            
            // Apply rounding if enabled
            const totalBasic = applyRounding(totalBasicRaw);
            const totalProtected = applyRounding(totalProtectedRaw);
            const totalStandardProtected = applyRounding(totalStandardProtectedRaw);

            // Update Due Today section - always show
            const dueTodayGroup = document.getElementById(`${rowId}-due-today-group`);
            const dueTodayTotal = document.getElementById(`${rowId}-due-today-total`);
            const dueTodayExplanation = document.getElementById(`${rowId}-due-today-explanation`);
            const savingsTodayContent = document.getElementById(`${rowId}-savings-today-content`);
            const savingsTodayTotal = document.getElementById(`${rowId}-savings-today-total`);
            
            if (dueTodayGroup && dueTodayTotal) {
                dueTodayTotal.textContent = `$${totalDueToday.toFixed(2)}`;
                
                // Build explanation text
                let explanationParts = [];
                if (taxAmount > 0) {
                    explanationParts.push('Taxes');
                }
                if (devicesDownPayment > 0 || cdDownPayment > 0) {
                    explanationParts.push('Down Payment');
                }
                if (accessoriesDueToday > 0) {
                    explanationParts.push('Accessories');
                }
                (STATE[rowId].dueTodayItems || []).forEach(item => {
                    if (item.description) {
                        explanationParts.push(item.description);
                    }
                });
                
                if (dueTodayExplanation) {
                    if (explanationParts.length > 0) {
                        dueTodayExplanation.textContent = explanationParts.join(', ');
                    } else {
                        dueTodayExplanation.textContent = '';
                    }
                }
                
                // Update Savings Today
                const savingsToday = STATE[rowId].savingsToday || 0;
                const savedTodayItems = STATE[rowId].savedTodayItems || [];
                const savingsTodayExplanation = document.getElementById(`${rowId}-savings-today-explanation`);
                if (savingsTodayContent && savingsTodayTotal) {
                    if (savingsToday > 0) {
                        savingsTodayContent.style.display = 'flex';
                        savingsTodayTotal.textContent = `$${savingsToday.toFixed(2)}`;
                        
                        // Show saved today items explanation
                        if (savingsTodayExplanation && savedTodayItems.length > 0) {
                            const explanationParts = savedTodayItems.map(item => item.description);
                            savingsTodayExplanation.textContent = explanationParts.join(', ');
                        } else if (savingsTodayExplanation) {
                            savingsTodayExplanation.textContent = '';
                        }
                    } else {
                        savingsTodayContent.style.display = 'none';
                        if (savingsTodayExplanation) savingsTodayExplanation.textContent = '';
                    }
                }
                
                // Hide due-today-content in print only if totalDueToday is 0 AND savingsToday is also 0
                // If savingsToday has a value, keep Due Today visible so they show side by side
                const dueTodayContentEl = document.getElementById(`${rowId}-due-today-content`);
                if (dueTodayContentEl) {
                    if (totalDueToday === 0 && savingsToday === 0) {
                        dueTodayContentEl.classList.add('hide-in-print');
                    } else {
                        dueTodayContentEl.classList.remove('hide-in-print');
                    }
                }
                
                // Hide entire due-today section in print if both totals are 0
                const footerTop = document.querySelector(`#${rowId} .footer-top`);
                if (footerTop) {
                    if (totalDueToday === 0 && savingsToday === 0) {
                        footerTop.classList.add('hide-due-today-section');
                    } else {
                        footerTop.classList.remove('hide-due-today-section');
                    }
                }
            }

            // Calculate per-line price display string (returns HTML)
            const getPerLineText = (total) => {
                if (!showPerLinePricing || lineCount === 0) return '';
                const perLine = total / lineCount;
                return `<span class="per-line-text"> ($${perLine.toFixed(2)}/line)</span>`;
            };
            
            // Determine if +Tax should be shown
            // Show only when: plan selected (new mode) or manual price entered (existing mode)
            // Also show when: connected devices or home internet are added (even without a voice plan)
            // Hide when: taxes included is checked (existing mode only)
            const taxesIncludedCheckbox = document.getElementById(`${rowId}-taxes-included`);
            const taxesIncluded = taxesIncludedCheckbox ? taxesIncludedCheckbox.checked : false;
            const hasVoicePlan = isManualMode ? (baseTotal > 0) : (planName !== '');
            const hasCDorHI = STATE[rowId].connectedDevices.length > 0 || STATE[rowId].homeInternet.length > 0;
            const hasPlanOrPrice = hasVoicePlan || hasCDorHI;
            const showTaxText = hasPlanOrPrice && !taxesIncluded;
            const taxText = showTaxText ? '<span class="tax-text">+ Tax</span>' : '';

            // Update inline totals (for new mode - in quote-right-section)
            const inlineTotalBasic = document.getElementById(`${rowId}-total-basic`);
            const inlineTotalProtected = document.getElementById(`${rowId}-total-protected`);
            if (inlineTotalBasic) inlineTotalBasic.innerHTML = `$${totalBasic.toFixed(2)}${taxText}${getPerLineText(totalBasic)}`;
            if (inlineTotalProtected) inlineTotalProtected.innerHTML = `$${totalProtected.toFixed(2)}${taxText}${getPerLineText(totalProtected)}`;
            
            // Update footer totals (for existing mode) - footer has separate + Tax divs
            const footerTotalBasic = document.getElementById(`${rowId}-footer-total-basic`);
            const footerTotalProtected = document.getElementById(`${rowId}-footer-total-protected`);
            if (footerTotalBasic) footerTotalBasic.innerHTML = `$${totalBasic.toFixed(2)}${getPerLineText(totalBasic)}`;
            if (footerTotalProtected) footerTotalProtected.innerHTML = `$${totalProtected.toFixed(2)}${getPerLineText(totalProtected)}`;
            
            // Update carrier price display with per-line if enabled
            const carrierPriceEl = document.getElementById(`${rowId}-carrier-price`);
            const footerCarrierPriceEl = document.getElementById(`${rowId}-footer-carrier-price`);
            const carrierPrice = STATE[rowId].carrierPrice || 0;
            const carrierLines = STATE[rowId].carrierLines || lineCount;
            const getCarrierPerLineText = (total) => {
                if (!showPerLinePricing || carrierLines === 0) return '';
                const perLine = total / carrierLines;
                return `<span class="per-line-text"> ($${perLine.toFixed(2)}/line)</span>`;
            };
            if (carrierPriceEl && carrierPrice > 0) carrierPriceEl.innerHTML = `$${carrierPrice.toFixed(0)}${getCarrierPerLineText(carrierPrice)}`;
            if (footerCarrierPriceEl && carrierPrice > 0) footerCarrierPriceEl.innerHTML = `$${carrierPrice.toFixed(0)}${getCarrierPerLineText(carrierPrice)}`;
            
            // Calculate and display yearly savings vs carrier
            // Use the price that will be displayed based on protection settings
            const yearlySavingsEl = document.getElementById(`${rowId}-yearly-savings`);
            if (yearlySavingsEl) {
                const carrierPrice = STATE[rowId].carrierPrice || 0;
                // Check if all devices have protection disabled for this calculation
                let allDevicesUnprotectedForSavings = false;
                if (STATE[rowId].devices.length > 0) {
                    allDevicesUnprotectedForSavings = STATE[rowId].devices.every((_, idx) => {
                        return STATE[rowId].protectionStatus[idx] === false;
                    });
                }
                // Check if any non-BYOD device has standard protection
                let hasNonBYODStandardProtectionForSavings = false;
                const protectedDevicesForSavings = STATE[rowId].devices.filter((_, idx) => STATE[rowId].protectionStatus[idx] !== false);
                if (protectedDevicesForSavings.length > 0) {
                    hasNonBYODStandardProtectionForSavings = STATE[rowId].devices.some((dev, idx) => {
                        if (STATE[rowId].protectionStatus[idx] === false) return false;
                        if (dev.cost === 0) return false; // Skip BYOD devices
                        const tierIdOrValue = STATE[rowId].protectionCosts[idx] || 'p360-t5';
                        return typeof tierIdOrValue === 'string' && tierIdOrValue.startsWith('std-');
                    });
                }
                // Use the displayed price based on per-row settings
                let ourPrice = totalProtected;
                if (allDevicesUnprotectedForSavings && STATE[rowId].devices.length > 0) {
                    ourPrice = totalBasic;
                } else if (hasNonBYODStandardProtectionForSavings) {
                    ourPrice = totalStandardProtected;
                }
                if (carrierPrice > 0 && ourPrice > 0 && carrierPrice > ourPrice) {
                    const monthlySavings = carrierPrice - ourPrice;
                    const yearlySavings = monthlySavings * 12;
                    yearlySavingsEl.textContent = `Yearly Savings of $${yearlySavings.toFixed(0)}`;
                    yearlySavingsEl.classList.remove('hidden');
                } else {
                    yearlySavingsEl.classList.add('hidden');
                }
            }

            // Visibility Logic - per-row settings
            const basicLabel = document.getElementById(`${rowId}-label-basic`);
            const basicBlock = document.getElementById(`${rowId}-block-basic`);
            const basicAmount = document.getElementById(`${rowId}-total-basic`);
            const protectBlock = document.getElementById(`${rowId}-block-protected`);
            const protectionLabel = document.getElementById(`${rowId}-protection-label`);
            const timelineToggleWrap = document.getElementById(`${rowId}-timeline-toggle-wrap`);
            const showUnprotected = STATE[rowId].showUnprotected;
            const showProtectionLabel = STATE[rowId].showProtectionLabel !== false;
            
            // Also get footer elements
            const footerBasicLabel = document.getElementById(`${rowId}-footer-label-basic`);
            const footerBasicBlock = document.getElementById(`${rowId}-footer-block-basic`);
            const footerProtectBlock = document.getElementById(`${rowId}-footer-block-protected`);
            const footerProtectionLabel = document.getElementById(`${rowId}-footer-protection-label`);
            
            // Check if all devices have protection disabled
            let allDevicesUnprotected = false;
            if (STATE[rowId].devices.length > 0) {
                allDevicesUnprotected = STATE[rowId].devices.every((_, idx) => {
                    return STATE[rowId].protectionStatus[idx] === false;
                });
            }

            if (STATE[rowId].devices.length > 0) {
                // Get per-row settings
                const showStandardProtection = STATE[rowId].showStandardProtection;
                
                // Check if any non-BYOD device has standard protection manually assigned
                // BYOD devices (cost === 0) with standard protection should NOT trigger the "Stnd Protection" label
                // Only devices with retail price that have standard protection should trigger it
                let hasNonBYODStandardProtection = false;
                const protectedDevices = STATE[rowId].devices.filter((_, idx) => STATE[rowId].protectionStatus[idx] !== false);
                if (protectedDevices.length > 0) {
                    hasNonBYODStandardProtection = STATE[rowId].devices.some((dev, idx) => {
                        if (STATE[rowId].protectionStatus[idx] === false) return false; // Skip unprotected
                        if (dev.cost === 0) return false; // Skip BYOD devices
                        const tierIdOrValue = STATE[rowId].protectionCosts[idx] || 'p360-t5';
                        return typeof tierIdOrValue === 'string' && tierIdOrValue.startsWith('std-');
                    });
                }
                
                // Determine what label text to show based on protection status
                let protectionLabelText;
                if (allDevicesUnprotected) {
                    protectionLabelText = 'w/o Protection';
                } else if (hasNonBYODStandardProtection) {
                    protectionLabelText = 'w/ Stnd Protection';
                } else {
                    protectionLabelText = 'w/ Protection';
                }
                
                // Main display shows appropriate protection price
                let displayProtectedTotal = totalProtected;
                
                // When ALL devices have protection disabled, show the non-protected price
                if (allDevicesUnprotected) {
                    displayProtectedTotal = totalBasic;
                } else if (hasNonBYODStandardProtection) {
                    // When a non-BYOD device has standard protection, show standard price
                    displayProtectedTotal = totalStandardProtected;
                }
                
                // Update main protected price display
                if (inlineTotalProtected) inlineTotalProtected.innerHTML = `$${displayProtectedTotal.toFixed(2)}${taxText}${getPerLineText(displayProtectedTotal)}`;
                if (footerTotalProtected) footerTotalProtected.innerHTML = `$${displayProtectedTotal.toFixed(2)}${getPerLineText(displayProtectedTotal)}`;
                
                // Show main protected block
                if (protectBlock) protectBlock.classList.remove('hidden');
                if (footerProtectBlock) footerProtectBlock.classList.remove('hidden');
                
                // Set protection label text and visibility
                // When showStandardProtection toggle is on, main label shows P360
                if (showStandardProtection && !allDevicesUnprotected) {
                    if (protectionLabel) {
                        protectionLabel.textContent = 'w/ P360 Protection';
                        protectionLabel.style.display = showProtectionLabel ? 'block' : 'none';
                    }
                    if (footerProtectionLabel) {
                        footerProtectionLabel.textContent = 'w/ P360 Protection';
                        footerProtectionLabel.style.display = showProtectionLabel ? 'block' : 'none';
                    }
                } else {
                    if (protectionLabel) {
                        protectionLabel.textContent = protectionLabelText;
                        protectionLabel.style.display = showProtectionLabel ? 'block' : 'none';
                    }
                    if (footerProtectionLabel) {
                        footerProtectionLabel.textContent = protectionLabelText;
                        footerProtectionLabel.style.display = showProtectionLabel ? 'block' : 'none';
                    }
                }
                
                // Set basic block label - used for secondary display
                // When showStandardProtection is on, basic block shows standard protection
                // When showUnprotected is on, basic block shows non-protected price
                if (showStandardProtection && !allDevicesUnprotected) {
                    if (basicLabel) {
                        basicLabel.textContent = "w/ Stnd Protection";
                        basicLabel.style.display = showProtectionLabel ? '' : 'none';
                    }
                    if (footerBasicLabel) {
                        footerBasicLabel.textContent = "w/ Stnd Protection";
                        footerBasicLabel.style.display = showProtectionLabel ? '' : 'none';
                    }
                    // Update basic amount to show standard protection total
                    if (basicAmount) basicAmount.innerHTML = `$${totalStandardProtected.toFixed(2)}${taxText}${getPerLineText(totalStandardProtected)}`;
                    const footerBasicAmount = document.getElementById(`${rowId}-footer-total-basic`);
                    if (footerBasicAmount) footerBasicAmount.innerHTML = `$${totalStandardProtected.toFixed(2)}${getPerLineText(totalStandardProtected)}`;
                } else {
                    if (basicLabel) {
                        basicLabel.textContent = "w/o Protection";
                        basicLabel.style.display = showProtectionLabel ? '' : 'none';
                    }
                    if (footerBasicLabel) {
                        footerBasicLabel.textContent = "w/o Protection";
                        footerBasicLabel.style.display = showProtectionLabel ? '' : 'none';
                    }
                    // Update basic amount to show non-protected total
                    if (basicAmount) basicAmount.innerHTML = `$${totalBasic.toFixed(2)}${taxText}${getPerLineText(totalBasic)}`;
                    const footerBasicAmount = document.getElementById(`${rowId}-footer-total-basic`);
                    if (footerBasicAmount) footerBasicAmount.innerHTML = `$${totalBasic.toFixed(2)}${getPerLineText(totalBasic)}`;
                }
                
                // Show/hide secondary pricing based on showUnprotected OR showStandardProtection toggle
                if (showUnprotected || showStandardProtection) {
                    if (basicBlock) basicBlock.classList.remove('hidden');
                    if (footerBasicBlock) footerBasicBlock.classList.remove('hidden');
                    if (basicAmount) basicAmount.classList.add('shrink');
                } else {
                    if (basicBlock) basicBlock.classList.add('hidden');
                    if (footerBasicBlock) footerBasicBlock.classList.add('hidden');
                }
                
                // Always show timeline protection slider when devices are present
                if(timelineToggleWrap) timelineToggleWrap.classList.remove('hidden');
            } else {
                // No devices - show total without protection subtitle
                if (protectBlock) protectBlock.classList.remove('hidden');
                if (footerProtectBlock) footerProtectBlock.classList.remove('hidden');
                if (inlineTotalProtected) inlineTotalProtected.innerHTML = `$${totalBasic.toFixed(2)}${taxText}${getPerLineText(totalBasic)}`;
                if (footerTotalProtected) footerTotalProtected.innerHTML = `$${totalBasic.toFixed(2)}${getPerLineText(totalBasic)}`;
                if (protectionLabel) protectionLabel.style.display = 'none';
                if (footerProtectionLabel) footerProtectionLabel.style.display = 'none';
                if (basicBlock) basicBlock.classList.add('hidden');
                if (footerBasicBlock) footerBasicBlock.classList.add('hidden');
                if(timelineToggleWrap) timelineToggleWrap.classList.add('hidden');
            }
            
            // Handle taxes included checkbox (existing mode only) - for footer + Tax divs
            const taxProtected = document.getElementById(`${rowId}-tax-protected`);
            const taxBasic = document.getElementById(`${rowId}-tax-basic`);
            const footerTaxProtected = document.getElementById(`${rowId}-footer-tax-protected`);
            const footerTaxBasic = document.getElementById(`${rowId}-footer-tax-basic`);
            if (taxesIncluded) {
                if (taxProtected) taxProtected.style.display = 'none';
                if (taxBasic) taxBasic.style.display = 'none';
                if (footerTaxProtected) footerTaxProtected.style.display = 'none';
                if (footerTaxBasic) footerTaxBasic.style.display = 'none';
            } else {
                if (taxProtected) taxProtected.style.display = '';
                if (taxBasic) taxBasic.style.display = '';
                if (footerTaxProtected) footerTaxProtected.style.display = '';
                if (footerTaxBasic) footerTaxBasic.style.display = '';
            }
            
            // Update header totals display (for print - in contact info section)
            const headerTotals = document.getElementById(`${rowId}-header-totals`);
            const headerTotalAmount = document.getElementById(`${rowId}-header-total-amount`);
            const headerTotalSub = document.getElementById(`${rowId}-header-total-sub`);
            const headerCarrierComparison = document.getElementById(`${rowId}-header-carrier-comparison`);
            const headerCarrierPrice = document.getElementById(`${rowId}-header-carrier-price`);
            const headerCarrierPerLine = document.getElementById(`${rowId}-header-carrier-per-line`);
            const headerCarrierName = document.getElementById(`${rowId}-header-carrier-name`);
            const headerVs = document.getElementById(`${rowId}-header-vs`);
            const headerTotalSecondary = document.getElementById(`${rowId}-header-total-secondary`);
            const headerTotalAmountSecondary = document.getElementById(`${rowId}-header-total-amount-secondary`);
            const headerTotalSubSecondary = document.getElementById(`${rowId}-header-total-sub-secondary`);
            const headerPerLine = document.getElementById(`${rowId}-header-per-line`);
            const headerPerLineSecondary = document.getElementById(`${rowId}-header-per-line-secondary`);
            const headerYearlySavings = document.getElementById(`${rowId}-header-yearly-savings`);
            const headerYearlyAmount = document.getElementById(`${rowId}-header-yearly-amount`);
            const showPerLine = showPerLinePricing; // Use global variable instead of checkbox
            
            if (headerTotals && headerTotalAmount) {
                // Handle carrier comparison
                const carrierPrice = STATE[rowId].carrierPrice || 0;
                const carrierName = STATE[rowId].carrierName || '';
                const carrierLines = STATE[rowId].carrierLines || lineCount;
                const hasCarrier = carrierPrice > 0 && carrierName;
                
                if (headerCarrierComparison && hasCarrier) {
                    headerCarrierComparison.classList.add('active');
                    headerCarrierComparison.style.display = '';
                    if (headerCarrierPrice) headerCarrierPrice.textContent = `$${carrierPrice.toFixed(0)}`;
                    if (headerCarrierName) headerCarrierName.textContent = carrierName;
                    
                    // Handle carrier per-line display
                    if (headerCarrierPerLine) {
                        if (showPerLine && carrierLines > 0) {
                            const carrierPerLine = carrierPrice / carrierLines;
                            headerCarrierPerLine.textContent = `($${carrierPerLine.toFixed(2)}/line)`;
                            headerCarrierPerLine.classList.add('active');
                            headerCarrierPerLine.style.display = '';
                        } else {
                            headerCarrierPerLine.classList.remove('active');
                            headerCarrierPerLine.style.display = 'none';
                        }
                    }
                } else if (headerCarrierComparison) {
                    headerCarrierComparison.classList.remove('active');
                    headerCarrierComparison.style.display = 'none';
                    if (headerCarrierPerLine) {
                        headerCarrierPerLine.classList.remove('active');
                        headerCarrierPerLine.style.display = 'none';
                    }
                }
                
                // Show/hide VS based on carrier comparison
                if (headerVs) {
                    if (hasCarrier) {
                        headerVs.classList.add('active');
                        headerVs.style.display = '';
                    } else {
                        headerVs.classList.remove('active');
                        headerVs.style.display = 'none';
                    }
                }
                
                // Determine which total to show based on per-row settings
                const showStandardProtectionForHeader = STATE[rowId].showStandardProtection;
                let displayTotal = totalProtected;
                let subText = 'w/ Protection + Tax';
                let showSecondary = false;
                let secondaryTotal = totalBasic;
                let secondarySubText = 'w/o Protection';
                const showUnprotected = STATE[rowId].showUnprotected;
                const showProtectionLabelForHeader = STATE[rowId].showProtectionLabel !== false;
                
                // Check if all devices have protection disabled
                let allDevicesUnprotectedForHeader = false;
                if (STATE[rowId].devices.length > 0) {
                    allDevicesUnprotectedForHeader = STATE[rowId].devices.every((_, idx) => {
                        return STATE[rowId].protectionStatus[idx] === false;
                    });
                }
                
                // Check if any non-BYOD device has standard protection manually assigned
                let hasNonBYODStandardProtectionForHeader = false;
                const protectedDevicesForHeader = STATE[rowId].devices.filter((_, idx) => STATE[rowId].protectionStatus[idx] !== false);
                if (protectedDevicesForHeader.length > 0) {
                    hasNonBYODStandardProtectionForHeader = STATE[rowId].devices.some((dev, idx) => {
                        if (STATE[rowId].protectionStatus[idx] === false) return false;
                        if (dev.cost === 0) return false; // Skip BYOD devices
                        const tierIdOrValue = STATE[rowId].protectionCosts[idx] || 'p360-t5';
                        return typeof tierIdOrValue === 'string' && tierIdOrValue.startsWith('std-');
                    });
                }
                
                if (STATE[rowId].devices.length === 0) {
                    displayTotal = totalBasic;
                    subText = taxesIncluded ? '' : '+ Tax';
                } else if (allDevicesUnprotectedForHeader) {
                    // When all devices are unprotected, show w/o Protection
                    displayTotal = totalBasic;
                    if (showProtectionLabelForHeader) {
                        subText = taxesIncluded ? 'w/o Protection' : 'w/o Protection + Tax';
                    } else {
                        subText = taxesIncluded ? '' : '+ Tax';
                    }
                } else if (hasNonBYODStandardProtectionForHeader) {
                    // Non-BYOD device has standard protection - show standard as main
                    displayTotal = totalStandardProtected;
                    if (showProtectionLabelForHeader) {
                        subText = taxesIncluded ? 'w/ Stnd Protection' : 'w/ Stnd Protection + Tax';
                    } else {
                        subText = taxesIncluded ? '' : '+ Tax';
                    }
                } else if (showStandardProtectionForHeader) {
                    // Show P360 as main, Standard as secondary
                    displayTotal = totalProtected;
                    if (showProtectionLabelForHeader) {
                        subText = taxesIncluded ? 'w/ P360 Protection' : 'w/ P360 Protection + Tax';
                        secondarySubText = taxesIncluded ? 'w/ Stnd Protection' : 'w/ Stnd Protection + Tax';
                    } else {
                        subText = taxesIncluded ? '' : '+ Tax';
                        secondarySubText = taxesIncluded ? '' : '+ Tax';
                    }
                    secondaryTotal = totalStandardProtected;
                    showSecondary = true;
                } else if (showUnprotected) {
                    // Show both prices when per-row showUnprotected is enabled
                    if (showProtectionLabelForHeader) {
                        subText = taxesIncluded ? 'w/ Protection' : 'w/ Protection + Tax';
                        secondarySubText = taxesIncluded ? 'w/o Protection' : 'w/o Protection + Tax';
                    } else {
                        subText = taxesIncluded ? '' : '+ Tax';
                        secondarySubText = taxesIncluded ? '' : '+ Tax';
                    }
                    showSecondary = true;
                } else {
                    // Default: show P360 protection price
                    if (showProtectionLabelForHeader) {
                        subText = taxesIncluded ? 'w/ Protection' : 'w/ Protection + Tax';
                    } else {
                        subText = taxesIncluded ? '' : '+ Tax';
                    }
                }
                
                headerTotalAmount.textContent = `$${displayTotal.toFixed(2)}`;
                if (headerTotalSub) headerTotalSub.textContent = subText;
                
                // Handle per-line display
                if (headerPerLine) {
                    if (showPerLine && lineCount > 0) {
                        const perLineAmount = displayTotal / lineCount;
                        headerPerLine.textContent = `($${perLineAmount.toFixed(2)}/line)`;
                        headerPerLine.classList.add('active');
                        headerPerLine.style.display = '';
                    } else {
                        headerPerLine.classList.remove('active');
                        headerPerLine.style.display = 'none';
                    }
                }
                
                // Handle secondary pricing display
                if (headerTotalSecondary) {
                    if (showSecondary && STATE[rowId].devices.length > 0) {
                        headerTotalSecondary.classList.add('active');
                        headerTotalSecondary.style.display = '';
                        if (headerTotalAmountSecondary) headerTotalAmountSecondary.textContent = `$${secondaryTotal.toFixed(2)}`;
                        if (headerTotalSubSecondary) headerTotalSubSecondary.textContent = secondarySubText;
                        
                        // Handle per-line for secondary
                        if (headerPerLineSecondary) {
                            if (showPerLine && lineCount > 0) {
                                const perLineSecondary = secondaryTotal / lineCount;
                                headerPerLineSecondary.textContent = `($${perLineSecondary.toFixed(2)}/line)`;
                                headerPerLineSecondary.classList.add('active');
                                headerPerLineSecondary.style.display = '';
                            } else {
                                headerPerLineSecondary.classList.remove('active');
                                headerPerLineSecondary.style.display = 'none';
                            }
                        }
                    } else {
                        headerTotalSecondary.classList.remove('active');
                        headerTotalSecondary.style.display = 'none';
                    }
                }
                
                // Handle yearly savings display for print header
                if (headerYearlySavings) {
                    if (hasCarrier) {
                        // Use the display total for comparison
                        const monthlySavings = carrierPrice - displayTotal;
                        if (monthlySavings > 0) {
                            const yearlySavings = monthlySavings * 12;
                            headerYearlySavings.classList.add('active');
                            headerYearlySavings.style.display = '';
                            if (headerYearlyAmount) headerYearlyAmount.textContent = `$${yearlySavings.toFixed(0)}`;
                        } else {
                            headerYearlySavings.classList.remove('active');
                            headerYearlySavings.style.display = 'none';
                        }
                    } else {
                        headerYearlySavings.classList.remove('active');
                        headerYearlySavings.style.display = 'none';
                    }
                }
                
                headerTotals.classList.add('active');
            }

            const timelineSection = document.getElementById(`${rowId}-timeline-section`);
            if (totalFMV > 0) {
                timelineSection.classList.add('active');
                document.getElementById(`${rowId}-fmv-total`).textContent = `$${totalFMV.toFixed(2)}`;
                const toggle = document.getElementById(`${rowId}-timeline-toggle`);
                const toggleValue = toggle ? toggle.value : 'protected';
                
                // Check if all devices have protection disabled for this calculation
                let allDevicesUnprotectedForTimeline = false;
                if (STATE[rowId].devices.length > 0) {
                    allDevicesUnprotectedForTimeline = STATE[rowId].devices.every((_, idx) => {
                        return STATE[rowId].protectionStatus[idx] === false;
                    });
                }
                
                // Check if any non-BYOD device has P360 protection
                let hasP360Protection = false;
                // Check if any non-BYOD device has standard protection
                let hasStandardProtection = false;
                const protectedDevicesForTimeline = STATE[rowId].devices.filter((_, idx) => STATE[rowId].protectionStatus[idx] !== false);
                if (protectedDevicesForTimeline.length > 0) {
                    STATE[rowId].devices.forEach((dev, idx) => {
                        if (STATE[rowId].protectionStatus[idx] === false) return;
                        const tierIdOrValue = STATE[rowId].protectionCosts[idx] || 'p360-t5';
                        if (typeof tierIdOrValue === 'string') {
                            if (tierIdOrValue.startsWith('std-')) {
                                hasStandardProtection = true;
                            } else if (tierIdOrValue.startsWith('p360-')) {
                                hasP360Protection = true;
                            }
                        }
                    });
                }
                
                // Update the timeline protection slider
                const showStandardProtectionSetting = STATE[rowId].showStandardProtection;
                updateTimelineProtectionSlider(rowId, hasP360Protection, hasStandardProtection, showStandardProtectionSetting);
                
                // Determine effective monthly cost based on slider selection
                let activeMonthlyCost;
                if (allDevicesUnprotectedForTimeline || toggleValue === 'none') {
                    // No protection
                    activeMonthlyCost = totalBasic;
                } else if (toggleValue === 'standard') {
                    // Standard protection
                    activeMonthlyCost = totalStandardProtected;
                } else if (toggleValue === 'p360') {
                    // P360 protection
                    activeMonthlyCost = totalProtected;
                } else if (toggleValue === 'protected' || toggleValue === 'true') {
                    // Generic protected - use whatever protection is assigned
                    if (hasStandardProtection && !hasP360Protection) {
                        activeMonthlyCost = totalStandardProtected;
                    } else {
                        activeMonthlyCost = totalProtected;
                    }
                } else {
                    // Default to protected total
                    activeMonthlyCost = totalProtected;
                }
                
                generateTimeline(rowId, activeMonthlyCost, totalFMV);
            } else {
                timelineSection.classList.remove('active');
            }
            
            renderRebateSummary(rowId);
            renderDiscountSummary(rowId, savingsData);
            
            // Adjust summary widths based on visibility
            updateSummaryWidths(rowId);
            
            // Update print visibility for sections
            const cdWrapper = document.getElementById(`${rowId}-col-bts`);
            if (STATE[rowId].connectedDevices.length === 0) cdWrapper.classList.add('print-hidden'); 
            else cdWrapper.classList.remove('print-hidden');
            
            const hiWrapper = document.getElementById(`${rowId}-col-internet`);
            if (STATE[rowId].homeInternet.length === 0) hiWrapper.classList.add('print-hidden'); 
            else hiWrapper.classList.remove('print-hidden');
            
            const rebateWrapper = document.getElementById(`${rowId}-col-rebates`);
            if (STATE[rowId].rebates.length === 0) rebateWrapper.classList.add('print-hidden'); 
            else rebateWrapper.classList.remove('print-hidden');
            
            const discWrapper = document.getElementById(`${rowId}-col-discounts`);
            if (STATE[rowId].discounts.length === 0) discWrapper.classList.add('print-hidden'); 
            else discWrapper.classList.remove('print-hidden');
            
            // Enable/disable discount and rebate buttons based on selections
            // Same logic as PDF button: need (lines + plan) OR CD OR HI for new mode, or (manual price) OR CD OR HI for existing
            const manualPrice = isManualMode ? (parseFloat(document.getElementById(`${rowId}-manual-price`).value) || 0) : 0;
            let hasValidSelections = false;
            if (isManualMode) {
                hasValidSelections = manualPrice > 0 || STATE[rowId].connectedDevices.length > 0 || STATE[rowId].homeInternet.length > 0;
            } else {
                hasValidSelections = (lineCount > 0 && planName) || STATE[rowId].connectedDevices.length > 0 || STATE[rowId].homeInternet.length > 0;
            }
            const discountBtn = document.getElementById(`${rowId}-discount-btn`);
            const rebateBtn = document.getElementById(`${rowId}-rebate-btn`);
            
            if (discountBtn) {
                if (hasValidSelections) {
                    discountBtn.classList.remove('btn-disabled');
                } else {
                    discountBtn.classList.add('btn-disabled');
                }
            }
            if (rebateBtn) {
                if (hasValidSelections) {
                    rebateBtn.classList.remove('btn-disabled');
                } else {
                    rebateBtn.classList.add('btn-disabled');
                }
            }
            
            renderDeviceList(rowId);
            renderCDList(rowId);
            renderHIList(rowId);
            updateAddonsDisplay(rowId);
            updateExportButtonVisibility();
            
            // Update carousel container height if in carousel mode
            updateCarouselContainerHeight();
        }
        
        // Update the timeline protection slider based on device protection settings
        function updateTimelineProtectionSlider(rowId, hasP360, hasStandard, showStandardProtection) {
            const sliderContainer = document.getElementById(`${rowId}-timeline-prot-slider`);
            const hiddenInput = document.getElementById(`${rowId}-timeline-toggle`);
            if (!sliderContainer || !hiddenInput) return;
            
            // Determine which options to show:
            // - If showStandardProtection is ON (comparing P360 vs Standard): show "P360", "Standard", "None"
            // - If only P360 devices exist (no showStandardProtection): show "P360", "None"
            // - If only Standard devices exist (no showStandardProtection): show "Standard", "None"
            
            const options = [];
            
            if (showStandardProtection && hasP360) {
                // User has P360 devices and is comparing to standard - show all 3 options
                options.push({ id: 'p360', label: 'P360' });
                options.push({ id: 'standard', label: 'Standard' });
                options.push({ id: 'none', label: 'None' });
            } else if (hasP360 && hasStandard) {
                // User has both P360 and standard devices manually assigned (not comparing)
                options.push({ id: 'protected', label: 'Protected' });
                options.push({ id: 'none', label: 'None' });
            } else if (hasP360) {
                // Only P360 devices
                options.push({ id: 'p360', label: 'P360' });
                options.push({ id: 'none', label: 'None' });
            } else if (hasStandard) {
                // Only standard devices
                options.push({ id: 'standard', label: 'Standard' });
                options.push({ id: 'none', label: 'None' });
            } else {
                // No devices with protection - hide the slider
                return;
            }
            
            // Get current value or default to first option
            let currentValue = hiddenInput.value;
            const validValues = options.map(o => o.id);
            if (!validValues.includes(currentValue)) {
                // Map old values to new valid values
                if (currentValue === 'true' || currentValue === 'protected') {
                    currentValue = options[0].id; // Default to first protection option
                } else if (currentValue === 'false') {
                    currentValue = 'none';
                } else {
                    currentValue = options[0].id;
                }
            }
            
            // Build the expanding slider HTML - all options inline, only active one visible when collapsed
            const optionsHtml = options.map(opt => {
                const activeClass = (opt.id === currentValue) ? 'active' : '';
                return `<div class="timeline-prot-slider-option ${activeClass}" data-value="${opt.id}">${opt.label}</div>`;
            }).join('');
            
            sliderContainer.innerHTML = optionsHtml;
            
            // Use a single click handler on the container for better reliability
            sliderContainer.onclick = function(e) {
                e.stopPropagation();
                const clickedOption = e.target.closest('.timeline-prot-slider-option');
                const isOpen = sliderContainer.classList.contains('open');
                
                if (isOpen && clickedOption) {
                    // Slider is open and user clicked an option - select it
                    setTimelineProtection(rowId, clickedOption.dataset.value);
                } else {
                    // Slider is closed or clicked on background - toggle it
                    toggleTimelineSlider(rowId);
                }
            };
            
            // Update hidden input
            hiddenInput.value = currentValue;
        }
        
        // Toggle the timeline slider expanded/collapsed
        function toggleTimelineSlider(rowId) {
            const sliderContainer = document.getElementById(`${rowId}-timeline-prot-slider`);
            if (!sliderContainer) return;
            
            const isOpen = sliderContainer.classList.contains('open');
            
            // Close all other open sliders first
            document.querySelectorAll('.timeline-prot-slider.open').forEach(el => {
                if (el !== sliderContainer) {
                    el.classList.remove('open');
                }
            });
            
            if (!isOpen) {
                sliderContainer.classList.add('open');
                
                // Add click outside listener to close
                setTimeout(() => {
                    document.addEventListener('click', closeTimelineSliderOnClickOutside);
                }, 0);
            } else {
                sliderContainer.classList.remove('open');
                document.removeEventListener('click', closeTimelineSliderOnClickOutside);
            }
        }
        
        // Close slider when clicking outside
        function closeTimelineSliderOnClickOutside(event) {
            const openSliders = document.querySelectorAll('.timeline-prot-slider.open');
            openSliders.forEach(slider => {
                if (!slider.contains(event.target)) {
                    slider.classList.remove('open');
                }
            });
            
            // Remove listener if no sliders are open
            if (document.querySelectorAll('.timeline-prot-slider.open').length === 0) {
                document.removeEventListener('click', closeTimelineSliderOnClickOutside);
            }
        }
        
        // Handle timeline protection slider click
        function setTimelineProtection(rowId, value) {
            const hiddenInput = document.getElementById(`${rowId}-timeline-toggle`);
            const sliderContainer = document.getElementById(`${rowId}-timeline-prot-slider`);
            if (!hiddenInput || !sliderContainer) return;
            
            // Update hidden input
            hiddenInput.value = value;
            
            // Update active state on options
            sliderContainer.querySelectorAll('.timeline-prot-slider-option').forEach(opt => {
                if (opt.dataset.value === value) {
                    opt.classList.add('active');
                } else {
                    opt.classList.remove('active');
                }
            });
            
            // Close the slider after a brief delay to show the selection
            setTimeout(() => {
                sliderContainer.classList.remove('open');
                document.removeEventListener('click', closeTimelineSliderOnClickOutside);
            }, 150);
            
            // Recalculate the row
            calculateRow(rowId);
        }

        function generateTimeline(rowId, monthlyBill, credits) {
            const container = document.getElementById(`${rowId}-timeline-visual`);
            container.innerHTML = '';

            if (monthlyBill <= 0) {
                container.innerHTML = `<div style="padding:10px; color:var(--success-color);">Bill covered entirely.</div>`;
                return;
            }

            let remainingCredit = credits;
            let month = 1;
            const limit = 7; 
            let keepCalculating = true;

            while (keepCalculating && month <= limit) {
                let billForMonth = 0;
                let isFree = false;

                if (remainingCredit >= monthlyBill) {
                    billForMonth = 0;
                    remainingCredit -= monthlyBill;
                    isFree = true;
                } else {
                    billForMonth = monthlyBill - remainingCredit;
                    remainingCredit = 0;
                    keepCalculating = false;
                }

                const point = document.createElement('div');
                point.className = 'timeline-point';
                
                const costStr = billForMonth === 0 ? "Free" : `$${billForMonth.toFixed(0)}`;
                const dotClass = isFree ? "tp-dot free" : "tp-dot";
                const costClass = isFree ? "tp-cost free" : "tp-cost";

                point.innerHTML = `
                    <span class="tp-label">Mo ${month}</span>
                    <div class="${dotClass}"></div>
                    <span class="${costClass}">${costStr}</span>
                `;
                container.appendChild(point);
                month++;
            }
            
            if (!keepCalculating && month <= limit) {
                 const point = document.createElement('div');
                point.className = 'timeline-point';
                point.innerHTML = `
                    <span class="tp-label">Mo ${month}+</span>
                    <div class="tp-dot"></div>
                    <span class="tp-cost">$${monthlyBill.toFixed(0)}</span>
                `;
                container.appendChild(point);
            }
        }
        
        // ============================================
        // QR CODE GENERATION AND LOADING
        // ============================================
        
        function generateQuoteBarcode(rowId) {
            const container = document.getElementById(`${rowId}-barcode-canvas`);
            if (!container) return;
            
            // Clear existing barcode
            container.innerHTML = '';
            
            // Serialize the quote data for this row (with full details)
            const quoteData = serializeQuoteDetailed(rowId);
            const jsonData = JSON.stringify(quoteData);
            
            // Create PDF417 barcode
            try {
                PDF417.render(container, jsonData, {
                    columns: 8,
                    securityLevel: 2,
                    moduleWidth: 1,
                    moduleHeight: 3,
                    margin: 5
                });
            } catch (e) {
                console.error('Barcode generation failed:', e);
                container.innerHTML = '<span style="font-size:10px; color:#999;">Code Error - Data too large</span>';
            }
        }
        
        // Detailed serialization with names for PDF417 (has more capacity than QR)
        function serializeQuoteDetailed(rowId) {
            const row = document.getElementById(rowId);
            const isManualMode = row.getAttribute('data-mode') === 'existing';
            const planName = document.getElementById(`${rowId}-plan`)?.value || '';
            const lineCount = parseInt(document.getElementById(`${rowId}-lines`)?.value) || 0;
            
            // Build detailed data structure
            const data = {
                v: 2, // Version 2 with detailed info
                mode: isManualMode ? 'existing' : 'new',
                lines: lineCount,
                plan: planName,
                manualPrice: isManualMode ? (parseFloat(document.getElementById(`${rowId}-manual-price`)?.value) || 0) : 0,
                
                // Devices with full details
                devices: STATE[rowId].devices.map((dev, i) => ({
                    name: dev.label || `Device ${i + 1}`,
                    tradeName: dev.tradeinName || '',
                    cost: dev.cost || 0,
                    promo: dev.promo || 0,
                    fmv: dev.fmv || 0,
                    protected: STATE[rowId].protectionStatus[i] !== false,
                    protCost: STATE[rowId].protectionCosts[i] || 'p360-t5'
                })),
                
                // Connected devices with names
                connectedDevices: STATE[rowId].connectedDevices.map(cd => ({
                    category: cd.category,
                    plan: cd.planKey,
                    name: cd.devName || cd.planKey,
                    cost: cd.devCost || 0,
                    promo: cd.devPromo || 0,
                    term: cd.term || 24,
                    qty: cd.quantity || 1
                })),
                
                // Home internet with names
                homeInternet: STATE[rowId].homeInternet.map(hi => ({
                    plan: hi.planKey,
                    label: hi.label || hi.planKey
                })),
                
                // Add-ons
                addons: (STATE[rowId].addons || []).map(addon => ({
                    name: addon.name,
                    price: addon.price,
                    amount: addon.amount
                })),
                
                // Rebates with full names
                rebates: STATE[rowId].rebates.map(r => ({
                    name: r.name || 'Rebate',
                    value: r.value || 0,
                    count: r.count || 1
                })),
                
                // Discounts with types
                discounts: STATE[rowId].discounts.map(d => ({
                    type: d.type || 'Manual',
                    name: d.name || '',
                    amount: d.amount || 0
                }))
            };
            
            return data;
        }
        
        function serializeQuote(rowId) {
            const row = document.getElementById(rowId);
            const isManualMode = row.getAttribute('data-mode') === 'existing';
            
            // Create plan index lookup for compact storage
            const planNames = Object.keys(PLANS_DATA);
            const planIndex = planNames.indexOf(document.getElementById(`${rowId}-plan`)?.value || '');
            
            // Create connected device plan index lookups
            const cdPlanKeys = {
                Watches: Object.keys(CONNECTED_DEVICE_PLANS.Watches),
                Tablets: Object.keys(CONNECTED_DEVICE_PLANS.Tablets),
                Data: Object.keys(CONNECTED_DEVICE_PLANS.Data)
            };
            
            // Create home internet plan index lookup
            const hiPlanKeys = Object.keys(HOME_INTERNET_PLANS);
            
            // Ultra-compact data structure
            const data = {
                v: 1,
                m: isManualMode ? 1 : 0,
                l: parseInt(document.getElementById(`${rowId}-lines`)?.value) || 0,
                p: planIndex >= 0 ? planIndex : -1,
                mp: isManualMode ? Math.round((parseFloat(document.getElementById(`${rowId}-manual-price`)?.value) || 0) * 100) : 0,
                // Devices: [cost*100, promo*100, fmv*100, protected, protCost*100] (skip label and down to save space)
                d: STATE[rowId].devices.map((dev, i) => [
                    Math.round((dev.cost || 0) * 100),
                    Math.round((dev.promo || 0) * 100),
                    Math.round((dev.fmv || 0) * 100),
                    STATE[rowId].protectionStatus[i] !== false ? 1 : 0,
                    Math.round(getProtectionValue(STATE[rowId].protectionCosts[i] || 'p360-t5') * 100)
                ]),
                // Connected devices: [category index, plan index, cost*100, promo*100, term, qty]
                cd: STATE[rowId].connectedDevices.map(cd => {
                    const catIndex = ['Watches', 'Tablets', 'Data'].indexOf(cd.category);
                    const planIdx = catIndex >= 0 ? cdPlanKeys[cd.category].indexOf(cd.planKey) : -1;
                    return [
                        catIndex,
                        planIdx,
                        Math.round((cd.devCost || 0) * 100),
                        Math.round((cd.devPromo || 0) * 100),
                        cd.term || 24,
                        cd.quantity || 1
                    ];
                }),
                // Home internet: [plan index]
                hi: STATE[rowId].homeInternet.map(hi => hiPlanKeys.indexOf(hi.planKey)),
                // Add-ons: [name, price*100, amount]
                ao: (STATE[rowId].addons || []).map(addon => [
                    addon.name,
                    Math.round((addon.price || 0) * 100),
                    addon.amount || 1
                ]),
                // Rebates: [value*100, count] (skip name to save space)
                rb: STATE[rowId].rebates.map(r => [Math.round((r.value || 0) * 100), r.count || 1]),
                // Discounts: simplified - just type indices
                ds: STATE[rowId].discounts.map(d => {
                    const types = ['Autopay Discount', 'Free Line', 'Work Perks', 'Insider Discount', 'Manual'];
                    return types.indexOf(d.type || 'Manual');
                })
            };
            
            return data;
        }
        
        // Camera scanning variables
        let videoStream = null;
        let scanInterval = null;
        let barcodeDetector = null;
        let scanCanvas = null;
        let scanCtx = null;
        
        function openScanModal() {
            document.getElementById('scan-modal').classList.add('open');
            document.getElementById('scan-result').classList.remove('success', 'error');
            document.getElementById('scan-result-text').textContent = '';
            
            // Reset image upload
            const imageInput = document.getElementById('qr-image-input');
            if (imageInput) imageInput.value = '';
            const imagePreview = document.getElementById('image-preview');
            if (imagePreview) imagePreview.style.display = 'none';
            
            // Reset displays
            const cameraContainer = document.getElementById('camera-container');
            const cameraError = document.getElementById('camera-error');
            const cameraLoading = document.getElementById('camera-loading');
            const cameraOverlay = document.getElementById('camera-overlay');
            
            if (cameraContainer) cameraContainer.style.display = 'block';
            if (cameraError) cameraError.style.display = 'none';
            if (cameraLoading) {
                cameraLoading.style.display = 'block';
                cameraLoading.textContent = 'Starting camera...';
            }
            if (cameraOverlay) cameraOverlay.style.display = 'none';
            
            // Start camera
            startCamera();
        }
        
        function closeScanModal() {
            document.getElementById('scan-modal').classList.remove('open');
            stopCamera();
        }
        
        async function startCamera() {
            const video = document.getElementById('qr-video');
            const cameraContainer = document.getElementById('camera-container');
            const cameraError = document.getElementById('camera-error');
            const cameraLoading = document.getElementById('camera-loading');
            const cameraOverlay = document.getElementById('camera-overlay');
            
            // Create canvas for frame capture
            scanCanvas = document.createElement('canvas');
            scanCtx = scanCanvas.getContext('2d', { willReadFrequently: true });
            
            // Check for camera API support first
            if (!navigator.mediaDevices || typeof navigator.mediaDevices.getUserMedia !== 'function') {
                console.log('Camera API not available');
                showCameraError('Camera not supported on this device');
                return;
            }
            
            // Try to initialize BarcodeDetector
            barcodeDetector = null;
            try {
                if (typeof BarcodeDetector !== 'undefined') {
                    const formats = await BarcodeDetector.getSupportedFormats();
                    if (formats && formats.includes('qr_code')) {
                        barcodeDetector = new BarcodeDetector({ formats: ['qr_code'] });
                    }
                }
            } catch (e) {
                console.log('BarcodeDetector error:', e);
            }
            
            try {
                // Request camera - use simpler constraints for better compatibility
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' },
                    audio: false
                });
                
                videoStream = stream;
                video.srcObject = stream;
                video.setAttribute('playsinline', '');
                video.muted = true;
                
                // Use loadeddata event which is more reliable on iOS
                video.onloadeddata = async () => {
                    try {
                        await video.play();
                        
                        // Camera is working
                        if (cameraLoading) cameraLoading.style.display = 'none';
                        if (cameraOverlay) cameraOverlay.style.display = 'block';
                        if (cameraContainer) cameraContainer.style.display = 'block';
                        if (cameraError) cameraError.style.display = 'none';
                        
                        // Set canvas size
                        scanCanvas.width = video.videoWidth || 640;
                        scanCanvas.height = video.videoHeight || 480;
                        
                        // Start scanning if we have BarcodeDetector
                        if (barcodeDetector) {
                            scanInterval = setInterval(() => scanFrame(video), 250);
                        } else {
                            // No BarcodeDetector - show image upload option alongside camera
                            if (cameraError) {
                                cameraError.style.display = 'block';
                                cameraError.querySelector('p').textContent = 'QR scanning not supported. Upload an image instead:';
                            }
                        }
                    } catch (playErr) {
                        console.error('Video play failed:', playErr);
                        showCameraError('Could not start video');
                    }
                };
                
            } catch (err) {
                console.error('getUserMedia error:', err);
                showCameraError('Camera access denied or not available');
            }
        }
        
        function showCameraError(message) {
            const cameraContainer = document.getElementById('camera-container');
            const cameraError = document.getElementById('camera-error');
            
            if (cameraContainer) cameraContainer.style.display = 'none';
            if (cameraError) {
                cameraError.style.display = 'block';
                const msgEl = cameraError.querySelector('p');
                if (msgEl && message) msgEl.textContent = message + ' Upload an image of the QR code:';
            }
            stopCamera();
        }
        
        function stopCamera() {
            if (scanInterval) {
                clearInterval(scanInterval);
                scanInterval = null;
            }
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            const video = document.getElementById('qr-video');
            if (video) video.srcObject = null;
        }
        
        async function scanFrame(video) {
            if (!video || video.readyState < video.HAVE_CURRENT_DATA) return;
            if (!scanCanvas || !scanCtx || !barcodeDetector) return;
            
            try {
                scanCtx.drawImage(video, 0, 0, scanCanvas.width, scanCanvas.height);
                const barcodes = await barcodeDetector.detect(scanCanvas);
                if (barcodes && barcodes.length > 0) {
                    onQRCodeDetected(barcodes[0].rawValue);
                }
            } catch (e) {
                // Ignore scan errors
            }
        }
        
        // Process uploaded QR code image
        async function processQRImage(input) {
            if (!input.files || !input.files[0]) return;
            
            const file = input.files[0];
            const imagePreview = document.getElementById('image-preview');
            const previewImg = document.getElementById('qr-preview-img');
            const imageStatus = document.getElementById('image-status');
            
            // Show preview
            const reader = new FileReader();
            reader.onload = async (e) => {
                previewImg.src = e.target.result;
                imagePreview.style.display = 'block';
                imageStatus.textContent = 'Processing image...';
                imageStatus.style.color = 'var(--text-secondary)';
                
                // Create image element for processing
                const img = new Image();
                img.onload = async () => {
                    // Try BarcodeDetector first
                    let result = null;
                    
                    if (typeof BarcodeDetector !== 'undefined') {
                        try {
                            const detector = new BarcodeDetector({ formats: ['qr_code'] });
                            const barcodes = await detector.detect(img);
                            if (barcodes && barcodes.length > 0) {
                                result = barcodes[0].rawValue;
                            }
                        } catch (e) {
                            console.log('BarcodeDetector failed on image:', e);
                        }
                    }
                    
                    // If BarcodeDetector didn't work, try with canvas
                    if (!result) {
                        try {
                            const canvas = document.createElement('canvas');
                            canvas.width = img.width;
                            canvas.height = img.height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0);
                            
                            if (typeof BarcodeDetector !== 'undefined') {
                                const detector = new BarcodeDetector({ formats: ['qr_code'] });
                                const barcodes = await detector.detect(canvas);
                                if (barcodes && barcodes.length > 0) {
                                    result = barcodes[0].rawValue;
                                }
                            }
                        } catch (e) {
                            console.log('Canvas detection failed:', e);
                        }
                    }
                    
                    if (result) {
                        imageStatus.textContent = 'QR code found! Loading quote...';
                        imageStatus.style.color = 'var(--success-color)';
                        setTimeout(() => onQRCodeDetected(result), 500);
                    } else {
                        imageStatus.textContent = 'Could not read QR code. Make sure the image is clear and the QR code is visible.';
                        imageStatus.style.color = 'var(--danger-color)';
                    }
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        function onQRCodeDetected(data) {
            stopCamera();
            
            try {
                // Decompress data
                const jsonData = decodeURIComponent(atob(data));
                const quoteData = JSON.parse(jsonData);
                
                // Validate version
                if (!quoteData.v || quoteData.v !== 1) {
                    throw new Error('Invalid quote version');
                }
                
                // Load the quote
                loadQuoteFromData(quoteData);
                
                document.getElementById('scan-result-text').textContent = ' Quote loaded successfully!';
                document.getElementById('scan-result').classList.add('success');
                document.getElementById('scan-result').classList.remove('error');
                
                // Close modal after delay
                setTimeout(() => {
                    closeScanModal();
                }, 1200);
                
            } catch (e) {
                console.error('Error parsing QR data:', e);
                document.getElementById('scan-result-text').textContent = ' Invalid QR code. Try again.';
                document.getElementById('scan-result').classList.add('success', 'error');
                
                // Restart camera
                setTimeout(() => {
                    document.getElementById('scan-result').classList.remove('success', 'error');
                    startCamera();
                }, 1500);
            }
        }
        
        function loadFromPastedQR() {
            const pastedData = document.getElementById('qr-paste-input').value.trim();
            
            if (!pastedData) {
                document.getElementById('scan-result-text').textContent = 'Please paste the QR code data first.';
                document.getElementById('scan-result').classList.add('success', 'error');
                return;
            }
            
            try {
                // Decompress data
                const jsonData = decodeURIComponent(atob(pastedData));
                const quoteData = JSON.parse(jsonData);
                
                // Validate version
                if (!quoteData.v || quoteData.v !== 1) {
                    throw new Error('Invalid quote version');
                }
                
                // Load the quote
                loadQuoteFromData(quoteData);
                
                document.getElementById('scan-result-text').textContent = ' Quote loaded successfully!';
                document.getElementById('scan-result').classList.add('success');
                document.getElementById('scan-result').classList.remove('error');
                
                // Close modal after delay
                setTimeout(() => {
                    closeScanModal();
                }, 1500);
                
            } catch (e) {
                console.error('Error parsing QR data:', e);
                document.getElementById('scan-result-text').textContent = ' Invalid QR code data. Please check and try again.';
                document.getElementById('scan-result').classList.add('success', 'error');
            }
        }
        
        function loadQuoteFromData(data) {
            // Check version - v2 has detailed names, v1 has compact indices
            const isV2 = data.v === 2;
            
            // Create plan lookups
            const planNames = Object.keys(PLANS_DATA);
            const cdPlanKeys = {
                Watches: Object.keys(CONNECTED_DEVICE_PLANS.Watches),
                Tablets: Object.keys(CONNECTED_DEVICE_PLANS.Tablets),
                Data: Object.keys(CONNECTED_DEVICE_PLANS.Data)
            };
            const hiPlanKeys = Object.keys(HOME_INTERNET_PLANS);
            const discountTypes = ['Autopay Discount', 'Free Line', 'Work Perks', 'Insider Discount', 'Manual'];
            const categories = ['Watches', 'Tablets', 'Data'];
            
            // Set mode FIRST - v2 uses 'existing'/'new', v1 uses 1/0
            const isExisting = isV2 ? (data.mode === 'existing') : (data.m === 1 || data.m === 'e');
            const loadedMode = isExisting ? 'existing' : 'new';
            
            // Temporarily set currentMode to the target mode to prevent resetCalculator from being called twice
            const previousMode = currentMode;
            currentMode = loadedMode;
            
            // Update toggle UI without triggering reset
            const slider = document.getElementById('toggle-slider');
            const labels = document.querySelectorAll('.toggle-labels span');
            labels.forEach(label => label.classList.remove('active'));
            const compareLinkWrapper = document.getElementById('compare-link-wrapper');
            
            if (loadedMode === 'new') {
                slider.className = 'toggle-slider position-0';
                labels[0].classList.add('active');
            } else {
                slider.className = 'toggle-slider position-1';
                labels[1].classList.add('active');
            }
            document.getElementById('rows-container').style.display = 'block';
            document.getElementById('compare-section').classList.remove('active');
            document.body.classList.remove('compare-mode');
            if (compareLinkWrapper) compareLinkWrapper.classList.remove('hidden');
            
            // Now reset and create a single row in the correct mode
            document.getElementById('rows-container').innerHTML = '';
            STATE = {};
            rowCount = 0;
            
            // Create a new row
            createNewRow();
            const rowId = `row-${rowCount}`;
            
            // Set lines - v2 uses 'lines', v1 uses 'l'
            const linesInput = document.getElementById(`${rowId}-lines`);
            const lineCount = isV2 ? (data.lines || 0) : (data.l || 0);
            if (linesInput) {
                linesInput.value = lineCount;
                if (isExisting) {
                    validateUpgrades(linesInput, rowId);
                } else {
                    validateLines(linesInput, rowId);
                }
            }
            
            // Set plan - v2 uses 'plan' name directly, v1 uses 'p' index
            if (!isExisting) {
                let planName = '';
                if (isV2) {
                    planName = data.plan || '';
                } else if (data.p !== undefined && data.p !== -1 && data.p !== '') {
                    if (typeof data.p === 'number') {
                        planName = planNames[data.p] || '';
                    } else {
                        planName = data.p;
                    }
                }
                if (planName) {
                    document.getElementById(`${rowId}-plan`).value = planName;
                    document.getElementById(`${rowId}-plan-trigger`).value = planName;
                    handleStandardPlan(rowId);
                }
            }
            
            // Set manual price - v2 uses 'manualPrice' directly, v1 uses 'mp' in cents
            if (isExisting) {
                const manualPriceValue = isV2 ? data.manualPrice : (data.mp ? data.mp / 100 : 0);
                if (manualPriceValue) {
                    const manualPrice = document.getElementById(`${rowId}-manual-price`);
                    if (manualPrice) {
                        manualPrice.value = manualPriceValue.toFixed(2);
                        handleManualPrice(rowId);
                    }
                }
            }
            
            // Load devices - v2 has objects with names, v1 has arrays
            const deviceData = isV2 ? data.devices : data.d;
            if (deviceData && deviceData.length > 0) {
                STATE[rowId].devices = deviceData.map((dev, i) => {
                    if (isV2) {
                        // V2 format: objects with names
                        STATE[rowId].protectionStatus[i] = dev.protected !== false;
                        // Handle both old numeric format and new tier ID format
                        STATE[rowId].protectionCosts[i] = dev.protCost || 'p360-t5';
                        return {
                            label: dev.name || `Device ${i + 1}`,
                            tradeinName: dev.tradeName || '',
                            cost: dev.cost || 0,
                            down: 0,
                            promo: dev.promo || 0,
                            fmv: dev.fmv || 0
                        };
                    } else if (Array.isArray(dev)) {
                        // V1 compact format (5 elements) or old format (7 elements)
                        if (dev.length === 5) {
                            STATE[rowId].protectionStatus[i] = dev[3] === 1;
                            STATE[rowId].protectionCosts[i] = (dev[4] || 1900) / 100;
                            return {
                                label: `Device ${i + 1}`,
                                cost: (dev[0] || 0) / 100,
                                down: 0,
                                promo: (dev[1] || 0) / 100,
                                fmv: (dev[2] || 0) / 100
                            };
                        } else {
                            STATE[rowId].protectionStatus[i] = dev[5] === 1;
                            STATE[rowId].protectionCosts[i] = (dev[6] || 1900) / 100;
                            return {
                                label: dev[0] || '',
                                cost: (dev[1] || 0) / 100,
                                down: (dev[2] || 0) / 100,
                                promo: (dev[3] || 0) / 100,
                                fmv: (dev[4] || 0) / 100
                            };
                        }
                    }
                    return { label: '', cost: 0, down: 0, promo: 0, fmv: 0 };
                });
                renderDeviceList(rowId);
            }
            
            // Load connected devices - v2 has objects, v1 has arrays
            const cdData = isV2 ? data.connectedDevices : data.cd;
            if (cdData && cdData.length > 0) {
                STATE[rowId].connectedDevices = cdData.map(cd => {
                    if (isV2) {
                        // V2 format: objects with names
                        const category = cd.category || 'Watches';
                        const planKey = cd.plan || '';
                        const planData = CONNECTED_DEVICE_PLANS[category]?.[planKey] || {};
                        return {
                            category: category,
                            planKey: planKey,
                            planData: planData,
                            devName: cd.name || planKey,
                            devCost: cd.cost || 0,
                            devPromo: cd.promo || 0,
                            term: cd.term || 24,
                            quantity: cd.qty || 1,
                            units: []
                        };
                    } else if (Array.isArray(cd)) {
                        const catIndex = cd[0];
                        const category = categories[catIndex] || 'Watches';
                        let planKey = '';
                        
                        if (typeof cd[1] === 'number') {
                            planKey = cdPlanKeys[category]?.[cd[1]] || '';
                        } else {
                            planKey = cd[1] || '';
                        }
                        
                        const planData = CONNECTED_DEVICE_PLANS[category]?.[planKey] || {};
                        return {
                            category: category,
                            planKey: planKey,
                            planData: planData,
                            devName: planKey,
                            devCost: (cd[2] || 0) / 100,
                            devPromo: (cd[3] || 0) / 100,
                            term: cd[4] || 24,
                            quantity: cd[5] || 1,
                            units: []
                        };
                    }
                    return null;
                }).filter(Boolean);
                renderCDList(rowId);
            }
            
            // Load home internet - v2 has objects, v1 has indices
            const hiData = isV2 ? data.homeInternet : data.hi;
            if (hiData && hiData.length > 0) {
                STATE[rowId].homeInternet = hiData.map(hi => {
                    let planKey = '';
                    let label = '';
                    
                    if (isV2) {
                        planKey = hi.plan || '';
                        label = hi.label || planKey;
                    } else if (typeof hi === 'number') {
                        planKey = hiPlanKeys[hi] || '';
                        label = planKey;
                    } else if (Array.isArray(hi)) {
                        planKey = typeof hi[0] === 'number' ? hiPlanKeys[hi[0]] : hi[0];
                        label = planKey;
                    } else {
                        planKey = hi;
                        label = planKey;
                    }
                    
                    const planData = HOME_INTERNET_PLANS[planKey] || {};
                    return {
                        planKey: planKey,
                        planData: planData,
                        label: label
                    };
                }).filter(h => h.planKey);
                renderHIList(rowId);
            }
            
            // Load add-ons - v2 has objects with names, v1 has arrays
            const aoData = isV2 ? data.addons : data.ao;
            if (aoData && aoData.length > 0) {
                STATE[rowId].addons = aoData.map(addon => {
                    if (isV2) {
                        return {
                            name: addon.name || 'Add-on',
                            price: addon.price || 0,
                            amount: addon.amount || 1
                        };
                    } else if (Array.isArray(addon)) {
                        return {
                            name: addon[0] || 'Add-on',
                            price: (addon[1] || 0) / 100,
                            amount: addon[2] || 1
                        };
                    }
                    return { name: 'Add-on', price: 0, amount: 1 };
                });
                updateAddonsDisplay(rowId);
            }
            
            // Load rebates - v2 has objects with names, v1 has arrays
            const rbData = isV2 ? data.rebates : data.rb;
            if (rbData && rbData.length > 0) {
                STATE[rowId].rebates = rbData.map((r, i) => {
                    if (isV2) {
                        return {
                            name: r.name || `Rebate ${i + 1}`,
                            value: r.value || 0,
                            count: r.count || 1
                        };
                    } else if (Array.isArray(r)) {
                        return {
                            name: `Rebate ${i + 1}`,
                            value: (r[0] || 0) / 100,
                            count: r[1] || 1
                        };
                    }
                    return { name: '', value: 0, count: 1 };
                });
                renderRebateList(rowId);
            }
            
            // Load discounts - v2 has objects, v1 has type indices
            const dsData = isV2 ? data.discounts : data.ds;
            if (dsData && dsData.length > 0) {
                STATE[rowId].discounts = dsData.map(d => {
                    if (isV2) {
                        return {
                            type: d.type || 'Manual',
                            name: d.name || '',
                            amount: d.amount || 0
                        };
                    } else if (typeof d === 'number') {
                        return {
                            type: discountTypes[d] || 'Manual',
                            name: '',
                            amount: 0
                        };
                    } else if (Array.isArray(d)) {
                        return {
                            type: d[0] || '',
                            name: d[1] || '',
                            amount: (d[2] || 0) / 100
                        };
                    }
                    return { type: 'Manual', name: '', amount: 0 };
                });
                renderDiscountList(rowId);
            }
            
            // Recalculate
            calculateRow(rowId);
            
            // Update default benefits slider visibility
            toggleDefaultBenefitsSwitch();
        }
    </script>
    
    <!-- SECRET PASSWORD MODAL -->
    <div id="secret-password-modal" class="modal-overlay" onclick="if(event.target === this) closeSecretPasswordModal()">
        <div class="modal-content" style="max-width: 350px;" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3> Access Required</h3>
                <button class="modal-header-close" onclick="closeSecretPasswordModal()">&times;</button>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <p style="margin-bottom: 15px; color: var(--text-secondary); font-size: 0.9rem;">Enter password to continue:</p>
                <input type="password" id="secret-password-input" placeholder="Password" style="width: 100%; padding: 12px; font-size: 1rem; border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 10px;" onkeydown="if(event.key === 'Enter') checkSecretPassword()">
                <p id="secret-password-error" style="display: none; color: var(--danger-color); font-size: 0.85rem; margin-bottom: 10px;">Incorrect password. Try again.</p>
                <button class="btn btn-primary" onclick="checkSecretPassword()" style="width: 100%;">Submit</button>
            </div>
        </div>
    </div>
    
    <!-- SECRET MENU MODAL -->
    <div id="secret-menu-modal" class="modal-overlay" onclick="if(event.target === this) closeSecretMenu()">
        <div class="modal-content" style="max-width: 500px;" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3> Secret Menu</h3>
                <button class="modal-header-close" onclick="closeSecretMenu()">&times;</button>
            </div>
            <div class="modal-body" style="padding: 20px; min-height: 200px;">
                <!-- Secret menu content will go here -->
                <p style="color: var(--text-secondary); text-align: center; font-style: italic;">Secret menu is currently empty.</p>
            </div>
        </div>
    </div>
</body>
</html>
